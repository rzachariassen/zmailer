.\" This manpage has been automatically generated by docbook2man 
.\" from a DocBook document.  This tool can be found at:
.\" <http://shell.ipoline.com/~elmert/comp/docbook2X/> 
.\" Please send any bug reports, improvements, comments, patches, 
.\" etc. to Steve Cheng <steve@ggi-project.org>.
.TH "MAILBOX" "8" "27 June 2001" "" ""
.SH NAME
mailbox \- zmailer local delivery transport agent
.SH SYNOPSIS

\fBmailbox\fR [ \fB-c \fIchannel\fB\fR]  [ \fB-h \fI"localpart"\fB\fR]  [ \fB-l \fIlogfilepath\fB\fR]  [ \fB-8abDCHPrSVX\fR] 

.SH "DESCRIPTION"
.PP
The \fBmailbox\fR
is a ZMailer transport agent which is usually only run by the
\fBscheduler\fR(8)
program to deliver mail to local user mailbox files.
The \fBmailbox\fR program must be run with root privileges,
and invoked with the same current directory as the \fBscheduler\fR,
namely \fI\fBPOSTOFFICE\fI/transport\fR.
.PP
Recipient addresses are processed as follows:
.TP 0.2i
\(bu
Strip doublequotes around the address, if any.
.TP 0.2i
\(bu
Strip prefixing backslashes, if any.
.TP 0.2i
\(bu
If the address starts with a '|', the rest of the recipient
address string is interpreted as a shell command to be run.
.TP 0.2i
\(bu
If the address starts with a '/', the recipient address
is a filename to append the message to.
.TP 0.2i
\(bu
Otherwise the recipient address must be a local user id.
.TP 0.2i
\(bu
If user is not found, and the first character of the address is
a capital letter, the entire address is folded to lowercase and
the user lookup is retried.
.PP
If delivering to a user mailbox (\fI\fBMAILBOX\fI/userid\fR) which
doesn't exist, the \fBmailbox\fR program will try to create it.
If the \fI\fBMAILBOX\fI/\fR directory is mounted
from a remote system this will succeed if the directory is group-writable.
.PP
Some sanity checks are done on deliveries to files and mailboxes:
.TP 0.2i
\(bu
The file being delivered to must have 1 link only, and must be either
\fI/dev/null\fR or a regular file.
.TP 0.2i
\(bu
The file lock must be held.
(See below for a chapter about locks.)
.PP
There is a further sanity check on mailbox deliveries, namely if the
mailbox is not empty the
\fBmailbox\fR
program will enforce 2 newlines as a separator before the message to
be delivered.  This guarantees that User Agents, like
\fBMail\fR(1),
can find the about-to-be delivered message even if the current contents of
the mailbox is corrupt.
.PP
When delivering to a process (by starting a Bourne shell to execute
a specified command line), the environment is set up to contain several
variables which are listed below at the ``Subprogram Environment Variables''
section.
The SIGINT and SIGHUP signals are ignored,
but SIGTERM is treated normally.
If the process dumps core, it will be retried later.
Sub-process exit codes are interpreted according to
\fI<sysexits.h>\fR codes,
and of those EX_NOPERM, EX_UNAVAILABLE,
EX_NOHOST, EX_NOUSER, and EX_DATAERR
are treated as permanent errors, all others are treated as temporary failures.
.PP
The actual data delivered to a file, mailbox, or process, is identical.
It consists of the concationation of a UUCP style separator line,
the message header specified in the message control file, and the
message body from the original message file.
The separator line starts with ``From '' and is followed by
the sender address and a timestamp.
.PP
After all deliveries and just before exiting, the \fBmailbox\fR
process will poke \fBcomsat\fR(8C) in case recipients have turned on
\fBbiff\fR(1).
The program may be compiled to look in the rwho files on the system
for recipient names logged onto neighbouring hosts, in which case the
\fBcomsat\fR on the remote host will be poked.
Even if this compile-time option is enabled, this will only be done
for users that have a \fI.rbiff\fR file in their home directory.
(Unless an ``-DRBIFF_ALWAYS'' compile option is used.)
.SH "OPTIONS"
.PP
.TP
\fB-c channel\fR
specifies which channel name should be keyed on.
The default is ``local''.
.TP
\fB-h ``localpart''\fR
specifies which of the possible multiple recipients is to be picked
this time. Default is ``none'', which selects all local channel
recipients, however when the routing is done with scripts storing some
tokens (other than ``-'') into the "host"-part, it is possible
to process "host-wise", i.e. so that each \fBuser\fR has their own
lock-state, and not just everybody hang on the same lock(s)..
.TP
\fB-l logfilepath\fR
specifies a logfile.  Each entry is a line containing message id, pre-existing
mailbox size in bytes, number of bytes appended, and the file name or command
line delivered to.
.TP
\fB-V\fR
prints a version message and exits.
.TP
\fB-a\fR
the access time on mailbox files is, by default, preserved across delivery,
so that programs such as \fBlogin\fR(1) can determine if new mail
has arrived.
This option disables the above action.
.TP
\fB-b\fR
disables biff notification.
.TP
\fB-r\fR
disables remote biff notification (if supported).
.TP
\fB-8\fR
enables MIME-QP-decoder to decode incoming MIME-email with Quoted-Printable
encoded characters.
.TP
\fB-M\fR
enables the creation of MMDF-style mail-folder in the incoming mail folder.
The default is "classic" UNIX-style folder.
.TP
\fB-C\fR
Canonify username by using internally version of username received in
pw_name field of the \fBgetpwnam()\fR call result.
.TP
\fB-D[D]\fR
For a user named: abcdef, one ``\fB-D\fR''
will place the mailbox file into
\fI$\fBMAILBOX\fI/a/abcdef\fR.
With ``\fB-DD\fR'' the mailbox file will be placed into:
\fI$\fBMAILBOX\fI/a/b/abcdef\fR.
.TP
\fB-P[P]\fR
This uses much of similar method as the ``\fB-D[D]\fR''
option, but directory names are derived from much more smoothly
distributing hash function over user names, namely:
\fBpjwhash32()\fR.

With one ``\fB-P\fR'' the calculated hash value is used by formula:
\fB'A'+(hash % 26)\fR to produce one mid-level directory.
With ``\fB-PP\fR''
the formula is more complex: upper directory uses formula:
\fB'A' + (hash / 26) % 26\fR
and lower uses formula:
\fB'A'+(hash % 26)\fR

The result of these ``\fB-P[P]\fR''
derived directory paths is something like:
\fI$\fBMAILBOX\fI/X/username\fR, or
\fI$\fBMAILBOX\fI/Y/X/username\fR.
.TP
\fB-X[X]\fR
This is similar to ``\fB-P[P]\fR''
option, but used hash function is \fBcrc32()\fR.
Resulting distribution is slightly different, and in fact quite smooth.
.TP
\fB-S\fR
This option enables ``Return-Receipt-To:'' message header recognition
and processing along with sending receipt to given address.
\fB(Newer sendmails don't anymore support this facility per default..)\fR
.SH "INTERFACE"
.PP
This program reads in processable file names relative to
the current working directory of the scheduler
(namely: \fI$\fBPOSTIOFFICE\fI/transport/\fR).
Optionally on the same line the scheduler may tell which host is to be
looked for from the recipients of the message.
.PP
\&.RS
\\fIrelative-spool-path\\fR [ <TAB< \\fIhostname\\fR ]
\&.RE
.PP
This program produces diagnostic output on the standard output.
Normal diagnostic output is of the form:
.PP
\&.RS
\\fIid\\fR/\\fIoffset\\fR<TAB>\\fInotify-data\\fR<TAB>\\fIstatus\\fR \\fImessage\\fR
\&.RE
.PP
where 
\&.I id
is the inode number of the message file,
\&.I offset
is a byte offset within its control file where the address being reported
on is kept,
\&.I status
is one of
\&.BR ok ,
\&.BR error ,
or
\&.BR deferred ,
and the
\&.I message
is descriptive text associated with the report.  The text is terminated by
a linefeed.  Any other format (as might be produced by subprocesses)
is passed to standard output for logging in the \fBscheduler\fR log.
.PP
The exit status is a code from
\fI<sysexits.h>\fR.
.SH "LOCKS"
.PP
Locking scheme used at the system is configurable at the runtime,
and has separate parameters for mailboxes, and files.
The data is configurable with zenv variable MBOXLOCKS
at which following characters have meanins:
.TP
\fB``:''\fR
Separates mailbox locks, and file-locks at the string.
The left side has mailbox locks, and the right side has
locks for other regular files. (Files with explicit paths
defined.)
.TP
\fB``.''\fR
For mailboxes only:
Does ``dotlock'' (userid.lock), or (at Sun Solaris)
maillock() mechanism.
.TP
\fB``F''\fR
If the system has \fBflock\fR()
system call, uses it to lock the entire file.
(\fBIgnored at systems without flock()!\fR)
.TP
\fB``L''\fR
If the system has \fBlockf\fR() system call, uses it to lock
the entire file.
(\fBIgnored at systems without lockf()!\fR)
.PP
Locks are acquired in the same order as the key characters are listed.
.PP
Default for the \fBlockf\fR() capable systems is:
.PP
MBOXLOCKS=".L:L"
.PP
You can choose insane combinations of lock mechanisms, which at some
systems cause locks to fail always, like at Linux-2.0 series where program
must not use both \fBlockf\fR() and \fBflock\fR() locks.
.PP
\fB It is extremely important, that selected locking methods are same
throughout the system at all programs trying to acquire locks on
mail spools.\fR
.SH "ENVIRONMENT"
.PP
The default location for user mailbox files varies per systems, but
usually it is one of: \fI/var/mail\fR, \fI/var/spool/mail\fR.
This may be modified by setting the variable MAILBOX in
\fI/etc/zmailer.conf\fR to the directory containing user mailbox files,
for example \fI/usr/spool/mail\fR.
This is best done in the ZMailer \fISiteConfig\fR file.
.PP
Variable MBOXLOCKS is used to define locking schemes
used for mailbox spool files, and separately for other regular files.
.SH "SECURITY"
.PP
Like all parts of the \fBZMailer\fR, the \fBmailbox\fR
chooses to err into overtly cautious side.
In case of pipes being run under the \fBmailbox\fR,
the program in pipe is started thru \fB/bin/sh\fR
with severely sanitized environment variables, and with only
file descriptors STDIN, STDOUT, and STDERR.
Programs are refused from running, if address analysis has found
suspicuous data; external messages can't directly run programs,
nor those addresses that have had a security breach detected during
\fB.forward\fR-, or other aliasing analysis.
(Same applies also with writing into explicitly named files.)
.PP
The pipe subprogram is run with user-id it gets thru the address
privilege analysis during message routing, and it gets the
group-id thru lookup of:  \fBgetpwuid(uid)\fR.
That is, if you have multiple usernames with same uid, there
are no guarantees as to which of them is used for the gid entry.
.PP
The pipe subprogram is started
\&.B without
use of
\&.I /bin/sh
command line interpreter (i.e. "system()" call), when the command
line begins with slash, and does not contain characters: `$' and '>'.
If any of those rules is not fulfilled, the subprogram is started
with ``/bin/sh -c "$cmdlinestr"'' call.   This allows running pipes
with carefully formed parameters, when the
\&.I mailbox
program is running inside shell-less chroot environment.
.SH "SUBPROGRAM ENVIRONMENT VARIABLES"
.PP
The
\&.I mailbox
sets following environment variables for the subprograms it runs
in the pipes:
.TP
\fBHOME\fR
The homedirectory path is taken from abovementioned \fBgetpwuid()\fR
lookup.
.TP
\fBUSER\fR
Likewise the textual username.
.TP
\fBSENDER\fR
is the incoming "MAIL FROM:<..>" address without brackets.
For an incoming error message, value "<>" is used.
.TP
\fBORCPT\fR
when present, is the XTEXT encoded ORCPT value received at
the message injection into this system.
See RFC 1891 for details.
.TP
\fBENVID\fR
when present, is the XTEXT encoded ENVID value received at
the message injection into this system.
See RFC 1891 for details.
.TP
\fBZCONFIG\fR
is the location of the ZMailer ZENV file.
.TP
\fBMSGSPOOLID\fR
Is the message spool-id in the ZMailer; subprograms may use this
info in co-operation with ZMailer to e.g. \fBsyslog\fR(3) what
they have done to the arrived message.
.TP
\fBMESSAGEID\fR
Is the RFC 822 "Message-ID:" header data as possibly copied into
the control file; another item to support \fBsyslog\fR(3) at programs.
.TP
\fBMAILBIN\fR
is the value from ZENV.
.TP
\fBMAILSHARE\fR
is the value from ZENV.
.TP
\fBPATH\fR
is the value from ZENV, or "/usr/bin:/bin:/usr/ucb" in case
no ZENV value is available.
.TP
\fBSHELL\fR
is constant value: "/bin/sh".
.TP
\fBIFS\fR
is constant value: "\\ \\\\t\\\\n".
.TP
\fBTZ\fR
is value from scheduler's environment variables via normal
environment inheritance rules.
Supposedly that of \fBsystemwide\fR time-zone setting.
Available to subprogram only if set when the \fBmailbox\fR was started.
.SH "FILES"
.PP
.TP 0.2i
\(bu
\fI/etc/zmailer.conf\fR
.TP 0.2i
\(bu
\fI/var/spool/postoffice/\fR (POSTOFFICE)
.TP 0.2i
\(bu
\fI/var/mail/\fR (MAILBOX)
.SH "SEE ALSO"
.PP
scheduler(8), comsat(8C), biff(1), flock(2), Mail(1), mboxpath(1)
.PP
RFC 821/2821 The basic SMTP specificationRFC 822/2822The basic email header structure specsRFC 1123Various 821 parameter clarificationsRFC 1341/1521/2045MIME specification (body, formats)RFC 1342/1522/2047MIME specification (headers)RFC 1428Basic MIME conversion rulesRFC 1891ESMTP DSNRFC 2298MDN specs, section 2.3
.SH "AUTHOR"
.PP
This program authored and copyright by:
\&.br
Rayan Zachariassen <rayan@cs.toronto.edu>
\&.br
Extensive modifications by:
\&.br
Matti Aarnio <mea@nic.funet.fi>
