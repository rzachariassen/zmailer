.\" $Header$
.ds ]W ZMailer 2.99
.TH SMTP 8 "13 Oct 2000"
.SH NAME
.B smtp
\- zmailer SMTP client transport agent
.SH SYNOPSIS
.B smtp
[
.B \-678deEHMrPsVxW
]
[
.B \-c
.I channel
]
[
.B \-h
.I heloname
]
[
.B \-l
.I logfile
]
[
.B \-p
.I remote-port
]
[
.B \-T
.I timeouts
]
[
.B \-S
.I /path/to/smtp-tls.conf
]
[
.B \-F
.I forcedest
]
[
.B \-L
.I localidentity
]
.I host
.SH DESCRIPTION
.I smtp
is a ZMailer transport agent which is usually only run by the
.IR scheduler (8)
to transfer messages to a remote Internet host using the SMTP
protocol. The
.I smtp
program must be run with the same
current directory as the
.IR scheduler ,
namely \fIPOSTOFFICE\fB/transport\fR.
.PP
The program scans the message control files named on stdin for addresses
destined for its channel and the host given on the command line.  If any
are found, all matching addresses and messages are transferred in a single
SMTP conversation.  The destination host might in fact be served by any
available mail exchanger for that host.
.SH OPTIONS
.IP \-6
Prefer IPv6 type socket and addresses, if available.
.IP \-7
forces SMTP channel to be 7-bit, and thus forcing all 8-bit texts to be
MIME-QP-encoded for the transport.
.IP \-77
This does same as
.I \-7
but also blocks of all ESMTP extensions from use.

This ``double-7'' option can be followed by ``\-8'' option to force the
channel to be 8-bit transparent, and even to decode MIME-QP TEXT/PLAIN,
but to do it without any ESMTP.
.IP \-8
forces SMTP channel to be 8-bit-clean, and as such, to decode the message
while transporting it (is it is MIME QP encoded).
.IP \-c\ \fIchannel\fR
specifies which channel name should be keyed on.  The default is
.BR smtp .
.IP \-d
turns on debugging output.
.IP \-e
asks that for every destination address specification with a matching channel
name, an MX lookup is done on the hostname to see whether the currently
connected host can provide service for that destination.  The default is
to just do a textual name comparison with the destination hostname as
given on the command line.
.IP \-E
use the "EHLO"-greeting
.B only
if the remote server initial banner reports "ESMTP" on it.
.IP \-h\ \fIhost\fR
specifies the hostname for the SMTP \fBHELO\fR greeting.  The default
is the hostname of the local system, as returned by
.IR gethostname (2)
or
.IR uname (2).
.IP \-F\ \fIforcedest\fR
overrides delivery destination by forceing
.B all
email to be sent to given
.I forcedest
hostname, or literal [IP-number].
.IP \-H
Disable the per default active forced 8-bit headers conversion into
.IR MIME-2 -format.
.IP \-L\ \fIlocalident\fR
specifies (for multi-homed machines) that they should use specified
identity when connecting to the destination.  Think of server with
multiple IP numbers due to virtual hosting, for example.  At such
systems there may be situation when virtual identity needs to be
used for reaching the destination system.

Understood formats for local identity are:
.sp
.nf
- "iface:eth0" -- (eth0 device in the system)
- "[ipv6.1111:2222:3333:...]" -- Literal IPv6 address for IPv6 system
- "[1.2.3.4]" -- Literal IPv4 address for non-IPv6 system
- "some.host.name" -- DNS/hosts data registered name
.fi
.sp
.IP \-l\ \fIlogfile\fR
specifies a log file where the complete SMTP command transaction will be
copied.  Each line in the log will be prefixed with the process id of
the transport agent process, so the same log file can be used by all SMTP
clients.
.IP \-M
specifies that system shall run in RFC 2033 specified
.I LMTP
mode when contacting remote systems.
Usage of this option requires also that destination port is defined,
and is not the SMTP default of 25.
.IP \-r
asks to set up SMTP connections using a source TCP port number under 1024.
This is in the range of port numbers only available to a privileged process
on some UNIX systems, which has led to some misguided attempts at mail security
based on this mechanism.
.IP \-s
asks to report the progress of the SMTP conversation and data transfer on
the command line in a way that will be visible to
.IR ps (1).
.IP \-x
turns off MX lookups on delivery connections.  This may be used ignore
public MX knowledge and do exactly what the router says in cases where
delivering to an explicit IP address is inappropriate.
.IP \-P
disable SMTP-PIPELINING usage (ESMTP keyword: PIPELINING)
.IP \-S\ \fI/path/to/smtp-tls.conf\fR
Transport-Layer-Security (a.k.a. Secure-Socket-Layer) feature configuration
file.  When this is supplied, and system is compiled to possibly use it,
and the remote system reports EHLO capability of
.BR STARTTLS ,
this client attempts to turn on the encryption on the socket.
There exists also a posssibility of
.I demanding
TLS mode of the connection - if so has been demand, but it is not available,
email is not sent over the connection.
.IP "-T \fItimeouts\fR"
.RS
specifies the timeouts when waiting for various things.
Possible submodes are:
.IP conn=\fI3m\fR
Timeout to wait for the TCP connection establishment.
The default is 3 minutes.
.IP tcpw=\fI3m\fR
Timeout to wait at lowlevel TCP socket write() routines
for the socket to accept some more input.
The default is 5 minutes.
.IP cmd=\fI5m\fR\ (or\ plain\ value)
Waiting for command replies (e.g. MAIL FROM, et.al.)
The default is 5 minutes.
.IP data=\fI2m\fR
From "DATA" verb issuance until "354" responce.
The default is 2 minutes.
.IP dot=\fI10m\fR
From "DATA" phase ending "." issuance until "250 OK" report
reception (this is \fBafter\fR the TCP write pipeline has completed).
The default is 20 minutes. (RFC 1123 gives 10 minutes.)
.RE
.IP \-V
prints a version message and exits.
.IP \-W
turns on the DNS WKS checking, and if the remote system does not
have SMTP in its WKS-bits, email delivery to such address is aborted
with an error message.
.SH INTERFACE
This program reads in processable file names relative to the current
working directory of the scheduler (namely: \fI$POSTIOFFICE/transport/\fR).
Optionally on the same line the scheduler may tell which host is to be
looked for from the recipients of the message.
.PP
.RS
\fIrelative-spool-path\fR [ <TAB> \fIhostname\fR ]
.RE
.PP
This program produces diagnostic output on the standard output.
Normal diagnostic output is of the form:
.PP
.RS
\fIid\fR/\fIoffset\fR<TAB>\fInotify-data\fR<TAB>\fIstatus\fR \fImessage\fR
.RE
.PP
where 
.I id
is the inode number of the message file,
.I offset
is a byte offset within its control file where the address being reported
on is kept,
.I status
is one of
.BR ok ,
.BR error ,
or
.BR deferred ,
and the
.I message
is descriptive text associated with the report.  The text is terminated by
a linefeed.  Any other format (as might be produced by subprocesses)
is passed to standard output for logging in the
.B scheduler
log.
.PP
The exit status is a code from
.BR <sysexits.h> .
.SH EXTENDED SMTP
When user sends out 8-bit mail with proper headers, this module can
send it out to conforming servers either in 8-bit transparent manner,
or down-converting
.I Content-Transfer-Encoding: 8BIT
to
.I Content-Transfer-Encoding: 7BIT
or
.I Content-Transfer-Encoding: QUOTED-PRINTABLE
depending on what is the mail contents.
.br
.B This works only with
.I Content-Type: text/plain
.B thus no fancy multipart/alternate et.al. schemes..
.br
When
.I Content-Transfer-Encoding:
\-header is not present in the headers, and recipient has not declared
8-bit SMTP capability, mail contents are treated with old 7-bit stripping
method.
.SH SECURE SOCKET LAYER SUPPORT
If you are using a version which has been made to use OpenSSL 0.9.4, or
latter version, you are able to encrypt the SMTP protocol session in case
the remote end supports RFC 2487 defined
.I STARTTLS
facility.
.PP
Possible example of the smtp\-tls.conf  file is given below:
.PP
.nf
\fC
#|
#| This is example configuration file for TLS support at the SMTP TA
#| programs, e.g. SMTP Client.
#|

tls-cert-file   @MAILVAR@/db/smtpserver-cert.pem
tls-key-file    @MAILVAR@/db/smtpserver-key.pem
tls-CAfile      @MAILVAR@/db/smtpserver-CAcert.pem
#tls-CApath /path/to/CAdir/
#tls-loglevel  0  # Value from 0 thru 4

#|
#| If the TLS mode is MANDATED for a session, copy this file to
#| e.g. "smtp-tls-mandatory.conf", uncomment following line, and
#| point those channels to use that new file.
#|
#demand-tls-mode
.fi
.SH FILES
.I /etc/zmailer.conf
.br
.I /var/spool/postoffice (POSTOFFICE)
.SH SEE ALSO
scheduler(8)
.SH SEE ALSO
router(8)
.PP
.TS
l l
l l
l l
l l
l s
l s
l s
l l.
RFC 821	The basic SMTP specification
RFC 822	Mail header format
RFC 974	MX routing
RFC 1123	Various 821 parameter clarifications

Several extended SMTP facilities are implemented:

RFC 1341/1521/2045	MIME specification (body, formats)
RFC 1342/1522/2047	MIME specification (headers)
RFC 1425/1651/1869	ESMTP EHLO framework
RFC 1426/1652	ESMTP 8BITMIME
RFC 1427/1653/1870	ESMTP SIZE
RFC 1428	Basic MIME conversion rules
RFC 1830/3030	ESMTP CHUNKING
RFC 1854/2197	ESMTP PIPELINING
RFC 1891	ESMTP DSN
RFC 1893/2034	ESMTP ENHANCEDSTATUSCODES
RFC 1985	ESMTP ETRN
RFC 2033	LMTP client mode
RFC 2487	ESMTP STARTTLS
RFC 2554+M$ Exchange	ESMTP AUTH LOGIN
RFC 2554+NetScape	ESMTP AUTH=LOGIN
RFC 2852	ESMTP DELIVERBY
.TE
.SH AUTHOR
This program authored and copyright by:
.br
Rayan Zachariassen <rayan@cs.toronto.edu>
.br
Heaps of extended SMTP facilities by:
.br
Matti Aarnio <mea@nic.funet.fi>
