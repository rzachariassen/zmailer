.\" $Header$
.ds ]W ZMailer 2.99
.TH SMTPSERVER 8 "20 Feb 1998"
.SH NAME
smtpserver \- zmailer SMTP server
.SH SYNOPSIS
.B smtpserver
[
.B \-46aignvBV
]
[
.B \-p
.I port
]
[
.B \-l
.I logfile
]
[
.BR \-s [\fBftveR\fR]
]
[
.B \-s strict
]
[
.B \-L
.I maxloadaver
]
[
.B \-M
.I SMTPmaxsize
]
[
.B \-P
.I postoffice
]
[
.B \-R
.I router
]
[
.B \-C
.I cfgfile
]
.SH DESCRIPTION
This program implements the server side of the SMTP protocol as described
in RFC821, and knows about the common extensions to the protocol expected by
Sendmail and BSMTP clients.
.PP
By default the program will kill the previous
.I smtpserver
daemon, if any, then detach and listen for SMTP connections.  Incoming
messages will be submitted for processing using the
.IR zmailer (3)
interface to ZMailer.  Nontrivial address checking is done
asynchronously, although this behaviour can be changed by a command line
option if you cannot afford to transfer data just to bounce it back.  All
checking is done by executing the
.IR router (8)
program in interactive mode, and executing a well-known shell function with
well-known parameters for each request.
.SH OPTIONS
.IP \-4
Explicitely to use IPv4 type of socket even on machines that is capable to
do IPv6 type of sockets.
.IP \-6
Explicitely to (try to) use IPv6 type of socket even if the machine does
not support it.
For a default the server will try to use IPv6, if it has been compiled on
an environment where it is present, but will do a fallback to IPv4 in case
the runtime system does not have IPv6.
.IP \-a
turn on RFC931/RFC1413 indentification protocol, and log the information
acquired with it to the submitted file.
.IP \-g
the gullible option will make the program believe any information it is
told (such as origin of a connection) without checking.
.IP \-i
runs the server interactively, which makes it usable for processing
a batched SMTP stream (BSMTP) on stdin.
With
.I \-v
option this echoes incoming BSMTP to create more accurate faximille
of BITNET BSMTP mailers.
.IP \-l\ \fIlogfile\fR
specifies a logfile and enables recording of incoming SMTP conversations.
.IP \-n
indicates the program is being run from
.IR inetd (8).
.IP \-p
specifies the TCP port to listen on instead of the default SMTP port, 25.
.IP \-B
flags the email to arrive via BSMTP channel (via BITNET, for example).
.IP \-L\ \fImaxloadaver\fR
tells the maximum load-average the system is under when we still accept
email in.
.IP \-M\ \fISMTPmaxsize\fR
Defines the asolute maximum size we accept from incoming email.
(Default: infinite) (This is local policy issue.)
.IP \-P\ \fIpostoffice\fR
specifies an alternate
.B POSTOFFICE
directory.
.IP \-R\ \fIrouter\fR
specifies an alternate
.I router (8)
program to use for address verification.
.IP \-C\ \fIcfgfile\fR
specifies nonstandard configuration file location; the default is
.IR $MAILSHARE/smtpserver.conf .
.IP \-s\ strict
this turns on all kinds of
.B strict
smtp protocol adherence checks, which in normal life can be relaxed
slightly.  Great for compliance testing ;)
.IP \-s\ [ftveRS]
specifies the style of address verification to be performed.  There are
four independent commands that can invoke some kind of address verification,
and four independent flags to control whether this should be done.  They are:
.ta 1i 1.5i
.sp
.nf
f	check MAIL FROM addresses
t	check RCPT TO addresses
v	check VRFY command argument
e	check EXPN command argument
R	require addresses to be of syntax:
		local@remote (strict 821)
S	allow sloppy input for systems incapable to
	respect RFC 821 properly; WinCE1.0 (and 2.0)
	does:
		"MAIL FROM:user@domain" :-(
.fi
.sp
The flags are concatenated to form the argument to the \-s option.  The
default is \fBve\fR.
.IP \-V
prints a version message and exits.
.SH EHLO AND 8BITMIME
On
.B RFC 1651/1652/1653+1428
there are extended SMTP specifications, which contain mechanism for declaring
8-bit transparent SMTP capability, as well as so called SIZE extension.
When sending SMTP does \fBEHLO\fR instead of \fBHELO\fR
it gets a set of responces which indicate that this system is capable on
multiple things, and one of them is so called \fB8BITMIME\fR.
.SH CONFIGURATION
If the \fIMAILSHARE/\fBsmtpserver.conf\fR exists it is read
to configure two kinds of things:

.IP PARAM\ \-entries
allow server start-time parametrization of several things, including:
.nf
.I \-\ help-texts
.I \-\ acceptance/rejection\ database\ definitions
.fi
.IP The\ style\ (\fI\-s\fR)\ option
behaviour based on glob patterns matching the
.BR HELO / EHLO
name given by a remote client.  Lines beginning with a
.I #
or whitespace are ignored in the file, and all other lines must consist
of two tokens: a shell-style (glob) pattern starting at the beginning of
the line, whitespace, and a sequence of style flags.  The first matching
line is used.  As a special case, the flags section may start with a
.I !
character in which case the remainder of the line is a failure comment
message to print at the client.  This configuration capability is intended
as a way to control misbehaving client software or mailers.

.IP PARAM\ maxsize
This is synonym to start-time
.I \-M
option.

.IP PARAM\ max-error-recipients
This defines how many recipients can be on a message whose source
address is
.B MAIL FROM:<>\fR.
That is, is an error message.  (Sometimes SPAMs are tried to inject
in that form...)

.IP PARAM\ MaxSameIpSource
This sets the maximum number of active connections from any given
single IP address.

When the limit is reached, system tells the remote end:
.B ``450 Too many simultaneous connections...''
(and then closes the connection.)

When the limit is exceeded by factor of four, the server just closes
the connection without telling anything.

.B Do note that this works only when the smtpserver is running as its
.B own daemon, not while run from under inetd!

.IP PARAM\ MaxParallelConnections
This limits how many simultaneous connections the server will accept
in total -- e.g. how many childs a master server can have running.
Default value: 800.

Exceeding the limit by less than 100 will get a message
.B ``450 Too many simultaneous connections...''
printed to the connection.
In every case the connection is closed right after the possible message.

.B Do note that this works only when the smtpserver is running as its
.B own daemon, not while run from under inetd!

.IP PARAM\ ListenQueueSize
This sets the listen queue size parameter for
.IR listen (2)
call at the server.

.IP PARAM\ TcpRcvBufferSize
This sets  setsockopt(SO_RCVBUF)  value, in case the system
default is not suitable.

.IP PARAM\ TcpXmitBufferSize
This sets  setsockopt(SO_SNDBUF)  value, in case the system
default is not suitable.

.IP PARAM\ DEBUGcmd
.IP PARAM\ EXPNcmd
.IP PARAM\ VRFYcmd
This trio (DEBUGcmd, EXPNcmd, VRFYcmd) are enablers of like named
SMTP verbs which have some uses in the debug mode.

They are normally disabled, but running them enabled does not allow
direct attacks with them.  (That we know of.)

.IP PARAM\ No8BITMIME
.IP PARAM\ NoCHUNKING
.IP PARAM\ NoDSN
.IP PARAM\ NoEHLO
.IP PARAM\ NoENCHANCEDSTATUS(CODES)
.IP PARAM\ NoETRN
.IP PARAM\ NoPIPELINING
This set are
.B disablers
of like named Extended SMTP EHLO responses, plus EHLO verb itself,
e.g. using these will turn off given (for example ``PIPELINING'')
response from the EHLO replies, and then a client possibly capable
to feed PIPELINING will not do it -- unless it breaks rules, and
does it even when the server does not report facility being available.

If you want to disable any of these, you better have a good reason
for it, as in general they work quite fine.

Of these, 8BITMIME can not in reality be disabled, only its adverticement
can be turned off.

.IP PARAM\ policydb
This defines smtp input policy filtering/analysis database location.
See the comments at the sample
.I proto/db/smtp-policy.src
file.

.IP Here\ is\ a\ possible\ configuration\ file:
.sp
.ta 0.0i 0.5i
.nf
\fC
#
# smtpserver.conf - autogenerated edition
#
#PARAM maxsize        10000000 # Same as -M -option
#PARAM max-error-recipients  3 # More than this is propably SPAM!
#PARAM MaxSameIpSource      10 # Max simultaneous connections
#                              # from any IP source address
#PARAM MaxParallelConnections 800 # Max simultaneous connections
#                              # in total to the server
#PARAM TcpRcvBufferSize  32000 # Should not need to set!
#PARAM TcpXmitBufferSize 32000 # Should not need to set!
#
#PARAM ListenQueueSize      10 # listen(2) parameter
#
#PARAM RcptLimitCount    10000 # Max number of recipients for one
#                              # MAIL FROM session. Minimum: 100
#
# Enables of some commands:
#PARAM  DEBUGcmd
PARAM   EXPNcmd
PARAM   VRFYcmd
#
# Disablers of some facility adverticements
#PARAM  NoEHLO
#PARAM	NoPIPELINING
#PARAM	No8BITMIME
#PARAM	NoCHUNKING
#PARAM  NoDSN
#PARAM  NoETRN
#
# HDR220 metatags:
#  %% -- '%' character
#  %H -- SS->myhostname
#  %I -- '+IDENT' if 'identflg' is set
#  %V -- VersionNumb
#  %T -- curtime string
#  %X -- xlatelang parameter
#
#PARAM hdr220 %H ZMailer ESMTP-server %V running at Yoyodyne Inc.
#PARAM hdr220 %H (NO UCE)(NO UBE) our local time is now %T
#
PARAM help ------------------------------------------------------
PARAM help  This mail-server is at Yoyodyne Propulsion Inc.
PARAM help  Our telephone number is: +1-234-567-8900, and
PARAM help  telefax number is: +1-234-567-8999
PARAM help  Our business-hours are Mon-Fri: 0800-1700 (TZ: -0700)
PARAM help
PARAM help  Questions regarding our email service should be sent
PARAM help  via email to address  <postmaster@OURDOMAIN>
PARAM help  Reports about abuse are to be sent to: <abuse@OURDOMAIN>
PARAM help ------------------------------------------------------
#
# Uncomment following for not to strip incoming addresses of
# form: <@aa,@bb:cc@dd> into non-source-routed base form: <cc@dd>
#
#PARAM  allowsourceroute
#
PARAM   accept-percent-kludge # "localpart" can contain '%' and '!'
#PARAM  reject-percent-kludge # "localpart" can't contain  --"--
#
# The policy database: (NOTE: See `makedb' for its default suffixes!)
#
PARAM  policydb   @DBTYPE@  @MAILVAR@/db/smtp-policy

#
#
# HELO/EHLO-pattern     style-flags
#               [max loadavg]
#
localhost           999 ftveR
some.host.domain    999 !NO EMAIL ACCEPTED FROM YOUR MACHINE
# If the host presents itself as:  HELO [1.2.3.4]  be lenient to
# it..  The syntax below is due to these patterns being SH-GLOB
# style patterns where the brackets are special characters.
\\[*\\]             999 ve
# Per default demant strict syntactic adherence, including fully
# qualified addresses for  MAIL FROM, and RCPT TO.  To be lenient
# on that detail, remove the "R" from "veR" string below:
*                   999 veR
.fi
.sp
.SH TCP-WRAPPER AND SMTPSERVER
If the ZMailer system is configured with tcp-wrapper code, then service-id
"smtp-receive" is looked for all those addresses that are allowed to feed
smtp email in.
.P
Usually this mode of operation is not used, and "hosts.allow"
file contains entry:
.P
.nf
  smtp-receive : ALL@ALL
.fi
.P
Alternatively, all the functions which tcp-wrapper could supply are
also available thru the policy database machinery.
.SH FILES
.I /etc/zmailer.conf
.br
.I /var/spool/postoffice/.pid.smtpserver (POSTOFFICE/.pid.smtpserver)
.br
.I /local/share/mail/smtpserver.conf (MAILSHARE/smtpserver.conf)
.SH SEE ALSO
router(8)
.br
RFC821, RFC1123, RFC1651, RFC1652, RFC1653, RFC1428
.SH AUTHOR
This program authored and copyright by:
.br
Rayan Zachariassen (was at U of Toronto)
.br
RFC165* (and several other) extensions by
.br
Matti Aarnio  <mea@nic.funet.fi>
