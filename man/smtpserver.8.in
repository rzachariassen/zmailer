.\" $Header$
.ds ]W ZMailer 2.99
.TH SMTPSERVER 8 "2 Mar 2000"
.SH NAME
smtpserver \- zmailer SMTP server
.SH SYNOPSIS
.B smtpserver
[
.B \-46aignBVvw
]
[
.B \-p
.I port
]
[
.B \-l
.I SYSLOG
]
[
.B \-l
.I logfile
]
[
.BR \-s [\fBftveR\fR]
]
[
.B \-s strict
]
[
.B \-I
.I pidfile
]
[
.B \-L
.I maxloadaver
]
[
.B \-M
.I SMTPmaxsize
]
[
.B \-P
.I postoffice
]
[
.B \-R
.I router
]
[
.B \-C
.I cfgfile
]
.SH DESCRIPTION
This program implements the server side of the SMTP protocol as described
in RFC821, and knows about the common extensions to the protocol expected by
Sendmail and BSMTP clients.
.PP
By default the program will kill the previous
.I smtpserver
daemon, if any, then detach and listen for SMTP connections.  Incoming
messages will be submitted for processing using the
.IR zmailer (3)
interface to ZMailer.  Nontrivial address checking is done
asynchronously, although this behaviour can be changed by a command line
option if you cannot afford to transfer data just to bounce it back.  All
checking is done by executing the
.IR router (8)
program in interactive mode, and executing a well-known shell function with
well-known parameters for each request.
.SH OPTIONS
.IP \-4
Explicitely to use IPv4 type of socket even on machines that is capable to
do IPv6 type of sockets.
.IP \-6
Explicitely to (try to) use IPv6 type of socket even if the machine does
not support it.
For a default the server will try to use IPv6, if it has been compiled on
an environment where it is present, but will do a fallback to IPv4 in case
the runtime system does not have IPv6.
.IP \-a
turn on RFC931/RFC1413 indentification protocol, and log the information
acquired with it to the submitted file.
.IP \-w
turn on usage of "whoson" protocol.  This option is available even if
actual code is not available.
.IP \-g
the gullible option will make the program believe any information it is
told (such as origin of a connection) without checking.
.IP \-i
runs the server interactively, which makes it usable for processing
a batched SMTP stream (BSMTP) on stdin.
With
.I \-v
option this echoes incoming BSMTP to create more accurate faximille
of BITNET BSMTP mailers.
.IP \-l\ \fISYSLOG\fR
A magic value of "SYSLOG" for the
.I logfile
is interpreted by directing all session log stuff thru syslogd;
something which
.B may
require better syslogd, than your system
has by default; see ``syslog-ng'' at a well indexed free software
sites.
.IP \-l\ \fIlogfile\fR
specifies a logfile and enables recording of incoming SMTP conversations.
If you want both file based session log, and syslog() based, issue this
option after ``\-l\ SYSLOG'' one.
.IP \-n
indicates the program is being run from
.IR inetd (8).
.IP \-p
specifies the TCP port to listen on instead of the default SMTP port, 25.
.IP \-B
flags the email to arrive via BSMTP channel (via BITNET, for example).
.IP \-I\ \fIpidfile\fR
specifies an alternate PID file location.
.IP \-L\ \fImaxloadaver\fR
tells the maximum load-average the system is under when we still accept
email in.
.IP \-M\ \fISMTPmaxsize\fR
Defines the asolute maximum size we accept from incoming email.
(Default: infinite) (This is local policy issue.)
.IP \-P\ \fIpostoffice\fR
specifies an alternate
.B POSTOFFICE
directory.
.IP \-R\ \fIrouter\fR
specifies an alternate
.I router (8)
program to use for address verification.
.IP \-C\ \fIcfgfile\fR
specifies nonstandard configuration file location; the default is
.IR $MAILSHARE/smtpserver.conf .
.IP \-s\ strict
this turns on all kinds of
.B strict
smtp protocol adherence checks, which in normal life can be relaxed
slightly.  Great for compliance testing ;)
.IP \-s\ [ftveRS]
specifies the style of address verification to be performed.  There are
four independent commands that can invoke some kind of address verification,
and four independent flags to control whether this should be done.  They are:
.ta 1i 1.5i
.sp
.nf
f	check MAIL FROM addresses
t	check RCPT TO addresses
v	check VRFY command argument
e	check EXPN command argument
R	require addresses to be of syntax:
		local@remote (strict 821)
S	allow sloppy input for systems incapable to
	respect RFC 821 properly; WinCE1.0 (and 2.0)
	does:
		"MAIL FROM:user@domain" :-(
.fi
.sp
The flags are concatenated to form the argument to the \-s option.  The
default is \fBve\fR.
.IP \-V
prints a version message and exits.
.SH CONFIGURATION
If the \fIMAILSHARE/\fBsmtpserver.conf\fR exists it is read
to configure two kinds of things:

.IP PARAM\ \-entries
allow server start-time parametrization of several things, including:
.nf
.I \-\ help-texts
.I \-\ acceptance/rejection\ database\ definitions
.fi
.IP The\ style\ (\fI\-s\fR)\ option
behaviour based on glob patterns matching the
.BR HELO / EHLO
name given by a remote client.  Lines beginning with a
.I #
or whitespace are ignored in the file, and all other lines must consist
of two tokens: a shell-style (glob) pattern starting at the beginning of
the line, whitespace, and a sequence of style flags.  The first matching
line is used.  As a special case, the flags section may start with a
.I !
character in which case the remainder of the line is a failure comment
message to print at the client.  This configuration capability is intended
as a way to control misbehaving client software or mailers.

.IP PARAM\ maxsize
This is synonym to start-time
.I \-M
option.

.IP PARAM\ min\-availspace\ 5000
This defines, in
.BR kilobytes ,
the minimum available space in
.B POSTOFFICE
directory after the message has been accepted in.

.IP PARAM\ max\-error\-recipients
This defines how many recipients can be on a message whose source
address is
.B MAIL FROM:<>\fR.
That is, is an error message.  (Sometimes SPAMs are tried to inject
in that form...)

.IP PARAM\ MaxSameIpSource
This sets the maximum number of active connections from any given
single IP address.

When the limit is reached, system tells the remote end:
.B ``450 Too many simultaneous connections...''
(and then closes the connection.)

When the limit is exceeded by factor of four, the server just closes
the connection without telling anything.

.B Do note that this works only when the smtpserver is running as its
.B own daemon, not while run from under inetd!

.IP PARAM\ MaxParallelConnections
This limits how many simultaneous connections the server will accept
in total -- e.g. how many childs a master server can have running.
Default value: 800.

Exceeding the limit by less than 100 will get a message
.B ``450 Too many simultaneous connections...''
printed to the connection.
In every case the connection is closed right after the possible message.

.B Do note that this works only when the smtpserver is running as its
.B own daemon, not while run from under inetd!

.IP PARAM\ ListenQueueSize
This sets the listen queue size parameter for
.IR listen (2)
call at the server.

.IP PARAM\ TcpRcvBufferSize
This sets  setsockopt(SO_RCVBUF)  value, in case the system
default is not suitable.

.IP PARAM\ TcpXmitBufferSize
This sets  setsockopt(SO_SNDBUF)  value, in case the system
default is not suitable.

.IP PARAM\ RcptLimitCount\ 10000
This sets the maximum number of accepted recipients per one
message transaction.  Default (and minimum!) value is 100,
which is mandated by the RFC 821.

.IP PARAM\ BindPort\ \ \ 25
.IP PARAM\ BindAddress\ [0.0.0.0]
.IP PARAM\ BindAddress\ [IPv6.0::0]
Per default the server mode SMTP-server binds to port 25 and any
locally accepted address, but occasionally people seem to want to
have separate server instances with different configurations, and
for those cases are these parameters.

.IP PARAM\ DEBUGcmd
.IP PARAM\ EXPNcmd
.IP PARAM\ VRFYcmd
This trio (DEBUGcmd, EXPNcmd, VRFYcmd) are enablers of like named 
SMTP verbs which have some uses in the debug mode.

They are normally disabled, but running them enabled does not allow
direct attacks with them.  (That we know of.)

.IP PARAM\ enable\-router
This enables interactive router use where user inputs reach the router.
As things turn out, while the canned scripts should be safe against any
and all inputs, a careless change in the router scripts may endanger
this status.

Per default this is
.B disabled
to protect your system.

To enable EXPN and VRFY, this must be enabled, but be
.B very carefull
when you do this.
This is also required for interactive router processing
of ``MAIL FROM'' and ``RCPT TO'' addresses.

.IP PARAM\ smtp\-auth
This enables 'SMTP AUTH' facility (AUTH verb, plus optional parameter
to MAIL verb).  With this the users who are able to 'login' successfully
to this host, are then able to relay the email thru the server unlimited.

.IP PARAM\ AUTH\-LOGIN\-also\-without\-TLS
This enables 'SMTP AUTH' facility usage also without running
under SSL/TLS security envelope.

.IP PARAM\ MSA\-mode
Enable Message Submission Agent mode, where smtpserver
.B requires
successful user authentication during SMTP sessions initiated from
outside of the trusted networks or the networks with relaying enabled
(see "fulltrustnet" and "relaycustnet" at the sample
.I proto/db/smtp-policy.src
file).

.IP PARAM\ SMTP\-auth\-pipe\ /path/to/program
This is a path to the external authentication program. The authenticator
should read a username from command line and a password from standard
input. Exit status 0 means successful authentication.

.B It is relatively easy to make a mistake in external authentication
.B program that follows the specification. Use this option only if
.B you know exactly what you do! BE CAREFULL!

.IP PARAM\ No8BITMIME
.IP PARAM\ NoCHUNKING
.IP PARAM\ NoDSN
.IP PARAM\ NoEHLO
.IP PARAM\ NoENCHANCEDSTATUS(CODES)
.IP PARAM\ NoETRN
.IP PARAM\ NoPIPELINING
This set are
.B disablers
of like named Extended SMTP EHLO responses, plus EHLO verb itself,
e.g. using these will turn off given (for example ``PIPELINING'')
response from the EHLO replies, and then a client possibly capable
to feed PIPELINING will not do it -- unless it breaks rules, and
does it even when the server does not report facility being available.

If you want to disable any of these, you better have a good reason
for it, as in general they work quite fine.

Of these, 8BITMIME can not in reality be disabled, only its adverticement
can be turned off.

.IP PARAM\ no\-multiline\-replies
Turn off ZMailer's default multiline replies; many systems (especially
from M$ breed) don't do RFC 821 Appendix E properly...

.IP PARAM\ policydb
This defines smtp input policy filtering/analysis database location.
See the comments at the sample
.I proto/db/smtp-policy.src
file.

.IP PARAM\ tarpit\ n1\ n2
This defines a pre-reply slow-down factor, and next delay multiplier
(both are integers).
Default values are (0, 0).  Delay tops at 250 (seconds).
The ``n1'' is used as the initial tarpit delay, and ``n2'' is
multiplier for formula:
.I next = prev + (prev * n2)

.IP PARAM\ rcvd\-ident
.IP PARAM\ rcvd\-whoson
.IP PARAM\ rcvd\-auth\-user
.IP PARAM\ rcvd\-tls\-mode
.IP PARAM\ rcvd\-tls\-peer
This quintet controls what possibly collected data is shown at
the published ``Received:'' header that this system generates.

.IP PARAM\ etrn\-cluster\ node\-name\-or\-address\ mq2\-username\ mq2\-passwd
In load-balance clusters a network level load-balancer may distribute
the incoming SMTP connections to multiple real machines, and by using
this parameter (repeatedly) to list those peers, system can relay
user initiated ETRN requests to all cluster nodes.

.I This method requires that the scheduler runs its mailq service
.I in MAILQv2 mode!

.IP Here\ is\ a\ possible\ configuration\ file:
.sp
.ta 0.0i 0.5i
.nf
\fC
#
# smtpserver.conf - autogenerated edition
#
#PARAM maxsize        10000000 # Same as -M -option
#PARAM min-availspace     5000 # Minimum free in POSTOFFICE after
#                              # message has arrived; in kBs.
#PARAM max-error-recipients  3 # More than this is propably SPAM!
#PARAM max-unknown-commands 10 # More than this is propably broken
#                              # client
#PARAM MaxSameIpSource      10 # Max simultaneous connections
#                              # from any IP source address
#PARAM MaxParallelConnections 800 # Max simultaneous connections
#                              # in total to the server
#PARAM TcpRcvBufferSize  32000 # Should not need to set!
#PARAM TcpXmitBufferSize 32000 # Should not need to set!
#
#PARAM ListenQueueSize      10 # listen(2) parameter
#
#PARAM RcptLimitCount    10000 # Max number of recipients for one
#                              # MAIL FROM session. Minimum: 100
#
#PARAM BindPort          25    # Binding port
#PARAM BindAddress  [0.0.0.0]  # Binding address - for multihomers..
#PARAM BindAddress [IPv6.0::0] # and here is for IPv6 - NO SPACES!
#
# Enables of some commands:
#PARAM  DEBUGcmd
PARAM   EXPNcmd
PARAM   VRFYcmd
PARAM  enable-router
#               # This is a security decission for you.
#               # This is needed for EXPN/VRFY and interactive
#               # processing of MAIL FROM and RCPT TO addresses.
#               # However it also may allow external user entrance
#               # to ZMailer router shell environment with some
#               # suitably pervert input, if quotation rules are
#               # broken in the scripts.
#
#PARAM  smtp-auth
#               # enable if you want to allow SMTP to autenticate
#               # with the default code against system /etc/passwd
#               # (or whatever source  getpwnam() uses for it..)
#
#PARAM  AUTH-LOGIN-also-without-TLS
#               # Enable, if the "AUTH LOGIN" is to be allowed to
#               # be used without running under SSL/TLS security
#               # envelope.
#
#PARAM  MSA-mode
#               # Message Submission Agent mode. Require
#               # successful user authentication during SMTP
#               # sessions initiated from outside of the trusted
#               # networks or the networks with relaying enabled
#               # (see "fulltrustnet" and "relaycustnet" in
#               # smtp-policy.src file).
#
#PARAM  SMTP-auth-pipe /path/to/program
#               # External authentication program. The
#               # authenticator should read a username from
#               # command line and a password from standard input.
#               # Exit status 0 means successful authentication.
#
# Disablers of some facility adverticements
#PARAM  NoEHLO
#PARAM  NoPIPELINING
#PARAM  No8BITMIME
#PARAM  NoCHUNKING
#PARAM  NoDSN
#PARAM  NoETRN
#PARAM  no-multiline-replies # except to EHLO
#
# HDR220 metatags:
#  %% -- '%' character
#  %H -- SS->myhostname
#  %I -- '+IDENT' if 'identflg' is set
#  %V -- VersionNumb
#  %T -- curtime string
#  %X -- xlatelang parameter
#
#PARAM hdr220 %H ZMailer ESMTP-server %V running at Yoyodyne Inc.
#PARAM hdr220 %H (NO UCE)(NO UBE) our local time is now %T
#
PARAM help ------------------------------------------------------
PARAM help  This mail-server is at Yoyodyne Propulsion Inc.
PARAM help  Our telephone number is: +1-234-567-8900, and
PARAM help  telefax number is: +1-234-567-8999
PARAM help  Our business-hours are Mon-Fri: 0800-1700 (TZ: -0700)
PARAM help
PARAM help  Questions regarding our email service should be sent
PARAM help  via email to address  <postmaster@OURDOMAIN>
PARAM help  Reports about abuse are to be sent to: <abuse@OURDOMAIN>
PARAM help ------------------------------------------------------
#
# Uncomment following for not to strip incoming addresses of
# form: <@aa,@bb:cc@dd> into non-source-routed base form: <cc@dd>
#
#PARAM allowsourceroute
#
# The policy database:
# (NOTE: See `makedb' for its default suffixes!)
#
PARAM  policydb   @DBTYPE@  @MAILVAR@/db/smtp-policy

#PARAM  tarpit 0 0   # No "tarpit" for 4XX/5XX reply codes
#PARAM  tarpit 20 2  # Initial delay: 20 secs, next = prev + (prev * 2)

#
# TLSv1/SSLv[23] parameters;
# all must be used for the system to work!
#
# See   doc/guides/openssl,  or:
# http://www.aet.tu-cottbus.de/personen/jaenicke/pfixtls/doc/setup.html
#
#PARAM  use-tls
#PARAM  tls-CAfile      /opt/mail/db/smtpserver-CAcert.pem
#PARAM  tls-cert-file   /opt/mail/db/smtpserver-cert.pem
#PARAM  tls-key-file    /opt/mail/db/smtpserver-key.pem
#  # Then some futher thoughs that may materialize some time..
#PARAM tls-loglevel     0
#PARAM tls-ccert-vd     0
#PARAM tls-ask-cert     0
#PARAM tls-require-cert 0
##PARAM tls-CApath ... (somewhen: verify client's certificates)
##PARAM tls-enforce-tls 1

# Elements to be added into "Received:" header's
# initial comment part:
#
#PARAM rcvd-ident       # The ident lookup result
#                       # (or even admitting it having queried)
#PARAM rcvd-whoson      # Likewise for "whoson"
#PARAM rcvd-auth-user   # Authenticated Username
#PARAM rcvd-tls-mode    # Cipher or not
#PARAM rcvd-tls-ccert   # Client Certificate reference

# A load-balanced server cluster may want to communicate
# the ETRN request to cluster components, here is how:
# See also:  doc/guides/etrn-cluster
#
#PARAM etrn-cluster localhost mq2-username mq2-passwd
#PARAM etrn-cluster node-2-name-or-address mq2-username mq2-passwd
#PARAM etrn-cluster node-3-name-or-address mq2-username mq2-passwd
#...
#PARAM etrn-cluster node-40-name-or-address mq2-username mq2-passwd

#
#
# HELO/EHLO-pattern     style-flags
#               [max loadavg]
#
localhost           999 ftveR
some.host.domain    999 !NO EMAIL ACCEPTED FROM YOUR MACHINE
# If the host presents itself as:  HELO [1.2.3.4]  be lenient to
# it..  The syntax below is due to these patterns being SH-GLOB
# style patterns where the brackets are special characters.
\\[*\\]             999 ve
# Per default demant strict syntactic adherence, including fully
# qualified addresses for  MAIL FROM, and RCPT TO.  To be lenient
# on that detail, remove the "R" from "veR" string below:
*                   999 veR
.fi
.sp
.SH PAM-SUPPORT FOR SMTP-AUTH
If the system has <security/pam_appl.h> file, following file will also
be needed for the system:
.PP
.nf
\fC
------- /etc/pam.d/smtpauth-login -----------
#%PAM-1.0
auth     required  /lib/security/pam_pwdb.so shadow
auth     required  /lib/security/pam_nologin.so
account  required  /lib/security/pam_pwdb.so
.fi
.SH FILES
.I /etc/zmailer.conf
.br
.I /var/spool/postoffice/.pid.smtpserver (POSTOFFICE/.pid.smtpserver)
.br
.I /local/share/mail/smtpserver.conf (MAILSHARE/smtpserver.conf)
.SH SEE ALSO
router(8)
.PP
.ta 2.5i
.nf
RFC 821	 The basic SMTP specification
RFC 1123	 Various 821 parameter clarifications

Several extended SMTP facilities are implemented:

RFC 1341/1521/2045	 MIME specification (body, formats)
RFC 1342/1522/2047	 MIME specification (headers)
RFC 1425/1651/1869	 ESMTP EHLO framework
RFC 1426/1652	 ESMTP 8BITMIME
RFC 1427/1653/1870	 ESMTP SIZE
RFC 1428	 Basic MIME conversion rules
RFC 1830	 ESMTP CHUNKING
RFC 1854/2197	 ESMTP PIPELINING
RFC 1891	 ESMTP DSN
RFC 1985	 ESMTP ETRN
RFC 2034	 ESMTP ENHANCEDSTATUSCODES
RFC 2487	 ESMTP STARTTLS
RFC 2554+M$ Exchange	 ESMTP AUTH LOGIN
RFC 2554+NetScape	 ESMTP AUTH=LOGIN
.fi
.SH AUTHOR
This program authored and copyright by:
.br
Rayan Zachariassen (was at U of Toronto)
.br
Extended SMTP, policy facilities, etc. by
.br
Matti Aarnio  <mea@nic.funet.fi>
