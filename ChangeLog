2004-10-23  Matti Aarnio  <mea@zmailer.org>

	* router/prototypes.h, router/rfc822.c, router/rtsyslog.c:
	    Track and report process RUSAGE (user and system CPU times)
	    if support for that is available.  Can be used to understand
	    system load developments.

	* transports/libta/mimeheaders.c:
	    Sometimes malformed messages undergoing format conversion
	    did cause smtp to drop core.  Turned out to be a mistaken
	    inclusion of the ASCII NUL into scan comparison range of
	    a string scanning.

	* smtpserver/subdaemon-rtr.c, smtpserver/subdaemon-ctf.c:
	    Made slight text changes to help on scanning the log
	    for appearance of internal "<subsys> DELAY %d SECONDS"
	    notes.

	* utils/policy-builder.sh.in:
	    Added a small sed-spell to remove input text line ends
	    since first '#' character in a line.  This allows now
	    adding comments on input line after initial data with
	    that '#' character:
	        example.com   # Added on 2004-Oct-23

2004-10-20  Matti Aarnio  <mea@zmailer.org>

	* transports/errormail/errormail.c, transports/expirer/expirer.c,
	  transports/hold/hold.c, transports/mailbox/mailbox.c,
	  transports/reroute/reroute.c, transports/sm/sm.c,
	  transports/smtp/smtp.c, utils/vacation/vacation.c:
	    Assign 'progname' ALWAYS before  readzenv() call !

2004-10-19  Matti Aarnio  <mea@zmailer.org>

	* smtpserver/policytest.c:
	    Report loudly (into log), when DNS lookups take more
	    than 30 seconds.

	* smtpserver/subdaemons.c:
	    There must be at least a dummy pointer init for rate-tracker, too.

	* include/shmmib.h, scheduler/mailq.inc:
	    Added couple subserver task queue tracker variables,
	    and their printouts.  These are debug stuff, but still..

	* smtpserver/smtpserver.c:
	    Note pipeline input along with lack of EHLO greeting!

	* smtpserver/smtpcmds.c:
	    Demand user to authenticate for SUBMISSION/MSA mode
	    MAIL/RCPT commands.

	* smtpserver/smtpserver.h, smtpserver/subdaemon-ctf.c,
	  smtpserver/subdaemon-rtr.c, smtpserver/subdaemons.c:
	    - Subdaemon ran sub-servers have idle-apoptosis
	    - Arrived jobs are queued in strict order of arrival,
	      and they can become revoked from the queue if the
	      client has disconnected before the job goes into
	      processing.

2004-10-07  Matti Aarnio  <mea@zmailer.org>

	* smtpserver/subdaemon-ctf.c:
	    Match interactive content-filter call interface with
	    documented behaviour (and what the router does).

	* smtpserver/subdaemons.c, smtpserver/subdaemon-rtr.c:
	    Reworked (more carefully) of how the round-robin job
	    queueing should work.  Now there is perhaps a bit of
	    fairness in job processing.

	* man/smtpserver.8.in:
	    Document (in man-page) about the 'msgratelimit nn,mm'
	    syntax parameter.

	* smtpserver/subdaemons.c, smtpserver/smtpserver.h:
	    When having received a job from a peer, mark it in
	    a separate flag, and use that flag then to talk with
	    the processing subprograms.  Also switched back to
	    "serve first the lowest number peer fd" system.

2004-09-27  Matti Aarnio  <mea@zmailer.org>

	* smtpserver/policytest.c, smtpserver/smtpserver.h,
	  smtpserver/subdaemon-trk.c:
	    A bit more of rate-limitter updates to complete things.
	    Rate-counters now return two values instead of one, recognize
	    that in policytest.  Moved  call_rate_counter() code into
	    subdaemon-trk.c, where it is a bit more "local" stuff.

2004-09-23  Matti Aarnio  <mea@zmailer.org>

	* smtpserver/policytest.c:
	    Use rate-limiter ONLY to make REJECTs, don't use "not limited"
	    to mean: "acceptable!"

2004-09-21  Matti Aarnio  <mea@zmailer.org>

	* smtpserver/mxverify.c, man/smtpserver.8.in:
	    Remove the old hard-coded '+' macro that is no longer valid..
	    Also warn about RBLs being rather ephemeral in nature..

	* smtpserver/policytest.c, smtpserver/subdaemon-trk.c:
	    Some initial experiments on adding RCPT counting in
	    rate-tracking.

	* smtpserver/subdaemon-rtr.c:
	    Report (into log) if the i-router subsystem response
	    time exceeds 30 seconds.

	* smtpserver/subdaemons.c:
	    Change a bit of the round-robinny processing details.
	    It may (or may not) improve sometimes observed long
	    delays..

2004-09-10  Matti Aarnio  <mea@zmailer.org>

	* smtpserver/subdaemons.c:
	    Changed the client input pickup methodology back into
	    "prefer lowest slot" (instead of round-robin).
	    It just didn't work :-(  (probably broken logic
	    somewhere in there..)

	* smtpserver/smtpchild.c:
	    Account childs by type, not all together..  (oops..)

2004-09-09  Matti Aarnio  <mea@zmailer.org>

	* smtpserver/subdaemon-rtr.c:
	    Changed subprocess instance abstraction details
	    so, that there are no absolutely fixed array sizes.

	* smtpserver/subdaemons.c:
	    Changed processed client input pickup methodology into
	    "process in round-robin manner" (as opposed to "lowest
	    slot first -- which can be seriously pessimal approach.

2004-09-07  Matti Aarnio  <mea@zmailer.org>

	* smtpserver/mxverify.c:
	    Source DNS verification went into woods a bit...
	    If the intention is to accept the MAIL FROM, if
	    it has just any DNS data, do so.

2004-09-06  Matti Aarnio  <mea@zmailer.org>

	* include/mailer.h, include/libz.h, lib/rfc822scan.c,
	  router/functions.c, router/prototypes.h, router/rfc822.c,
	  router/rfc822hdrs.c, router/shliaise.c:
	    Removed all vestiges of detecting '#' at the lead of
	    the address lines, and considering it as an indication
	    of a comment.  Doing that comment-skipping in callers,
	    where appropriate at all.

	* scheduler/mq2.c, scheduler/mailq.inc:
	    Added (into the scheduler's "MAILQ -QQQQ" processing)
	    a way to call external arbitrary command, whose output
	    is collected into the command output.  This allows
	    "easy" addition of custom system monitoring data
	    into the output.  Something will get added into "contrib".

2004-09-05  Matti Aarnio  <mea@zmailer.org>

	* smtpserver/policytest.c:
	    Realized that under some conditions it is possible to
	    spin in place of the automagic "this rcpt domain is
	    my local".

2004-09-03  Matti Aarnio  <mea@zmailer.org>

	* smtpserver/subdaemons.c, smtpserver/smtpserver.h,
	  smtpserver/subdaemon-ctf.c, smtpserver/subdaemon-rtr.c:
	    Always watch for subdaemon client connection readability,
	    and do read it.  If it yields EOF, kill the peer..

	* router/router.c, router/router.h, router/rfc822.c:
	    Slight alteration in router's unremovable console
	    logging..  now it can be removed with '-l' option.

	* smtpserver/subdaemon-rtr.c, smtpserver/subdaemon-ctf.c:
	    SIGTERM reaction corrections in "clients" when talking
	    (or trying to) with the subdaemon.

	* smtpserver/smtpserver.c:
	    Make the SMTP speaker loop to obey SIGTERM, and to
	    drop everything it was doing... (gracefull death of
	    server instance.)

	* smtpserver/smtpserver.c, smtpserver/smtpserver.h,
	  smtpserver/smtpchild.c:
	    Do classfull connection accounting statistics.

	* smtpserver/smtpserver.c:
	    setsockopt(s, IPPROTO_IPV6, IPV6_V6ONLY, (void*)&on, sizeof(on))
	    (if available, binds the IPv6 socket only to v6 version
	     of the protocol port, not v4+v6 combined space!)

	* smtpserver/subdaemons.c:
	    Process customer inputs in fair round-robin manner.
	    Otherwise customers who have gotten lowest socket
	    numbers might just dominate the server, and those
	    that have higher numbers would starve.

2004-08-22  Matti Aarnio  <mea@zmailer.org>

	* transports/smtp/smtp.c, man/smtp.8.in:
	    Added  -1  option to order SMTP connection shutdown after
	    every message delivery.  This isn't quite the same thing,
	    as "one MAIL-transaction per connection" under all operational
	    conditions (e.g. if 'listexpand's' EZMLM-mode is used) but
	    it definitely is for all normal cases.

2004-08-20  Matti Aarnio  <mea@zmailer.org>

	* smtpserver/smtphook.c, smtpserver/smtpserver.h,
	  smtpserver/smtpserver.c:
	    If the "my_perl" flag is not set, don't even let procedure
	    stack init (macro embedded) codes to run in hooks.
	    Call  ZSMTP_hook_set_ipaddress()  at the start of the
	    smtpserver() function loop.

	* smtpserver/smtpserver.h, smtpserver/smtpserver.c,
	  smtpserver/smtptls.c, smtpserver/smtpcmds.c, smtpserver/smtpauth.c:
	    Reworked the 'with' clause data presentation in style of
	    the RFC 3848.

2004-08-12  Matti Aarnio  <mea@zmailer.org>

	* smtpserver/subdaemons-ctf.c:
	    Eugene crosser noted two buglets in subdaemon
	    communication protocol processing.

	* smtpserver/smtpserver.c, man/smtpserver.8.in,
	  proto/smtpserver.conf.in:
	    Added a POSSIBILITY to report contacting IP address
	    literal in the initial 220 greeting line.

2004-08-04  Matti Aarnio  <mea@zmailer.org>

	* configure.in, man/smtpserver.8.in, proto/smtpserver.conf,
	  smtpserver/cfgread.c, smtpserver/policytest.c,
	  smtpserver/policytest.h, 
	    Igor Milyakov sent some new SPF related patches.

	* smtpserver/mxverify.c, smtpserver/policytest.c,
	  smtpserver/smtpserver.c, smtpserver/subdaemon-rtr.c:
	    Ran "gcc -ansi -pedantic"  and got a bunch of warnings.
	    This tries to fix most of those.

	* router/libdb/ldap-new.c:
	    Experimental fixes, and updates from Jeff Warnica.
	    He asked this to be stored into some other file,
	    rather than into baseline of ldap.c.

2004-07-14  Matti Aarnio  <mea@zmailer.org>

	* configure.in:
	    Version 2.99.57.pre3

	* smtpserver/smtptls.c:
	    Dist-cache disabled compilation fixed.

	* smtpserver/smtphook.c:
	    A bit work to please the compiler (to silence it, that is)

	* configure.in, smtpserver/smtptls.c:
	    Know  --enable-distcache  -- code modelled after
	    the one in Apache-2.0 mod_ssl module.
	    (Distributed Session Cache)

	* smtpserver/smtpserver.c, smtpserver/smtpserver.h,
	  smtpserver/smtpauth.c, smtpserver/smtphook.c,
	  smtpserver/smtp-perl-hooks.pl.in:
	    First write-thru of perl-hooks for smtpserver.

2004-07-11  Matti Aarnio  <mea@zmailer.org>

	* smtpserver/smtpserver.c, smtpserver/cfgread.c,
	  smtpserver/policytest.c, smtpserver/smtpauth.c,
	  smtpserver/smtphook.c,   smtpserver/smtpserver.h:
	    More of perl-hook machinery.

	* smtpserver/policytest.c:
	    Reorganized  pt_mailfrom()  logic.

	* smtpserver/smtpserver.c, smtpserver/smtpauth.c,
	  smtpserver/smtpserver.h:
	    Treat whoson result equal to authentication
	    (to some extent.)

2004-07-10  Matti Aarnio  <mea@zmailer.org>

	* smtpserver/smtpserver.h, smtpserver/smtpchild.c,
	  smtpserver/smtpserver.c, smtpserver/subdaemons.c:
	    Child reaper/reap-tracker changes to manage
	    detecting death of subdaemons, and to report it,
	    and even restart them.

	* smtpserver/smtpserver.c:
	    logfile tagging logic changes to tag more stuff
	    from master.

	* smtpserver/smtpcmds.c:
	    Reply message ENHANCEDSTATUSCODES massage.

	* smtpserver/smtphook.c:
	    A bit more of hook stuff..

	* man/smtpserver.8.in:
	    Add couple words about socket-type content-filter
	    interface.

2004-07-09  Matti Aarnio  <mea@zmailer.org>

	* smtpserver/subdaemons.c, smtpserver/subdaemon-ctf.c:
	    Contentfilter interface to socket required some
	    additional fixes.  Waiting for a report from Eugene.

	* proto/cf/aliases.cf:
	    Third try to get Eugene Crosser's DOMAIN_AWARE_GETPWNAM
	    to work correctly..  (I applied the thing by hand, and
	    were sloppy reader :-( )

	* smtpserver/smtpcmds.c, smtpserver/smtpserver.c:
	    When i-router replies a message, do issue its possible
	    ENHANCEDSTATUSCODE value in proper position of the reply
	    (in addition to the "Hi [1.2.3.4]," prefix..)
	    Also added several of those messages, and moved the
	    "boo boo, you are in our blacklists" replies around
	    so that a microsoft user getting only the last reply line
	    from the server will get something usefull.

	* configure.in, smtpserver/Makefile.in, smtpserver/policytest.c,
	  smtpserver/smtpserver.h, smtpserver/smtphook.c:
	    Added begins of embedded perl hooking into smtpserver so that
	    folks can install their own policy stuff, as they want..
	    THIS IS NOT YET USABLE!

	* smtpserver/policytest.c:
	    Moved 'state->authuser' check onwards within  pt_mailfrom().
	    And added hardwired 'verify that mail from domain does exist'
	    into it.

2004-07-08  Matti Aarnio  <mea@zmailer.org>

	* configure.in, smtpserver/cfgread.c, smtpserver/policytest.c,
	  smtpserver/smtpdate.c, smtpserver/policytest.h, 
	  smtpserver/smtpserver.h:
	    SPF_ALT to SPF2 library support migration.

	* smtpserver/cfgread.c:
	    SPF parameter parsing bug fix from Eugene Crosser.

2004-07-07  Matti Aarnio  <mea@zmailer.org>

	* configure.in:
	    Version 2.99.57.pre2

	* configure.in:
	    New:  --with-resolvlib="-L ... -R ... -lxxx"
	    Allow manual definition of linking-time of possibly
	    esoteric resolver library name, and linking rules.

	* include/libsh.h, libsh/interpret.c, router/daemonsub.c:
	    Moved  traphup()  prototype into  libsh.h, and
	    fixed wait() prototype in interpret.c.

2004-07-06  Matti Aarnio  <mea@zmailer.org>

	* smtpserver/subdaemon-rtr.c:
	    Compiling in Solaris  with Sun CC shows subtle bugs..
	    (of dead code, removed it)

	* proto/cf/server.cf, proto/cf/aliases.cf, proto/cf/rrouter.cf:
	    No more using  $(dequote .. )  function, but using
	    explicite patterns in  ssift  clauses to handle couple
	    forms of quoted localparts.

	* libsh/execute.c, libsh/listutils.c:
	    Found dangerous code deep inside the execute.c handling
	    stream redirections under some esoteric conditions.

	* smtpserver/Makefile.in, router/Makefile.in, snmp/Makefile.in,
	  utils/vacation/Makefile.in, utils/makedb/Makefile.in:
	    Rearranged library specifications so that --generic-lib=
	    parameters will lead the linking (in case -L is used!)

	* libsh/trap.c, router/daemonsub.c:
	    Noticed that in Solaris the master router leaves zombies.
	    This is a bit uncertain attempt at handling that by regularly
	    collecting all zombies, and instantiating processing vectors.
	    Eventually:  wait4(-1 ..) is wrong, correct is:  wait4(0 ..)

	* libsh/trap.c:
	    Nick Briggs reports odd compiler things on Solaris
	    with Sun compilers in strict ANSI mode...  I tried
	    to introduce safe fallbacks.

	* smtpserver/mxverify.c, smtpserver/policytest.c,
	  smtpserver/policytest.h:
	    Hunted down (finally) conditions of when MX testing
	    lets thru something into %-hack

2004-07-01  Matti Aarnio  <mea@zmailer.org>

	* router/db.c:
	    In some situations we leaked db lookup keys into memory.
	    Plugged that leakage hole.

2004-06-23  Matti Aarnio  <mea@zmailer.org>

	* smtpserver/smtpserver.c:
	    Found a long-lurked bug in reporterr().
	    It did refer to wrong data in Solaris -> SEGV.
	    Oops..  Corrected printf()-like parameters, and
	    now it should not fault.  This happened in
	    the tail of failing SMTP session, so it didn't
	    matter for message reception.

2004-06-22  Matti Aarnio  <mea@zmailer.org>

	* router/rfc822.c:
	    Move the verbose-tracing a bit earlier in the processing.

	* router/rfc822.ssl:
	    Remains of an attempt to modify the local-part address
	    semantics...  Not a success :-(

	* router/lib/header.c:
	    Change parsing rules for envelope headers.

	* smtpserver/policytest.c:
	    When in MSA-mode, _ignore_ 'relaycustnet +' attributes.
	    Will then always demand user to authenticate!

	* smtpserver/rfc821scn.c:
	    Deep reading of RFC 2821/2822 did show, that we had
	    a wee bit wrong type encodings for '"', '.', and '@'.
	    Corrected those, and under non-strict conditions did
	    modify the parsing to allow e.g.:  .foo.@example.com

	* smtpserver/smtpserver.c:
	    At the star of incoming session, report (into log) also
	    the PID of the running smtpserver process.  Helps to debug
	    couple odd problems that I have seen.

	* smtpserver/subdaemons.c:
	    Error-code  EBADFD  is something that exists only at Solaris,
	    and at Linux, not at FreeBSD..

2004-06-02  Matti Aarnio  <mea@zmailer.org>

	* smtpserver/policytest.c:
	    Fixed the rate-tracker to function again.
	    For a while the rate tracker responses were just ignored...

2004-05-23  Matti Aarnio  <mea@zmailer.org>

	* smtpserver/subdaemons.c:
	    After exec()ing actual subdaemons, the  subdaemon_nofiles
	    variable must be reinitialized -- doing it in
	    subdaemons_loop() now.

2004-05-17  Matti Aarnio  <mea@zmailer.org>

	* smtpserver/smtpdata.c:
	    Report the content-filter result message as single message,
	    if at all possible.

	* smtpserver/subdaemon-ctf.c:
	    Detect and process EOF from subdaemon subserver correctly.

2004-05-11  Matti Aarnio  <mea@zmailer.org>

	* utils/vacation/vacation.c, man/vacation.1.in:
	    Experiment a bit with attempting to reply with
	    the address that the message came in with.
	    (Pick: user, orcpt, inrcpt   in that order.
	     Last found stays in effect.)

	* utils/vacation/vacation.c, man/vacation.1.in:
	    Make the code to match the man page (-r option),
	    then realized that -t option document matches
	    current behaviour..   Anyway, 1.00 days is much
	    better default interval.

	* include/libz.h, lib/parseintv.c:
	    Change the passed parameters to be of 'const' type.
	    This code does not alter them.

2004-05-10  Matti Aarnio  <mea@zmailer.org>

	* router/router.c, router/shliaise.c, proto/cf/standard.cf:
	    Change the router's log thingie to log with
	    spoolid, instead of message-id.

2004-05-09  Matti Aarnio  <mea@zmailer.org>

	* smtpserver/smtpserver.h, smtpserver/smtpserver.c,
	  smtpserver/smtptls.c:
	    Detect if there is known EOF coming up in read pipe.
	    This is meaningfull to check in case we are very early
	    in SMTP session, and somebody is feeding us spam...

	* smtpserver/policytest.c, smpserver/smtpauth.c:
	    Compiler said "uname might be used uninitialized"..
	    Actually it is not used in the policy code
	    either, but that is another story...

2004-05-08  Matti Aarnio  <mea@zmailer.org>

	* smtpserver/smtpserver.c, smtpserver/subdaemons.c:
	    For Solaris environemnts...  start the smtpserver's
	    subservers via execl(), actually does it for all
	    environments, but still...

	* include/shmmib.h, scheduler/scheduler.c,
	  transports/mailbox/mailbox.c, transports/smtp/smtp.c,
	  transports/expirer/expirer.c, transports/errormail/errormail.c,
	  transports/hold/hold.c, transports/sm/sm.c,
	  transports/reroute/reroute.c:
	    Changed SHMMIB area variables all to be of "volatile" kind.

	* smtpserver/smtpcmds.c, 
	    Changed report output a bit, don't give router output
	    directly to type() as a format string.

	* smtpserver/smtpserver.c:
	    Implement  zsleep()  by means of calling select(2).

	* smtpserver/subdaemon-rtr.c, smtpserver/subdaemons.c:
	    Reworked subprocess error (EOF) processing a bit.
	    Perhaps now dying router will automagically recover
	    loosing only the session currently underway.

2004-05-07  Matti Aarnio  <mea@zmailer.org>

	* smtpserver/smtpserver.h, smtpserver/smtpserver.c,
	  smtpserver/cfgread.c, smtpserver/subdaemons.c,
	  man/smtpserver.8.in, proto/smtpserver.conf.in:
	    Change the tarpit parameters to be of 'double'
	    type, instead of 'int'.  Allows slower growth
	    of the exponent value..  Also do sleep()s
	    with  select().  Also tuneup of tarpit calls.
	    They are not used in all rejects...

	* smtpserver/kissig/*:
	    Removed old code predating present policy material.

2004-05-04  Matti Aarnio  <mea@zmailer.org>

	* router/functions.c:
	    In  rfc822syntax  do report errors to stderr ONLY
	    if the system is tty interactive!

2004-05-02  Matti Aarnio  <mea@zmailer.org>

	* proto/smtpserver.conf.in, smtpserver/cfgread.c,
	  smtpserver/policytest.c, smtpserver/policytest.h,
	  smtpserver/smtpauth.c, smtpserver/smtpserver.h,
	  smtpserver/subdaemon-trk.c:
	    - Track the number of FAILED SMTP AUTHs, and refuse
	      to do any if there are too many failures from given
	      IP address.  This is, of course, somewhat troublesome
	      under some conditions -- one user can cause DoS for
	      others...  But avoids password breaking oracle service.
	    - Count _all_ RCPTs, not just accepted ones..
	    - Count data-aborts too.

	* lib/symbol.c:
	    When called upon NULLing the internal default
	    symbol database that hasn't been initialized,
	    just _don't_.  Otherwise NULL referral leads
	    to madness .. and core files..

	* smtpserver/smtpserver.h, smtpserver/smtpserver.c,
	  smtpserver/smtpcmds.c, smtpserver/smtpdata.c,
	  smtpserver/smtpetrn.c:
	    Something bothered me in variable names,
	    and I changed one.  I added "Hi <remoteip>, .."
	    for many error messages to aid troublesome
	    host pickup by means of simple grepping...

2004-04-30  Matti Aarnio  <mea@zmailer.org>

	* man/smtpserver.8.in, proto/smtpserver.conf.in,
	  smtpserver/cfgread.c, smtpserver/smtpserver.h,
	  smtpserver/subdaemon-rtr.c:
	    Cloned content-filter interaction machinery
	    also into router interactions, now there
	    can be multiple instances of the router
	    if single isn't enough..  By default there
	    can be 2 i-routers.

	* smtpserver/smtpserver.h, smtpserver/subdaemons.c:
	    "Test and debug before release..."  Damn..
	    Ok, now that subdaemon_send_to_peer() works.
	    At the same time reworked the peer buffer
	    allocations to happen _late_, that is, when
	    a peer interaction is created, not at boot..
	    Shrinks server memory consumption considerably.

	* smtpserver/subdaemons.c: subdaemon_send_to_peer()
	    Internal code was .. not my best writing.
	    Rewrote it to be somewhat more sane..

	* smtpserver/subdaemon-trk.c:
	    When outputing the "Z-REPORT DUMP", start it with datetime,
	    and end it with data line count..  Similar with SIGUSR1
	    processing.

	* smtpserver/subdaemons.c:
	    Deep within fdgets() a read(2) call did yield EBADFD,
	    treat that as "EOF", and let auto-recovery handle it.

	* smtpserver/smtpserver.h:
	    Shrunk memory block pre-allocated for each potential
	    client from 7 kB to about 3 kB.  In systems with 1024
	    as "ulimit -n", this shrinks process image by 4 MB...

	* smtpserver/policytest.c, smtpserver/subdaemon-trk.c:
	    Styling beauty-warts, and correcting internal
	    communications primitives to match client, and
	    server to each other...

	* smtpserver/smtpreport.c:
	    When processing the authorization file, turn on root-powers
	    to access the file, then return into trusted mode.

	* include/libsh.h, include/splay.h, lib/splay.c,
	  lib/symbol.c,libsh/interpret.c, libsh/zmsh.c,
	  router/db.c, router/libdb/hreader.c, router/libdb/incore.c,
	  scheduler/mailq.c, scheduler/msgerror.c,
	  scheduler/prototules.c, scheduler/qprint.c,
	  scheduler/readconfig.c, scheduler/scheduler.c,
	  scheduler/threads.c, transports/mailbox/mailbox.c:
	    Changed the API of  sp_scan()  function, especially
	    the API of the CALLED function f.  Now can supply
	    an opaque (to splay) parameter that is passed on to
	    item processor.   (Eliminated a bunch of static globals
	    from all over the code...)

	* transports/mailbox/mailbox.c:
	    Reworked the rwhois/rbiff related splay-code.
	    Not so sure if it is _correct_, as I don't use it anymore
	    anywhere...  It _should_ be ok, but I have done mistakes
	    before...

	* transports/smtp/smtp.c:
	    Don't burn cycles to CNAME map MAIL FROM domain..
	    That isn't absolutely necessary...  Still doing
	    RCPT TO domain CNAME mapping.

	* smtpserver/subdaemon-trk.c, smtpserver/policytest.c:
	    - Format fixes
	    - Don't log Z-REPORT replies into smtpserver log file.

2004-04-28  Matti Aarnio  <mea@zmailer.org>

	* smtpserver/smtpserver.h, smtpserver/subdaemon-ctf.c,
	  smtpserver/subdaemon-rtr.c, smtpserver/subdaemon-trk.c,
	  smtpserver/subdaemons.c:
	    Modify underlying details in fdgets() handling to use
	    larger read() operations, than 1 byte at the time..
	    This gives slight speedup, ... well, at least nicer
	    kernel call traces...

	* smtpserver/Makefile.in, smtpserver/contentpolicy.c,
	  smtpserver/mxverify.c, smtpserver/policytest.c,
	  smtpserver/policytest.h, smtpserver/smtpcmds.c,
	  smtpserver/smtpdata.c, smtpserver/smtpserver.c,
	  smtpserver/smtpserver.h, smtpserver/subdaemon-trk.c:
	    - Reworked parameters of the policy related functions
	      to use only one state variable pointer.
	    - Add accounting of recipients of messages in
	      addition to the counting of messages.
	      Won't (yet) have _limit_ on number of recipients..
	
	* smtpserver/subdaemon-rtr.c:
	    The interactive router complained in manual
	    test mode.  Perhaps should develop a fallback
	    interactive router mode for these test things.

2004-04-27  Matti Aarnio  <mea@zmailer.org>

	* smtpserver/smtpserver.c:
	    Noticed, that after "550" rejection at connection,
	    the system still did print out "220 " greeting line.
	    Adding couple grouping brackets solved that thing.

	* smtpserver/smpserver.h,
	  smtpserver/smtpreport.c, smtpserver/policytest.c,
	  smtpserver/subdaemon-trk.c, man/smtpserver.8.in:
	    - Added a "z-report uu pp dump" subcommand, that
	      does pretty much the same as SIGUSR1, but over
	      the SMTP channel.
	    - Track number of excesses, if a user _ever_
	      exceeds his/her ratelimit, then that IP will
	      be forever in tracking.

	* smtpserver/subdaemon-ctf.c:
	    Some oddball core-dumps being eliminated..

	* proto/cf/SMTP.cf.in, proto/cf/SMTP+UUCP.cf.in,
	  proto/cf/TELE-FI.cf.in, proto/cf/UTAI.cf,
	  proto/cf/UTGPU.cf, proto/cf/UTdefault.cf.in:
	    Copied better comments from UT*.cf files
	    into standard SMTP and SMTP+UUCP templates.
	    Tweaked all files slightly.

2004-04-23  Matti Aarnio  <mea@zmailer.org>

	* proto/cf/rrouter.cf:
	    Bug in treatment of addresses where the domain part
	    has IP address literal:  local@[1.2.3.4]
	    The net result was scary attempt of execution of
	    commands that have names like:  "1.2.3.4",
	    which naturally always failed resulting failure
	    of doing detection of intended "this is local IP
	    address in this system".

2004-04-22  Matti Aarnio  <mea@zmailer.org>

	* SiteConfig.in, man/man-index.sh, man/smtpserver.8.in:
	    More man-page style editing.  The result is nice to read..
	    (and oddly a bit TeXish in feel...)

	* smtpserver/policytest.c, smtpserver/subdaemon-trk.c,
	  man/smtpserver.8.in:
	    Improved  "Z-REPORT"  command verb processing.
	    Document for it is in the man-page..

	* smtpserver/subdaemon-ctf.c, smtpserver/subdaemons.c:
	    Don't (conditionally) start any sort of content-filter.

	* man/smtpserver.8.in, man/Makefile.in:
	    Produce the PDF files via DVI file route.
	    The resulting file is _a_lot_ nicer to look at!

2004-04-20  Matti Aarnio  <mea@zmailer.org>

	* man/smtpserver.8.in, proto/smtpserver.conf.in:
	    Document "PARAM contentfilter-maxpar 2".

	* smtpserver/subdaemons.c, smtpserver/subdaemon-ctf.c,
	  smtpserver/cfgread.c:
	    Run parallel contentfilters in case one isn't
	    enough..  Startup code side-effect is that when
	    one is needed, _max_set_ will be started.
	       "PARAM contentfilter-maxpar nn"
	    limits the number of parallel started contentfilters.
	    Hard-limit inside the code is 20, above which this
	    parameter can not increase the number of CFs.

2004-04-19  Matti Aarnio  <mea@zmailer.org>

	* smtpserver/contentpolicy.c, smtpserver/smtpserver.c,
	  smtpserver/smtpserver.h, smtpserver/subdaemon-ctf.c:
	    Cleaning the new contentfilter interface, dead
	    code, etc.

	* transports/smtp/smtp.c:
	    Slight change in outbound EZMLM mode MAIL FROM
	    addresses; added spoolid on the generated "local-part".

	* man/scheduler.8.in, man/smtpserver.8.in:
	    Document editing; Z-REPORT ACL explanation,
	    although not result explanation...
	    Smtpserver's document updates.

	* smtpserver/contentpolicy.c, smtpserver/policytest.h,
	  smtpsever/smtpserver.h, smtpserver/subdaemon-ctf.c:
	    Rearranged things so that content-policy happens
	    under the centralized management daemon of its own.
	    Presently only one ContentFilter instance can be
	    running there, which might be a wee bit too little..

	* smtpserver/subdaemon-trk.c:
	    Report tracking slot allocation age in addition to
	    the total number of MAILs ("RATE"s) queried at it.
	    (If the tracking never yields all slots zero, then
	    the entry may get rather old, and the MAILs count
	    very high...)

	* smtpserver/smtpserver.c:
	    Renamed "IDENT" to "Z-IDENT", and "DEBUG" to "Z-DEBUG".

	* smtpserver/smtpserver.c:
	    Code rearrange; K&R doesn't like some C99 things..

	* smtpserver/subdaemon-trk.c:
	    Unused variables, and occasional lack of init..

2004-04-16  Matti Aarnio  <mea@zmailer.org>

	* include/shmmib.h, smtpserver/smtpreport.c,
	  smtpserver/Makefile.in, smtpserver/smtpserver.h,
	  smtpserver/policytest.h, smtpserver/policytest.c,
	  smtpserver/subdaemon-trk.c:
	    Created  "Z-REPORT <user> <password> IP 1.2.3.4" command
	    into SMTP responder that will query the internal rate-tracker
	    server for more details about rating counters.
	    (Won't say a thing about _limits_ at all!)
	    Can use  scheduler.auth   file for user+password+ACLs,
	    no need to have separate file..

	* smtpserver/smtpcmds.c, smtpserver/smtptls.c:
	    Extra White-space sloppy-scanner fixes.

	* smtpserver/policytest.c:
	    SPF api tracking fix from Eugene Crosser.

	* smtpserver/cfgread.c, 
	    Implemented  BindSmtp, BindSmtpS, BindSubmit PARAMs for
	    the system.  Also PARAM report-auth-file.

	* man/smtpserver.8.in, proto/smtpserver.conf.in:
	    - Update the sample  smtpserver.conf  to match current
	    - Mention new  BindSmtp/BindSmtpS/BindSubmit PARAMs, and
	    - PARAM report-auth-file ...

	* proto/cf/server.cf, smtpserver/smtpcmds.c:
	    Do support running HELO/EHLO string thru the interactive
	    router...  although that isn't all the most brightest
	    thing to do...  (nor the example router script really
	    works at all..)

	* scheduler/mq2.c, scheduler/mq2auth.c, scheduler/prototypes.h,
	  smtpserver/smtpreport.c:
	    Revised somewhat the  scheduler.auth  file parsing, and
	    reused same code (AND SAME DATA FILE!) for ACLs of
	    various things.

	* scheduler/prototypes.h, scheduler/scheduler.c,
	  scheduler/transport.c:
	    Reworked the 'mailq' TCP socket binding somewhat.
	    Depending on system modes, IPv6 binding may or may not
	    support also IPv4 connections.  Handling that by creating
	    at first the IPv6 socket bound on any6/mailq port, and then
	    a IPv4 socket is attempted to bind of  any/mailq.
	    If the IPv4 doesn't bind successfully, will be using
	    IPv6 listening socket for everyhing.

	* smtpserver/smtpserver.c, smtpserver/smtpserver.h:
	    Reworked the listen socket binding codes.
	    Background includes abovementioned IPv4 vs. IPv6 issues.

	* lib/selfaddrs.c:
	    Instead of casting, use Usockaddr pointer.

	* lib/zgetbindaddr.c, lib/zgetifaddress.c:
	    - Added magic literals: "any", "any6"
	    - Noticed several deficiencies in address pickup at least
	      of Linux IPv6 kind.. (link-local isn't very usefull...)

	* proto/post-install.sh.in:
	    A bug report from  Volker Stolz  about typo in
	    $POSTOFFICE  directory creation (I always have that
	    as its own filesystem -> never noticed this one...)

	* lib/prversion.c:
	    Update the integrated year...

2004-04-14  Matti Aarnio  <mea@zmailer.org>

	* proto/cf/aliases.cf:
	    Finally did the fix that Eugene Crosser pushed me to do
	    for quite a while..  Damn typo.

	* smtpserver/policytest.c, smtpserver/policytest.h:
	    - Internal rcpt_nocheck variable is not set
	      anywhere -> dead code
	    - Make SMTP AUTH, and 'full_trust' to be exactly equal
	      (they were similar, now they are equal)
	    - Make WHOSON equal to 'always_accept' processing
	      (now that 'always_accept' has been demoted slightly
	       to make various possibly rejecting checkups before
	       accepting the message.)

2004-04-12  Matti Aarnio  <mea@zmailer.org>

	* proto/cf/server.cf:
	    Do "db flush expansions"  and "db flush hostexpansions"
	    for all "from" and "to" addresses at start.

	* smtpserver/subdaemon-rtr.c, smtpserver/subdaemons.c:
	    Remove a bunch of debugging printouts.

	* lib/fdpassing.c, smtpserver/smtpserver.h:
	    Do proper includes for <fcntl.h>

	* router/daemonsub.c, router/prototypes.h, router/router.c,
	  smtpserver/subdaemon-ctf.c, smtpserver/subdaemon-rtr.c:
	    Handle gracefully subdaemon router process death,
	    (and have it die gracefully.)

	* router/router.c, proto/cf/server.cf:
	    Automated 'server purge' every about 1000 interactions.
	    Also call 'server init' before start.

	* lib/fdpassing.c, lib/zshmmibattach.c, subdaemon-rtr.c:
	    Add a few  fcntl(fd,F_SETFD,FD_CLOEXEC)  calls into
	    selected places so that exec()ed subprocesses won't
	    inherit undesirable filehandles.

	* include/libz.h, transports/mailbox/mailbox.c,
	  transports/mailbox/mboxpath.c:
	    Match prototypes of crc32() and pjwhash32() properly..

	* router/daemonsub.c, router/functions.c, router/prototypes.h,
	  router/router.c, include/libsh.h, libsh/builtins.c,
	  router/db.c:
	    Couple additional fixes on memory allocation/free strategies.
	    Improved memory recycling, freeing objects no longer needed.
	    (Also cleaning up a bit of extern declarations..)

	* smtpserver/policytest.h, smtpserver/subdaemon-trk.c:
	    Oops..  Reserved too small buffer for IPv6 address
	    hex storage. (Used in rate-tracking.)

	* include/libz.h:
	    Publish prototypes for crc32*() functions.

	* include/io.h:
	    Allow selective io-redirection disabling

	* router/router.c,  man/router.8.in, proto/cf/aliases.cf,
	  proto/cf/fqdnaliases.cf, proto/cf/server.cf,
	  router/functions.c, router/prototypes.c:
	    Created  -Ismtpserver  function mode, that calls
	    the router script interpreter's  "$(server ..)" function
	    in definitely secure manner.  This is for use under
	    new smtpserver's router interaction logic.
	    Also created  $(isinteractive)  script function, that
	    can be used in short-circuiting potentially lengthy
	    expansions that are not really interesting in this mode.

	* router/router.c, router/router.h, router/daemonsub.c,
	  router/Makefile.in, router/dateparse.c, router/db.c,
	  router/functions.c, router/prototypes.c, router/rfc822.c,
	  router/rfc822hdrs.c, router/rfc822walk.c, router/rtsyslog.c,
	  router/shliaise.c:
	    Created "router.h"  and used it as only include file
	    for all source files.

	* smtpserver/contentpolicy.c, smtpserver/policytest.c:
	    Minor edits.

	* smtpserver/smtprouter.c, smtpserver/Makefile.in:
	    Killed the file.  All the functionality went into
	    subdaemon-rtr.c  file.

	* smtpserver/smtpserver.c:
	    Removed vestiges of router running as a sub-process of
	    current SMTP interaction instance.

	* smtpserver/smtpserver.h:
	    Couple new prototypes, plus handling fd_set passed as
	    a pointer.

	* smtpserver/subdaemon-rtr.c, smtpserver/subdaemons.c
	    Running one interactive router sub-instance under the
	    multiplexing server.  Possibly need to have more ???

	* smtpserver/subdaemon-trk.c, smtpserver/subdaemons.c:
	    Moved  fdgets()  function into subdaemons.c file
	    (common use..)  Added non-blocking operation mode for it.

2004-04-09  Matti Aarnio  <mea@zmailer.org>

	* smtpserver/smtpserver.c:
	    Move the subdaemons_init() again.  Place it now right
	    after becoming stand-alone daemon right before creating
	    listening sockets.

	* smtpserver/subdaemon-ctf.c:
	    Minor coding style edit (use calloc() instead of
	    malloc+memset).

	* smtpserver/subdaemon-trk.c:
	    Add timeout handling into fdgets() code.  The intention
	    being, that system not responding properly within user-
	    supplied time-limit can be detected.

	* smtpserver/subdaemons.c:
	    Rework subdaemon forking code to properly close client-end
	    of the rendezvous-sockets within the subdaemons.  Don't close
	    quite every possible file descriptor, but do close several..

2004-04-08  Matti Aarnio  <mea@zmailer.org>

	* doc/guides/smtp-policy:
	    Document somewhat about the "ratelimitmsgs 300" attribute
	    pair.

	* include/shmmib.h, scheduler/mailq.inc:
	    Store, and print PIDs of these subdaemons.

	* smtpserver/subdaemon-trk.c:
	    Security-first; unlink() target dump file name,
	    then open it exclusively.

	* smtpserver/policytest.c:
	    Store into log file the result that the ratetracker gave.

	* smtpserver/policytest.c, smtpserver/policytest.h,
	  smtpserver/readpolicy.c:
	    - Rearranged MAIL FROM processing code, allowing rate-limit
	      to be used, as well as reworking things in IP address space
	      (where its variables need to be set..)
	    - Enabled compiling policy rulesets with 'ratelimitmsgs nnn'
	      settings.

	* smtpserver/smtpserver.c:
	    Moved subdaemons_init() a bit latter than previously..

	* smtpserver/subdaemon-trk.c, smtpserver/subdaemons.c:
	    Testing and debugging until it begun to work, and die
	    after all tracking clients have disconnected, and not
	    die at weird moments, and ...

	* include/libz.h, lib/fdpassing.c:
	    - Modify the call interface to always support only
	      bidirectional pipe kind of thing.  One fd for the client
	      side, one for the server side.  Not two.
	    - The fdpass_sendfd() returns now 0 for successfull send
	      (that is, sendmsg syscall), and -1 for other situations.

	* include/policy.h, smtpserver/policytest.c,
	  smtpserver/policytest.h, smtpserver/policydata.c,
	  smtpserver/smtpserver.h, smtpserver/subdaemon-trk.c:
	    First scriblings on how to make one fully functional
	    subdaemon server (rate-tracker), but it is still
	    missing some intermediate bits and pieces...

	* include/splay.h, lib/splay.c:
	    Convert the splay block (spblk) to be slab-allocated
	    cellish thing (like conscell:s in router) along with
	    a chain of free spblk:s in the stree chain.

2004-04-05  Matti Aarnio  <mea@zmailer.org>

	* smtpserver/subdaemon-ctf.c, smtpserver/subdaemon-rtr.c,
	  smtpserver/subdaemon-trk.c, smtpserver/smtpserver.c,
	  smtpserver/subdaemons.c:
	    Split the growing file into smaller slices...

2004-04-04  Matti Aarnio  <mea@zmailer.org>

	* configure.in:
	    Version label: 2.99.57-pre1

	* include/netdb6.h, lib/fdpassing.c, libc/fullname.c,
	  libc/myhostname.c, router/libdb/ndbm.c, smtpserver/cfgread.c,
	  smtpserver/smtpcmds.c, smtpserver/smtpdata.c, ssl/ssl.c,
	  router/libdb/yp.c:
	    Some SunPro C-compiler warnings silenced...

	* smtpserver/subdaemons.c, smtpserver/Makefile.in,
	  smtpserver/smtpserver.c, smtpserver/smtpserver.h:
	    Coding subdaemon-server subsystem; initial steps,
	    not yet in use in any form or shape...

	* proto/post-install.sh.in:
	    Do CONDITIONALLY create individual subdirectories
	    inside the $POSTOFFICE  when called.  E.g. if a directory
	    does already exist, don't remake it, but possibly make
	    its subdirectories!

	* lib/fdpassing.c:
	    Pass a fd thru a given handle to another process.

	* scheduler/pipes.c -> lib/pipes.c,  scheduler/resources.c ->
	  lib/resources.c, include/libz.h, scheduler/prototypes.h,
	  router/daemonsub.c, lib/Makefile.in, scheduler/Makefile.in,
	  router/Makefile.in:
	    Moved the pipes.c, and resources.c files from scheduler/ to
	    lib/,  it has uses outside the scheduler, after all...

2004-04-01  Matti Aarnio  <mea@zmailer.org>

	* README.UPGRADING, include/libz.h, include/shmmib.h,
	  lib/fdstatfs-test.c, lib/fdstatfs.c, lib/zshmmibattach.c,
	  router/rfc822.c, scheduler/mailq.inc, scheduler/scheduler.c,
	  smtpserver/smtpcmds.c, smtpserver/smtpdata.c,
	  smtpserver/smtpserver.c:
	    - new gauges tracking the number of i-nodes available/used
	      in various partitions where ZMailer has activity.
	      (If those filesystems are separate to begin with...)
	      (Spending reserved spaces in the memory block, no
	       need to change block magic numbers :) )
	    - allowing split of $POSTOFFICE into two separate
	      filesystems, although "transport/" MUST be mounted
	      as  $POSTOFFICE/transport/ !

2004-03-31  Matti Aarnio  <mea@zmailer.org>

	* router/libdb/gdbm.c, router/libdb/ndbm.c, router/db.c:
	    Hunting strange memory corruptions, which turned out to
	    be my own mistakes from about 20 hours ago...  Damn.

	* proto/scheduler.conf.in:
	    Add  "smtp-par/*"  clause, explicite parallellism
	    to be used, if postmaster so desires (to some target
	    where there is lots of traffic...)

	* router/libdb/gdbm.c:
	    Eugene Crosser reports odd gdbm database opening problems
	    in, and I see the same in Solaris, but not in Linux...
	    Adding now some extra debug stuff to see what goes wrong.
	    .. Looks like 'make clean; make' would help ?
	    My own Solaris problem was bad ZENV setup.

	* include/sleepycatdb.h, lib/sleepycatdb.c, man/smtpserver.8.in,
	  smtpserver/policytest.h, smtpserver/policytest.c:
	    Dot in some notes about SleepyCat DB RPC mechanisms..
	    More is yet in "TO DO" list...
	
	* router/libdb/bsdbtree.c, router/libdb/bsdhash.c:
	    Do a bit more elaborate comparison set on database alteration
	    from underneath ourself.

	* utils/perl/Makefile.in,  configure.in:
	    More hoops to get perl setup parameter feed in,
	    and to make installation into non-root DESTDIR=
	    to succeed.

	* configure.in:
	    Accept environment variables  LIBDB3,  LIBDB4,  which
	    have effect if system has  <db3/db.h>  and  <db4/db.h>
	    headers, respectively.

	* router/libdb/gdbm.c:
	    Urgh, folks have repeatedly told me that this gdbm
	    interface leaks fds like no tomorrow..  I finally
	    tried it myself, and it was ... most educative.
	    Looks like sip->dbprivate datablock introduction
	    code mutation was never completed.

	* router/libdb/ndbm.c:
	    Did same code mutation as gdbm.c has, and completed it
	    all in one go..  (compile tested in Solaris 8)

	* libsh/isterminal.c, libsh/execute.c, libsh/sslwalter.c,
	  include/libz.h:
	    New  z_isterminal(fd)  function.  If it yields false,
	    execute.c will cry out missing external program with
	    LOG_EMERG level message.

	* configure.in:
	    AC_HEADER_CHECK(termios.h)

2004-03-19  Matti Aarnio  <mea@zmailer.org>

	* TODO, lib/sleepycatdb.c:
	    Add some markers for RPC access mode; work to be done...

	* packaging/rpm/README-RPM, packaging/rpm/zmailer.spec:
	    Xose Vazquez  sent some updates.

	* proto/cf/fqdnalias.cf, proto/cf/p-routes.cf:
	    Differentiate route lookup (especially for DEFAULT)
	    in between 'sender' and 'recipient' modes.

	* man/smtpserver.8.in, proto/smtpserver.conf.in,
	  smtpserver/cfgread.c, smtpserver/smtpserver.c,
	  smtpserver/smtpserver.h:
	    Contact-pointer message tunability feature into
	    smtpserver from Eugene Crosser.


2004-03-11  Matti Aarnio  <mea@zmailer.org>

	* utils/makedb/makedb.c, utils/makedb/dblook.c,
	  lib/sleepycatdb.c, smtpserver/policytest.c:
	    Support for SleepyCat DB 4.2

	* smtpserver/policytest.c:
	    "TrustWhosOn" shotgun patch from
	    ("Neal Morgan" <Neal@Morgan-Systems.com>)
	    Another patch from Eugene Crosser to
	    add back a (state->always_accept) test.
	    Which one of those now does the fix ?
	    Hmm..

	* config.h.in, configure.in, include/policy.h,
	  man/smtpserver.8.in, proto/smtpserver.conf.in,
	  proto/db/smtp-policy.src,  smtpserver/Makefile.in,
	  smtpserver/cfgread.c, smtpserver/policytest.c,
	  smtpserver/policytest.h, smtpserver/readpolicy.c,
	  smtpserver/smtpdata.c, smtpserver/smtpserver.h:
	    Eugene Crosser <crosser@rol.ru> sent big
	    patch for implementing SPF in ZMailer.
	    I don't quite agree with the ideas in
	    SPF, but...

	* transports/smtp/appendlet.c:
	    sfputc() alone does never indicate EOF,
	    that must be checked explicitely!
	    (Andrey Blochintsev <bag@iptelecom.net.ua>)

	* include/zmclib.c, lib/zmclib.c:
	    A work-in-progress of librarizing multicast communication
	    setup things.  The darn thing is _very_ complex, when one
	    must handle multiple interfaces, including talking MC
	    somewhere, where system default MC routes don't point
	    to... (e.g. some backend lan..)

	* proto/cf/aliases.cf:
	    Eugene Crosser found out that I had been wrong all along..
	    "bug in treating of domain_aware_getpwnam"

	* proto/cf/aliases.cf:
	    MailMan 2.0.5 integration scripts from 
	    Xose Vazquez Perez <xose@wanadoo.es>

	* snmp/README.NET-SNMP, snmp/Makefile.in, snmp/mta.h,
	  snmp/mibs/MTA-MIB.txt, snmp/mibs/ZMAILER-MIB.txt,
	  snmp/mibs/.index, snmp/mibs/NETWORK-SERVICES-MIB.txt,
	  snmp/mta_columns.h, snmp/mta_enums.h, snmp/mta.c:
	    Work in progress, can't say much yet...


2003-11-29  Matti Aarnio  <mea@zmailer.org>

	* proto/cf/aliases.cf, proto/cf/fqdnaliases.cf,
	  proto/db/dbases.conf, proto/cf/crossbar.cf, proto/db/userdb,
	  proto/cf/crossbar.cf:
	    Went thru details about 'userdb' processing, and why the
	    'user:mailname' things didn't produce public results.
	    Support is present for mapping  user+foo  to
	    user.name+foo@domain  thru %-substitution.

	* transports/smtp/appendlet.c:
	    Slipped a brain-fart into this code during the earlier
	    "Don't use BDAT every time" thing.  Oops!
	    The bug: Failure to do the "dot-duplication" algorithm
	    in DATA mode for non text/plain messages!  :-(

2003-11-27  Matti Aarnio  <mea@zmailer.org>

	* router/libdb/ldap.c:
	    Found a sneaky typo - for some reason my compilations
	    don't compile LDAP by default :-(

2003-11-24  Matti Aarnio  <mea@zmailer.org>

	* transports/smtp/smtpauth.c:
	    Suspend logging on '-l' file as well as verbose-log,
	    while writing the secret on outgoing SMTP stream.

2003-11-23  Matti Aarnio  <mea@zmailer.org>

	* transports/smtp/smtp.c, transports/smtp/smtpauth.c, TODO:
	    Testing, and correcting the -A option 'smtpauth()'
	    processing while feeding test messages to
	    Cyrus IMAP 2.2.2 (BETA) server.  Interesting beast this...
	    PROBLEM: Reveals in  -l  option file, as well as  verboselog
	    the outgoing _secret_ data in authentication!

	* proto/cf/router.cf, proto/cf/server.cf, proto/cf/SMTP.cf.in:
	    Changes In order to get one system to report straight from
	    'routes' database an entry like following:
	      foo.dom  error!nosuchuser!explanation text here
	    straight into online router processing, like:
	      554 5.0.0 unresolvable address <...>; nosuchuser; explanation txt

	* man/smtp.8.in, transports/smtp/smtp.h, transports/smtp/smtp.c,
	  transports/smtp/Makefile.in, transports/smtp/smtpauth.c,
	  doc/guides/cyrus-imap:
	    Initial write-through of simple SMTP client authentication
	    against selected remote clients - this is intended to be
	    used under some sort of protection, like TLS, or very least
	    within a protected network.  Indeed it is only written to
	    work against Cyrus IMAP LMTP server over loopback network.

2003-11-21  Xosé Vazquez Peres  <xose@wanadoo.es>

	* proto/cf/aliases.cf:
	    mailman-zmailer integration.

2003-11-21  Matti Aarnio  <mea@zmailer.org>

	* man/smtpserver.8.in, smtpserver/smtpserver.c,
	  smtpserver/smtpauth.c, smtpserver/smtpcmds.c,
	  smtpserver/smtpdata.c:
	    Created "-s sloppy" runtime option to turn
	    on fully sloppy behaviour with no expection
	    to get HELO greeting, nor "<"/">" pair in
	    email addresses.

2003-11-20  Matti Aarnio  <mea@zmailer.org>

	* transports/smtp/smtp.c:
	    Don't use BDAT mode, if the message size estimate
	    is larger, than our outgoing BDAT buffer Chunk-Size.

	* proto/scheduler.conf.in, scheduler/msgerror.c,
	  scheduler/readconfig.c,  scheduler/prototypes.h,
	  transports/errormail/errormail.c, man/scheduler.8.in,
	  man/errormail.8.in:
	    Added "PARAMstore-error-on-error = 1" parameter
	    into the scheduler.  And added "discard error-on-error"
	    cases into errormail.

	* configure.in, router/daemonsub.c:
	    Buggy (in Solaris et.al.) autoconf of  dirfd()  thing
	    in they fchdir() callbacks.   Probably should redo
	    the thing somehow differently...  (This is for users
	    of  ROUTERDIRHASH=1  and multiple  ROUTERDIRS  directories.)

	* scheduler/msgerror.c, transports/errormail/errormail.c:
	    Add "Return-Path:" data label into produced
	    error messages.

2003-11-18  Matti Aarnio  <mea@zmailer.org>

	* configure.in:
	    Mark the version as  2.99.56  (finally!)

2003-11-16  Matti Aarnio  <mea@zmailer.org>

	* proto/cf/aliases.cf:
	    More patches from Eugene Crosser (actually something
	    I omitted by accident when applying things manually;
	    as in "retyping" ..)

	* smtpserver/policytest.c:
	    Moved target specific rejects early -- so that we can
	    reject some targets even for cases where e.g. message
	    source IP address carries "relay all thru us".

	* transports/smtp/smtp.c:
	    More of wrong return code hunting.
	    It turns out, that reopening has been done without
	    resetting MX index, and that omission caused in some
	    case at some targets the reopen to fail with fatal
	    error code.

2003-11-07  Matti Aarnio  <mea@zmailer.org>

	* transports/smtp/smtp.c, transports/smtp/smtp.h:
	    Tracked connection restart problems, specifically against
	    HOTMAIL, which runs things in highly questionable manner,
	    but that may happen with other systems, too.
	    (Apparently HM hangs up the inbound smtp connection
	    right after receiving end of previous message.)

	* compat/sendmail/sendmail.c, smtpserver/smtpserver.h,
	  smtpserver/smtpserver.c, smtpserver/smtpcmds.c:
	    - When 'sendmail' is called with '-bs' option, let it
	      call the subsequently started  smtpserver as:
	      "sendmail-smtp-in".
	    - Don't call policy database functions, when the program
	      isn't being run under a network socket.

2003-11-07  Eugene Crosser  <crosser@rol.ru>
             
	* proto/cf/aliases.cf:
	     Define "sysuser" variable that is either "user" or
	     "user@domain". Use this as argument to 'homedirectory' and
	     'login2uid' functions that ultimately call getpwnam()

	* proto/cf/server.cf:
	    Strip off domain part of "user" variable only if getpwnam()
	    is not domain-aware.  As far as I can tell, this variable  
	    is unly used in 'login2uid' and 'fullname' functions.

	* transports/mailbox/fmtmbox.c:
	    If getpwnam() is domain-aware, pwd->pw_name may contain
	    username@domain; but we need to compute hash of local part
	    only, because otherwise hash("user@mydomain.com") and
	    hash("user") would differ, and "defaultdomain" feature would
	    break.  "address" is always the local part (domain has been 
	    cut off before).

	* transports/mailbox/mailbox.c:
	    If DOMAIN_AWARE_GETPWNAM=1, do not rfc822localize() the user,
	    just strip off quotes in case they are present (no syntax 
	    check here, just delete any double quote that is not
	    backslash-escaped).  Thus further zgetpwnam() will be called
	    on user with domain.

2003-11-06  Matti Aarnio  <mea@zmailer.org>

	* smtpserver/mxverify.c, smtpserver/policytest.c:
	    More of Mariano's question analysis.
	    Found out that I were slightly too paranoid about
	    T_TXT object length, and actually cut back one char
	    from all objects.  Now will log lookup results
	    into smtpserver's commentary side-stream.

	* smtpserver/mxverify.c, smtpserver/policytest.c:
	    Mariano Absatz wanted DNS RBL tests (results, at least)
	    to be logged into smtpserve log.

	* smtpserver/readpolicy.c:
	    Looked deeper into policy database compilation process.
	    Behold; sysadmin can create attributes that are TOO LONG.
	    Now the sysadmin can't.  Pattern compilation will fail
	    at such.

2003-11-05  Andrey Blochintsev <bag@iptelecom.net.ua>

	* smtpserver/readpolicy.c:
	    Allow '_' prefixed user names to be used.

2003-11-04  Matti Aarnio  <mea@zmailer.org>

	* router/daemonsub.c:
	    Well, things weren't proper for tasks in the primary router
	    directory.  My testing was with alternates...

	* smtpserver/policytest.c:
	    Roy Bixler reported that his smtpserver does hang up
	    when processing (rather long) DNS BL datasets.
	    It turned out that policy compiler uses unsigned char
	    for various things, including attribute length (thus
	    up to 255-2 is ok for an attribute data), but my interpreter
	    referred to it as signed char, and things larger than 127
	    became negative in length all the sudden...

	* configure.in, SiteConfig.in:
	    From Eugene Crosser:  Configure system-wide  SYSLOGFLG=,
	    SNMPSHAREDFILE=, and  DOMAIN_AWARE_GETPWNAM= ZENV variables.

	* configure.in:
	    Test and determine, how one can find out the FD associated
	    with  opendir() target object. To be used in  router process,
	    when a   fchdir()  is needed.

	* libc/mail.c, libc/sfmail.c:
	    A wee bit of adaptations to compile the beast in Windows
	    (cygwin, that is..)

	* proto/cf/process.cf, router/daemonsub.c, router/rfc822.c:
	    Support input files going into ROUTERDIRHASH= sublevel,
	    and don't do unnecessary rename()s if the original file
	    has proper name ( = i-node number in decimal ) already.
	    The   process   function may get scalled as:
	      process B/123456
	    which is now perfectly legal.
	    NOTE: The daemon subsystem will do file locking on the
	    original file for the duration of file staying in the
	    processing!

2003-10-26  Matti Aarnio  <mea@zmailer.org>

	* router/libdb/ldap.c:
	    Patches to support LDAPv3 (via option setting)
	    thru a  "protocol 3" line in the configuration file.

2003-10-07  Matti Aarnio  <mea@zmailer.org>

	* transports/smtp/smtptls.c:
	    In some rare occasions the discipline processor loops
	    forever in errno processing, when it has received an
	    EINTR during a syscall.

2003-10-03  Matti Aarnio  <mea@zmailer.org>

	* smtpserver/smtpserver.c:
	    Compressed logged commentary lines a bit.
	    Remote host reversed name, and its actual IP address
	    are listed in same line.

2003-10-01  Matti Aarnio  <mea@zmailer.org>

	* smtpserver/smtpcmds.c:
	    When outputing commentary data to spool file, quote
	    all chars outside normal printable ASCII range, and
	    some inside it...

2003-09-27  Matti Aarnio  <mea@zmailer.org>

	* configure.in:
	    Changed the  --without-ldap   to   --with-ldap
	    and worked a bit in other internal related things.

2003-09-26  Matti Aarnio  <mea@zmailer.org>

	* include/mail.h.in, libc/mail.c, libc/sfmail.c:
	    New variants of *mail_close*() functions, now
	    can control the asynchronity of the close()
	    thing.  Essentially controlling use of  fsync(2)
	    on outgoing spool file descriptor.

	* man/scheduler.8.in, proto/scheduler.conf.in,
	  scheduler/msgerror.c, scheduler/prototypes.h,
	  scheduler/readconfig.c, scheduler/scheduler.c:
	    Added  "PARAMmsgwriteasync = 1" option that
	    can control the asynchronity in mail.c/sfmail.c
	    library routines.

	 * transports/smtp/smtp.c, man/smtp.8.in:
	     From Andrey Blochintsev <bag@iptelecom.net.ua> an option
	     to allow connection to IP addresses of the same host.

2003-09-25  Matti Aarnio  <mea@zmailer.org>

	* configure.in, router/db.c, router/libdb/gdbm.c,
	  router/libdb/ldap.c:
	    - A bunch of "--without-*" things:
	    	    --without-ndbm
		    --without-gdbm
		    --without-ldap
	      To disable some autodetections.
	    - Removed traces of SDBM autoconfig;
	      a once-upon-a-time replacement for NDBM.

	* smtpserver/smtpcmds.c:
	    When reporting various rejections, do report also
	    peer IP address.  This to help some analysis, and
	    to some extent, to help users.

	* configure.in:
	    - Default builtin value for SCHEDULEROPTIONS is
	      now changed to  "-S -H".
	    - Fixed a missing comma from  --with-perl-installdirs
	      option parameter processing.
	    - Added some AC_MSG_RESULT()s about NDBM library
	      pickup processing.

	* proto/cf/fqdnaliases.cf:
	    One instance of  $(listexpand .. ) call needed
	    "-N -" parameter as not to do DSN expansions.

	* proto/forms/delivery
	    - Added "ADR Bcc: <nobody>" to drain  errors-on-error
	      reports.
	    - Made small URL change

	* utils/perl/Makefile.in:
	    Removed (from 'install' target) explicite PREFIX=
	    value setup. Possible PREFIX= value can be set
	    thru configure time  --with-perl-installdirs="..."
	    parameter.

2003-09-09  Matti Aarnio  <mea@zmailer.org>

	* configure.in, utils/perl/Makefile.in:
	    have  --with-perl-includedirs="INCLUDEDIRS=vendor"
	    option at configure time.  It seems to be usefull
	    (or at least working) thing at RedHats, but the same
	    doesn't hold true with all other perl environments
	    that I use...

2003-09-08  Matti Aarnio  <mea@zmailer.org>

	* man/Makefile.in:
	    Replaced (in 'make install' target) literal
	    'zm' suffix in files with '$Z' substitution.

	* man/aliases.5.in, man/newaliases.1.in,
	  man/smtpserver.8.in:
	    Man-page text updates.

2003-09-05  Matti Aarnio  <mea@zmailer.org>

	* transports/smtp/smtp.c:
	    Patch from Jerzy Sobczyk about outgoing SMTP not
	    always honouring '-h' option set local hostname
	    in outbound EHLO/HELO greetings.

2003-09-03  Matti Aarnio  <mea@zmailer.org>

	* smtpserver/contentpolicy.c:
	    Patch from Eugene Crosser to run be able to run
	    content-filter as an AF_UNIX socket server.

2003-09-02  Matti Aarnio  <mea@zmailer.org>

	* transports/smtp/appendlet.c:
	    Oops, readalready processing bug.

	* transports/sm/sm.c, transports/mailbox/mailbox.c:
	    Code rearrangements during verification job that
	    similar bugs don't exist as in appendlet..

2003-09-01  Matti Aarnio  <mea@zmailer.org>

	* scheduler/prototypes.h:
	    Change 'const char *log;' to 'const char *logfn;'

	* utils/perl/Makefile.in:
	    Deeper study of what to do in perl module compilation.
	    Now  "make install DESTDIR=.." parameter should have
	    real effect in the underlying  Makefile.PL  files.

	* transports/libta/ctlopen.c:
	    One test of  ta_use_mmap  was slightly wrong, and
	    end result was faulty  let_buffer()  initialization.

2003-08-29  Matti Aarnio  <mea@zmailer.org>

	* debian/*
	    Debian packet builder scripts from 
	    Xose Vazquez Perez <xose@wanadoo.es>

	* include/libz.h, lib/zgetbindaddr.c, scheduler/transport.c,
	  smtpserver/smtpserver.c, smtpserver/smtpserver.h,
	  smtpserver/cfgread.c, transports/smtp/smtp.c:
	    Added third parameter into  zgetbindaddr()  function,
	    namely: what address family should be used ?
	    Entry parameter is: AF_INET / AF_INET6 (0 == AF_INET)
	    That is needed for  "iface:..." binding mode.

	* utils/smtpserver-log-parser.pl.in:
	    Found a bug in the 'pid-parser', changed the RE patterns,
	    and system that formerly leaked a lot of memory does now
	    only a little bit..

	* man/scheduler.8.in:
	    Fixed a typo in  PARAMauthfile= document.

	* proto/smtpserver.conf.in:
	    Documentary comment changes in the end of the file
	    in the 'style-flags' section.

2003-08-28  Matti Aarnio  <mea@zmailer.org>

	* man/Makefile.in, SiteConfig.in, man/zmailer-conf-generate.pl,
	  man/mailq-m-generate-pl:
	    New generator (zmailer.conf.5zm), and typo fix in the old.
	    Also source changes in SiteConfig.in  which is used as
	    input for the  zmailer.conf.5zm  file.

	* configure.in, transports/libta/ctlopen.c, SiteConfig.in:
	    Change the  --with-ta-mmap  to control what  SiteConfig
	    file (and thus  zmailer.conf  file) gets about TA_USE_MMAP=
	    variable value.

	* man/*:
	    Massive rework of man-pages; all cross-references will
	    be using suffix names like:  (8zm).  Man-sections got
	    "zm" tagged to them to ease the placement into various
	    systems, like with 'inn' that has 'sm.8' ...

	* smtpserver/contentpolicy.c, smtpserver/smtpdata.c:
	    - Typo in debug texts of contentpolicy filter harness.
	    - Small default-text code rearrangements in smtpdata.c

	* man/man-to-html.sh:
	    Apparently we can be without 'groff -c' option, and still not
	    get colour output to produced HTML..   Oh yes, that was when
	    using '-Thtml' output driver.  Present HTML generation uses
	    '-Tascii' and magic state processor to convert produced
	    (with occasional escapes) text file into fixed width courier
	    font HTML.

2003-08-26  Matti Aarnio  <mea@zmailer.org>

	* proto/smtpserver.conf, smtpserver/smtpcmds.c:
	    In prototype smtpserver.conf: comment away 'localhost'
	    case with 'f' and 't' flags.  People do get surprises
	    when using those, and skipping some notes in INSTALL.
	    ALSO: Made 'enable_router' to semi-silently to control
	    even looking into router controlling flags.  If router
	    is not enabled, it is not complained about.

	* SiteConfig.in,  include/ta.h, transports/libta/ctlopen.c,
	  transports/libta/lockaddr.c, transports/mailbox/mailbox.c,
	  transports/sm/sm.c, transports/smtp/smtp.h,
	  transports/smtp/smtp.c, transports/smtp/appendlet.c:
	    Changed compile time configured  TA_USE_MMAP  feature
	    to runtime configured  ZENV variable  TA_USE_MMAP,
	    whose existence uses the thing, and nonexistence
	    does read message into limited size internal buffer...
	    ACTUALLY TESTED CODES ARE: 'mailbox' AND 'smtp'.
	    THE 'sm' IS NOT TESTED AT THIS POINT!

2003-08-25  Matti Aarnio  <mea@zmailer.org>

	* utils/makedb/makedb.c, utils/policy-builder.sh.in:
	    Code crashed in case the input wasn't like it was wanted..
	    Oops.

	* smtpserver/policytest.c, doc/guides/smtp-policy,
	  man/smtpserver.8.in, proto/db/smtp-policy.src:
	    Document editing, and at policytest.c: localizing
	    pbuf[] variable to its actual use.
	  
	* transports/smtp/smtp.c:
	    Conditionalize one ESMTP_STARTTLS referral, that
	    was added recently.

2003-08-22  Matti Aarnio  <mea@zmailer.org>

	* proto/db/smtp-policy.src:
	    Couple comments on input syntax.

	* utils/policy-builder.sh.in, utils/makedb/makedb.c:
	    "makedb -p" crashed in some situations, fixed
	    NULL referral.  Also report about exit code of
	    the makedb  in  policy-builder.sh  script.

	* configure.in:
	    Version 2.99.56.pre9

	* smtpserver/smtpserver.h, smtpserver/cfgread.c,
	  smtpserver/contentpolicy.c, smtpserver/smtpdata.c,
	  man/smtpserver.8.in:
	    Support multiline replies from the content-policy program.
	    Separator in between lines is '\r' (CR) character!

	* Makefile.in:
	    Added target "make autoconf" -- to help myself...

2003-08-22  gettextize  <bug-gnu-gettext@gnu.org> / Matti Aarnio

	* configure.in (AC_CONFIG_FILES), aclocal.m4, config.sub,
	  config.guess. config.rpath, include/gettext.h, po/*, m4/*
	  ABOUT-NLS, intl/*:
	    Ran  "gettextize --c --intl", and did what it told to do.
	    Introduced also m4/ directory.

2003-08-21  Matti Aarnio  <mea@zmailer.org>

	* smtpserver/contentpolicy.c:
	    One extra newline in comment logging into a file.

	* transports/mailbox/mailbox.c:
	    Didn't always yield diagnostics for the outgoing
	    messages.  My bad..  (EDQUOT processing in particular.)

	* transports/libta/diagnostic.c, include/ta.h:
	    Make sure we always have NOTARY 'action' value
	    set for something!

2003-08-20  Matti Aarnio  <mea@zmailer.org>

	* libc/Makefile.in, libresolv/Makefile.in, man/Makefile.in,
	  utils/Makefile.in, utils/makedb/Makefile.in,
	  utils/mxverify/Makefile.in, utils/perl/Makefile.in,
	  utils/vacation/Makefile.in:
	    DESTDIR= defined where it overrides inherited
	    thing from environment.  Don't define it!

2003-08-19  Matti Aarnio  <mea@zmailer.org>

	* smtpserver/smtpserver.c:
	    Moving variable 'int s' into places where
	    it is actually used.

2003-08-15  Matti Aarnio  <mea@zmailer.org>

	* sfio2002/*
	    Removing the entire tree, won't be using that one,
	    way too much demanding stuff, like threads...

	* man/smtpserver.8.in, smtpserver/cfgread.c,
	  smtpserver/smtpauth.c, smtpserver/smtpserver.h:
	    A bit more of SASL related things.
	    Added "PARAM sasl-mechanisms ...", copied a bit
	    more of sendmail code into here, and used it.
	    Still my tests failed to login...

	* scheduler/scheduler.c:
	    Jerzy Sobczyk reported bug in 'Z' option processing

	* smtpserver/smtpserver.c, smtpserver/smtpauth.c,
	  smtpserver/smtpserver.h,  man/smtpserver.8.in,
	  proto/smtpserver.conf.in, smtpserver/Makefile.in,
	  smtpserver/cfgread.c:
	    Complete the  Cyrus-SASL-2  code integration,
	    quite experimental yet!
	    In early tests the SASL library appears to use
	    /dev/random,  which is very bad news...

	* smtpserver/smtpserver.h, smtpserver/smtpserver.c,
	  smtpserver/cfgread.c, man/smtpserver.8.in:
	    Support multiple instances of  "PARAM BindAddr"
	    Also massive code rearrangement around the primary
	    accept() call.

	* smtpserver/smtpdata.c:
	    Use  smtp_tarpit()  calls instead of local own response
	    delayer..

	* include/policy.h, smtpserver/readpolicy.c,
	  smtpserver/policytest.c, smtpserver/policytest.h,
	  smtpserver/smtpserver.c, smtpserver/smtpserver.h:	  
	    Eugene Crosser's IP source configurable maxparallelipconnects

	* proto/zmailer.sh.in:
	    Couple typos in -Z/--zconfig parameter passing

	* router/db.c, router/libdb/ldap.c, configure.in:
	    Synced to be in par with OpenLDAP 2.1.25, should also
	    work with older ones.

	* proto/cf/aliases.cf, proto/cf/fqdnaliases.cf:
	    Support (convert!)  (.+)--(.*)  in place of  ([^+]+)\+(.*)

	* scheduler/scheduler.c:
	    Move the first getzenv() call to be after readzenv() call,
	    if any.

	* smtpserver/rfc821scn.c:
	    Comment away an unused variable.

2003-07-23  Matti Aarnio  <mea@zmailer.org>

	* scheduler/scheduler.c:
	    Found a likely reason for scheduler's file descriptor
	    leakage..    The sfio-package does something wrong in
	    odd case used in log-file re-opening, and filehandle
	    recycling.

	* scheduler/scheduler.c:
	    Don't unlink the message file in case its opening fails.
	    (Like when scheduler/system has ran out of fd's)

	* scheduler/mailq.c:
	    Count also files in the $POSTOFFICE/queue/, and show it,
	    if it
	
	    _differs_ from  $POSTOFFICE/transport/  count.
	    Changed also slightly the output texts, which _MAY_
	    affect some management scripts!

2003-07-01  Matti Aarnio  <mea@zmailer.org>

	* doc/guides/smtp-policy, proto/smtpserver.conf.in,
	  proto/db/smtp-policy.src:
	    Typo fixes

	* transports/libta/ctlopen.c, transports/libta/mimeheaders.c,
	  transports/smtp/smtp.c:
	    Semi-meaningless changes to assist trace debugging of
	    memory leaks.  No idea if that finds my last 1-2 % of
	    memory leaks that I still see...

2003-06-27  Matti Aarnio  <mea@zmailer.org>

	* README.LICENSES, LICENSES/README, LICENSES/ARTISTIC,
	  LICENSES/BSD, LICENSES/GPL-2, LICENSES/LGPL-2:
	    Clarifying the license issues of ZMailer.

2003-06-25  Matti Aarnio  <mea@zmailer.org>

	* configure.in:
	    Changed version number to more RPM-friendly one, e.g. no
	    hyphen in it.

	* transports/smtp/smtp.c:
	    The  getmxrr()  calls in cname_lookup() did leak AI and NAME
	    objects.  Freeing collected (and unneeded) data there.

2003-06-24  Matti Aarnio  <mea@zmailer.org>

	* configure.in, scheduler/mailq.inc, scheduler/mailq.c,
	  scheduler/mq2.c:
	    Auto-config test to find  getloadavg()  function
	    (BSD, Solaris 8, Linux, ... a de-facto API for this
	    data, in libc !)  and to print  1 and 5 minute
	    load-averages into the scheduler's "mailq -M"
	    report.

	* transports/libta/diagnostic.c, transports/smtp/getmxrr.c:
	    Moving variable declarations around a bit, and not doing
	    initializations for NULLs/zeroes, thus letting things
	    to be placed into BSS instead of initialized read/write
	    data segment.

2003-06-22  Matti Aarnio  <mea@zmailer.org>

	* transports/libta/mimeheaders.c:
	    Last detected memory leak in header parsers.

2003-06-21  Matti Aarnio  <mea@zmailer.org>

	* include/ta.h, transports/libta/ctlopen.c,
	  transports/libta/diagnostic.c, transports/libta/mimeheaders.c:
	    More memory leak tracking related work.  Most fumbling in
	    the dark, I am afraid..

2003-06-20  Matti Aarnio  <mea@zmailer.org>

	* include/ta.h, transports/libta/ctlopen.c,
	  transports/libta/Makefile.in, transports/sm/sm.c,
	  transports/smtp/smtp.c, transports/mailbox/mailbox.c,
	  transports/hold/hold.c, transports/errormail/errormail.c,
	  transports/expirer/expirer.c, transports/reroute/reroute.c:
	    Removed  rp->routermxes  field, data format parsing, and
	    support calls for it from system.  It never materialized
	    fully, and is weaker method, than original (not materialized
	    either) X-or recipient addresses..

	* transports/mailbox/mailbox.c, transports/sm/sm.c,
	  transports/smtp/appendlet.c:
	    Still tracking memory leaks.  Apparently the SFIO library
	    doesn't free up memory in all cases.  Namely  sfnew()
	    call has a bit of problems, especially when  sfdisc() sets
	    processing discipline, and likely reallocs buffer..
	    Now altering code to use heap based static buffers.
	
2003-06-19  Matti Aarnio  <mea@zmailer.org>

	* router/rfc822.c, router/functions.c:
	    - Removing dead code (lots of it)
	    - Reworked a bit the  reject()  function address processing,
	      now also the originally intended error recipient will
	      receive the message. (Thanks to Peter Ip to raise my
	      attention at it.)
	    - All router internal  mail_open()  calls are wrapped with
	      runastrusteduser()/runasrootuser() calls, so that created
	      message file's owner will be 'trusted'.  Is THAT an ok
	      thing in all situations ?  No definite idea...

	* proto/cf/standard.cf:
	    Rearranged the list of known top-level domains, and added
	    'info', 'biz', 'name', 'eu'.
	
	* transports/mailbox/mailbox.c, transports/libta/mimeheaders.c,
	  transports/libta/ctlopen.c:
	    Been hunting memory leaks...  Have found a bunch more..

	* transports/smtp/smtptls.c:
	    When there was no logging file of any kind, this used to
	    send TLS related diagnostics to the scheduler's log, which
	    didn't work very nicely in one of my systems..
	    Now changed so that if there is verbose-log, printouts
	    go there, and independent of that, if there is smtp
	    transport-agent log,  printouts go also there.
	    If there are neither, nothing is printed.

2003-06-17  Matti Aarnio  <mea@zmailer.org>

	* smtpserver/policytest.c:
	    If MAIL FROM test had  'rejectsource -' and/or
	    'freezesource -'  attributes in  'user@do.main'
	    lookup, disable lookups of those same things from
	    fallbacks of 'do.main'  lookup.

	* transports/mailbox/mailbox.c, transports/libta/mimeheaders.c,
	  include/ta.h, transports/smtp/smtp.c:
	    Track a bit more of allocated memory chunks, and provide
	    explicite free() routines for them. (Hunting originally
	    memory leaks in  mailbox.)

	* transports/mailbox/mailbox.c, man/mailbox.8.in:
	    Added option "-F edquot"  to instantly fatalify quota-exceed
	    condition of the baseline code.

	* libc/getaddrinfo-test.c:
	    Another test-harness..

2003-06-09  Matti Aarnio  <mea@zmailer.org>

	* configure.in:
	    Mark version 2.99.56-pre7

	* include/libz.h, include/shmmib.h, lib/fdstatfs-test.c,
	  lib/fdstatfs.c, lib/zshmmibattach.c, router/daemonsub.c,
	  scheduler/mailq.inc, scheduler/scheduler.c,
	  smtpserver/smtpcmds.c, smtpserver/smtpdata.c,
	  smtpserver/smtpserver.h:
	    - When wanting to add used spool space gauges into
	      SHM segment header, realized that it does not have
	      32 spare uint variables..  Oops..  Had to change
	      block layout -> new MAGIC, full rearrancement of all
	      so far accumulated small counters, etc..
	    - renamed  fd_statfs()  into  free_fd_statfs(), and
	      added a cousin for it:  used_fd_statfs().  Both return
	      space in kilobytes (e.g. can describe up to 2 TB...)
	    - Removed  RT.StoredRecipients  gauge, which the router
	      can't maintain anyway.

	* lib/fdstatfs.c, lib/zshmmibattach.c, scheduler/scheduler.c,
	  smtpserver/smtpserver.h, smtpserver/smtpcmds.c,
	  smtpserver/smtpdata.c, smtpserver/smtpserver.c:
	    Changed the  fd_statfs()  to report KILOBYTES of free space,
	    while still returning it via mere 'long' variable in all
	    systems (e.g. may have limit of LONG_MAX a.k.a. around 2 G,
	    which in kilobytes means: around 2 Terabytes ..)
	    Also re-juggled codes using this free-space data.

	* man/Makefile.in, man/mailq-m-generate.pl, scheduler/mailq.inc,
	  man/man-to-html.sh, man/mailq.1.in:
	    Generating "mailq-m(5)" man-page from within mailq.inc
	    stored XMLish comments.

	* include/shmmib.h, router/daemonsub.c, router/rfc822.c,
	  smtpserver/smtpserver.c, smtpsserver/smtpdata.c:
	    - Count router process faults explicitely
	    - Let smtpserver to count attempted incoming recipients
	      (similarly with ss.ReceivedMessages counter)
	    - Let smtpserver to count instances, when arriving
	      connection has been summarily closed due to too high
	      a load.  (Limit criterias are PARAM parametrizable.)
	    - Track router actual job processing instances failing
	      somehow, and count those separately. 

2003-06-05  Matti Aarnio  <mea@zmailer.org>

	* scheduler/mailq.inc:
	    Print added seen EHLO-capability counters, and sent SMTP
	    options counters.

2003-06-04  Matti Aarnio  <mea@zmailer.org>

	* include/shmmib.h, smtpserver/smtpcmds.c,
	  transports/smtp/smtp.c:
	    Count several ESMTP options seen, (and used) by the smtp-ta,
	    and used by the smtp clients.

	* include/shmmib.h, scheduler/mailq.inc, smtpserver/smtptls.c,
	  transports/mailbox/mailbox.c, transports/smtp/smtp.c,
	  transports/hold/hold.c, transports/errormail/errormail.c,
	  transports/sm/sm.c, transports/expirer/expirer.c,
	  transports/reroute/reroute.c:
	    Changed names of a number of variables, and added basic
	    counters into all transport agents, which didn't have
	    anything.

	* Makefile.in, compat/Makefile.in, doc/Makefile.in,
	  lib/Makefile.in, libc/Makefile.in, libident/Makefile.in,
	  libmalloc/Makefile.in, libresolv/Makefile.in, libs/Makefile.in,
	  libsh/Makefile.in, man/Makefile.in, proto/Makefile.in,
	  router/Makefile.in, scheduler/Makefile.in, sfio/Makefile.in,
	  smtpserver/Makefile.in, ssl/Makefile.in,  utils/Makefile.in,
	  transports/Makefile.in:
	    "make mostlyclean" -- clean everything except SFIO library.
	    (Which is stand-alone in itself..)  This is side-result from
	    SHMMIB-block tunings.

	* configure.in, proto/zmailer.sh.in, transports/sm/sm.c,
	  transports/smtp/smtp.h, transports/smtp/smtp.c,
	  transports/mailbox/mailbox.c:
	    While going over some unrelated things, spotted
	    mentions about mailbox "From " header syntax details.
	    Its presumed syntax is very particular, and needs
	    care with correct values.  Particular danger is of
	    getting some odd system-wide locale setting to wreck
	    proper date presentation rules.  Best solution would
	    most likely be to open-code the presentation of time,
	    instead of using  ctime(3), but ...

2003-06-02  Matti Aarnio  <mea@zmailer.org>

	* transports/smtp/smtp.c:
	    Wondering, if we are sometimes missing closing of
	    smtp sessions in SMTP transport agents.  Just in case
	    we do, added an   atexit()  mechanism to handle it.
	    Latter experiments of shutting down the scheduler, and
	    observing that eventually the outgoing socket gauges
	    do go to zero..  all is thus well.

2003-05-30  Matti Aarnio  <mea@zmailer.org>

	* scheduler/mailq.c:
	    Just before closing the MAILQ-v2 command socket, do
	    send there "QUIT\n" command too!  Sure the EOF handles
	    the cleanup too, but ...

	* scheduler/mq2.c, scheduler/mailq.pl, scheduler/update.c:
	    Andrey Blochintsev <bag@iptelecom.net.ua>  sent patch
	    to implement "KILL MSG" type functionality via the MAILQ-v2
	    socket command.  Client to implement it is in (surprise),
	    the perl-testbench of MQ2...  Yours Truly did small style
	    edits (like C99/C++ style "//" comment change to "/*" )

2003-05-29  Matti Aarnio  <mea@zmailer.org>

	* include/shmmib.h, scheduler/scheduler.c, scheduler/mailq.inc:
	    Count for scheduler's time-server starts, and last
	    start-time.

	* transports/smtp/smtp.c:
	    Count pipelining transmits only when doing connection
	    open, not for every sent message...

2003-05-27  Matti Aarnio  <mea@zmailer.org>

	* smtpserver/smtpdata.c:
	    Examples in RFC 2034 weren't the best possible, practice has
	    shown, that "250 2.6.0 .." isn't quite what is intended.
	    Sending now (like sendmail) "250 2.0.0 ..."

	* include/shmmib.h, scheduler/Makefile.in, scheduler/mailq.inc,
	  scheduler/scheduler.h, smtpserver/smtpcmds.c,
	  smtpserver/smtphelp.c, smtpserver/smtpserver.h,
	  smtpserver/smtpserver.c, transports/smtp/smtp.c:
	    More simpleish counters and gauges...

	* transports/smtp/smtp.c, include/shmmib.h, scheduler/mailq.inc:
	    Count outgoing sessions where we use PIPELINING.

	* scheduler/scheduler.c:
	    Fix the  LogFreeSpace-kB-G  to be filled (instead of
	    overwriting  SpoolFreeSpace-kB-G !)

	* include/shmmib.h, transports/smtp/smtp.c, scheduler/mailq.inc:
	    Added smtp TA process creation counter, and a gauge to
	    observe how many there are running in parallel.

2003-05-26  Matti Aarnio  <mea@zmailer.org>

	* bin/mkdep.in, bin/mklibdep.in, compat/rmail/Makefile.in,
	  compat/sendmail/Makefile.in, lib/Makefile.in,
	  libc/Makefile.in, libident/Makefile.in,
	  libresolv/Makefile.in, libsh/Makefile.in,
	  router/Makefile.in, router/libdb/Makefile.in,
	  scheduler/Makefile.in,  sfio/Makefile.in,
	  smtpserver/Makefile.in, transports/errormail/Makefile.in,
	  transports/expirer/Makefile.in,
	  transports/fuzzyalias/Makefile.in, transports/hold/Makefile.in,
	  transports/libta/Makefile.in, transports/mailbox/Makefile.in,
	  transports/reroute/Makefile.in, transports/sm/Makefile.in,
	  transports/smtp/Makefile.in, utils/makedb/Makefile.in,
	  utils/vacation/Makefile.in:
	    Fixed the "make depend" processing, now it works also when
	    compiling in "adjacent directory" (tested only in that,
	    though..)

	* include/libz.h, include/shmmib.h, lib/fdstatfs.c,
	  router/daemonsub.c, lib/zshmmibattach.c, router/rfc822.c,
	  scheduler/mailq.c, scheduler/mq2.c, scheduler/scheduler.c,
	  scheduler/threads.c, scheduler/transport.c, scheduler/update.c,
	  smtpserver/smtpchild.c, smtpserver/smtpcmds.c,
	  smtpserver/smtpdata.c, smtpserver/smtpetrn.c,
	  smtpserver/smtpserver.c, smtpserver/smtpserver.h,
	  smtpserver/smtptls.c, transports/smtp/smtp.c,
	  transports/smtp/smtp.h:
	    Reworked a bit more of the monitor counters and gauges.
	    (Actually a lot..  Added first glimmers even to SMTP-ta.)


2003-05-25  Matti Aarnio  <mea@zmailer.org>

	* smtpserver/smtpserver.c:
	    Account incoming SMTP protocol command lines, and
	    some part of bad inputs.

	* lib/zshmmibattach.c:
	    Fixes around the file locking mechanisms.
	    flock/fcntl/lockf supported.

	* scheduler/scheduler.c:
	    Fixed the StoredReceipients and ReceivedRecipients
	    accounting counters.  Primarily that gauge, secondarily
	    moved the received counter next to the gauge.
	    (The gauge was incrementing twice for each received
	    recipient, and decremented once for each sent ...)

	* router/rfc822.c:
	    Track the number of recipient addresses before routing
	    those addresses (and possibly expanding them).

2003-05-24  Matti Aarnio  <mea@zmailer.org>

	* include/shmmib.h, lib/zshmmibattach.c, router/daemonsub.c,
	  router/router.c, scheduler/mailq.c, scheduler/mq2.c,
	  scheduler/scheduler.c, scheduler/scheduler.h,
	  scheduler/threads.c, scheduler/transport.c, scheduler/update.c,
	  smtpserver/smtpchild.c, smtpserver/smtpserver.c,
	  smtpserver/smtpserver.h:
	    - Added fields of primary daemons start times, and counters
	      of how many times they have been started in this block..
	    - Fixed the scheduler process accounting, and for a good
	      measure, threw in thread, vertex, and recipient gauges.

	* utils/perl/Makefile.in:
	    As the "mailq" needs to be copied from its original location,
	    when processing building in "adjacent directory",
	    the "make clean"  will need to remove it under same
	    conditions.

	* router/router.c, router/daemonsub.c, scheduler/scheduler.c,
	  smtpserver/smtpserver.c:
	    Moved  Z_SHM_MIB_Attach()  into a place where these programs
	    have _not_yet_ detached themselves from the console, and will
	    loudly complain if the SHM attachement fails (presuming that
	    SNMPSHAREDFILE  ZENV variable is set at all.)

	* scheduler/mailq.c, scheduler/mq2.c, utils/perl/mailq/mailq.pm,
	  man/mailq.1.in:
	    A new primitive:  "SHOW COUNTERS", which can be invoked
	    with "mailq -QQQQ" and is same text as local memory attached
	    "mailq -M" -- but can be at remote system.

	* man/Makefile.in, man/man-to-html.sh, man/zmailer.3.in:
	    Using GNU Makefile "pattern rules" to do things that
	    had been open-coded into the makefile.  Also support
	    referring to  e.g.  ZMailer::mailq(3)  in hyperlinks.

	* configure.in, lib/zshmmibattach.c, include/libz.h,
	  scheduler/mailq.c:
	    Added test for <sys/file.h> header,  Added  flock()/lockf()
	    locking of the shared segment storage, and detailed error
	    status returning from Z_SHM_MIB_Attach() so that  "mailq -M"
	    can report what exactly happened, when things didn't work.

	* include/libz.h,  lib/zshmmibattach.c,  smtpserver/smtpdata.c,
	  scheduler/scheduler.c, smtpserver/smtpcmds.c, scheduler/mailq.c:
	    More text changes, implemented two instances of spool free
	    space gauge.  (That thing peaks at about 2 GB, only when
	    space goes BELOW it, there is a reason to watch for it..)

	* smtpserver/fdstatfs.c, smtpserver/fdstatfs-test.c,
	  smtpserver/Makefile.in, lib/fdstatfs.c, lib/fdstatfs-test.c,
	  lib/Makefile.in:
	    Moved the fdstatfs*.c files from one directory to another.
	    Did that also in CVS repository, and thus preserved revision
	    data..

	* scheduler/mailq.c:
	    More 'mailq -M' printouts.

	* include/shmmib.h, router/daemonsub.c, router/rfc822.c,
	  scheduler/scheduler.c, scheduler/transport.c,
	  smtpserver/smtpcmds.c, smtpserver/smtpdata.c,
	  smtpserver/smtpetrn.c, smtpserver/smtptls.c:
	    - New counter variables, changed the magic version
	      (mapping will be rejected if there is old persistent file
	       in the system!) 
	    - More code to do SHM counting/tracking

	* utils/webtools/mailq-m.php,  utils/webtools/mailq-q.php,
	  utils/webtools/mailq-v.php:
	    An experimental set of web-tools to do ZMailer status
	    display in web..  Developed for friends to look into
	    a busy system without using command-line tools..
	    Also as concepts for doing some advanced tinkering.

2003-05-23  Matti Aarnio  <mea@zmailer.org>

	* lib/zshmmibattach.c, include/libz.h, include/shmmib.h,
	  scheduler/scheduler.c, router/daemonsub.c, scheduler/update.c,
	  scheduler/threads.c, lib/Makefile.in, SiteConfig.in,
	  scheduler/mailq.c, man/mailq.1.in, router/router.c,
	  smtpserver/smtpserver.h, smtpserver/smtpchild.c,
	  smtpserver/smtpserver.c:
	    - Added new library function -- attach global
	      MTA-instance specific shared memory mapped file
	      to some particular running process.
	    - Added new counters and gauges, far in excess of
	      official RFC listed gauges..  SNMP shall coalesc
	      subsystem counters and gauges.
	    - Using this global shared segment for the time-server, too.

	* utils/perl/Makefile.in:
	    Doing "make clean" shall not crash even if previous
	    "make" hasn't been run in a subdirectory, where things
	    are done with 'Makefile.PL' way...

	* transports/smtp/smtp.c:
	    Additional "once" counter that breaks the loop, if
	    other ways don't stop it -- when doing "more recipients"
	    retry things.

2003-05-22  Matti Aarnio  <mea@zmailer.org>

	* configure.in, transports/smtp/smtp.h, transports/smtp/smtp.c:
	    Had a deeper look into "NAGLE" code, and realized that
	    we didn't  #include  <netinet/tcp.h>,  which carries the
	    necessary socket-option tokens,  thus no "NAGLE" control
	    was ever done.

	* sfio/bin/iffe, sfio/src/lib/sfio/Stdio_b/features/stdio,
	  sfio/src/lib/sfio/features/common, sfio/src/lib/sfio/features/sfio:
	    Picked the 'iffe' script from SFIO-2002, as well as
	    'features/sfio', and 'features/common', the 'features/stdio'
	    did need a bit of manual fixing, as there is no equivalent in
	    newer version.  (SFIO-2002 usage is -- seriously in doubt
	    due to its overflowing of thread stuff.)

2003-05-21  Matti Aarnio  <mea@zmailer.org>

	* smtpserver/smtprouter.c:
	    When encountering "*INTERNAL*ERROR*" do report with '400'
	    status, instead of '500' status...

	* proto/db/smtp-policy.src:
	    In boilerplate texts, say "Your address is not liked .."
	    instead of "Your domain is not liked ..".

	* transports/smtp/smtp.c:
	    The SMTP "NOOP" shall timeout in 30 seconds..
	    Otherwise it lingers around with DOT-timeout (20 minutes)..
	    Also report this process state in proctitle data.

	* transports/smtp/smtp.c:
	    In EZMLM mode the SMTP TA didn't unlock all recipients,
	    which did cause considerable amount of  "#resync" activity
	    in between the scheduler, and SMTP TA.
	    Replaced a ton of 'return's with 'goto more_recipients;'
	    in order to coherently handle the EZMLM mode in all of
	    its forms.  Also unbroke the rp-chain (which is broken in
	    EZMLM detection)

	* sfio/src/lib/sfio/sfsetbuf.c, sfio/src/lib/sfio/sftable.c,
	  sfio/src/lib/sfio/sfvprintf.c, sfio/src/lib/sfio/Sfio_dc/sfdcdio.c:
	    Small fixes to silence the compilation warnings.

	* scheduler/scheduler.c, scheduler/update.c:
	    Moved  global_wrkcnt,  and  MIBMtaEntry->mtaStoredMessages
	    counter managements around so that they are essentially
	    tracking on how many memory instances there are of the
	    'struct ctlfile' objects.  Strictly speaking this isn't
	    the same as count of jobs, but a lot simpler to do..

	* scheduler/update.c:
	    When reporting 'multiple processing of address ...',
	    do mention also channel & host data for the _process_
	    which is reporting.

2003-05-20  Matti Aarnio  <mea@zmailer.org>

	* configure.in:
	    Mark version: 2.99.56-pre6

	* router/rfc822.c:
	    Eugene Crosser reported that envelope header
	    "with" without a value does cause router process
	    to drop core.  Indeed it does that.  Oops.
	    (denial of service attack is possible from
	    inside the system.)

	* man/smtpserver.8.in, man/zmailer.3.in:
	    Reworked/updated environment variable pickups of these
	    programs.

	* smtpserver/smtptls.c:
	    Instead of picking the POSTOFFICE location all by itself,
	    use smtpserver process global value.

	* smtpserver/smtpserver.c:
	    Andrey Blochintsev <bag@iptelecom.net.ua>  sent
	    a patch to move  WHOSON  lookup upwards a bit
	    so that the data is available, when it is being
	    logged.

	* INSTALL:
	    Updated to match the reality a bit better, than
	    what it has been for a long time...

2003-05-15  Matti Aarnio  <mea@zmailer.org>

	* smtpserver/contentpolicy.c, smtpserver/smtprouter.c,
	  smtpserver/smtpserver.c, smtpserver/smtpserver.h:
	    From  Andrey Blochintsev <bag@iptelecom.net.ua>
	    spotted process deaths by NULL pointer referral
	    during state cleanup.

	* transports/mailbox/mailbox.c:
	    Turning EDQUOT failure to instant permanent failure.

2003-05-13  Matti Aarnio  <mea@zmailer.org>

	* smtpserver/policytest.c, smtpserver/smtpserver.c:
	    Removed  printf()s  from policy-test debug outputs,
	    and use  type()  instead.

	* smtpserver/policytest.c, proto/db/smtp-policy.src,
	  doc/guides/smtp-policy:
	    From  Andrey Blochintsev <bag@iptelecom.net.ua>
	    a bit more code, and commentary updates in boilerplate.

	* transports/smtp/smtptls.c:
	    Oops, when "HAVE_OPENSSL" is inactive, still supply
	    msg_info() function to be used, as well as  FILE *vlog.

	* libc/strsignal.c:
	    Matching tests with earlier autoconf rewrites

	* configure.in, man/Makefile.in, man/*:
	    Changed ALL man-page files to be autoconf generated
	    so that @MAILBIN@ substitutions (et.al.) can be
	    done into the files.  (Also renamed files in the
	    CVS repository to reflect changed names in order
	    to preserve the change history.)

	* proto/post-install.sh.in:
	    Added '--destdir' option.

	* Makefile.in:
	    DESTDIR value dependent reminder notes referring to
	    "postinstall" tool.

2003-05-10  Matti Aarnio  <mea@zmailer.org>

	* transports/smtp/smtp.c:
	    Increase the timeout_data to 5 minutes by default to
	    match timeout_cmd -- in PIPELINING mode we had a bit
	    too low timeouts..

	* proto/scheduler.conf.in:
	    By default, comment away the "ageorder" flag.
	    When a troublesome message jams the queue, allow
	    the queue to be randomized so that the troublesome
	    message won't stay in its head.

	* smtpserver/policytest.c:
	    From  Andrey Blochintsev <bag@iptelecom.net.ua>:
	
    Is it possible to setup smtp-policy to block
    almost all mail (exept to: abuse@ or to: postmaster@)
    from some networks?

    It seems for me settings like:
	_rbl0          rcpt-dns-rbl      +:dul.maps.vix.com....
	_rbl1          test-rcpt-dns-rbl +
    doing that for RBL-listed network[s], but it is not possible
    to have analogous setup for locally listed (in smtp-policy.*)
    networks.

    The patch below solves this problem.
    To activete you need add rcpt-dns-rbl attributes starting
    with '_' ('_' symbol is not allowed in dns names).

    With this patch settings
	[10.10.10.25]/32      rcpt-dns-rbl "_+"
	[10.10.10.0]/24       rcpt-dns-rbl "_TEST reject msg"
	postmaster@my.domain = _full_rights
    means that:
    Mail from 10.10.10.0/24 to postmaster@my.domain -- accepted
         from 10.10.10.25 accepted/rejected by other rules (relaytarget +/- ...)
         from 10.10.10.0/24 to other will be rejected with
           "550 5.7.1 Policy analysis reported: TEST reject msg rcpt=<bag@i.kiev.ua>"
    diagnostic
	

2003-05-09  Matti Aarnio  <mea@zmailer.org>

	* libsh/io.h, libsh/io.h, libsh/builtins.c:
	    While trying to implement a sh_read(), with a lot less
	    incomprehensible code, had to introduce fgetc() redirecting.

	* proto/cf/fqdnalias.cf, proto/cf/aliases.cf, router/functions.c:
	    Correcting a bit of the 'listexpand'  treatment of DSN data
	    in expanded addresses.  When expanding thru LISTS, new ORCPT
	    (and new Return-Path) will result.on each recipient address,
	    but when expanding thru ALIASES (and .forward), ORCPT and
	    Return-Path will stay unmodified.
	    Disabled former (now unused)  "listaddresses"  function,
	    which does a small part of the job...

	* scheduler/scheduler.c:
	    Andrey Blochintsev reported typo in  setproctitle()
	    call.  (***BSD specific thing.)

	* proto/zmailer.sh.in:
	    Eino Tuominen spotted that I still have sloppy style to
	    write scripts without testing them before publishing..
	    ( e.g. users test :-/ )  Missing double-quote in one
	    sh embedded perl script.

	* proto/cf/fqdnalias.cf:
	    Modification typo lurked in the FQDN aliasing script.
	    OUTCH!  Found it when testing local virtualized email
	    service failing to failure, and producing 'deferred'
	    messages...

	* lib/sleepycatdb.c, smtpserver/policytest.c,
	  utils/makedb/dblook.c, utils/makedb/makedb.c:
	    Support compiling against SleepyCat DB 4.1
	    (the C-API has again been changed;  db->open()  got
	     additional parameters...)

2003-05-08  Matti Aarnio  <mea@zmailer.org>

	* libsh/builtins.c:
	    Debugging  sh_read()'s internal buffer
	    re-allocation/extension code.
	    Something is wrong in there, and it grows without bounds..

	* include/listutils.h, libsh/listmalloc.c, router/db.c:
	    "function with parameter that is a pointer to a function
	    with ..."     .. found correct thing.  I wish gcc would
	    tell as much as the Sun WorkShop C compiler tells...

	* configure.in, include/zresolv.h:
	    Solaris 2.6 oops.. u_int16_t isn't known type there..

	* transports/sm/sm.c, transports/mailbox/mailbox.c,
	  router/daemonsub.c, scheduler/transport.c,
	  smtpserver/smtpserver.c, smtpserver/smtpserver.h:
	    Worked over the  wait4()/wait3()/waitpid()/wait() usage.
	    Essentially addded  wait4()  to the mix.

	* configure.in, Makefile.in:
	   Syncing things to be in par with  autoconf 2.57, including
	   having it as a pre-req..  Also producing BUGREPORT and VERSION
	   literals from  configure.in  file !
	   

	* configure.in, smtpserver/smtpserver.c, scheduler/scheduler.c,
	  transports/smtp/smtp.c:
	    Andrey Blochintsev reports that FreeBSD 4.x needs
	    to use  setproctitle()  function.  Added autoconfig
	    tests for that.

	* lib/rfc822date.c:
	    Just to be on the safe side, enlarging some buffers,
	    and adding explicite sprintf() string lenth limits.

	* proto/zmailer.sh.in:
	    Refer to inlined perl-script executor with  @PERL@
	    autoconfig token.

	* proto/post-install.sh.in:
	    Typo fix in autoconf patterns.  Should actually rename
	    this either to 'post-install', or 'post-install.pl',
	    as it is a perl script...
	
	* lib/sleepycatdb.c:
	    Andrey Blochintsev reported that things didn't work quite
	    smoothly with only BSD DB 1.x in system. (No SleepyCat's
	    latter versions.)

	* scheduler/conf.c:
	    Lower the  global_report_interval  from 15 to 5 minutes.

2003-05-06  Matti Aarnio  <mea@zmailer.org>

	* lib/zgetbindaddr.c, transports/mailbox/mboxpath.c,
	  router/rtsyslog.c:
	    Looking deep into "gcc -Wall" diagnostic reports.
	    Added includes for missing prototype declarations.

	* router/libdb/bind.c, smtpserver/mxverify.c,
	  transports/libta/dnsgetrr.c, transports/smtp/getmxrr.c,
	  utils/mxverify/mxverify-cgi.c, include/zresolv.h:
	    Modern resolver libraries don't have  _getshort(), and
	    _getlong() as public prototyped entities.  Took model
	    off modern resolver libraries, and used macroes
	    NS_GET16() / NS_GET32() / NS_INT16SZ / NS_INT32SZ.
	    Where macroes are not available, supplying our own
	    versions.  Centralized all related defines.

	* proto/zmailer.sh.in:
	    Reworked  'resubmit'  command internal mechanism
	    to handle cases, where the 'deferred' directory
	    has thousands of messages.  A bit perl required..

	* lib/mail.c:
	    realloc()ing uninitialized variable -- OOPS!
	    (Since 2003-4-17)

	* INSTALL:
	    Small updates, more is needed...

	* Makefile.in, compat/rmail/Makefile.in,
	  compat/sendmail/Makefile.in, libc/Makefile.in,
	  man/Makefile.in, packaging/solaris/Makefile.in,
	  proto/Makefile.in, router/Makefile.in, scheduler/Makefile.in,
	  smtpserver/Makefile.in, transports/errormail/Makefile.in,
	  transports/expirer/Makefile.in,  utils/Makefile.in,
	  transports/fuzzyalias/Makefile.in, transports/hold/Makefile.in,
	  transports/mailbox/Makefile.in, transports/reroute/Makefile.in,
	  transports/sm/Makefile.in, transports/smtp/Makefile.in,
	  utils/makedb/Makefile.in, utils/mxverify/Makefile.in,
	  utils/perl/Makefile.in:
	    Rewriting the virtual-root installation support to use
	    "DESTDIR=" instead of "prefix=".  The Proper Way ...

	* include/mail.h.in, scheduler/readconfig.c,
	  scheduler/scheduler.c, smtpserver/debugreport.c,
	  transports/errormail/errormail.c, transports/expirer/expirer.c,
	  transports/hold/hold.c, transports/sm/sm.c,
	  transports/libta/lockaddr.c, transports/libta/tasysyslog.c,
	  transports/mailbox/mailbox.c, transports/reroute/reroute.c:
	    Further cleanup after inserting Eugene's patch-cluster.
	    Adding   #include "libc.h"  usually, and various other
	    merryments it involves.

2003-05-05  Matti Aarnio  <mea@zmailer.org>

	* SiteConfig.in, configure.in, include/libz.h,
	  scheduler/transport.c, smtpserver/cfgread.c,
	  transports/smtp/smtp.c, lib/Makefile.in,
	  lib/zgetbindaddr.c:
	    Patch cluster from Eugene Crosser to librarize common code,
	    and to introduce 'BINDADDR' ZENV variable.

	* compat/sendmail/sendmail.c:
	    If process environment has ZCONFIG variable set, does read
	    ZENV variables from that place.

	* proto/mailrm.sh.in, proto/newaliases.in,
	  proto/newfqdnaliases.in, proto/post-install.sh.in,
	  transports/expirer/manual-expirer.in,
	  transports/reroute/manual-rerouter.in,
	  utils/policy-builder.sh.in, utils/rotate-logs.sh.in,
	  utils/zmailer.init.sh.in:
	    Eugene Crosser noted, that not all scripts inherit / are
	    otherwise configurable to use alternate (than configured-in)
	    value of  ZCONFIG.

2003-05-02  Matti Aarnio  <mea@zmailer.org>

	* smtpserver/contentpolicy.c, smtpserver/readpolicy.c,
	  include/policy.h, smtpserver/policytest.c,
	  smtpserver/policytest.h, doc/guides/smtp-policy,
	  proto/db/smtp-policy.src:
	    Added 'filtering +' phrase to smtpserver's IP ADDRESS tests.

	* utils/perl/mailq/Makefile.PL, utils/perl/mailq/mailq.pm,
	  utils/perl/mailq/MANIFEST, utils/perl/mailq/README,
	  utils/perl/mailq/Changes, utils/perl/Makefile.in,
	  utils/Makefile.in, configure.in:
	    Made old perl-test tool into proper OO Perl code.
	    Requires perl 5.8. (I think).

	* scheduler/agenda.c, scheduler/msgerror.c, scheduler/threads.c,
	  scheduler/scheduler.c, scheduler/prototypes.h:
	    Debugging the long living thing where "mailq -Q" mode reports
	    negative counts for stored messages.  Apparently fixed it!
	    ( Didn't :-(  )

2003-05-01  Matti Aarnio  <mea@zmailer.org>

	* smtpserver/smtpserver.c, smtpserver/smtpserver.h,
	  man/smtpserver.8, proto/smtpserver.conf.in:
	    tar-pit things from James MacKinnon.
	    Actually diff against 2.99.55, which has been adapted to
	    current CVS.

	* proto/zmailer.sh.in:
	    Quote typo introduced when adding  --zconfig   option..
	    Oops.

2003-04-30  Matti Aarnio  <mea@zmailer.org>

	* Makefile.in:
	   Version 2.99.56-pre5

	* README.UPGRADING:
	    The router internal logic change IS script incompatible!
	    Carefull out there with your  aliases.cf,  and
	    fqdnaliases.cf !

	* proto/cf/aliases.cf, proto/cf/fqdnalias.cf, router/functions.c:
	    - When a list-expansions fails to produce recipient list,
	      do produce an error message only, when the message being
	      routed is _not_ an error message in itself.
	    - In scripts, do understand that the 'listexpand' can yield
	      a NULL list, and branch at it conditionally to do different
	      codepath behaviour.

	* scheduler/update.c:
	    Change in debug outputs to use more usefull spoolid
	    reference.

2003-04-28  Matti Aarnio  <mea@zmailer.org>

	* transports/smtp/smtp.c, transports/libta/diagnostic.c:
	    Allow multiple calls to  diagnostic()  function,
	    and make sure that only first of them does actual
	    DIAGNOSTIC reporting, all the rest do just logging to
	    given FILE*.

	* transports/smtp/smtp.c:
	    More code re-arrangements regarding connection retries.

	* transports/smtp/smtp.c, transports/smtp/smtp.h:
	    A bit experimental re-arrangements of EZMLM related
	    processing of messages in smtp-level.  Moved  smtp
	    connection formation from before deliver() to within
	    it, so that it can (when needing) re-open the connection.

	* utils/mxverify/mxverify-cgi.c:
	    Auto-detect, if can use IPv6 addresses in testing.

	* scheduler/mailq.c, man/mailq.1:
	    Added '-Z' option to mailq, alike at scheduler, et.al.

2003-04-17  Matti Aarnio  <mea@zmailer.org>

	* transports/libta/ctlopen.c, transports/libta/mimeheaders.c:
	    Cleaning up the for-clause code a bit. Removing unnecessary
	    malloc()/free() things, which are dropping core at one
	    test system.  (In the end it was mallocated buffer end
	    overscribling that dropped those cores at mysterious
	    places, but as this was the only altered place...)

	* man/zmailer.1, proto/zmailer.sh.in, router/router.c,
	  man/router.8, scheduler/scheduler.c, man/scheduler.8,
	  smtpserver/smtpserver.c, man/smtpserver.8, transports/sm/sm.c,
	  transports/smtp/smtp.c, transports/errormail/errormail.c,
	  transports/hold/hold.c, transports/mailbox/mailbox.c,
	  transports/reroute/reroute.c, proto/newdb.in,
	  proto/newdbprocessor.in:
	    - Zmailer, Router, Scheduler, Smtpserver: explicite options
	      to define non-compiled-in path to  ZCONFIG  ZENV file.
	    - Transport Agents: if  ZCONFIG _environment_  variable is set,
	      read ZCONFIG from that file.  Inherits that from scheduler...
	    - Some tools: if  ZCONFIG _environment_  variable is set,
	      read ZCONFIG from that file.  Inherits that from zmailer(1).

	* scheduler/scheduler.c scheduler/agenda.c, scheduler/mq2.c,
	  scheduler/msgerror.c, scheduler/prototypes.h,
	  proto/zmailer.sh.in,  scheduler/transport.c,
	  scheduler/update.c:
	    Automated (within 30 seconds of previous) log-file re-opening

	* man/manual-rerouter.8, man/reroute.8, man/Makefile.in:
	    Man-pages for the reroute transport-agent.

	* transports/hold/hold.c:
	    Long time bug in produced envelope metadata entry.

	* transports/reroute/reroute.c, transports/reroute/Makefile.in,
	  transports/reroute/manual-rerouter.in:
	    Experimental version of reroute -- e.g. command some
	    channel/host target queue back to the router.

	* transports/libta/mimeheader.c:
	    When outputting ORCPT value into "for clause", do
	    decode the XTEXT encoded data into plain format.

2003-04-16  Matti Aarnio  <mea@zmailer.org>

	* SiteConfig.in, transports/libta/mimeheader.c:
	    More beauty tuning of the for-clause processing subroutine.
	    Added also a way to disable the addition of the for-clause
	    via a ZENV variable.

2003-04-15  Matti Aarnio  <mea@zmailer.org>

	* smtpserver/mxverify.c:
	    Another error spotting by Eugene Crosser -- for a while
	    CVS versions have not done any sort of DNS-BL lookups
	    correctly.  (Since 2002-09-01.)

	* transports/smtp/smtp.c:
	    "RSET" processing didn't -- various MAIL FROM related
	    state variables were reset before the optional "RSET"
	    protocol exchange was done, and thus in some cases
	    PIPELINEd processing did lead to undesirable behaviour.
	    This bug was introduced on  2003-02-14   in order to fix
	    scattered around RSET code paths so that there will always
	    be an RSET, when there is need for it.  Urgh.
	    
	    It appeared when a message was tried to send in the
	    connection right after something needing that RSET;
	    thanks to reports about "there seem to be multiple
	    messages to these troublesome destinations" for finally
	    finding this.

2003-04-14  Matti Aarnio  <mea@zmailer.org>

	* configure.in:
	    Quite old configuration thing bites us with newer  autoconf
	    produced sed-scripts.  Namely   @ROUTEUSER_IN_ABNORMAL_UNIX@
	    value in running  $MAILSHARE/zmailer.conf   file  will
	    cause sed to spin in place.

	* include/ta.h,  transports/libta/ctlopen.c,
	  transports/libta/fwriteheader.c, transports/libta/mimeheaders.c,
	  transports/libta/swriteheader.c:
	    Tuning a bit more of "from-clause" processing so that it
	    sticks better within 80 columns.

	* libc/myhostname.c:
	    From  Eugene Crosser:  find out my local
	    hostname only once (e.g. scheduler et.al.
	    long-running processes.)

	* transports/errormail/errormail.c:
	    - If the source address is 'channel error', send
	      the message back to domainless "postmaster" in
	      our own machine.
	    - If the message is to be discarded ("NOTIFY=NEVER"
	      at all recipients, or some such), indicate that
	      at the syslogged string.

	* libc/mail.c, libc/sfmail.c, SiteConfig.in:
	    Add  INPUTDIRS=  ZENV variable processing,
	    also  INPUTDIRHASH=  and  INPUTNOTIFY= !
	    Presently just testing!

	* router/db.c, router/rfc822.c:
	    Been doing a bit of debugging of one odd system
	    built a while ago, with reports "this isn't working.."
	    (definitely it wasn't, wrong configs running...)

2003-04-11  Matti Aarnio  <mea@zmailer.org>

	* SiteConfig.in, configure.in:
	    Updated default configuration values a bit, rearranged
	    SiteConfig.in  parts to be more "groupped by function".

2003-04-07  Matti Aarnio  <mea@zmailer.org>

	* lib/sleepycatdb.c:
	    Eugene Crosser noted, that this file fails to compile,
	    when no SleepyCat DB is available in the compilation
	    environemnt.  Oops!  Adding couple conditionals to
	    appease the compiler...

2003-04-06  Matti Aarnio  <mea@zmailer.org>

	* lib/sleepycatdb.c:
	    Adding debugging things, trying to understand
	    couple CDB-mode related problem things.
	    Possibly this is about a bug in system thread library,
	    which interacts badly with SleepyCat DB 4.0.14  ?

2003-04-04  Matti Aarnio  <mea@zmailer.org>

	* transports/smtp/smtp.c:
	    Urgh, two chain-gang movement pointer mistakes, and
	    a long running process went into busy spinning...

	* transports/libta/mimeheaders.c:
	    Additional book-keeper things for knowing when
	    the thing can fold, and when it can't.

	* router/rfc822hdrs.c:
	    Tuning (part of) folding header printing code.

2003-04-03  Matti Aarnio  <mea@zmailer.org>

	* transports/sm/sm.c:
	    Oops, bad parameter for  header_received_for_clause()
	    function.  Used one was always NULL, which is kind of
	    bad idea...

	* transports/smtp/smtp.c:
	    Finished complete RFC 1123 part 5.2.2  CNAME rewriting
	    both in MAIL FROM and RCPT TO.  Also cleaned up code
	    somewhat in relevant parts.

	* transports/smtp/smtp.c, transports/smtp/getmxrr.c,
	  transports/smtp/smtp.h:
	    Third round, completing processing also in cases,
	    where target domain is not the same as to what is
	    being used for connection forming.
	
	* transports/smtp/smtp.c, transports/smtp/getmxrr.c,
	  transports/smtp/smtp.h:
	    - getmxrr() -- prepared for further refinements
	      of CNAME cache related lookups.
	    - add_cname_cache(), cname_lookup() -- two interfaces
	      to RFC 821 related RCPT TO rewriting for CNAME
	      aliased domain names.  This DOES NOT touch on
	      visible headers, nor ORCPT data, only RCPT TO
	      domain.  Still a bit incomplete...
	      Actually that reference is: RFC 1123 part 5.2.2

2003-04-02  Matti Aarnio  <mea@zmailer.org>

	* man/smtpserver.8:
	    Forgotten document of several months old
	       PARAM tls-random-source /sock/path
	    parameter.

	* include/ta.h, transports/libta/mimeheaders.c:
	    New  header_received_for_clause()  function to add a FOR
	    clause into top-most RECEIVED: header.

	* transports/smtp/smtp.c, transports/mailbox/mailbox.c,
	  transports/sm/sm.c, transports/errormail/errormail.c:
	    Use  header_received_for_clause()  function.

	* transports/smtp/smtp.c, transports/smtp/getmxrr.c,
	  transports/smtp/smtp.h:
	    Follow strictures of RFC 821 about rewriting RCPT TO
	    envelope domain, if target domain did resolve via CNAME.
	      Actually that reference is: RFC 1123 part 5.2.2

	* transports/smtp/smtp.c:
	   If target system has DSN capability, but our sent address
	   does not (for some reason) have DSN data, generate them
	   from default values...

	* router/daemonsub.c:
	    When the child process closes, as its final act, do: exit(0)

	* smtpserver/cfgread.c:
	    A bit of cleanup of the parser: wrap all OpenSSL related
	    options inside appropriate IFDEF test,  AND  from now on,
	    begin reporting in smtpserver's verbose log, if configuration
	    contains PARAM entry which isn't known/doesn't have enough
	    parameters.  (Helps debugging...)

2003-03-13  Matti Aarnio  <mea@zmailer.org>

	* scheduler/update.c, scheduler/statuslog-ids-to-spoolids.pl,
	  man/scheduler.8:
	    Change in  statistics-log file format to have
	    easier correlation with syslogged data.
	    Also a tool to convert the statistics-log file
	    to new format.

2003-03-06  Matti Aarnio  <mea@zmailer.org>

	* smtpserver/rfc821scn.c:
	    Turned off the code assigning semantic meaning
	    to the local-part contained % and ! characters.
	    Relaying policy control will look at them, but
	    only when the address domain is _local_, and
	    the address is on  RCPT TO.

	* man/smtpserver.8:
	    Cleaned up a bit the OpenSSL/TLS related documentation.
	    Added missing 'h' option document.

	* smtpserver/smtptls.c:
	    Changed couple internal warning texts into a lot less
	    alarmistic "could not load .. from file, will use
	    built-in default" (of DH pamaters.)

	* transports/libta/mime2headers.c:
	    Limit the length of produced "MIME-2" header tokens.
	    This is mostly a beauty-wart, but might in some cases
	    be usefull thing.

2003-03-05  Matti Aarnio  <mea@zmailer.org>

	* include/mailer.h, router/rfc822.c, router/rfc822hdrs.c,
	  router/rtsyslog.c, lib/taspoolid.c, router/prototypes.h,
	  smtpserver/smtpserver.c:
	    - Generate file  taspoolid  at message envelope
	      parse time into  'struct envelope',  and pass it
	      around instead of generating it at multiple times.
	    - In  Received:  header, former   id <spoolid>   is
	      now changed to:   id spoolid  (without angle-brackets)
	    - Message-id generation uses now taspoolid value
	      as one component of its formulation.
	    - explicitely constified some constant data.

	* router/functions.c:
	    Comment away dead declarations.

	* proto/smtpserver.conf.in:
	    Comment away the default  PARAM help  text where
	    "Yoyodyne Propulsion" is mentioned as system
	    owner...   People don't edit those...

2003-02-28  Matti Aarnio  <mea@zmailer.org>

	* proto/cf/standard.cf, router/libdb/header.c:
	    Remove headers which we produce into e.g.
	    messages stored in mailbox / processes run
	    in pipes, etc.

	* router/rfc822hdrs.c:
	    When producing our  Received:  header, don't anymore
	    put the spool-id inside angle-brackets.

2003-02-20  Matti Aarnio  <mea@zmailer.org>

	* smtpserver/smtptls.c, transports/smtp/smtptls.c:
	    Updated one function prototype to match version 0.9.7.

	* configure.in:
	    In RedHat (8.0 / Rawhide ?) system the OpenSSL 0.9.7
	    is compiled with Kerberos inside it.  Compilation,
	    and linkage will need additional CFLAGS and LIBS
	    to succeed.  To provide those, a system specific
	    pkg-config   tool is used, where available.

	* configure.in:
	    Updated things to match rules of  autoconf 2.57
	    (e.g.  LIBOBJS  is no longer allowed direct assignment)

	* scheduler/mailq.c, smtpserver/smtpserver.c:
	    Typo fixed from Eugene Crosser.

	* TODO:
	    Updated / rearrangements / removing completed items

2003-02-14  Matti Aarnio  <mea@zmailer.org>

	* Makefile.in:
	    Version: 2.99.56-pre4
	    * WILL DO ALSO A RELEASE TARBALL OF THIS, *
	    * BUT DON'T TRUST IT YET! *****************

	* transports/smtp/smtp.c, transports/smtp/smtp.h:
	    Centralized RSET sending into one place in
	    MAIL/RCPT/DATA loop. Using state variable  do_rset
	    in the SmtpState context to indicate POSSIBLE need
	    for doing it.  Definite non-need is when DATA/BDAT
	    has completed successfully, and also right before
	    the first MAIL.

	* router/libsh/bsdhash.c, router/libdb/bsdbtree.c:
	    Correct clearing of DBM private data storage pointer.

	* scheduler/mailq.c:
	    Fix "mailq -s" access failure printing to use correct
	    directory string pointer.

2003-02-06  Matti Aarnio  <mea@zmailer.org>

	* compat/sendmail/sendmail.c, libsh/builtins.c, libsh/execute.c,
	  router/libdb/bsdbtree.c, router/libdb/bsdhash.c,
	  router/libdb/ndbm.c, transports/libta/ctlopen.c:
	     Do  #include <errno.h>  -- that is definitely needed
	     for correctly compiling code at glibc 2.3.1+,  but is
	     correct for other cases, too.

	* transports/smtp/smtp.c:
	    Convert couple  LOG_ERR  level syslog()s to   LOG_NOTICE.
	    They don't quite deserve being blasted to people's consoles..

	* transports/smtp/smtp.c, transports/smtp/smtp.h,
	  transports/smtp/smtptls.c:
	    Additional "writeclosed" flag to inform that the socket
	    shall not be written to, no matter what.

	* libsh/execute.c, libsh/zmsh.c:
	    Added option 'J' into ZMSH interpreter to trace a subset of
	    'I' traced things.

	* libsh/expand.c,  libsh/interpret.c:
	    Disable eating away backquotes from expanded variable values.
	    EFFECTS TO BE TESTED MORE THOROUGH!

	* proto/cf/aliases.cf, proto/cf/rrouter.cf, proto/cf/server.cf:
	    Moved  $(dequote ...)  calls into separate variable
	    assignments to analyze things for backquote (non-)processing.

	* libsh/path.c:
	    Don't include <sfio.h>,  it isn't needed.

	* router/daemonsub.c:
	    If message has been (tried to) process earlier, and
	    the "lock pid" is ours, do process the message, otherwise
	    see at first if the system has a process with that pid in
	    it, then skip that item..   (FIXME: this is not perfect...)

	* libsh/regex.h:
	    Moving one #endif upwards a bit to make sure
	    there is always some definition for  __restrict  et.al.

2002-10-07  Matti Aarnio  <mea@zmailer.org>

	* smtpserver/smtpcmds.c, smtpserver/smtpserver.c,
	  smtpserver/smtptls.c:
	    Oops..  Wrap  HAVE_OPENSSL  around data entries which
	    are available only when the macro is defined...

2002-10-04  Matti Aarnio  <mea@zmailer.org>

	* smtpserver/smtptls.c:
	    Make CA file/directory issuance optional for smtpserver.

	* router/daemonsub.c:
	   E.Crosser reported that on some platform (apparently
	   at least Solaris), child process death causes file-
	   handle leakage in process.  (E.g. missing close() calls
	   somewhere.)  While at it, I cleaned a bit of the code..

	* lib/loginit.c:
	   Do lessen the number of syscalls done by this routine.
	   (At Linux with glibc 2.2.x).

2002-09-23  Matti Aarnio  <mea@zmailer.org>

	* compat/sendmail/sendmail.c:
	    Improved the verbose-trace printing code.
	    Turned out the lattest glibc stdio code didn't
	    resume reading from fd, when it had reached EOF once,
	    or some such equally weird thing...
	    Also noticed temporary file usage insecurity
	    whereby somebody could persuade us to append
	    texts into some existing file in systems where
	    mkstemp() call does not exist.. (Not overwrite,
	    nor read what invocator's privileges don't allow
	    to be read...)

	* transports/smtp/smtp.c, transports/smtp/smtp.h,
	  transports/smtp/smtptls.c:
	    - If TLS mode is mandated, but not available,
	      yield a TEMPFAIL at connection..  Hopefully
	      sysadmin will detect it before a full-blown
	      failure occurs, and traffic is lost.
	    - Also included template code for handling server
	      certificate verification failure at SMTP connection
	      level. (final integration is a TODO thing,)
	    - A bit more of Postfix TLS code into SMTP client
	      system.  (Still the session-cache in TODO..)

2002-09-21  Matti Aarnio  <mea@zmailer.org>

	* smtpserver/smtpserver.h, smtpserver/smtpserver.c,
	  smtpserver/smtpcmds.c, smtpserver/cfgread.c,
	  smtpserver/smtptls.c:
	    Radical revisioning; adapting current Postfix TLS
	    code into ZMailer environment.
	    TODO: session-cache...

	* transports/smtp/smtp.h, transports/smtp/smtp.c,
	  transports/smtp/smtptls.c:
	    Radical revisioning; adapting current Postfix TLS
	    code into ZMailer environment.
	    TODO: session-cache...

2002-09-19  Matti Aarnio  <mea@zmailer.org>

	* transports/smtp/smtptls.c, transports/smtp/smtp.h, man/smtp.8,
	  proto/smtp-tls.conf.in:
	    The OpenSSL code doesn't (anymore) like to work without
	    proper random pre-seeding...

2002-09-10  Matti Aarnio  <mea@zmailer.org>

	* scheduler/scheduler.c:
	    Default the 'expiry2' to be zero, if it can't be set to
	    be anything more appropriate.

2002-09-06  Matti Aarnio  <mea@zmailer.org>

	* SiteConfig.in:
	    Changed the default value for SCHEDULERDIRHASH  to be  2
	    It is important thing for large queue sites, while
	    at small systems it uses deep hashing unnecessarily..

	* configure.in:
	    Mark for presense of header  <sasl/sasl.h>

	* man/scheduler.8, scheduler/scheduler.c:
	    The  -E  option for the scheduler can now have
	    two parameters to better control the pre-scan of
	    the input queue.  Also altered default values.

	* scheduler/readconfig.c, scheduler/scheduler.h, man/scheduler.8,
	  scheduler/agenda.c,  scheduler/conf.c, scheduler/scheduler.c,
	  scheduler/prototypes.h, scheduler/threads.c:
	    Another form of expiry -- when the queues become truly
	    huge, ZMailer's scheduler has not been able to expire
	    messages because it must at first do a delivery attempt
	    at least once. A new "expire2=" time limit _beyond_primary_
	    _expiry_.

	* smtpserver/mxverify.c:
	    The bad T_TXT data detection and cutback, nominally
	    the same thing as with e.g. sendmail.  Also clean
	    up the received string to have only printable
	    characters in ISO-8859-* character-sets.
	    All that this could have done in ZMailer is to pick
	    garbage data from beyond the (received) buffer, not
	    overwrite anything.

	* contrib/clean-mean-contentfilter-1.00.tar.gz:
	    Package from Eugene Crosser: "if you think it's worth,
	    maybe you'll include the attached thing into contrib/.
	    It's running here for more than a week under serious
	    load. It's not very smart and not very portable but
	    it's light (I did not feel any noticable growth of load
	    on the servers)."
	
2002-09-03  Matti Aarnio  <mea@zmailer.org>

	* smtpserver/smtpserver.c, smtpserver/zpwmatch-pipe.c:
	    Running the legacy application authentication against
	    SASL via an external program..  Turns out the old
	    pipe-matcher code fails (by looping with ECHILD error)
	    when we have active child exit reaper...  Oops.

	* smtpserver/smtpauth-sasl.c:
	    The external program mentioned above.  This program is NOT
	    to be considered as official part of ZMailer MTA, the
	    goal is to provide an official version in the smtpauth.c
	    at some point...  I just needed a QUICK and working thing.

	* smtpserver/smtpcmds.c:
	    From user feedback (helpdesk manager report to developers,
	    wow...): The "rejection due to MX rule" report needs
	    improved text.  Altered wording, and added client IP address
	    printout into the text.

	* router/prototypes.h, router/rfc822.c, lib/rfc822scan.c:
	    Modifications to header parsing.
	    - An all-white-space line shall be CONTINUATION, not
	      end-of-headers (ancient BITNET card-images are other
	      story, but lets not worry about them...)
	    - Altered the makeLetter() function parameters removing
	      a parameter that has not been used for several years.
	    - WorkInProgress: internal changes into  makeLetter()...

	* configure.in, smtpserver/smtpauth.c:
	    Initial configuration hooks for enabling CMU Cyrus Sasl-2.x
	    The code itself is NOT functional as of yet.

2002-09-02  Matti Aarnio  <mea@zmailer.org>

	* router/rfc822.c:
	    Did something wrong, while scrubbed dead code..
	    Detection of header/body (in RFC822 sense) separation
	    fixed.  (Well, not entirely.. there are things which
	    probably SHOULD stay in headers...)

	* transports/libta/diagnostic.c:
	    A beauty-wart in syslog()ed data, when truncking embedded
	    CR containing diagnostic message, skip over the last CR
	    also...

	* transports/smtp/smtp.c:
	    Support -F connection to  UNIX:/...  sockets.
	    This MUST be defined at the command line! No routing
	    controlled version allowed!  (security, you see..)
	    (This is subject to system having AF_UNIX support in
	     the first place, but that should be quite common...)

	* README.UPGRADING:
	    Change in what  sm  outputs for envelope meta-data to
	    be in line with other transport-agents... (mailbox,
	    in particular.)

	* transports/sm/sm.c:
	    Testing reveals... NULL pointer referrals :-(

	* libc/Makefile.in, libresolv/Makefile.in, router/Makefile.in,
	  router/libdb/Makefile.in, scheduler/Makefile.in,
	  smtpserver/Makefile.in, transports/hold/Makefile.in,
	  transports/libta/Makefile.in, transports/mailbox/Makefile.in,
	  transports/reroute/Makefile.in, utils/makedb/Makefile.in,
	  utils/vacation/Makefile.in:
	    Modified usage of  @GENINCL@  autoconfig macro so that it
	    will always be the LAST inclusion define for the each
	    compilation.  This way if the (as has happened to yours
	    truly) GENINCL ( /usr/local/include ) has a file with
	    same name as something important ZMailer internal (mail.h
	    from UW-IMAP C-client), it won't override internal file..

	* proto/cf/fqdnalias.cf:
	    When doing  fqdnroute  processing on a "plus-full"
	    address, pass proper parameters to the database lookup.

	* include/zmsignal.h, router/daemonsub.c, router/db.c,
	  router/router.c, router/rfc822.c:
	    Observed certain kind of difficulties at abruptly
	    closed database accesses -- SleepyCat DB 3.x CDS
	    goes into bad lock state, unless properly cleaned
	    after with atexit().

	* transports/sm/sm.c:
	    Do similar X-***: header processings as the 'mailbox'
	    does for ORCPT, EnvelopeID, and Envelope-To.
	    Streamline a bit separatorsequence processing.

2002-09-01  Matti Aarnio  <mea@zmailer.org>

	* lib/rfc822scan.c, router/functions.c, router/rfc822.c:
	    Removed code (for printaliases function) that is no longer
	    used, observed situations, when the malformed headers
	    can be split by ZMailer.

	* smtpserver/mxverify.c:
	    When doing varioud "RBL" lookups, always catenate a "."
	    into end of the lookup domain in order to suppress
	    unnecessary "search" work by the resolver libraries.
	    Doing:  _res.options &= ~RES_DNSRCH;  might do it too...

	* smtpserver/smtpcmds.c:
	    Noticed that in unused code there is potential for
	    serious trouble with router call.  '#if 0' wrappers in..
	    Also, modify SIZE= value parameter parser to accept
	    strictly valid value in range 1 thru 1 000 000 000.

	* proto/db/smtp-policy.relay:
	    Add a comment covering user-specific destination addresses.

2002-08-23  Matti Aarnio  <mea@zmailer.org>

	* smtpserver/smtpdata.c:
	    Reworked the  ta-spoolid  generation and presentation
	    in the DATA and BDAT phases after the contentpolicy()
	    call (and even before it..)

	* transports/libta/mime2headers.c:
	    Arnt Gulbrandsen  reported a GI (of GIGO) case
	    producing invalidly encoded header MIME token.
	    namely the double-quote is not legal char unencoded
	    char inside the Q-format token.

	* configure.in:
	    Added missing   utils/smtp-contentfilter  into
	    generated files list.

	* utils/makedb/dblook.c:
	    Use  db_strerror() to report error strings properly.
	    Usage of  strerror()  does not work at DB3/DB4 ..

	* man/smtpserver.c, smtpserver/contentpolicy.c,
	  utils/smtp-contentfilter.in, README.UPGRADING:
	    A change in the  smtpserver <-> contentfilter
	    interface protocol!  Some users have written
	    content-filters based on the sample framework,
	    and those will need matching changes (rather
	    simple!) in the filter code!  See  README.UPGRADING !

2002-08-22  Matti Aarnio  <mea@zmailer.org>

	* proto/post-install.sh.in:
	    Changed behaviour rules a bit.
	    Now the prototype of whatever there are prototypes of
	    will be kept in its original place, and only copies
	    will be made.

	* lib/sleepycatdb.c:
	    Spotted a bug in database opening error handling.

2002-08-19  Matti Aarnio  <mea@zmailer.org>

	* transports/smtp/smtp.c:
	    Changed logtag() returned tag-string format.
	    New one will tell time (in secs) since start of
	    the program, and incremental sequence number.

	* proto/post-install.sh:
	    Having been asked ... printing more verbose progress
	    reporting while doinga POSTOFFICE subdirectories.

	* smtpserver/smtpauth.c, smtpserver/smtpcmds.c,
	  smtpserver/smtpserver.c, smtpserver/smtpserver.h:
	    Format change in the verbose protocol log tags.

2002-08-12  Matti Aarnio  <mea@zmailer.org>

	* transports/smtp/smtp.c:
	    In some cases the  smtp_sync()  is called when outbound write
	    socket has already been killed.

	* proto/newdbprocessor.in:
	    Updated internal comment carried documentation, and
	    sample of  dbases.conf  in the script.

	* proto/db/dbases.conf:
	    Documented the existence of "-r" as newdb_compile_option.

2002-07-11  Matti Aarnio  <mea@zmailer.org>

	* sfio2002/*
	    Entire subtree -- SFIO version 2002.1
	    Basic injection, no adaptations yet.

	* include/libz.h, lib/selfaddrs.c, lib/zgetifaddress.c,
	  router/libdb/selfmatch.c, smtpserver/mxverify.c, 
	  smtpserver/policytest.c, smtpserver/smtpserver.h,
	  transports/smtp/smtp.c, transports/smtp/smtp.h:
	    Moving commonly used 'Usockaddr' type into libz.h,
	    and updating interfaces playing with addresses to
	    use that type for the parameters.

	* proto/smtpserver.conf.in, smtpserver/cfgread.c:
	    Eugene Crosser noticed that binding to named interface
	    does not quite succeed..  Address storage goes into
	    slightly wrong place -> binding fails.

2002-07-05  Matti Aarnio  <mea@zmailer.org>

	* smtpserver/smtpcmds.c:
	    A practically unexploitable potential buffer overflow.
	    Exploit requires presense of 'h' flag in EHLO greeting
	    match patterns (non documented, non-default style flag),
	    and that the host address reversal text is long in the
	    extreme. Getting the server to crash is less difficult,
	    than to get it to execute anything..   Repeat: A 'h' must
	    be present in style-flags at the end of the smtpserver.conf
	    file EHLO/HELO-patterns, AND the hostname reversal PTR text
	    must be longer than around 100 bytes.  Then, maybe, it will
	    be possible to feed working buffer overflow exploit..

	* Makefile.in:
	    Version 2.99.56-pre3 (CVS tagged  2-99-56-pre3)

	* transports/smtp/smtp.c:
	    An attempt to create a smart way (at least at Linux and
	    at some BSD's) to de-nagle tcp streams in high-performance
	    manner.   Low-performance de-nagle is:  sleep(1) ...

	* configure.in, acconfig.h, aclocal.m4:
	    Updates to remove couple of deprecated features, adding
	    third parameters (often also second) to AC_DEFINE() macroes.

	* proto/post-install.sh.in, proto/cf/fqdnalias.cf,
	  proto/cd/rrouter.cf, proto/db/dbases.conf,
	  proto/db/fqdnroutes, proto/Makefile.in:
	    - cleaned up a bit the  routes_spec()  function parameter
	      variables -- less confusion with the new name, I hope..
	    - new routing mechanism:
	           fqdnroutes -- user@domain -> chan!data..
	
	* lib/sleepycatdb.c, include/sleepycatdb.c,
	  router/libdb/bsdbtree.c, router/libdb/bsdhash.c
	    More rework on SleepyCat DB driver routines to better use
	    the ZSleepyPrivate structure to carry relevant reference
	    data.
	
	* router/libdb/gdbm.c, configure.in:
	    Similar code work to SleepyCat DB for GDBM.
	    Testing for library having   gdbm_fdesc()   function.

	* router/db.c, router/function.c, router/prototypes.h,
	  router/libdb/search.h:
	    - Renamed the low-level dblookup driver routine from
	      'db()' to 'dblookup()' after having problems of finding
	      the caller...
	    - Reworked the %-substitution code radically; now %[1-9] will
	      be a key of same index at every time.  The  %0 MAY change
	      in case some driver routine (e.g. 'pathalias') is defined
	      at the 'relation' statement.  The relation MUST have
	      '-%' option for the %[0-9] substitutions to be active!

2002-06-25  Matti Aarnio  <mea@zmailer.org>

	* transports/smtp/smtp.c:
	    Separating DATA ending dot into separately done write(2),
	    which hopefully leads into separately pushed out frame,
	    and finally packet separation at the DATA-phase ending dot
	    sending..  World is full of braindead firewalls...

	* include/sleepycatdb.h, lib/sleepycatdb.c,
	  router/libdb/bsdbtree.c, router/libdb/bsdhash.c:
	    More work at the SleepyCat DB Concurrent Data Store  support.

	* router/db.c:
	    Clean a bit of the database call mechanism passed parameter
	    block by doing initial memset(,0,) on it..

	* libc/mail.c, libc/sfmail.c:
	    Change (slightly) of how the initial temporary file name
	    is formed so that there are no leading white spaces at a
	    host which has shorter than 7 chars hostname..

2002-06-20  Matti Aarnio  <mea@zmailer.org>

	* include/sleepycatdb.h, lib/sleepycatdb.c,
	  proto/newdbprocessor.in:
	    More of  SleepyCat DB support stuff.

	* smtpserver/smtpauth.c:
	    Stole code (yet incomplete, and not integrated) from sendmail
	    8.12.*  for using SASL code in SMTP server authentication.

2002-06-18  Matti Aarnio  <mea@zmailer.org>

	* configure.in, acconfig.h:
	    Full support for finding SleepyCat DB 4.0, and
	    to inform the system about it.

	* lib/Makefile.in, lib/sleepycatdb.c, include/sleepycatdb.h:
	    Librarize support for SleepyCat DB by allowing more versatile
	    parametrisation, e.g. DBENV things, etc.   This to make it
	    possible to work with "Concurrent Data Store" kind databases.
	    E.g. single-writer, multiple readers to allow online
	    modifying of the databases.

	* router/db.c, router/libdb/search.h:
	    For each online database, supply a private variable usable
	    by the database method itself for whatever needs it has
	    (e.g. storing own structure with private data, like DB
	     structure handle.)

	* router/libdb/bsdbtree.c, router/libdb/bsdhash.c:
	    Usage of librarized SleepyCat DB interface, and radical
	    surgery to discard a bunch of splay-trees that are no longer
	    necessary as the database method handle carries "dbprivate"
	    pointer.

	* smtpserver/policytest.c, utils/makedb/dblook.c,
	  utils/makedb/makedb.c, utils/vacation/vacation.c:
	    Support SleepyCat DB 4.0; use (where can) librarized
	    support interface.

	* transports/smtp/smtp.c:
	    Fix the call parameters to "select_sleep()" so that there
	    is explicite knowledge of when the select is for writing,
	    and when it is for reading.

	* utils/smtp-contentfilter.in:
	    Fix originally inverted test on meta-environment scanner
	    stopping condition part.

2002-05-28  Matti Aarnio  <mea@zmailer.org>

	* smtpserver/smtpserver.c:
	    Eugene Crosser reported smtpserver spinning in place,
	    and that is indeed possible if the deprecated  ssmtp
	    service is in use.  Moving relevant initialization code
	    upwards slightly fixes the problem.
	    (Later Eugene admitted that there could have been
	     a pilot error -- omitting "make clean" before "make".)

2002-05-20  Matti Aarnio  <mea@zmailer.org>

	* smtpserver/smtpserver.c:
	    In some testing cases the "progname" variable is not
	    set with any sane (non-NULL) value.

	* utils/policy-builder.sh.in:
	    Output the "smtp-policy.relay*" file entries only, when
	    there is some data in the line, e.g. no comments, nor
	    blank lines..

	* smtpserver/contentpolicy.c:
	    A bit more of debug output into local log..

	* transports/smtp/smtp.c:
	    Sometimes the  SS->smtpfp  will be NULL, and at such times
	    sferror() on stream yields SEGV..  Additional code armouring.

	* utils/smtp-contentfilter.in:
	    A bit cleaner use of perl's implied default variables..

2002-05-16  Matti Aarnio  <mea@zmailer.org>

	* scheduler/transport.c:
	    The code didn't consume the scheduler-notify input socket
	    at the mux() code, although it was looked for by the
	    select() in the code.

2002-04-20  Matti Aarnio  <mea@zmailer.org>

	* transports/smtp/smtp.c:
	    In the obscureish EZMLM mode we LACKED mandatory trailing
	    ">" character at MAIL FROM envelope address.
	    A major goofup.. :-/
	    (Especially as I use the beast myself sometimes..)

	* transports/mailbox/mboxpath.c:
	    At the  usage()  do document also the -X[X] option.

2002-04-18  Matti Aarnio  <mea@zmailer.org>

	* transports/mailbox/mailbox.c:
	    Finally a bit of understanding about how to manage
	    persistent errno status on sfio streams.

	* transports/smtp/smtp.c, transports/smtp/smtp.h,
	  transports/smtp/smtptls.c:
	    Persistent error storage things, but as of yet the
	    detail analysis/reporting at calling layers is vague.

	* libc/mail.c, libc/sfmail.c, router/rfc822.c:
	    Add missing  #include "zmsignal.h"  lines...

2002-04-17  Matti Aarnio  <mea@zmailer.org>

	* include/ta.h, transports/libta/diagnostic.c,
	  transports/errormail/errormail.c, transports/smtp/smtp.c,
	  transports/expirer/expirer.c, transports/hold/hold.c,
	  transports/libta/ctlopen.c, transports/mailbox/mailbox.c,
	  transports/smtp/smtp.h:
	    - Add 'FILE *verboselog' parameter to  diagnostic() API
	      call, and get a cascade of things..  That is often the
	      last, undocumented, and most interesting thing anyway..
	    - Play with MAILBOX to detect (and neatly report) when
	      write to a file fails due to EDQUOT ...  Perhaps
	      fail it immediately ? (TODO item..)

2002-04-12  Matti Aarnio  <mea@zmailer.org>

	* transports/smtp/getmxrr.c:
	    Extended the test-harness a bit by telling what
	    are the two standard tests for it, and their
	    expected results.

2002-04-05  Matti Aarnio  <mea@zmailer.org>

	* transports/smtp/smtp.h, transports/smtp/smtp.c:
	    Debugging oddball 'yield OK when DEFER is correct' problems..
	    .. and fixed the blunder in the call of  smtpopen().

	* transports/libta/ctlopen.c:
	    The RP data block is not initialized completely in all cases,
	    which causes occasional bugs.  Doing   memset()  for it at
	    first, then filling in non-zero values.  This resulted from
	    RP structure expansion a month ago.

2002-03-08  Matti Aarnio  <mea@zmailer.org>

	* transports/reroute/reroute.c, transports/reroute/Makefile.in,
	  transports/Makefile.in:
	    Added a new Transport Agent -- "reroute", e.g. send given
	    messages back to router.  This is intended for quite special
	    (and intimate) interaction with the Scheduler.

	* transports/mailbox/mailbox.c, man/mailbox.8:
	    Add a few subprocess execution environment variables
	    which carry more of message meta-data, than previously.

	* transports/libta/ctlopen.c:
	    Pass the  INFROM= DSN metadata into   rp->infrom  field.

	* transports/hold/hold.c:
	    Detect "channel error" type messages properly.
	    Pass more of DSN Metadata to outgoing message envelope.
	    Output "env-end\n" meta-header after the envelope headers.

	* transports/expirer/expirer.c:
	    Update the comments a bit.

	* router/rfc822.c, libc/mail.c, libc/sfmail.c:
	    Take precautions (just in case) "the next-stage notify"
	    socket closes, and causes a SIGPIPE to be sent to relevant
	    process.

	* proto/scheduler.conf.in:
	    Remove "-8" from a few prototype command lines.

2002-02-22  Matti Aarnio  <mea@zmailer.org>

	* smtpserver/policytest.h, utils/makedb/makedb.c,
	  utils/makedb/dblook.c:
	    System with only SleepyCat DB 3.x in it (not 2.x, nor 1.x)
	    didn't support it properly.  Oops..

	* configure.in, libc/Makefile.in, man/Makefile.in:
	    Found out, why  --libdir=,  --includedir=, and
	    --mandir=  options didn't have effect.  D'uh..

2002-02-20  Matti Aarnio  <mea@zmailer.org>

	* router/rfc822.c:
	    Remove few earlier added ":" characters from places
	    where those went into report form filenames.
	    My blunder :-(

2002-02-18  Matti Aarnio  <mea@zmailer.org>

	* utils/makedb/makedb.c:
	    Remove else -brances causing problems in some cases.
	    I got definite reports about this earlier, but had
	    solid neutronium in my skull...

2002-02-15  Matti Aarnio  <mea@zmailer.org>

	* libc/mail.c, libc/sfmail.c, router/rfc822.c:
	    Oops,  MSG_NOSIGNAL seems to be Linux specific
	    thing, at least Solaris 2.6 doesn't support it
	    for  sendto()  system call.
	
2002-02-11  Matti Aarnio  <mea@zmailer.org>

	* scheduler/transport.c:
	    Match the mailq socket tcp-wrapper behaviour to that of
	    what the man-page says -- "tcp-wrapper is not used for
	    MAILQ-v2 type sockets".

	* SiteConfig.in:
	    By default publish  SCHEDULERDIRHASH=1  value.
	    Publish also  SCHEDULERNOTIFY=  and ROUTERNOTIFY=
	    variables, which are used by the notifier codes.

	* include/libc.h, transports/libta/nonblocking.c:
	    Moved the non-blocking code to be macro in  libc.h.
	    At some places a #include <fcntl.h> is needed before
	    #include "libc.h".

	* include/ta.h, scheduler/mq2.c, scheduler/transport.c,
	  transports/libta/warning.c:
	    The preceding fd-blocking macro thing affected these
	    files.  (Other usage places already did suitable #includes)

	* libc/mail.c, libc/sfmail.c, router/daemonsub.c:
	    If ROUTERNOTIFY is defined in  zmailer.conf, then
	    mail_close() (not .._alternative() !) will presume
	    there might exist an AF_UNIX socket with that name
	    into which a notification message about a new job
	    can be sent.

	* router/rfc822.c, scheduler/transport.c:
	    The Scheduler Notify socket got changed to use
	    SCHEDULERNOTIFY=   ZENV variable, and be AF_UNIX socket.

2002-02-07  Matti Aarnio  <mea@zmailer.org>

	* scheduler/scheduler.c, scheduler/conf.c,
	  scheduler/prototypes.h, scheduler/transport.c:
	    Implemented a 'notifysocket', which is an UDP socket
	    (mailq/udp) receiving simple "NEW X/Y/123-456" text lines,
	    and verifying the inputs a bit..  Perhaps should have this
	    configurable, so that the system could have multiple
	    schedulers around...

	* scheduler/scheduler.c:
	    Reworked  2001-10-27 Stephen <steve@activemessage.com>
	    scheduler queue rescan timer thing into less magic..

2002-02-05  Matti Aarnio  <mea@zmailer.org>

	* router/db.c, proto/cf/p-routes.cf, router/libdb/search.h:
	    Support _multiple_ instances of fallback keys, e.g.:
	        $(routesdb "$domain" -: ".:$(get $A type)" -: .)
	    which will look up fallback keys:
	        .:sender
		.:recipient
	    depending on address type, and
	        .
	    if neither of those exist..

2002-02-01  Matti Aarnio  <mea@zmailer.org>

	* proto/cf/fqdnaliases.cf:
	    Instead of:     returns (bitbucket ...)
	    do it properly: returns (((bitbucket ...)))

	* scheduler/update.c:
	    At   u_error2()   log the name of the event fully.

	* router/libdb/bind.c:
	    h_errhost[] change into source material length safe
	    construction.

	* router/libdb/dbm.c:
	    Mark this file with a  "#warning"  for being suspicuously
	    old-fashioned system with various problems...

2002-01-31  Matti Aarnio  <mea@zmailer.org>

	* proto/newdb.in:
	    Match the test in  router/libdb/ndbm.c  about which
	    component file to move _last_.  This has been a bug
	    since  2000-05-18 ...

2002-01-31   Alexey Antipov <rabbit@lipetsk.ru>

	* router/libdb/bind.c:
	    h_errhost[] buffer overflow in some oddball cases.

2001-12-15  Matti Aarnio  <mea@zmailer.org>

	* man/sm.8:
	    Revising the man-page.

2001-12-15  Nicolas Baumgarten <nico@pert.com.ar>

	* transports/sm/sm.c:
	    Added 'O' flag to configuration to output ORCPT data
	    into  X-Orcpt: header.

2001-12-07  Matti Aarnio  <mea@zmailer.org>

	* transports/mailbox/mailbox.c, transports/libta/swriteheaders.c:
	    When message writing into a file fails with e.g. EDQUOT
	    (quota exceeded), abort writing completely, discard sfio
	    buffers, and truncate away the incompletely received message.
	    This problem appeared at Solaris 8, when using quotas.

	* transports/smtp/getmxrr.c:
	    Cleanup some compiler warnings.

2001-11-07  Matti Aarnio  <mea@zmailer.org>

	* transports/smtp/smtp.c, transports/smtp/smtptls.c,
	  man/smtp.8:
	    Trying to figure out what to do with problematic
	    case on a Solaris 2.6 system speaking to some Win-NT
	    SMTP server application which looses all but the
	    first two TCP frames it receives.  The Solaris goes
	    to retransmit backoff from which it never really
	    recovers, and the write connection times out.
	    Implemented thus a '-w 1000' option to define the
	    value of the socket option SO_SNDBUF.

2001-10-27  Stephen <steve@activemessage.com>

	* scheduler/scheduler.c:
	    Observed problems with scheduler's input queue scanning.
	    Sent in a patch (which didn't quite do it..)

2001-10-25  Matti Aarnio  <mea@zmailer.org>

	* transports/smtp/smtp.c, transports/smtp/smtptls.c:
	    - edge comparisons in time handling code cause
	      short (1 sec) busy-loopings every now and then.
	    - When MAIL FROM results a 5xx status with immediate
	      closure of the socket following that report,
	      yield proper rejection, not EX_TEMPFAIL.

	* transports/smtp/smtptls.c, transports/smtp/smtp.h,
	  transports/smtp/smtp.c, transports/libta/ctlopen.c,
	  transports/libta/tasyslog.c, include/ta.h:
	    Move the "taspoolid()" invokation into ctlopen()
	    processing from within  tasyslog()  call.
	    At  smtp,  copy also the "->taspoolid" pointer
	    field into the SmtpState structure.

2001-10-23  Matti Aarnio  <mea@zmailer.org>

	* scheduler/msgerror.c, scheduler/scheduler.c,
	  scheduler/scheduler.h, scheduler/update.c:
	    Added couple  zsyslog()  calls to conditionally syslog
	    when scheduler has completed processing of a message.

	* router/rfc822.c:
	    Added a bit of double-colons on squirel() and
	    reject() calls when the thing is FATAL.
	    (Its me again being dense and forgetting documentation
	    elsewere, but the ":error-on-error" tag looked so neat...)

	* router/libdb/bsdbtree.c, router/libdb/bsdhash.c,
	  smtpserver/policytest.c, utils/makedb/dblook.c,
	  utils/makedb/makedb.c:
	    Reworked SleepyCat DB 1.x/2.x/3.x conditionals.

2001-10-21  Matti Aarnio  <mea@zmailer.org>

	* scheduler/mq2.c:
	    Tracked wrong resource accounting at mailq2 code;
	    it used to increment the number of (tracked) childs
	    in a place where such increment is harmfull, and
	    did lead to sort of "inflation" of children to such
	    an extent that there were phantoms in all allowed
	    resource slots..  Thus the 'mailq -Q' thing begun
	    to fail in most annoying way.
	    Also allowed for 'challenge' subfield to be filled
	    with a NULL pointer by the  strdup(), which a bit
	    later could lead to NULL referral, and thus SigSEGV..

2001-10-21  Michael Loftis <mloftis@wgops.com>

	* scheduler/scheduler.c:
	    In queue injection spotted a test of time which is reversed!

2001-10-16  Matti Aarnio  <mea@zmailer.org>

	* scheduler/mq2.c:
	    Correct the way how orderly close ("QUIT") of mailq is
	    handled -- the socket needs to be discarded properly...

	* libsh/builtins.c, router/functions.c, router/daemonsub.c:
	    Fixup the various return codes, specifically use EX_USAGE
	    for the usage report.

2001-10-10  Matti Aarnio  <mea@zmailer.org>

	* proto/cf/aliases.cf,  proto/cf/aliases-new.cf,
	  proto/cf/canon.cf, proto/cf/crossbar.cf,
	  proto/cf/fqdnaliases.cf, proto/cf/server.cf,
	  proto/cf/fussy-aliases.cf, proto/cf/i-smtp.cf,
	  proto/cf/i-uucp.cf, proto/cf/p-bitnet.cf,
	  proto/cf/rrouter.cf, proto/cf/standard.cf:
	    Noticed strange bounces which turned out to be due to
	    calls of functions which have optional options beginning
	    with '-' character.  These fixes handle cases where localpart
	    and/or domain name begins with a minus.  A full throughout
	    analysis of all functions inside the router, and related
	    documentation in the ZMailer Manual is future project.

2001-10-09  Matti Aarnio  <mea@zmailer.org>

	* man/smtpserver.8, smtpserver/smtpserver.c,
	  smtpserver/smtpserver.h, smtpserver/smtpcmds.c,
	  smtpserver/cfgparse.c, proto/smtpserver:
	    PARAM force-rcpt-notify-never
	    Whatever the incoming DSN NOTIFY= value is, we force it
	    always to be NOTIFY=NEVER.   This is for those who won't
	    like to let others even to find out that the message made
	    into the system, but still want to support incoming DSN.
	    (That is, not to disable DSN!)

2001-10-04  Matti Aarnio  <mea@zmailer.org>

	* proto/cf/p-smtp.cf, proto/cf/standard.cf, proto/cf/trusted.cf:
	    Add a bit of 'provide nnn' things.

	* scheduler/mq2.c, scheduler/mq2auth.c, scheduler/prototypes.h,
	  scheduler/transport.c, scheduler/update.c:
	    Track the number of open mailq2 sockets.  Track also
	    memory usage, and abort the connection of MQ2 socket if
	    the buffer size needed for the input line exceeds 16k.

2001-10-02  Matti Aarnio  <mea@zmailer.org>

	* scheduler/readconfig.c:
	    Support arbitrary large sets of:
	         AAAA/*
		 BBBB/*
		 CCCC/*
		 DDDD/*
		    params
	    channel/host selector pairs preceding common
	    parameter sets.  Original was just AAAA+BBBB,
	    adding third did fail the first dataset...

	* proto/cf/crossbar.cf, proto/cf/fqdnalias.cf,
	  proto/cf/p-uucp.cf, proto/cf/rrouter.cf,
	  proto/cf/standard.cf:
	    A bit more of revisions of 'returns' vs. 'return'
	    primitives.  Mostly adding comment: "error code return"

	* libsh/builtins.c:
	    Damn!  The  'returns'  primitive WAS NOT returning
	    _string_ in all cases.

2001-10-01  Matti Aarnio  <mea@zmailer.org>

	* configure.in:
	    SH-script bug in SleepyCat DB 3.x tests.

	* proto/newdbprocessor.in, proto/cf/UTAI.cf, proto/cf/UTGPU.cf,
	  proto/cf/aliases-new.cf, proto/cf/aliases.cf, proto/cf/canon.cf,
	  proto/cf/crossbar.cf, proto/cf/fqdnalias.cf, proto/cf/p-routes.cf,
	  proto/cf/p-iproutes.cf, proto/cf/p-smtp.cf, proto/cf/p-usenet.cf,
	  proto/cf/p-uucp.cf, proto/cf/rrouter.cf, proto/cf/standard.cf:
	    Reports about problems when aliases map into purely decimal
	    digit containing local name prompted rewriting parts of the
	    scripts (and newdbprocessor tool!) with old(*) 'returns' return
	    in place of the original 'return' return.  The difference is
	    that 'returns' will _always_ yield a string, while 'return'
	    may yield an integer value if the username/whatever is made
	    of purely decimal digits...
	    ( *: "old" as "long existing" )

	* Makefile.in:
	    CVS tagged version 2.99.56-pre1

	* include/libc.h, proto/zmailer.sh.in, man/zmailer.1:
	    Update the beast at Solaris 2.6, and learn some
	    new things...

2001-09-30  Matti Aarnio  <mea@zmailer.org>

	* configure.in, acconfig.h:
	    Autoconfig detection of  SleepyCat DB 3.x

	* router/db.c, router/libdb/bsdbtree.c, router/libdb/bsdhash,
	  smtpserver/policytest.c, utils/makedb/dblook.c,
	  utils/makedb/makedb.c, utils/vacation/vacation.c:
	    Use the SleepyCat DB 3.x call API; even prefer it!
	    (Except for vacation: Prefer NDBM, then GDBM, BSD DB...)

	* README.UPGRADING:
	    Note the usage of SleepyCat DB 3.x !

	* transports/mailbox/mailbox.c:
	    Got a spotting of code which isn't needed..

	* utils/rotate-logs.sh.in:
	    Let the $PATH to handle command binary locating.
	    That is, 'mv' and 'touch' are trusted to $PATH...

	* proto/zmailer.sh.in:
	    Fix typos at '-q' option processing!

2001-09-27  Matti Aarnio  <mea@zmailer.org>

	* packaging/rpm/*:
	    Updated version of RPM specs file, et.al. from
	    Xosé Vázquez

2001-09-26  Matti Aarnio  <mea@zmailer.org>

	* smtpserver/policytest.c:
	    For HELO/EHLO parameters, do a bit less work, ignore
	    case of '[1.2.3.4]' type parameters completely.

	* proto/scheduler.conf.in:
	    Set default expiration to be 5 days (from old 3 days).
	    RFC 2821 does suggest 4-5 days.

2001-09-22  Matti Aarnio  <mea@zmailer.org>

	* acconfig.h, config.h.in, configure.in, include/hostenv.h,
	  lib/nobody.c, lib/trusted.c, router/db.c, router/functions.c,
	  router/rfc822.c, router/libdb/nbm.c, scheduler/scheduler.c,
	  sfio/src/lib/sfio/sfio.h, sfio/src/lib/sfio/Sfio_dc/sfdcdio.c,
	  sfio/src/lib/sfio/Sfio_dc/sfdcdos.c, smtpserver/policytest.c,
	  sfio/src/lib/sfio/Sfio_dc/sfdcfilter.c,smtpserver/policytest.h,
	  sfio/src/lib/sfio/Sfio_dc/sfdcseekable.c, smtpserver/smtpcmds.c,
	  sfio/src/lib/sfio/Sfio_dc/sfdcsubstream.c, transports/hold/hold.c,
	  sfio/src/lib/sfio/Sfio_dc/sfdctee.c, transports/expirer/expirer.c,
	  sfio/src/lib/sfio/Sfio_dc/sfdcunion.c, transports/fuzzyalias/db.c,
	  transports/mailbox/mailbox.c, transports/smtp/getmxrr.c,
	  transports/sm/sm.c, transports/smtp/smtp.c, utils/makedb/dblook.c,
	  utils/makedb/makedb.c, utils/vacation/vacation.c:
	    A very large OpenBSD patch cluster; including:
	    - Revision of database facility autoconfig
	    - several printf warnings
	    - sfio #define collision avoidance
	    - SETEUID() and friends

	* proto/zmailer.sh.in:
	    A  -q  option for completely quiet operation
	    (part of OpenBSD patch cluster)

	* utils/mxverify/mxverify-cgi.c, utils/mxverify/getaddrinfo.c:
	    Some radical cleanups in the TEXT/HTML presentation

	* transports/smtp/smtp.c:
	    Certain diagnostics control bits fixed so that RSETs won't
	    overwrite last real command performed on connection and
	    having done something which e.g. caused a reject

	* smtpserver/cfgread.c, smtpserver/smtpdata.c,
	  smtpserver/smtpserver.c, smtpserver/smtpserver.h:
	    "PARAM outlook-tls-bug" -- Outlook Express seems to kick on
	    TLS when it is told to use TLS, and the destination port is
	    not 25, but _anything_else_ !

2001-07-31  Matti Aarnio  <mea@zmailer.org>

	* smtpserver/smtpdata.c:
	    Had omitted couple  fflush()  calls in DATA and BDAT
	    to commit accumulated buffered data into file so that
	    external  contentfilter()  program can analyze it.

2001-07-29  Matti Aarnio  <mea@zmailer.org>

	* utils/autoanswer.pl.in:
	    Fixing buggy tests; originally about "$nosend", but
	    there were some other too..	

	* include/mail.h.in:
	    Forgot this from the inject below...

2001-07-05  Matti Aarnio  <mea@zmailer.org>

	* include/libc.h, include/mail.h.in, libc/mail.c, libc/sfmail.c,
	  scheduler/msgerror.c, smtpserver/smtpdata.c, 
	  transports/errormail/errormail.c, transports/smtp/getmxrr.c:
	    Changed (properly) the _*mail_close_() inode parameter to
	    be 'long'.

2001-07-04  Matti Aarnio  <mea@zmailer.org>

	* transports/errormail/errormail.c:
	    Recognize source channel 'error', and produce the destination
	    address accordingly -- ugly thing to do an "error-in-error"
	    message that way, but..

	* transports/mailbox/mailbox.c:
	    Recognize (and wipe out, and re-insert at delivery) incoming
	    headers "Original-Recipient:"  (for RFC 2298 section 2.3),
	    and "Envelope-ID:".

2001-06-15  Matti Aarnio  <mea@zmailer.org>

	* transport/smtp/smtp.c:
	    In synchronous SMTP connections, handle the result
	    processing correctly so that permanent reject with
	    MAIL FROM will permanently reject the message..

2001-06-11  Matti Aarnio  <mea@zmailer.org>

	* utils/mxverify/mxverify-cgi.c:
	    Print out the user supplied input (arg strings) properly
	    protected so that even if the input happens to be HTML
	    text in disguise, it shows up as "a string".

2001-06-04  Matti Aarnio  <mea@zmailer.org>

	* scheduler/transport.c, scheduler/msgerror.c:
	    Oh no, one-off string length after  cfgdirpath()  function
	    behaviour change.   Got around to write \0 to child, which
	    promptly misbehaved...

	* scheduler/transport.c, scheduler/conf.c:
	    Under some mysterious conditions (Linux kernel 2.4.5-pre4. ?)
	    the scheduler does not get select on read on dead childrens
	    stdout ??

	* smtpserver/smtpserver.h, smtpserver/smtpserver.c,
	  smtpserver/smtptls.c, smtpserver/smtpdata.c:
	    Got rid of all  alarm()  calls in the server code, and use
	    select() instead everywhere. Along with NON-BLOCKING sockets.
	    The previous code has apparently allowed accumulation of
	    servers, which never die out...

2001-06-03  Matti Aarnio  <mea@zmailer.org>

	* scheduler/mailq.c:
	    Oops time; closing FILE * object twice is BAD THING to do
	    in some cases.  Must not do so.  Early closing of the
	    underlying read socket is ok.

	* proto/smtpserver.conf.in:
	    In  smtp-auth  related PARAMs, do emphasise their security
	    implications!

2001-05-30  Matti Aarnio  <mea@zmailer.org>

	* scheduler/scheduler.c, scheduler/msgerror.c,
	  scheduler/qprint.c, scheduler/threads.c,
	  scheduler/transport.c, scheduler/update.c:
	    I suspect that in certain cases the scheduler should do
	    "resync" on message file instead of just logging a complaint
	    into stderr like it now does at the end of  findvertex().
	    Adding some debugging data so that I can verify the thing.

2001-05-25  Matti Aarnio  <mea@zmailer.org>

	* README.UPGRADING:
	    Semi-forgotten note about the results of 2001-05-15's
	    libta/dianostic.c + scheduler/update.c + smtp TA/scheduler
	    interaction protocol detail.  You can have NEWER scheduler,
	    than smtp-ta, because this is backwards channel detail.

	* lib/cfgets.c:
	    Darryl Miles <darryl@netbauds.net>  found strange looking
	    problem with certain kind of "malformed" input for scheduler
	    configuration file.  Turns out that when this function
	    encounters EOF, and it isn't at the beginning of the line,
	    the line buffer never gets zero-terminated causing possibly
	    strange side-effects when thus revealed previous content of
	    the buffer may reappear.

	    Additional coding to always zero-terminate the allocated
	    buffer.   The code is being used both as classical  fgets(),
	    but also by returning exact number of characters collected.

	    I am doubtfull that the previous state was in any way capable
	    to produce system security threat.

2001-05-22  Matti Aarnio  <mea@zmailer.org>

	* proto/cf/fqdnaliases.cf, proto/cf/process.cf,
	  proto/cf/aliases.cf:
	    Some experiments on doing message-wide 'didexpand' analysis
	    to see if complicated duplicate recipient removal code works.

2001-05-21  Matti Aarnio  <mea@zmailer.org>

	* smtpserver/smtpetrn.c:
	    Tell to the remote scheduler [source.ip.address]@mynodename
	    when issueing ETRN thru MQ2 mechanism.
	    Helps to hunt down cases where lots of ETRN requests are
	    appearing into the scheduler for domains that we don't serve,
	    and/or other such strange things...

	* configure.in, libc/gai_strerror.c:
	    Problems at compling "replacement-ipv6-libc"
	    with RH 7.1 libc.

2001-05-16  Matti Aarnio  <mea@zmailer.org>

	* ssl/Makefile.in, ssl/ssl.c, ssl/ssl:sst.[ch], ssl/ssl_sst.[ch]:
	    Changed references from  ssl:sst.[ch]  files to  ssl_sst.[ch]

2001-05-15  Matti Aarnio  <mea@zmailer.org>

	* include/ta.h, scheduler/update.c,  transports/smtp/smtp.c,
	  transports/libta/diagnostic.c, transports/smtp/getmxrr.c:
	    Define and use  EX_DEFERALL  exit code, which introduces
	    a new, somewhat differently behaving handling of temporary
	    kind of failures -- intended for smtp transport-agent for
	    DNS lookup failures of some domains, and connection failures.
	    To large extent this behaves as if "retryat +60" were
	    defined, but this will also mark ALL subsequent messages
	    in the thread (via "nextitem" chain) to 1) have been
	    attempted, and 2) with the same message as we initially have.
	    (It does not, however, expire any messages - at least
	     directly.)

	* scheduler/mailq.c:
	    The 'mailq -v' did show the ta-work-specification-file
	    size, not message size in 'bytes %ld' printout.. :-(

	    Also:  Have options:  "-c channel -h host"
	    which TOGETHER will let querying of some particularly
	    interesting destination channel/host pair among all that
	    the system may have active.  Requires MAILQ-V2 mode, and
	    '-v' option use (not '-Q'!).

2001-05-10  Matti Aarnio  <mea@zmailer.org>

	* include/libc.h:
	    Copy the 'GETNAMEINFOFLAGTYPE' test code into this
	    file too from  libc/getnameinfo.c.  Bloody Solaris..

2001-05-08  Matti Aarnio  <mea@zmailer.org>

	* Makefile.in:
	    Version 2.99.55-patch1

	* transports/smtp/smtp.h, transports/smtp/smtp.c:
	    Reworking (simplifying) DATA phase processing,
	    and quick-retry handling of socket write/read
	    failure induced closes.  There is limit of three
	    attempts on any given host for the delivery before
	    giving up entirely.  (Passing the failure to the
	    scheduler..)

2001-05-04  Matti Aarnio  <mea@zmailer.org>

	* proto/cf/p-routes.cf:
	    Wrong function called to pick the flag data..

	* transports/smtp/smtp.c:
	    Fixup into pipelined error diagnostics accumulation
	    methodology.

	* proto/newdbprocessor.in:
	    PERL 5.6.0+ specific syntax altered back to earlier syntax,
	    which even the lattest perl does support.

	* configure.in:  --with-zconfig-noload   option to disable
	    preloading of possibly existing ZCONFIG file contents
	    into configuration variables.

2001-04-04  Matti Aarnio  <mea@zmailer.org>

	* transports/smtp/getmxrr.c:
	    If destination has one MX, and lookup for its A yields
	    EAI_AGAIN, remember to report SS->mxcount = 0 ...

2001-04-03  Matti Aarnio  <mea@zmailer.org>

	* proto/forms/delivery:
	    Changed the URL reference to a "decode key" at
		http://www.zmailer.org/delivery-report-decoding.html

	* acconfig.h, configure.in:
	    When supporting local  _getaddrinfo_() function,
	    have a HAVE_ variable for it too!

	* include/mail.h.in, router/rfc822.c:
	    Rearranged the _CF_*** defines into the order at which
	    the router uses them -- while editing documentation,
	    and needing coherent view at the things.

	* scheduler/threads.c:
	    When running parallel TAs at same thread, remember to
	    traverse pointer chain when showing process list..
	    (verbose debugging to stderr..)

	* libc/getaddrinfo.c:
	    Present at the debug vlog file the g->gaih() return code
	    in octal (it is a bitset, after all)

	* smtpserver/mxverify.c, transports/smtp/getmxrr.c:
	    Use the  HAVE__GETADDRINFO_  flag for local debug version..
	    Also done changes for retrieving AF_INET and AF_INET6
	    addresses separately, as there seems to be some problems
	    when trying to use  ai_family == 0  ("any goes") form.

2001-03-08  Matti Aarnio  <mea@zmailer.org>

	* include/mailer.h, router/rfc822.c, router/libdb/header.c,
	  transports/errormail/errormail.c, scheduler/msgerror.c,
	  proto/cf/p-routes.cf, router/functions.c:
	    New envelope header:  "errormsg"  telling that a message
	    is internally generated error message; router script has
	    new function:  $(iserrmessage) yielding this flag.

	* include/libc.h, include/libsh.h, include/sysprotos.h,
	  libc/getopt.c, libsh/builtins.c, libsh/interpret.c,
	  libsh/main.c, libsh/zmsh.c, router/router.c, router/db.c,
	  router/functions.c:
	    Changed all Router/ZMSH internal instances of getopt() to be
	    zgetopt() with additional capability -- optionset can now
	    contain doublecolon as an option, IF the ':' is the FIRST
	    character at the option specifier string...

	* proto/newdbprocessor.in, proto/db/dbases.conf, router/db.c,
	  proto/cf/p-routes.cf, proto/cf/rrouter.cf, proto/db/routes,
	  router/libdb/search.h:
	    Implemented DBlookup routine to be able to pick some options
	    at runtime, '-:' (with string arg) supplies default lookup
	    key in case the normal iteration fails.
	    Cases where the "zmailer newdb" should generate the lookup
	    wrapper function with user parameter passing.
	    Also support 'incore' database by compiling from source file
	    to "db add" statements in the ``relationname.zmsh'' script.

	* router/rfc822.c, router/functions.c, router/prototypes.h:
	    Streamlined the recognition of the message being coming
	    from an Error Channel ( not same as "errmessage" !)

	* proto/cf/aliases.cf:
	    The FOO+TAG needs to cut off at the first '+' char, not
	    by the last (or whatever the REGEXP code happens to use)

	* libsh/regex.c libsh/regex.h:
	    Updated this pair to a very recent GLIBC contained version.

	* transports/smtp/smtp.c:
	    At response wait timeout, do have a GOAL TIME of when
	    to timeout, not returning to it over and over again..

	* configure.in, aclocal.m4, config.h.in:
	    Using experimental  autoconf 2.49d  mandated couple of
	    changes...

2001-03-02  Matti Aarnio  <mea@zmailer.org>

	* README.UPGRADING:
	    Added a note about the ALTERED default locations
	    of  zmailer.conf  and  mail.conf  files.

	* man/smtpserver.8, proto/smtpserver.conf.in:
	    Fix up the tcp-wrapper related documentation, and the default
	    stuff in the  smtpserver.conf  template.

	* scheduler/threads.c:
	    Print the gauges of message counts in the queue with SIGNED
	    values, thus making underflows (negatives) more obvious.

2001-03-01  Matti Aarnio  <mea@zmailer.org>

	* scheduler/mailq.c:
	    Embarassing uninitialized array elements used for checking
	    if loop ends - Tomasz Bojakowski <mad@devil.inside.pin.pl>
	    reported errors.

2001-02-27  Matti Aarnio  <mea@zmailer.org>

	* transports/smtp/smtp.c:
	    At  smtp_sync()  when running in PIPELINING, if the
	    MAIL FROM has produced 400 or 500 series response,
	    do fault the RCPT TO responses in every case.
	    (With EX_UNAVAILABLE for 500-series, not EX_TEMPFAIL.)

	* smtpserver/smtpserver.h, smtpserver/smtpserver.c:
	    Track Z_read() return errno code more properly to
	    the 'Session closed w/o QUIT' log report.
	    Case where this was needed was actually some firewall
	    product which f**d OUTBOUND SMTP session of raporter...

2001-02-26  Matti Aarnio  <mea@zmailer.org>

	* utils/listexpand.c, transports/smtp/smtp.c, include/ta.h,
	  transports/libta/ctlopen.c:
	    Implemented "EZMLM-alike" listexpander which does
	    the envelope MAIL FROM address content rewrite at
	    tne outgoing SMTP session.  This is done with 'DSN'
	    dataentry  EZMLM=  which is presumed to have valid
	    stuff to be appended to the localpart of the address
	    envelope:  '+recipient=40address.dom', for example.

	    When compared with more classical approach, this does
	    message routing in system-friendly way, and only changes
	    the output stage slightly.  (At classical case the message
	    is expanded for each recipient, say 3000 copies of 60 kB
	    each..  This mechanism is way faster.)

2001-02-24  Matti Aarnio  <mea@zmailer.org>

	* smtpserver/smtpcmds.c:
	    Make RCPT TO synchronous router reporting to be a copy
	    of MAIL FROM one -- report things correctly, that is.

2001-02-23  Matti Aarnio  <mea@zmailer.org>

	* router/rfc822.c, router/rtsyslog.c:
	    Added the time to process the message to the router syslog
	    report.  Both 'delay' and 'xdelay' just like at the TA's.
	    'delay' is time from message injection to routing completion,
	    'xdelay' is the time spent at the routing.

	* utils/listexpand.c, utils/Makefile.in:
	    Added '+ezlml' option, changed the low limit at
	    the -bundlesize -- and set its default to 6000!
	    Also re-learned that 'skip821address()' can only
	    be used with *valid* addresses,  rfc821_path2()
	    is for possibly invalid input scanning!

2001-02-21  Matti Aarnio  <mea@zmailer.org>

	* Makefile.in:
	    Version 2.99.55  (the real release!)

	* router/functions.c:
	    At  $(listaddresses ..) and $(listexpand ..)  functions,
	    removed the '"%1"@..' type substitutions with '-l' option.
	    See the comment about '-%' at 'relation' function below.
	
2001-02-20  Matti Aarnio  <mea@zmailer.org>

	* scheduler/agenda.c, scheduler/scheduler.c, scheduler/mq2.c,
	  smtpserver/smtpetrn.c:
	    Report the ETRN information with contactee's IP address, and
	    timestamp when writing it into the scheduler's log.

	* proto/newdbprocessor.in, proto/db/dbases.conf, man/router.8,
	  proto/cf/fqdnalias.cf, router/db.c, router/functions.c:
	    Add '-%' option to the 'relation' routine to control, when
	    looked up data contained '%0' thru '%9' may get substituted.

	* proto/Makefile.in:
	    Remove at 'distclean' files which are autoconf generated.

2001-02-19  Matti Aarnio  <mea@zmailer.org>

	* transports/smtp/getmxrr.c:
	    Format printing of '%s' with NULL argument -> NULL-
	    referral -> ...

	* scheduler/mailq.c:
	    When doing some slow  'mailq -vv', and using MAILQv2, do
	    query all data out of the scheduler before poking into
	    the files (which may be a lot).  Limit the time of inter-
	    action with the scheduler to the minumum.

2001-02-16  Matti Aarnio  <mea@zmailer.org>

	* scheduler/readconfig.c:
	    One-off bug in ${ZENV} substitution code.

	* configure.in:
	    Derive  ZCONFIG  (formely defaulted to  /etc/zmailer.conf)
	    from  --prefix  !  The same way as --prefix derives
	    $MAILSHARE.    Officially zmailer.conf's new location
	    *is* $MAILSHARE.

2001-02-15  Matti Aarnio  <mea@zmailer.org>

	* proto/cf/fqdnaliases.cf:
	    Moved the local-part (user) extraction up a bit so that
	    it can be given to the listaddresses as expansion parameter.

	* router/functions.c:
	    At  $(listaddresses ..) and $(listexpand ..)  functions,
	    support '"%1"@..' type substitutions with '-l' option.
	    I am now considering this *wrong* approach, and am doing
	    more sendmailish approach to %N substitutions.

	* router/functions.c, router/db.c, router/libsh/search.h:
	    Support up to 8-9 additional substitution options at the
	    database lookups.  At the moment is lacking the actual %N
	    substitution code!  WORK IN PROGRESS!

	* scheduler/mailq.c:
	    a bit of comments & one missing newline on error printouts.

2001-02-14  Matti Aarnio  <mea@zmailer.org>

	* router/router.c:
	    Cut down logging/log printing a bit -- duplicated data
	    actually.

2001-02-13  Matti Aarnio  <mea@zmailer.org>

	* proto/scheduler.conf.in, scheduler/readconfig.c:
	    Allow ${ZENV} substitutions in PARAM lines.
	    ("PARAMauthfile" and "PARAMmailqsock", to be exact.)

	* smtpserver/policytest.c:
	    Do Test-Rcpt-DNS-RBL also based on FULL userid lookup.
	    Allows some users to want the lookup, others not.

	* proto/cf/SMTP.cf.in, proto/cf/SMTP+UUCP.cf.in:
	    Search for the 'mail.conf' from  $MAILSHARE/mail.conf,
	    and not from  /etc/.

2001-02-08  Matti Aarnio  <mea@zmailer.org>

	* router/functions.c:
	    At  $(filepriv ...)  function, when the call supplies
	    file userid, do presume valid REGULAR file.  This is true
	    for several databases which produce privilege controlling
	    results.

	* proto/cf/canon.cf, proto/cf/rrouter.cf:
	    More issues at DECNET-IV type address analysis.
	    Now we support a bit of being DECNET-IV gateway, although
	    we propably need to rewrite headers major way to be able to
	    route to and from DECNET-IV domains.

	* smtpserver/Makefile.in:
	    Do refer to wantconn.o file in the OBJS macro, it needs to
	    be compiled in case it is wanted to be used...

2001-02-01  Matti Aarnio  <mea@zmailer.org>

	* man/mailbox.8, transports/mailbox/mailbox.c:
	    Add two more environment variables to pre-existing
	    ones at the mailbox driven subprocesses:
	    - MSGSPOOLID=<ZMailer-internal-spoolfile-id>
	    - MESSAGEID=<somebody-supplied-string>
	    These were created when I had a need, of course..
	    Pipe driven application should be able to syslog(3)
	    meaningfully what was the message disposition.
	    (Majordomo in my case ;) )

2001-01-31  Matti Aarnio  <mea@zmailer.org>

	* configure.in, acconfig.h:
	    - --with-routeruser-is-abnormal  option
	    - detect possible pre-existing ROUTERUSER_IN_ABNORMAL_UNIX
	      value in zmailer.conf file
	    - in case of wanting to use tcp-wrappers, do analyze if it
	      needs adding -lnsl library in addition to -lwrap -- some
	      unfortunate systems (RedHat 6.2-7.0) compile the bloody
	      wrapper library with one NIS call, and the ZMailer does not
	      use NIS libraries for anything (except if router wants..)

	* smtpserver/smtpserver.h, smtpserver/smtpserver.c,
	  smtpserver/smtpdata.c:
	     Arm the alarm(2) just before call to read(), and re-arm
	     it right after return from it.  This *may* cut down the
	     number of alarm(2) calls a bit.
	
	* smtpserver/smtpserver.h, smtpserver/smtpserver.c,
	  smtpserver/wantconn.c, scheduler/transport.c,
	  scheduler/wantconn.c:
	    #ifdef  USE_TCPWRAPPER   in addition to  #ifdef HAVE_TCPD_H

2001-01-30  Matti Aarnio  <mea@zmailer.org>

	* libresolv/gethnamaddr.c:
	    Silence the code in several occasions.
	    Getting SIG data is *not* a problem, it *does* happen.

	* smtpserver/smtpserver.c:
	    Clean "RSET" response from
	      "250 2.0.0 2.0.0 Reset processed.."
	    to one with: "250 2.0.0 Reset processed.."

2001-01-25  Matti Aarnio  <mea@zmailer.org>

	* transports/smtp/smtp.c:
	    Change all instances of  getaddrinfo()  parameters of
	    service name "smtp" to port-number "0".  Give also
	    some detail on what the getaddrinfo() diagnostics gave.

	* router/functions.c:
	    - In  $(listaddresses ..)  and  $(listexpand ..)  functions,
	      explicitely support receiving lines with '#'- starting them
	      (comments, you see).  Also when found no addresses,
	      explicitely do mention A) what EUID the expansion was
	      running, and B) that user should check the file/directory
	      protections of the original file.
	    - Also, the $(filepriv ...)  function will from now on
	      allow wider opening privileges in some cases -- if
	      residence directory does not have X-bits in group
	      and/or world, then related bits in the file are not
	      checked -- i.e. if the directory is not world-
	      accessible, it is irrelevant if file has w-bit in
	      world set.

	* proto/cf/SMTP+UUCP.cf.in, proto/cf/SMTP.cf.in:
	    Couple of fixes, and code rearrangements into
	    the sample boiler plate.

	* transports/smtp/getmxrr.c:
	    Play a bit more with  rmsgappend()  calls here.
	    Specifically report if  getaddrinfo()  calls report
	    some diagnostics!

2001-01-24  Matti Aarnio  <mea@zmailer.org>

	* lib/selfaddrs.c, transports/smtp/smtp.c:
	    If resolver supports option flag  RES_USE_INET6, but
	    system doesn't support IPv6 socket, clear that flag.

	* libresolv/gethnamaddr.c, libresolv/netdb.h:
	    When using   --with-bundled-libresolv  silence things a bit
	    as one particular #define may be set before calling this.
	    Also, do explicitely at first lookup /etc/hosts file for
	    host, only then do resolver lookups.

2001-01-22  Matti Aarnio  <mea@zmailer.org>

	* include/libz.h, include/mailer.h, compat/sendmail/sendmail.c,
	  lib/nobody.c, lib/pwdgrp.c, lib/trusted.c, router/functions.c,
	  router/router.c, scheduler/readconfig.c, smtpserver/zpwmatch.c,
	  transports/hold/hold.c, transports/mailbox/fmtmbox.c,
	  transports/mailbox/mailbox.c, transports/mailbox/mboxpath.c,
	  transports/smtp/smtp.c, transports/smtp/smtp.h,
	  utils/vacation/Makefile.in, utils/vacation/vacation.c:
	    Use  zgetpwnam()  everywhere where there used to be
	    getpwnam(),  supply also our very own   struct Zpasswd
	    for the data referral.
	    Library  lib/pwdgrp.c  is the location of the wrapper
	    function, which intention is to clarify error handling
	    of various systems -- getpwnam() returning NULL may mean
	    many things, and interpreting  errno  is -- challenging.

	* libsh/builtin.c, libsh/interpret.c, libsh/variables.c,
	  proto/cf/SMTP+UUCP.cf.in, proto/cf/SMTP.cf.in,
	  proto/cf/aliases-new.cf, proto/cf/aliases.cf,
	  proto/cf/consist.cf, proto/cf/fuzzy-aliases.cf,
	  proto/cf/process.cf, proto/cf/rrouter.cf,
	  proto/cf/server.cf, proto/cf/standard.cf, README.UPGRADING:
	    Change internal variable expantion to never do IFS
	    tokenisation at expanded strings.
	    Supply  $(ifssplit ...)  function in case it is needed
	    for something, and just token-lists don't make it.
	    Write some definite words on README.UPGRADING !

2001-01-22  Eugene Crosser <crosser@online.ru>

	* transports/libta/mimeheaders.c:
	    Sometimes quoted string (to de stripped) is really not,
	    and we must be carefull to do it only with a string of
	    minimum length of 3.

2001-01-22  Matti Aarnio  <mea@zmailer.org>

	* transports/smtp/smtp.c:
	    When the reply collection goes to timeout ( smtp_sync() ),
	    CLOSE the smtp-connection.  Also do rmsgappend() a report,
	    that reply collection went into timeout..

2001-01-16  Matti Aarnio  <mea@zmailer.org>

	* transports/hold/hold.c:
	    Do same processing here as at router/functions.c.

	* router/functions.c:
	    Condition "no such user" can be signaled with   getpwnam()
	    yielding NULL and errno == 0.  Not only   errno == ENOENT.

	* lib/dbpwdgrp.c, lib/nobody.c, lib/pwdgrp.c, lib/trusted.c,
	  router/daemonsub.c, router/functions.c, router/router.c,
	  transports/mailbox/mailbox.c:
	    Essentially in front of *every*  getpwnam(),  do place
	    explicite clear of   errno  variable.
	    Apparently at Solaris 2.6 it isn't cleared/set quite always
	    when doing error paths...

2001-01-15  Matti Aarnio  <mea@zmailer.org>

	* transports/mailbox/mailbox.c:
	    Typo -- mmfd_mode which should be  mmdf_mode ...

	* transports/libta/diagnostic.c:
	    #include <errno.h> -- apparently cc at Solaris 2.6
	    didn't like it without :-/

	* smtpserver/smtpserver.h, smtpserver/cfgread.c:
	    More Sol26/SunSoft CC things.

	* lib/rfc822scan.c:
	    Recognize  "HOST::USER"@decnet-IV.gw  syntax,
	    and don't ever unquote it.  We don't support
	    being the DECNET-IV gateway ourselves.

	* proto/zmailer.sh.in:
	    If  dbases.conf  is not in use, and we execute
	    'zmailer newdb', do 'newdb' the $MAILSHARE/db/mboxmap
	    also.

2000-12-31  Matti Aarnio  <mea@zmailer.org>

	* transports/mailbox/mailbox.c:
	    At normal success path, do proper  fsync(2)  return
	    status analysis - if the filesystem where the write
	    goes to is ever truly asynchronous, the only way to
	    know if it runs out of diskspace, or whatever is after
	    the return of fsync(2).

	* libc/mail.c, libc/sfmail.c, scheduler/msgerror.c,
	  router/rfc822.c, transports/libta/diagnostic.c:
	    More of carefull  fsync(2)  calls.

	* transports/mailbox/mailbox.c, smtpserver/smtpcmds.c,
	  transports/libta/diagnostic.c:
	    Also carefull wrappers for  ftruncate(2)  calls.

2000-12-30  Matti Aarnio  <mea@zmailer.org>

	* transports/libta/mimeheaders.c:
	    Survive bad control characters in input.

	* proto/cf/aliases.cf:
	    Sender address rewrite function to yield full
	    "$user$plustail$domain" - incoming quad arrives
	    without domain part.

	* router/rfc822.c
	    When in 'trace sequencer', do debug print call
	    parameters to $(crossbar ...) before the call.

	* scheduler/readconfig.c, scheduler/transport.c:
	    setpriority() syscall autoconfig things

2000-12-14  Matti Aarnio  <mea@zmailer.org>

	* smtpserver/smtpdata.c:
	    "BDAT 0 LAST" is valid per explicite example at RFC 3030.
	    It is also valid per syntax, but not quite so by mere
	    engineering thought...
	
2000-12-04  Matti Aarnio  <mea@zmailer.org>

	* transports/libta/mimeheaders.c:
	    ElectricFence is your friend!  Writing over
	    the end of the allocated array by on element :-/

2000-12-02  Matti Aarnio  <mea@zmailer.org>

	* transports/smtp/smtp.c:
	    Don't soften reception of RCPT TO if MAIL FROM gave
	    500 series code -- there was some reason for this...

	* transports/libta/tasyslog.c:
	    Report correctly if we have detected MULTIPART(QP).

	* lib/selfaddrs.c:
	    Something odd at Solaris -- none of supported functions
	    got called ??? -- realloc() bug :-(

	* All over the place;
	    Changeing  getzenv()'s  return value to 'const char *'
	    caused all kinds of nuisance warnings to sprout...

	* All over the place; (Makefile.in):
	    More "make -j N" work.

2000-12-01  Matti Aarnio  <mea@zmailer.org>

	* lib/linebuffer.c, lib/selfaddrs.c, router/daemonsub.c,
	  scheduler/scheduler.c:
	    Changed some code doing
	    	if (!ptr) ptr = malloc(..); else ptr = realloc(ptr,..);
	    into
	    	ptr = realloc(ptr,...)
	    after wanting to simplyfy one part of code and reading
	    man-page..

	* Makefile.in, libident/Makefile.in, libs/Makefile.in,
	  libsh/Makefile.in, router/Makefile.in, smtpserver/Makefile.in,
	  router/libdb/Makefile.in, sfio/Makefile.in,
	  sfio/src/lib/sfio/makefile.in, 
	  sfio/src/lib/sfio/Stdio_b/Makefile.in, 
	  sfio/src/lib/sfio/Stdio_b/sfstdhdr.sh:
	    Tried to "make -j 20" and learned things about parallellism..
	    Things really aren't correct yet, and at least sfio may end
	    up being compiled some N-4 times in parallel...

	* transports/smtp/smtp.c:
	    Modify some loops - removed unnecessary state free()er code
	    from within the  smtp_sync()  -- with a theory that the
	    pipecmds[] array goes boinkers somewhen...

2000-11-30  Matti Aarnio  <mea@zmailer.org>

	* transports/libta/mimeheaders.c, transports/mailbox/mailbox.c,
	  transports/smtp/smtp.c, include/ta.h:
	    Content-Type Parser had reversed pointers -- oops
	    Changed parsers (multiple) parameters from (char **)
	    to (char *)

	* transports/libta/mimeheaders.c:
	    RFC822 ATOM skipping didn't.. (single-char atoms)

	* transports/libta/swriteheaders.c,
	  transports/libta/fwriteheaders.c:
	    Reusing variable caused wrong content at the pointer,
	    and rare SIGSEGVs lurking ...

2000-11-24  Matti Aarnio  <mea@zmailer.org>

	* transports/libta/mimeheaders.c:
	    Simplify!  More of the simplification of code.

	* transports/libta/ctlopen.c:
	    add a bit to an allocation -- not that it really
	    should matter, but ...
	
	* transports/smtp/smtp.c:
	    sprinkled  smtp_flush() around places while hunting one
	    nasty memory corruption.

	* transports/libta/swriteheaders.c,
	  transports/libta/fwriteheaders.c:
	    Some leftover counter adjustments in places where
	    it now harmed...

	* transports/smtp/smtp.c:
	    Debugging most peculiar problems - propably at swriteheader.c
	    Showing at the verbose log the WRITTEN headers.

	* transports/smtp/smtp.c:
	    A bit different handling on pipelined response collection.
	    If MAIL FROM yields an error, report it, never mind what
	    socket read did later..

	* transports/libta/mimeheaders.c:
	    Simplify!  Don't try to be smart when playing with malloced
	    buffers -- it doesn't pay, quite contrary...  Found a number
	    of cases where a buffer got reallocated, but a pointer into
	    it wasn't adjusted into the new area.

	* transports/libta/swriteheaders.c,
	  transports/libta/fwriteheaders.c:
	    Changed the code from "scan the input to determine future
	    space needs" to "(re)expand as more space is needed" to
	    make sure there is no discrepancy in between the two.

2000-11-23  Matti Aarnio  <mea@zmailer.org>

	* transports/smtp/smtp.c:
	    Few hours of going over the  smtp_sync()'s smtp_nbread()
	    call, and its surroundings.  Inverted its logic, and finally
	    got simple, clean, understandable code.  ("I smell Wumpus!")

	* scheduler/mailq.c:
	    Wondered that "mailq -vv" didn't show diagnostic messages
	    along other data.  Now it does.  Plus other small tuneups
	    of the result.

	* transports/smtp/smtp.c:
	    A bit more of care on referencing 'logfile' variable.
	    Not using uninitialized one.

	* transports/mailbox/mailbox.c:
	    A trivialish  return-receipt-to  processing fixup at
	    the mailbox so that the user-supplied string is unfolded
	    into single line with spaces in places of folds (newlines).
	    (Proper fix is FULL RFC 822 scanner to pick the recipient
	     address, but perhaps not...)

	* transports/smtp/smtp.c:
	    Blocking read waiting was done with busy-loop, and
	    if the connection *stays* in ESTABLISHED state, but
	    never timeouts --> busy spin goes on, and on...

	* scheduler/msgerror.c:
	    Don't try to be clever with cfp->mid field reuse at
	    the slurp()ed instance -- use incoming 'cfpi->mid'.

2000-11-21  Matti Aarnio  <mea@zmailer.org>

	* transports/smtp/smtp.c:
	    Meaningless variable name changes (and some revoked changes
	    which got committed into CVS - and now removed.)

	* transports/libta/fwriteheaders.c,
	  transports/libta/swriteheaders.c:
	    One subtle bug in BDAT buffering mode left in line-ending
	    newline handling --> surprising crashes seen.

	* transports/libta/mimeheaders.c:
	    Reserve a bit more space for coalesced mime-headers
	    (of "totlen" type).

	* transports/smtp/appendlet.c:
	    Outch! Messages without Content-Type: header did SIGSEGV!

	* lib/selfaddrs.c:
	    there is no field called ifr_ifindex, there is: ifr_index
	    -- returned to previous: memset(ptr, 0, size)
	    -- because Linux glibc 2.1+ has ifr_ifindex, solaris has
	       ifr_index   (barf...)

2000-11-19  Matti Aarnio  <mea@zmailer.org>

	* man/smtpserver.8, smtpserver/policytest.c:
	    Lowercasify the lookup key for alias item lookups,
	    and fill in the doc/guides/smtp-policy header into
	    the manual page of the smtpserver.

2000-11-17  Matti Aarnio  <mea@zmailer.org>

	* scheduler/threads.c, scheduler/mailq.c:
	    Some experiments of making the  mailq-v2  mode mailq
	    to show same things as the old version was able with
	    'verbose' mode turned on.

	* **/Makefile.in:
	    Changes on what we refer at LIBDEB= definitions.

	* transports/libta/mimeheaders.c:
	    - Missing initialization of one buffer -> result is
	      memory scrible and utter chaos..
	    - Wondering of X-Warning: writer does something fishy,
	      as the Received: header generated by the site where
	      that writer is used does not appear in the message..

	* proto/scheduler.conf.in, proto/db/routes:
	    Define channel   smtp-log  which (obviously) logs
	    the SMTP protocol into log-file.  See "-l" option
	    at  smtp(8) man-page.

2000-11-16  Matti Aarnio  <mea@zmailer.org>

	* configure.in:
	    Some reworking around NDBM tests -- we *MAY* have
	    problems when <ndbm.h> is actually from BSD DB 1.85.
	    Specifically in OpenBSD 2.7, several other BSDs as well.

	* transports/smtp/getmxrr.c, scheduler/mailq.c,
	  libc/myhostname.c:
	    BSD  getaddrinfo()  call returns ai_canonname member as NULL
	    in very common cases!  Uargh :-(

	* lib/Makefile.in:
	    At  'make selfaddrs-test', do use autoconfigured @LIBRESOLV@
	    library reference.

2000-11-14  Matti Aarnio  <mea@zmailer.org>

	* lib/selfaddrs.c, lib/zgetifaddress.c:
	    Fix the support for FreeBSD 4.2*/OpenBSD 2.7* featured
	    getifaddrs() function.

	* Makefile.in:
	    Mark version "2.99.55-pre1cvs" (which means nothing much)

	* include/ta.h, transports/libta/fwriteheaders.c,
	  transports/libta/swriteheaders.c, transports/libta/markoff.c,
	  transports/libta/mime2headers.c, transports/libta/stringlib.c,
	  transports/libta/mimeheaders.c, transports/smtp/appendlet.c,
	  transports/smtp/smtp.c, transports/smtp/smtp.h:
	    Initial steps towards doing proper format downgrade
	    during (SMTP) transport.
	    - Modified header handling to process folded lines as single
	      string, not as a sequence of strings.
	    - Wrote proper RFC822/MIME token scanner into  mimeheaders.c
	      which is able to correctly skip over places where
	      (folded)LWSP is allowed, including possible (comments)
	      in them.

2000-11-12  Matti Aarnio  <mea@zmailer.org>

	* CVS tagged this as Version zmailer-2-99-54-patch1
	  Made also CVS based diff against 2.99.54.

	* lib/selfaddrs.c:
	    Learned something about the SIOCGIFFLAGS/SIOCGLIFFLAGS
	    ioctl parameters, and what is necessary for initializing
	    its call.

	* transports/smtp/smtp.c:
	    Some oddball moments don't fail properly after response
	    timeout during certain critical periods -- mainly of
	    DATA/RSET.
	    Doing   smtpclose()  where we used to RSET  right after
	    DATA has been sent, and response to it has been waited
	    for way too long..

2000-11-02  Matti Aarnio  <mea@zmailer.org>

	* smtpserver/smtpserver.h, smtpserver/smtpserver.c:
	    Turn the listening sockets into NON-BLOCKING mode,
	    and once connection is accept(2)ed, turn the communication
	    socket into blocking mode.

	* transports/smtp/getmxrr.c:
	    Randomish bounces seen at  vger.kernel.org  for domains
	    which have non-functional DNS servers (likely due to
	    network failure, or some such.)  Symptom seems to
	    indicate NXDOMAIN DNS query reply status, but the
	    darn thing happens *rarely*...
	    ... I am not sure this change is a smart thing to do,
	    ... and later on I removed this change.
	    It looks like getting NXDOMAIN is trouble at whatever
	    system happens to be the DNS server, and we are better
	    off when we don't trouble ourselves too much with
	    circumventations at the resolver code for it.

2000-10-31  Matti Aarnio  <mea@zmailer.org>

	* transports/smtp/smtp.c:
	    Move the  notarystatsave()  function call up so that it will
	    always be called for all collected replies.  Formelly there
	    were cases where it didn't get called, which caused somewhat
	    weird looking results when the TA program switched to
	    alternate destination domain.

	* libc/getaddrinfo.c:
	    Disable entirely the AF_LOCAL support.
	    The code in question used tmpnam() which created some
	    complaints from the recent linker/libc at RH 6.2/7.0
	    hybride system.

	* configure.in, proto/smtpserver.conf(.in):
	    Turns out that "make install" when working in "adjacent
	    directory" setup doesn't pick correctly the smtpserver.conf
	    for the installation.  Returning to generated smtpserver.conf
	    file, although strictly speaking that is not needed.

	* proto/db/dbases.conf, utils/policy-builder.sh.in,
	  proto/newdbprocessor.in:
	    Spotted a few mistakes at the perl scripts of newdbprocessor.
	    With a hindsight -- me stupid...
	    Spotted also missing "-d pathalias" at "routesdb"
	    specification.  And some awk cleanups at policy-builder
	    as well, of course.

	* packaging/solaris/README:
	    Some additional comments on usage of this tool subset.

2000-10-24  Matti Aarnio  <mea@zmailer.org>

	* proto/cf/rrouter.cf, proto/cf/canon.cf:
	    Support magic trick:
		@[CHANNELNAME]:user@domain
	    in such a manner as to produce
		(((CHANNELNAME domain user@domain ATTRIBUTES)))
	    routing result

2000-10-23  Matti Aarnio  <mea@zmailer.org>

	* transports/smtp/smtp.c, utils/mxerify/mxverify-cgi.c:
	    For IPv4 addresses, verify that our connect(2)
	    destination is of valid IPv4 network (first octect
	    is in range of 1..223), at mxverify exclude loopback.

	* transports/smtp/Makefile.in:
	    Add into "make install" installation of $MAILBIN/getmxrr-test
	    so that it will be available at all installations...

	* utils/mxverify/mxverify-cgi.c:
	    Small text changes.

	* transports/smtp/smtp.c:
	    Noticed a few places where we need to reset the
	    "SS->rcptstates" variable.

2000-10-20  Matti Aarnio  <mea@zmailer.org>

	* proto/Makefile.in, packaging/Makefile.in:
	    'make install' will install also 'doc/guides/*' files
	    into $MAILSHARE/guides/  -- there seems to be call for
	    those files from some users...  In other environs,
	    like Linux distributions, there could be some sort
	    of  /usr/share/doc/zmailer-NNN/guides/ for them.

	* doc/guides/smtp-policy, utils/policy-builder.sh.in:
	    Defined ".manual" versions for ".mx", and ".relay"
	    of  smtp-policy driver files.  This enables more
	    wide-spread automated data fill-in, plus local
	    ".manual overrides".

2000-10-17  Matti Aarnio  <mea@zmailer.org>

	* transports/libta/ctlopen.c:
	    Return NULL, not 'void' in certain silence case.

	* transports/libta/diagnostic.c:
	    Try not to do so verbose diagnostic report over
	    syslog as via TA->scheduler channel.

	* smtpserver/smtpdata.c:
	    Parse possible "contentpolicy" analysis report, and present
	    it (in several cases) to the user.

	* smtpserver/smtphelp.c:
	    Small fixes for help presentation, and parameter recognition.

2000-10-16  Matti Aarnio  <mea@zmailer.org>

	* smtpserver/smtpdata.c, smtpserver/smtphelp.c,
	  smtpserver/smtptls.c, smtpserver/smtpserver.c:
	    Rethought of things, killed the Z_printf() abomination.
	    Also fixed inadverent NULL referral which Eugene Crosser
	    found as well.  (It blocked my incoming email :-( )

	* man/smtpserver.8, smtpserver/contentfilter.c,
	  smtpserver/smtpdata.c:
	    Improved documentation of the CONTENTFILTER INTERFACE
	    ( = wrote it ), and modified a bit of the interface itself.

	* configure.in, proto/smtpserver.conf, smtpserver/cfgread.c,
	  man/smtpserver.8, proto/Makefile.in, 
	    Allow $ZENV expansions in smtpserver's configuration.
	    Thus allow simpler moving of the thing to other location
	    without needing to edit anything but  zmailer.conf  file..
	    Also removed  smtpserver.conf  from autoconfigured
	    protofiles.

	* scheduler/readconfig.c, smtpserver/cfgread.c,
	  transports/sm/sm.c, transports/mailbox/mailbox.c,
	  transports/smtp/smtptls.c:
	    Changed all instances of macro-in-macro style CPP things
	    of 'SKIPWHILE(testfunction,varname)' to be appropriate
	    'SKIPSPACE(varname)' and 'SKIPTEXT(varname)'.
	    (RedHat 7.0 gcc version does not work correctly with those..)

	* smtpserver/policytest.c, smtpserver/rfc821scn.c,
	  smtpserver/smtpcmds.c, smtpserver/smtpdata.c,
	  smtpserver/smtpetrn.c, smtpserver/smtpserver.c,
	  smtpserver/smtpserver.h, smtpserver/smtphelp.c,
	  smtpserver/mxverify.c:
	    Aimed for some coherence at debug mode printouts/flushes
	    in some cases.  Mainly the problem is that at
	    the policytest.c,  and at the mxverify.c the debug output
	    goes to stdout via printf(), while elsewere it goes
	    via type() to SFIO attached to the connection.
	    TO BE ACCURATE, AS THINGS ARE NOW IS NOT SUITABLE
	    FOR DEBUGGING E.G. SSL WRAPPED SESSIONS!

	* smtpserver/smtpserver.h, smtpserver/smtpserver.c,
	  smtpserver/cfgread.c, smtpserver/smtptls.c:
	    - Have new runtime flag (-t) telling that this is a session
	      running immediately under TLS (port tcp/465, "ssmtp"),
	      which feature predates STARTTLS facility.
	    - Have parallel listen socket for two different services;
	      namely plain 'smtp', and 'ssl/smtp')

	* scheduler/mq2auth.c, scheduler/msgerror.c, include/libz.h,
	  scheduler/readconfig.c, lib/cfgets.c, smtpserver/cfgread.c,
	  transports/errormail/errormail.c, transports/mailbox/mailbox.c,
	  transports/sm/sm.c, transports/smtp/appendlet.c:
	    Renamed that function to be   csfgets()  -- after I myself
	    got confused about its calling convention...
	    (That is: FILE * or Sfio_t * thing..)

2000-10-13  Matti Aarnio  <mea@zmailer.org>

	* sfio/src/lib/sfio/makefile.in,
	  sfio/src/lib/sfio/Stdio_b/Makefile.in:
	    Noticed an omission in cross-directory compilations.
	    Sometimes 'iffe' would fail when directory 'FEATURES' didn't
	    exist at the running position.  Oops.

2000-10-12  Matti Aarnio  <mea@zmailer.org>

	* utils/makedb/dbdump.c:
	    New option:  -policydump   which decodes the policy
	    binary set into a text.

	* smtpserver/smtpserver.h, smtpserver/smtpserver.c,
	  man/smtpserver.8, smtpserver/cfgread.c, smtpserver/smtphelp.c,
	  smtpserver/smtpcmds.c, smtpserver/smtpdata.c:
	    Implemented experimental LMTP (RFC 2033) support,
	    this is *not* for real LMTP use, merely for debugging
	    LMTP clients.

	* transports/smtp/smtp.c, transports/smtp/smtp.h,
	  proto/scheduler.conf.in:
	    Completed the LMTP (-M) mode, tested it quite a bit with
	    and without remote speaking PIPELINING. Can support even
	    remotes announcing STARTTLS capability in the LMTP port.
	    Removed duplicate remote response analysis code from
	    synchronous (non pipelined) code path, now using only
	    the  smtp_sync()  to collect replies.

	    Supplied sample "smtp-lmtp/*" configuration for use. 

	* proto/zmailer.sh.in:
	    Do cd to $POSTOFFICE  when starting smtpserver.
	    Dropping cores to system root is not polite..

	* man/sendmail.8, man/zmsh.1:
	    Changed <mea@utu.fi> to <mea@nic.funet.fi>

	* man/smtp.8:
	    Mention RFC 2033 and LMTP at the RFC list in the end.

	* man/scheduler.8, scheduler/mq2auth.c, proto/scheduler.auth.in:
	    Allow multiple instances of same userid by scanning
	    the address ACLs at each UID.  Thus nobody@localhost
	    can get different level of access from nobody@elsewere.

2000-10-10  Ambrose Li <acli@mingpaoxpress.com>

	* utils/vacation/vacation.c:
	    Removed some duplicate code, and detect autoreplies whose
	    source address is:  <>

2000-10-10  Matti Aarnio  <mea@zmailer.org>

	* lib/Makefile.in:
	    "make install" did put zmailer.h into
	    $prefix/$prefix/include/,    which is "somewhat" wrong...

	* man/smtp.8, transports/smtp/smtp.c, transports/smtp/smtp.h:
	    Implemented LMTP (RCF 2033) at the smtp TA program.
	    To enable LMTP, use option '-M'.

	* scheduler/mq2.c:
	    When reporting "unknown" command, do tell things differently:
	      "Unknown command, or refused by access control;" ...

	* smtpserver/mxverify.c:
	    Fix the IPv6 nybble-reverse code to do proper in6 type
	    reverser, although an alternate (binary labels) is defined
	    these days...

	* transports/libta/ctlopen.c:
	    See if the message to be opened is an ETRN request -- if yes,
	    just return with failure...  (manual-expirer triggers this.)

	* transports/libta/mimeheaders.c:
	    While parsing for Content-Type: parameters, allow LWSP in
	    same lines.  Full specification really calls for RFC 822
	    tokens along with CWSP and commend handling.

	* transports/mailbox/mailbox.c:
	    Separates "From MAILER-DAEMON " from "Return-Path: <>".
	    Produces "X-Envelope-To: <...>" header.

	* ChangeLog, INSTALL, Overview, README.TCP-WRAPPER,
	  README.UPGRADING, compat/sendmail/sendmail.c,
	  doc/guides/configure, doc/guides/smtp-etrn,
	  include/zmsignal.h, lib/hashtest.c,
	  man/smtpserver.8, proto/smtpserver.conf.in,
	  proto/cf/aliases-new.cf,
	  proto/cf/aliases.cf, proto/cf/rrouter.cf,
	  proto/cf/standard.cf, router/prototypes.h,
	  router/rfc822walk.c, scheduler/msgerror.c,
	  scheduler/scheduler.c, smtpserver/rfc821scn.c,
	  transports/sm/sm.c, smtpserver/smtprouter.c,
	  transports/libta/diagnostic.c,  transports/mailbox/mailbox.c,
	  transports/smtp/smtp.c,  utils/smtpserver-log-parser.pl.in,
	  utils/pop-proxy/pop-proxy.c:
	    A great speller-bee of "propab*" -> "probab*".

2000-09-26  Matti Aarnio  <mea@zmailer.org>

	* man/sm.8, transports/sm/sm.c:
	    Updated (with a radical hand) the manual page to list
	    what sendmail 8.11 does with flag characters, and what
	    the ``sm'' does with same characters (and some more).

2000-09-25  Matti Aarnio  <mea@zmailer.org>

	* transports/hold/hold.c:
	    This was left out from the commit 4 days ago.

	* libresolv/sys/bitypes.h, sfio/src/lib/sfio/sfhdr.h,
	  ssl/ssl.c:
	    Experimental changes to support compilation at AIX 4.1.

	* proto/db/dbases.conf:
	    The 'thishost' relations used to carry '-d pathalias'
	    driver option on original systems, now it was missing..

2000-09-22  Matti Aarnio  <mea@zmailer.org>

	* proto/Makefile.in:
	    An adjacent directory install failed when system
	    does not have suitable binary 'install' program, and
	    'install.sh' is needed.  Rearranged things.

2000-09-21  Matti Aarnio  <mea@zmailer.org>

	* scheduler/mq2auth.c, scheduler/scheduler.c:
	    File leakage at authuser(), which caused opendir() to fail,
	    and its resulting NULL was used unprotected -> SEGV.
	    (Ran out of free file descriptors.)

	* router/functions.c, transports/hold/hold.c,
	  proto/cf/aliases.cf:
	    "hold" handling for the $(homedirectory ...) function.

2000-09-20  Matti Aarnio  <mea@zmailer.org>

	* proto/cf/rrouter.cf, proto/db/routes:
	    Generalizing on various smtp* mechanisms.

	* proto/scheduler.conf.in:
	    Channel prototypes for  smtp77/*, smtp77x/*, and others.
	    Some reordering, and log option rearrangements.

	* transports/smtp/smtp.c, man/smtp.8:
	    ESMTP disabler feature. ( -77 option )

	* packaging/solaris/Makefile.in, packaging/solaris/README,
	    More work at package manufacturing, now it likely works
	    and produces suitable Solaris PKG files.

	* Makefile.in:
	    Copy current compilation time valid  config.status  and
	    ChangeLog files into $MAILSHARE  directory.  Those give
	    a very good idea of HOW the package was made.

	* packaging/solaris/*:
	    Reworked a bit with Solaris pkgmk wizard..

	* proto/cf/aliases.cf:
	    A nuisance (unlikely a security problem) with *-group
	    expansion.  One pair of double-quotes missing.

	* scheduler/mq2.c:
	    mq2_discard() function did completely bogus chain traverse.
	    Oops..

2000-09-19  Matti Aarnio  <mea@zmailer.org>

	* Makefile.in:
	    Version 2.99.54 (retagged here)
	
	* lib/getaddrinfo.c, lib/getzenv.c,
	  smtpserver/mxverify.c, smtpserver/smtpcmds.c:
	    Pointer arithmetic with (void*) !! Urgh..

	* smtpserver/Makefile.in:
	    Oops.. QC failure, wrong dependency order -> compilation
	    failure

	* router/functions.c, proto/cf/aliases.cf, proto/cf/fqdnalias.cf:
	    Suspended the  $(zapDSNnotify ...) processing development.
	    The issues I am trying solve there are rather -- complicated.

	* router/daemonsub.c:
	    Do test for "an inode in processing" while looking for
	    tasks in the router subdirs -- thus won't reinsert a
	    task already in active handling back into the queue.

	* proto/newdbprocessor.in:
	    Test for "^bind", "ldap", "ordered" and "unordered" db
	    types while regenerating the dbases.conf relations.

2000-09-18  Matti Aarnio  <mea@zmailer.org>

	* scheduler/transport.c:
	    A verbose debug printing of the 

2000-09-14  Matti Aarnio  <mea@zmailer.org>

	* smtpserver/smtpetrn.c:
	    Teached IPv6 support to the ETRN-Cluster code.

	* scheduler/transport.c, scheduler/mq2auth.c:
	    If system allows, create the "mailq" port in IPv6 space.
	    Know how to turn IPv4-Mapped-in-IPv6 address into IPv4 one,
	    and thus be able to test it neatly.

2000-09-08  Matti Aarnio  <mea@zmailer.org>

	* transports/smtp/getmxrr.c:
	    Even when we have seen EAI_AGAIN results, be a happy
	    camper in the end if we get ANY MX entries which have
	    valid address records.

2000-09-07  Matti Aarnio  <mea@zmailer.org>

	* router/libdb/bsdbtree.c router/libdb/gdbm.c:
	    At iterative DB walkthroughs there were some
	    problems at these two functions.  Now they
	    should a) find data, b) terminate.

2000-09-04  Matti Aarnio  <mea@zmailer.org>

	* configure.in:
	    Change linkage order of  -lnsl vs. -lxnet.
	    If -lxnet leads, SEGV is about guaranteed. :-( 
	    (That is utterly weird problem...)
	
	* libc/myhostname.c:
	    If system does not carry  getaddrinfo(3)  function
	    in its standard repertoire (or we are told not to use
	    possibly existing system instance due to e.g. bugs),
	    then use "old-fashioned"  gethostbyname(3)  function
	    to resolve canonic hostname.

	* utils/makedb/dblook.c:
	    The "-dump" mode has been broken for a while.
	    Turned out that auto-variables for key & data need
	    (apparently) be zeroed before even the R_FIRST
	    position pickup succeeds.  D'uh !

	* lib/selfaddrs.c:
	    Solaris resolver function don't apparently like (at all)
	    if the host parameter to e.g. gethostbyname() is 0-size
	    string.

	* smtpserver/cfgread.c, man/smtpserver.8:
	    Recognize "PARAM bindaddr iface:...." syntax to define
	    named interface on which SOME address you want to bind.
	    (Prefers IPv6 if such exists, otherwise IPv4.)

	* smtpserver/smtpdata.c:
	    During DATA and BDAT processing, if the feeder
	    failed to send first 1024 bytes of content, our
	    data transfer watchdog timer was not initialized.
	    I was wondering why one Solaris machine kept
	    collecting hanging smtpserver processes...

	* libc/mailvars.c, libc/mail.c, libc/sfmail.c:
	    - Rearranged couple of variables to separate file
	      so that  mail.c  object won't be included when
	      not needed..  (at the scheduler, and at the mailbox)
	    - reworked file renaming to always use ino based
	      decimal number string at the destination directory.
	    - reconverted mail.c to SFIO based sfmail.c

2000-08-30  Matti Aarnio  <mea@zmailer.org>

	* compat/sendmail/sendmail.c:
	    - Recognize  "sendmail -bd"  as an order to run "zmailer"
	      script.
	    - Input and encode INFROM= data into DSN dataset.

	* proto/cf/aliases.cf, proto/cf/crossbar.cf,
	  proto/cf/fqdnalias.cf, proto/cf/standard.cf,
	  router/functions.c, router/prototypes.h,
	  router/rfc822.c, router/shliaise.c:
	    - New experiental code to handle DSN data handling bugs
	      in alias expansion-like situations.
	      This is NOT complete thing!
	    - Debug code to analyze the effects of the SCHEDULERDIRHASH
	      ZENV variable.

	* transports/libta/ctlopen.c:
	    Recognize (but skip)  INFROM=  DSN metadata.

	* utils/Makefile.in, utils/mxverify/getaddrinfo.c:
	    Copied the  getaddrinfo.c  from libc/  to this
	    utility.  Made "make clean" and "make distclean"
	    work from toplevel so that they will also clean
	    the  utils/mxverify/ subdir.

	* Makefile.in:
	    At the end of "make install", correct the "post-install"
	    suggestion to correct program name.

	* scheduler/mailq.c:
	    Do set the PORTNUM to the destination socket addresses
	    before trying to connect -- connecting to port 0 is not
	    usually a successfull thing...

	* libc/getaddrinfo.c:
	    At Solaris the  uname(2)  call return NON NEGATIVE
	    value on success, not necessarily ZERO as in Linux...

2000-08-29  Matti Aarnio  <mea@zmailer.org>

	* scheduler/mq2auth.c:
	    Copy addresses into separate range buffers for
	    masking and comparison.  (Generalized the function).

	* scheduler/msgerror.c:
	    Construct the report message somewhat differently

	* scheduler/udpate.c:
	    Do certain diagnostics only when  (verbose)  flag is set.

	* transports/smtp/getmxrr.c, transports/smtp/smtp.c:
	    Remove more old debug statements, make sure that
	    lack of memory from  getaddrinfo() is handled
	    properly (e.g. exit(EX_OSERR) -- not best, but..)

2000-08-23  Matti Aarnio  <mea@zmailer.org>

	* smtpserver/mailq.c:
	    Use  getaddrinfo()  to pick the peer address.

	* include/listutils.h:
	    Incorrect ANSI-C pre-processor string concatenation
	    directive use.

	* libc/myhostname.c:
	    Pick any of my possible addresses, don't specify port.
	    (We are looking for CANONIC NAME, after all..)

	* smtpserver/smtpdata.c:
	    Pipelined BDAT after failed MAIL FROM segfaulted
	    on one unprotected SS->mfp referral.  Oops.

2000-08-21  Matti Aarnio  <mea@zmailer.org>

	* libc/getaddrinfo.c:
	    Complete IPv4/IPv6 functionality with proper
	    timeout error handling, and malloc()ed memory
	    garbage collection.  This supplies the function
	    for   --with-ipv6-replacement-libc   cfg option.
	    (Necessary at all systems with GNU LIBC versions
	     up to 2.2. -- up to 2.3.2, very least)

2000-08-19  Matti Aarnio  <mea@zmailer.org>

	* proto/newdbprocessor.in:
	    Process the owner/group/mode triplet too.

2000-08-18  Ambrose Li <acli@ada.dhs.org>

	* configure.in, acconfig.h, scheduler/transport.c,
	  transports/smtp/getmxrr.c:
	    Linux 2.2.* with libc5 fixes.

2000-08-17  Matti Aarnio  <mea@zmailer.org>

	* smtpserver/policytest.c, router/libdb/bsdhash.c,
	  router/libdb/bsdbtree.c, utils/makedb/makedb.c,
	  utils/vacation/vacation.c:
	    RedHat 6.0 BSD DB surprised somewhat... Fixes for
	    the configuration senses.

	* configure.in, libs/Makefile.in:
	    library building order correction, and autoconfiguration
	    straightening so that lack of dbm databases is reported
	    corrently. (The NDBM even with its faults is sort of ok,
	    but the DBM - its predecessor - is not...)

2000-08-02  Matti Aarnio  <mea@zmailer.org>

	* include/libz.h, scheduler/scheduler.c, scheduler/update.c,
	  lib/esyslib.c, include/ta.h:
	    To track strange looking  eunlink()  problem reported
	    by Eugene my first approach is to add identity tags for
	    eunlink() calls so I can have some additional clue as
	    to *which* of four possible places the problems are
	    occurring at.  (Fift place is impossible, fortunately.)

2000-08-02  Eugene Crosser <crosser@online.ru>

	* transports/smtp/getmxrr.c:
	    Yet another wrong index variable usage -- one which affects
	    MX-list purge of self-identity matching of MX servers.
	    Symptom:  "No MX, no address"
	    [mea: That may have been part of the problem,  getaddrinfo()
	          yielding EAI_NONAME in places of EAI_AGAIN may have
		  been another.. -- at least for me.]
	
2000-08-02  Matti Aarnio  <mea@zmailer.org>
	
	* libc/getaddrinfo.c, libc/getnameinfo.c:
	    Picked lattest versions out from  GLIBC 2.1.92 source,
	    and cleaned it up to be simple single-threaded thing
	    without locks, and without IPv6 support.
	    STILL PROBABLY LEAKS MEMORY!

2000-08-01  Matti Aarnio  <mea@zmailer.org>

	* transports/smtp/smtp.c:
	    Some debug printout revisions.  Somewhat embarassing to have
	    a SEGV at debug code when work-code without it works..

	* configure.in:
	    Modifications on how NDBM vs. GDBM vs. BSD DB libraries
	    are linked to ZMailer.  NDBM must be explicitely linked
	    as '-lc' if it is at libc, *and* that linkage reference
	    must be before any other as only then will there be change
	    to get real NDBM, and not some fake layers which all those
	    others do provide!

2000-07-31  Matti Aarnio  <mea@zmailer.org>

	* scheduler/scheduler.h, scheduler/scheduler.c,
	  scheduler/msgerror.c:
	    Recognize our internal NOTIFY=TRACE flag.

	* transports/smtp/smtp.c:
	    When 'NOTIFY=TRACE' flag is present, don't send it out
	    as it is our INTERNAL thing.  Thus the change from string
	    based output to flag-based output routine.

	* include/ta.h, include/mailer.h, include/libz.h:
	    Moved  STREQ()/STREQN()/CISTREQ()/CISTREQN()  macroes
	    from  mailer.h (and ta.h)  to libz.h.

	* utils/md5sum.c:
	    Completed  usage()  function, and some comments.

	* compat/sendmail/sendmail.c:
	    Added acceptance for our internal  -N TRACE flag, which
	    is for eased debugging of RFC 2852 features.

2000-07-30  Matti Aarnio  <mea@zmailer.org>

	* libident/identuser.c:
	    A buglet in read loop.  The 'break' affects only
	    the innermost loop construct, and it needed to go
	    out the outer too..  Nuisance thing, I would say.
	    (And usage of indent is questionable anyway..)

	* smtpserver/smtpserver.h, smtpserver/smtpcmds.c,
	  smtpserver/cfgread.c, smtpserver/smtpserver.c,
	  include/ta.h, transports/libta/ctlopen.c:
	    Initial hooks for RFC 2852.

	* transports/libta/diagnostic.c:
	    Turn on, temporarily, O_APPEND flag on the file.

	* scheduler/msgerror.c:
	    Missed variable inits, and malformed format statement.

	* transports/smtp/getmxrr.c:
	    dnscache by djb produces replies which don't have NS or AD
	    sections, and when scanning replies, we had one-off
	    comparison error which bailed out in case the ANSWER
	    section reached the end of the reply packet.

	* man/scheduler.8:
	    Updating on data formats and communication protocols.

	* transports/libta/lockaddr.c:
	    Be carefull as *not* to overwrite part of diagnostic
	    data with spaces.  This has never been a bug, except
	    that trying to understand some aspects of the system
	    while updating documents revealed that we do unnecessary
	    scrubbing there.

2000-07-29  Matti Aarnio  <mea@zmailer.org>

	* transports/smtp/Makefile.in, transports/smtp/smtp.h,
	  transports/smtp/smtp.c, transports/smtp/getmxrr.c:
	    Moved  getmxrr()  function to separate file, and
	    wrapped it with a test shell in attempt to understand
	    *why* it seems to fail at some inputs at some machines.

	* scheduler/msgerror.c:
	    Hooks for "expanded" action status.

	* transports/smtp/smtp.c:
	    Streamlined error handling when returning from getmxrr().

2000-07-27  Matti Aarnio  <mea@zmailer.org>

	* transports/smtp/smtp.c:
	    - At getmxrr() a missed state variable initialization
	      (to zero) caused errorneous eternal loops. OOPS!
	    - smtp_sync() didn't handle RCPTSTATE_500 at all.. (oops).
	    - calls to  stashmyaddresses()  don't need to carry
	      determined self-host-identity.

2000-07-24  Matti Aarnio  <mea@zmailer.org>

	* scheduler/msgerror.c:
	    A simple spelling error in normally invisible text sent
	    towards the user inside the delivery status reports.

2000-07-18  Matti Aarnio  <mea@zmailer.org>

	* transports/smtp/smtp.c:
	    Possibly  ssfgets()  fell on over-by-one allocation/storage
	    error so that the buffer tail got stomped over, and some
	    systems didn't like it --> they crashed.

	* configure.in, router/db.c, router/libdb/bsdbtree.c,
	  router/libdb/bsdhash.c, smtpserver/policytest.h,
	  smtpserver/policytest.c, utils/makedb/makedb.c,
	  utils/makedb/dblook.c, utils/vacation/vacation.c,
	  README.UPGRADING:
	    Reworked things to support another kind of set of
	    SleepyCat DB libraries.  Not yet covering version 3.x.

	* lib/rfc822scan.c:
	    A bit more characters into "no need to quote these here"
	    set -- allow address <@[1.2.3.4]:foo@bar> and <foo@[1.2.3.4]>

2000-07-17  Matti Aarnio  <mea@zmailer.org>

	* libs/Makefile.in, Makefile.in:
	    Merge  libsfio.a  generation into this file also, so that
	    there is no absolute need to run its make as the first
	    thing among subdirs.
	    Also made top-level "make libs" target which recompiles
	    and/or just reconstructs (with ar) all libraries.

	* transports/smtp/smtp.c:
	    Oops.. Solaris 2.6 --with-bundled-libresolv  does not
	    know about BIND 8 resolver's AD and CD bits.  Don't use
	    them.

	* Makefile.in:
	    Version 2.99.53

	* smtpserver/smtpcmds.c:
	    At MAIL FROM policy reporting we did always yield
	    400-series reply even when actual code directed us
	    to yield 500-series..

2000-07-14  Grace He <ghe@scs.Ryerson.CA>

	* router/dateparse.c:
	    Fix for "Date: 00-06-29 03:50:11" induced crashes

2000-07-14  Matti Aarnio  <mea@zmailer.org>

	* lib/selfaddrs.c:
	    Rearrange SIOCGLIFCONF / SIOCGIFCONF code a bit, will
	    prefer SIOCGLIFCONF over SIOCGIFCONF if both are available.

	* lib/selfaddrs.c, lib/zgetifaddress.c, include/libz.h,
	  configure.in, utils/makedb/Makefile.in:
	    Solaris 8 test derived fixes.

2000-07-12  John D Groenveld <jdg117@elvis.arl.psu.edu>

	* man/Makefile.in:
	    If "${MANDIR}/man3" directory does not exist, create it.

2000-07-11  Matti Aarnio  <mea@zmailer.org>

	* transports/smtp/smtp.c:
	    Sometimes printing to logfp was done unconditionally -- when
	    the logfp variable carries NULL :-/

2000-06-22  Matti Aarnio  <mea@zmailer.org>

	* transports/smtp/smtp.c, smtpserver/mxverify.c:
	    Further commentary from  bind-workers  told me that unless
	    the AA-bit (authoritative answer) is set, the received ADDATA
	    isn't possibly good enough to trust - some of A/AAAAs may
	    have expired.  Thus we shall use that reply section for
	    A/AAAA only if AA-bit is set.

2000-06-21  Matti Aarnio  <mea@zmailer.org>

	* smtpserver/mxverify.c, transports/smtp/smtp.c:
	    Made smtpserver MXVERIFY to use DNS ADDITIONAL DATA,
	    and reorganized A record collection so that if some
	    MX server does not have A, that is asked for it
	    explicitely, and if ipv6 is in use, if AAAA data
	    does not exist for a server, it is asked for.
	    In case ipv6 is not in use, this collapses into plain
	    A type data retrieval.

	* lib/selfaddrs.c:
	    Removed a test which is never true.

	* transports/smtp/smtp.c:
	    Some more tuning of  getmxrr()  pathology processing.

2000-06-20  Matti Aarnio  <mea@zmailer.org>

	* transports/smtp/smtp.c:
	    Use  zgetifaddress() for '-L iface:eth0' binding.

	* configure.in, include/libz.h, lib/Makefile.in,
	  lib/selfaddrs.c, lib/zgetifaddress.c:
	    Autoconfigure  BSDI derived  getifaddrs()  call,
	    and have sensible IOCTL set for both interface
	    list, and for interface address lookup code.

	* scheduler/mailq.c:
	    One-off in array realloc() biting us at Solaris..

	* transports/smtp/smtp.c, nam/smtp.8:
	    Coded '-L' option processing to bind to named local
	    interface.

	* lib/selfaddrs.c:
	    Experimental SIOCGLIFCONF code for IPv6 speaking
	    some-BSD systems -- to pick IPv6 interface addresses
	    from the system.

	* transports/smtp/smtp.c, transports/smtp/smtp.h:
	    When doing   getmxrr()  for MX data, will use also
	    the DNS supplied ADDITIONAL DATA segment materiel
	    for MX machine addresses.

2000-06-19  Matti Aarnio  <mea@zmailer.org>

	* scheduler/update.c:
	    Organically relating to  smtpopen() -> "retryat +60"
	    code, if NEXT thing to feed has its expiry tag in
	    past (and non-zero), then *stay* in CFSTATE_STUFFING
	    so that possible next thing will be quickly diagnosed
	    out of the queue at the end of its expiry time..
	    ALSO fixed double-counting of attempts on therads
	    and vertices!

	* transports/smtp/smtp.c:
	    If smtpopen() yields EX_TEMPFAIL, always do diagnostics
	    with 60 seconds timeout flag.. ( -> "retryat +60" )
	    so that the entire message queue will not be retried
	    there just for no good reason..

	* smtpserver/smtptls.c:
	    Following some discussion at OpenSSL list, I noticed
	    that DH type keys are not supported by our current code.
	    Now we should match that of OpenSSL: apps/s_server.c
	    sample code again.

	* transports/smtp/smtp.c:
	    Allow  ssfgets()  to enlarge the input string in runtime,
	    which enables us later to make weird things like multiple
	    hosts feeding in same connection... (perhaps)

	* transports/smtp/smtp.c:
	    Continued the rewrite by handling weird looking errors
	    from some sites which mistakenly limit the number of
	    recipients per smtp connection (session)!  Will do
	    close of the socket after each case where RCPT TO yields
	    400 series code.  (That will also knock on some real
	    temporary failures, like DNS timeouts when recipient
	    does verify the through-going address for e.g. MX analysis.)

	* transports/smtp/smtp.h, transports/smtp/smtp.c:
	    Rewrote (in a sane way) the pipelined smtp_sync()
	    status code formulation so that we won't reject
	    recipients just because their system yields 400
	    code for all RCPTs which they get, and then said
	    to DATA that 'no recipients given yet'..

2000-06-14  Matti Aarnio  <mea@zmailer.org>

	* proto/cf/fqdnalias.cf:
	    Don't fqdn-alias if it looks like RFC-822 source route
	    address.

	* lib/rfc822scan.c:
	    Allow RFC-822 source route addresses to go thru without
	    needing quotes -- allow ',' and ':' to be included into
	    addresses without quotes.

2000-06-13  Matti Aarnio  <mea@zmailer.org>

	* proto/cf/fqdnalias.cf:
	    A missed thing in privilege processing in case db lookup
	    succeeds.

	* scheduler/scheduler.h, scheduler/mq2.c, scheduler/mailq.c,
	  scheduler/threads.c:
	    Implemented (in C) initial part of 'mailq' and 'mailq -v'
	    commands for MAILQ-V2 protocol.

	* scheduler/scheduler.c, man/scheduler.8, scheduler/mq2.c,
	  scheduler/mailq.pl:
	    Playing with MAILQ-V2 code to get (experimental) version
	    of detailed reporting a'la old mailq-v1 code.

	* scheduler/mailq.pl:
	    Now this PERL mailq supports functions:
		mailq
		mailq -Q
		mailq -QQ
		mailq -QQQ
	    and has also option '-U' for logging with non-default
	    username/password pair.

2000-06-07  Matti Aarnio  <mea@zmailer.org>

	* transports/libta/ctlopen.c:
	    If ctlopen() contained open() of message body file fails,
	    send a warning() up to the scheduler log WITH errno of
	    that open() call..

	* proto/db/smtp-policy.src:
	    _RBL* alias labels are turned to LOWER CASE -- those keys
	    are lowercased during encoding, but data attributes are
	    not modified while compiling the database, nor when looking
	    up tags..

	* smtpserver/smtpserver.h, smtpserver/smtpdata.c,
	  smtpserver/cfgread.c,    smtpserver/contentpolicy.c,
	  utils/smtp-contentfilter.in:
	    CONTENT policy interface, and sample filter implementation..

	* scheduler/scheduler.c, scheduler/conf.c, scheduler/msgerror.c,
	  man/scheduler.8:
	    Modify the '-n' option semantics to control how DSN RET
	    option value is set in absense of originator supplied value.

2000-06-02  Matti Aarnio  <mea@zmailer.org>

	* scheduler/mailq.c:
	    Count files in POSTOFFICE/router/ directory also when
	    it is subdir-hashed..

	* router/daemonsub.c:
	    Tried actually to use ROUTERDIRHASH=1 mode, and learned
	    of bitter errors at the subchild feeder code...  Dirname
	    was written twice to the workfilename.

	* router/libdb/header.c:
	    Allow just about *any* character to appear at headers
	    database key fields..  old limits were too strict anyway.

	* proto/post-install.sh.in:
	    More minor tweaks.

2000-05-28  Matti Aarnio  <mea@zmailer.org>

	* proto/Makefilein, proto/post-install.sh.in:
	    Small fixes that disjoint installation test shows up..

2000-05-26  Matti Aarnio  <mea@zmailer.org>

	* transports/smtp/smtp.c, transports/smtp/smtp.h:
	    Cosmetics-like things about diagnostics tracking.

	* proto/newdb.in, proto/newdbprocessor.in,
	  proto/post-install.sh.in:
	    These are all PERL scripts now -- that last one should be
	    renamed, thinking about it...

2000-05-25  Matti Aarnio  <mea@zmailer.org>

	* transports/smtp/smtptls.c:
	    Proper network timeout monitored non-blocking wrapper
	    for SSL_connect()  code.

	* transports/smtp/smtp.h, transports/smtp/smtp.c:
	    Reworked diagnostics codes a bit to collect only relevant
	    SMTP transaction bits per each recipient.
	    (Although still not *quite* correct for problems diagnosed
	     at DATA/dot time, which need all recipients, not just the
	     last one...)

2000-05-24  Matti Aarnio  <mea@zmailer.org>

	* proto/newdb.in:
	    Rewritten into PERL(v5) script.

	* smtpserver/rfc821scn.c, smtpserver/smtpcmds.c:
	    Eugene Crosser wanted to have:  <foo!_bar@some.dom>,
	    our scanner demanded an alphanum starter character for
	    the sub-fields of the local-part.  Now allowing also
	    the underscore as starter there -- for a username..
	    (smtpcmds.c has some diagnostics report beauty warts.)

2000-05-18  Matti Aarnio  <mea@zmailer.org>

	* proto/newdb.in, router/libdb/ndbm.c, router/libdb/dbm.c:
	    At NewDBM (ndbm) the dbm_dirfno() does not always yield
	    success at the dbm_open().  It *may* yield some scrap data
	    for a while -- especially if the db is *very* small.
	    The  dbm_pagfno()  yields always ok filehandle number,
	    and thus we use it -- and change file moving order to
	    .DIR .PAG to match which is tested later.

2000-05-10  Matti Aarnio  <mea@zmailer.org>

	* proto/Makefile.in, proto/post-install.sh.in:
	    Moved POSTOFFICE directory subdir generation into
	    the  post-install.sh  script.  Execution of that
	    script before system becomes ready for running is
	    now MANDATORY!  (At least at fresh installations.)

2000-05-09  Matti Aarnio  <mea@zmailer.org>

	* router/rfc822.c:
	    Existence of ZENV variable ``SCHEDULERDIRHASH'' drives
	    movement of files from router to the scheduler to go
	    straight to hashed subdirs at the scheduler.

	* router/daemonsub.c:
	    A lot more work at the daemon subsystem.
	    Now it runs a dedicated set of router processes for
	    the primary router directory, plus one for each of
	    ``ROUTERDIRS'' variable defined auxiliary directories.

	* libc/mail.c, router/daemonsub.c, man/router.8,
	  SiteConfig.in:
	    If ZENV variable ``ROUTERDIRHASH'' exists, and has value
	    ``1'', all message submissions will be using direct moving
	    nto ``A'' thru ``Z'' hash-subdirectories -- if they don't
	    exist, things FAIL!

	* scheduler/mq2auth.c, scheduler/transport.c:
	    Mailq-V2 IP-ACL system works!

	* scheduler/scheduler.c, scheduler/transports.c:
	    Call  syncweb()  also inside the   mux()  routine
	    so that new jobs will get assimilated faster.

2000-05-08  Matti Aarnio  <mea@zmailer.org>

	* libc/mail.c, router/rfc822.c:
	    Simplified message injection code a bit; especially
	    tried to lessen the number of directory operations.
	    (Even though comments in the source say that rename(2)
	     isn't safe, we are using it...)

	* INSTALL:
	    Refer to HTML renderation of ZMailer manual's install part..

	* scheduler/msgerror.c:
	    Drop leading \r from report data.  No weird looking blank
	    line in resulting report.

	* transports/smtp/smtp.c:
	    Don't diagnose TLS status unconditionally, it is annoying
	    thing to have accumulating into scheduler's log..

	* smtpserver/smtpserver.c:
	    When --with-whoson  is used at configuration, and
	    smtpserver is run without '-w' option, policy test
	    is falling on default of "yes this is always ok relay
	    source" behaviour -- which in general is wrong :-(

2000-05-04  Matti Aarnio  <mea@zmailer.org>

	* lib/selfaddrs.c:
	    Yet Another small surprise at Linux systems about
	    self-address extraction.  :-/

2000-04-20  Matti Aarnio  <mea@zmailer.org>

	* smtpserver/smtpcmds.c, smtpserver/smtpserver.c:
	    Fix "from_box" setting to match current treatment
	    of user input string (e.g. not stomping things
	    with '\0' chars..)
	    Synced  MaxErrorRecipients  default value with
	    documentation.

	* smtpserver/cfgread.c:
	    Documentation (proto/smtpserver.conf.in) says that
	    PARAM name is:  RcptLimitCount,  while it was recognized
	    only as  RcptLimitCnt ...  Oops.

2000-04-18  Matti Aarnio  <mea@zmailer.org>

	* router/db.c:
	    A mistake in cache LRU chain handling caused eternal
	    loop to form sometimes.  Oops.

2000-04-14  Matti Aarnio  <mea@zmailer.org>

	* transports/libta/ctlopen.c:
	    An odd corner case of error handling allowed access to
	    uninitialized elements of an array -> junk data blew up..

	* scheduler/threads.c, scheduler/update.c:
	    Trying to understand why 'deferred' diagnostics causes
	    practically immediate reissuance of a task..
	    Understanding dawns, thread rescheduling was implemented
	    in fumes, so crazy it was (but then, I don't drink nor
	    smoke...)

	* router/functions.c, lib/rfc822scan.c:
	    Router function "$(dequote ...)" was previously castrated
	    a bit too much.  This isn't like sendmail-8's dequote class,
	    but far more brutal beast..

	* proto/Makefile.in:
	    Fix db subdir installation to work on a system without
	    GNU/BSD install (using locally supplied script).

	* compat/rmail/Makefile.in:
	    Allow  "mkdir -p ..." to fail on Solaris. (Anywhere actually)

	* libc/whathost.c:
	    Improved error handling by adding posixy redo of things
	    in case stat()s yield an error.. (Solaris 2.6 is complaining
	    somewhat in these routines..)

	* transports/smtp/smtptls.c:
	    Moved things around so that it works also when compiled
	    WITHOUT (Open)SSL.

2000-04-13  Matti Aarnio  <mea@zmailer.org>

	* transports/smtp/smtp.c:
	    Moved one instance of  tls_conf_file  inside HAVE_OPENSSL
	    conditional.  Oops..

	* transports/smtp/smtp.c, transports/smtp/smtptls.c,
	  transports/smtp/smtp.h:
	    Try to combat certain TLS related problems mentioned before.
	    (An hour later: Cured them apparently..)

	* smtpserver/smtptls.c, smtpserver/smtpserver.c:
	    Under TLS do always flush replies - to simulate one other
	    MTA running under TLS wrapper.
	    (This was removed a bit later.)

2000-04-12  Matti Aarnio  <mea@zmailer.org>

	* router/db.c:
	    For Matthias Urlich; a method to declare at RELATION entry
	    if NEGATIVE CACHE is used at the particular relation (pre-
	    requires that cache is also used..) Driven with: -N option.

2000-04-11  Matti Aarnio  <mea@zmailer.org>

	* scheduler/mq2.c, scheduler/mq2auth.c, scheduler/prototypes.h,
	  scheduler/scheduler.h, scheduler/scheduler.c,
	  scheduler/transport.c:
	    Hooks for verifying MAILQv2 contactee IP address.

	* router/db.c:
	    Mathias Ulrichs <smurf@noris.de> suggest negative cache
	    for DB lookup related caches.  It is simple to do, but
	    not so simple to explain to be usefull...

2000-04-08  Matti Aarnio  <mea@zmailer.org>

	* scheduler/msgerror.c, scheduler/prototypes.h,
	  scheduler/threads.c, scheduler/transport.c:
	    Tracked possible reasons for processing crashes
	    when maxthr>1.

	* transports/smtp/smtp.c:
	    Changed the commentary log accumulation method, now
	    it will clear only at "MAIL FROM..." and from then
	    on collect all until next "MAIL FROM...".
	    Should make easier to understand some odd error reports.

	* scheduler/scheduler.c, scheduler/threads.c, scheduler/update.c:
	    Added some debugging related  memset()s just before freeing
	    some pointer containing memory blocks.
	    Also modified unvertex() slightly to forward nextfeed in
	    case current vertex is (at all) in any sort of processing.

2000-04-07  Matti Aarnio  <mea@zmailer.org>

	* scheduler/update.c:
	    Log only really important diagnostics about error
	    conditions in the system, not errors in email receiving.

	* scheduler/threads.c:
	    One instance of vertex free() has been processed
	    improperly.  If the 'nextfeed' is still pointing
	    to the vertex which is being deleted, it must be
	    advanced..  Although getting this means that the
	    scheduler has just fed the same job twice to TAs..

2000-04-06  Matti Aarnio  <mea@zmailer.org>

	* transports/smtp/smtptls.c:
	    Disable TLS read_ahead setting.  That mode doesn't
	    work quite well, and can definitely groak against
	    Stalker Software's  CommuniGate Pro smtpserver when
	    running in PIPELINING mode.

2000-04-02  Matti Aarnio  <mea@zmailer.org>

	* proto/cf/aliases.cf, proto/cf/fqdnalias.cf:
	    - More work on rewritten expansion loop prevention measures.
	    - Added UserDB sender address rewriter into fqdnalias.cf too.

	* lib/rfc822scan.c, router/functions.c, proto/cf/aliases.cf:
	    Reworked alias (et.al.) expansion loop preventation
	    machinery.  Now a message aliased as:
		user1: user2, user1
	    will be delivered to both, unless some other mapping diverts.
	    NOT YET A COMPLETE THING!

2000-03-30  Matti Aarnio  <mea@zmailer.org>

	* proto/zmailer.sh.in, proto/newdb.in, proto/db/dbases.conf:
	    Now 'zmailer newdb' uses the  $MAILVAR/db/dbases.conf  file,
	    if it exists.  (But the converted needs to be rewritten,
	    and security issues need more thought...)

2000-03-29  Matti Aarnio  <mea@zmailer.org>

	* scheduler/threads.c:
	    thread_reschedule() crashed on thr->thvertices being NULL ??

	* router/rfc822hdrs.c:
	    Sometimes missed sending out at least one space after the
	    header name tag.

	* scheduler/transport.c, scheduler/update.c,
	  scheduler/mq2auth.c,  transports/smtp/smtptls.c:
	    Various bad diagnostics seen (from smtp) which in turn
	    crashed scheduler :-/  Oops..   Some new comments into
	    mq2auth.c about possible future directions.

	* proto/cf/crossbar.cf, proto/db/userdb:
	    Some more work on this, now allowing rather peculiar
	    ZMailerish keying at least for ":mailname" keys..

	* router/db.c:
	    Reworked cache code to be faster (I hope) by means of having
	    a crc32 hash value against which the matching is done.
	    The goal is to support in order of 10k entries in the cache
	    without too large of an impact on performance.
	    ( The hash collisions are resolved by means of doing actual
	      key  strcmp() )
	    The cache at each DB relation interface is still an LRU
	    with linear (urgh..) search time.  (A splay-tree was also
	    considered, but decided not to use.)

2000-03-28  Matti Aarnio  <mea@zmailer.org>

	* proto/cf/aliases.cf, proto/cf/crossbar.cf,
	  proto/cf/standard.cf, proto/db/dbases.conf,
	  proto/db/kill-headers, proto/db/userdb:
	    Created a way (always on when DB is defined, and
	    rewrite (at crossbar.cf) happens via 'internet') to
	    do ``username'' mapping to given FQDN address,
	    e.g.  ``user.name@here.domain''
	    Reworked kill-headers initialization.

	* include/mailer.h, proto/Makefile.in, proto/cf/standard.cf,
	  proto/db/kill-headers, router/rfc822.c, router/libdb/header.c:
	    Runtime configuration mechanism for killing named headers.
	    We have some uses for removing e.g. gateway generated
	    "X-Login-ID:" type of things which no recipient has any
	    business of seeing.

	* Makefile.in:
	    Version 2.99.53-pre1

2000-03-27  Matti Aarnio  <mea@zmailer.org>

	* transports/smtp/smtp.c:
	    When the outbound SMTP fp is closed, don't truncate the
	    reported address -- mainly to stop "." appearing as the
	    last outbound state, when "data" really is it..

	* scheduler/MAILQ-V2, scheduler/mailq.pl, scheduler/mq2.c,
	  scheduler/prototypes.h, scheduler/threads.c:
	    Playing with ideas regarding MAILQ-V2 protocol.
	
2000-03-24  Matti Aarnio  <mea@zmailer.org>

	* configure.in, transports/mailbox/dotlock.c:
	    Autosense 'HAVE_GETHOSTID', and if it isn't, try to
	    create it in couple different ways (For earlier Solaris,
	    and HPUX systems, very least.)

2000-03-23  Matti Aarnio  <mea@zmailer.org>

	* INSTALL, configure.in, Makefile.in, sfio/Makefile.in,
	  sfio/src/lib/sfio/makefile.in,
	  sfio/src/lib/sfio/{Sfio_{dc,f},Stdio_{b,s}}:
	    Made SFIO compilation environment to work also when
	    running in "subdirectory" configuration (e.g. using
	    ../configure ...)
	    Also cleaned up the SFIO configuration system a bit.

	* doc/guides/smtp-policy:
	    Added some words about the policy testing by using -T option.

2000-03-21  Matti Aarnio  <mea@zmailer.org>

	* man/smtpserver.8, smtpserver/smtpserver.h,
	  smtpserver/smtpserver.c:
	    Implemented  -T  option for a local interactive policy
	    testing without having connectivity all around the world.
	    See the man-page.

2000-03-18  Matti Aarnio  <mea@zmailer.org>

	* router/daemonsub.c, router/conf.c:
	    Spotted a self-healing misbehaviour in the child process
	    feeder, which skipped messages from queue quite *often*.
	    Cured that by waiting in proper place for successfull
	    delivery.  Also changed some default values for
	    "stability" processing.

	* router/rfc822hdrs.c, router/rfc822.c, lib/token.c:
	    Aborted (and deactivated) foldable tokens processing on
	    headers we don't know about right now.  Perhaps need to
	    have some other approach on the problem...

2000-03-17  Matti Aarnio  <mea@zmailer.org>

	* smtpserver/smtpcmds.c, smtpserver/smtprouter.c:
	    Instead of using printf format:  %*s  we need to use  %.*s

	* transports/libta/swriteheaders.c:
	    Eugene Crosser spotted CHUNKING mode problem with
	    message header TAB expansion.  Outch!

	* router/router.c:  logit()
	    Changed  stdout  written log printf() format so that
	    quite large lists of addresses are allowed.

2000-03-15  Matti Aarnio  <mea@zmailer.org>

	* configure.in, transports/mailbox/mailbox.c:
	    "--without-maillock" configuration option from
	    Eugene Crosser.   We don't seem to be quite
	    as happy chaps with Solaris maillock() as we
	    would like to be in all cases :-/
	    (E.g. if we use any other than  /var/mail/ directory
	     for mailboxes, Solaris  maillock()  will still put
	     locks into /var/mail/ directory :-?  Hmm..)

2000-03-14  Matti Aarnio  <mea@zmailer.org>

	* scheduler/msgerror.c:
	    Reworked report suppression; if all RCPTs have NOTIFY=NEVER,
	    no report shall be made.   Some cleanup of report generation.

	* transports/mailbox/mailbox.c:
	    Small cleanup of RFC 1894 action status reports.

	* transports/smtp/smtp.c:
	    - Do (at least try) shunt new scheduler TA driver state-
	      machine only when connection fails, not when a message
	      delivery yields some 400 series status code.
	    - PIPELINING mode in smtp_sync() did react suboptimally
	      (wrong) to DATA yielding 500 series code when MAIL FROM
	      or any/all RCPT TO commands yield 400 series status.
	    - DRUMS/SMTPUPD tells that if MX records are available,
	      but none are usable (preference pruning rule), this
	      must be reported as an error.  We allow '-W' mode to
	      override this so that when '-W' is present, this case
	      is not an error, IF destination domain has A + WKS/smtp
	      permitting delivery there.

	* smtpserver/smtpcmds.c:
	    DRUMS/SMTPUPD tells that policy based rejections of
	    recipients shall use 550 (and 450) codes.

2000-03-09  Matti Aarnio  <mea@zmailer.org>

	* transports/libta/diagnostic.c, include/ta.h,
	  transports/smtp/smtp.c:
	    Some diagnostics related rework due to absolutely
	    insanely behaving SMTP reception.     Diagnostic
	    output in EX_TEMPFAIL or EX_IOERR are not per default
	    (actually never) stored directly to the file by the TA
	    program, and anyway doing diagnostics in such case is
	    marginally usefull -- retries may happen, for example!
	    Now things should allow recipient address to be retries
	    properly even with mode locking working ok.

2000-03-05  Matti Aarnio  <mea@zmailer.org>

	* smtpserver/smtpcmds.c:
	    More systematic approach at MAIL FROM and RCPT TO
	    related reporting where related addresses are wanted
	    to be included into the diagnostic messages.  All that
	    just for completely braindead approach prevalent in
	    M$ client software...

2000-03-03  Matti Aarnio  <mea@zmailer.org>

	* scheduler/msgerror.c:
	    Basic footwork for DELAYED reporter.
	    (Incomplete yet.)

	* scheduler/scheduler.c:
	    Reverted earlier change which counted already processed
	    recipients into MTA-MIB variables.

	* doc/Makefile.in, man/Makefile.in, libresolv/Makefile.in,
	  scheduler/Makefile.in:
	    Fixed "make depend" to work.

	* scheduler/Makefile.in, scheduler/servauth.h:
	    DELETED servauth.h -- something entirely forgotten,
	    and same stuff reimplemented elsewere.

	* man/smtp.8, man/smtpserver.8:
	    Updates/fixes to text.

	* scheduler/scheduler.c, scheduler/scheduler.h,
	  scheduler/conf.c, scheduler/agenda.c, scheduler/msgerror.c,
	  scheduler/readconfig.c, scheduler/prototypes.h,
	  man/scheduler.8:
	    - Slightly simplified doagenda()
	    - Created accumulated report collector/reporter subservice.

2000-03-01  Matti Aarnio  <mea@zmailer.org>

	* proto/forms/delivery:
	    Added an URL reference to a "decode key" at
		http://www.zmailer.org/reports.html

	* scheduler/scheduler.h, scheduler/update.c, scheduler/threads.c,
	  scheduler/prototypes.h, scheduler/readconfig.c,
	  scheduler/msgerror.c, man/scheduler.8:
	    - Reworked how IDLE handles idle process recycling; always
	      the channel must match, host may or may not need to match.
	    - Reworked parts of error reporting in preparation for
	      creating delay reports.
	      (And earlier FAILED/DELIVERED/RELAYED reports at the same
	       time, of course..)

	* proto/cf/fqdnalias.cf:
	    Spotted some FIXME things..

	* transports/smtp/smtp.c:
	    When socket write failure causes shutdown of write direction
	    socket, do turn all back reported 500 series errors into
	    softer  400 series codes.  Won't unnecessarily reject
	    messages.

2000-02-29  Matti Aarnio  <mea@zmailer.org>

	* smtpserver/smtpetrn.c, man/smtpserver.8, man/scheduler.8:
	    Completed the etrn-cluster code. Seems to work, even.
	    Updated man-pages a bit.

	* smtpserver/smtpserver.c, smtpserver/smtpserver.h,
	  smtpserver/cfgread.c, smtpserver/smtpcmds.c:
	    - PARAM sum-sizeoption-value  -- modify how
	      MAIL FROM:<> SIZE=nn option value is processed
	      when compared against various limits in the system;
	      if the option is present, effectively the system required
	      free space is message size multiplied by the recipient
	      count.
	    - PARAM max-unknown-commands nn -- how many pure junk
	      commands can be accepted before our side hungs the
	      connection. Default limit: 10

2000-02-28  Matti Aarnio  <mea@zmailer.org>

	* smtpserver/smtpserver.c, smtpserver/smtpserver.h,
	  smtpserver/cfgread.c, smtpserver/smtpetrn.c,
	  proto/smtpserver.conf.in, doc/guides/etrn-cluster:
	    - A bug in '-l SYSLOG' which bite me at Solaris.. Oops..
	    - some reworking of ETRN-CLUSTER code, but no completition
	       yet.

2000-02-25  Matti Aarnio  <mea@zmailer.org>

	* transports/smtp/smtp.c:
	    If DATA-dot-phase ending dot yields EX_TEMPFAIL, don't
	    do diagnostics right after smtpwrite(".").  It leads
	    to bad retry results :-/

	    Reworked something else; simplified code for header
	    output -- which will be "obviously correct".

	* smtpserver/smtpserver.c:
	    Make '-l SYSLOG' option to work in parallel with possible
	    '-l /path/to/file' logging option.

2000-02-18  Matti Aarnio  <mea@zmailer.org>

	* configure.in:
	    Moved   --with-zconfig=  code around a bit, apparently
	    it was quite ineffective, and has been that way for quite
	    a while :-/
	    (More so the documentation spoke of some other option..)

2000-02-17  Eugene Crosser  <crosser@online.ru>

	* smtpserver/smtpdata.c, configure.in, acconfig.h:
	    (Auto)configure  USE_TRANSLATION  into smtpserver.
	    [mea] minimized Eugene's patch inside smtpserver code by
	          rearrangeing 'USE_TRANSLATION' usage in smtpdata.c
		  (e.g.: Eugene wrote it, Matti possibly botched it..)

2000-02-15  Matti Aarnio  <mea@zmailer.org>

	* scheduler/agenda.c, scheduler/mq2.c, scheduler/prototypes.h,
	  scheduler/scheduler.c, scheduler/scheduler.h,
	  scheduler/threads.c, scheduler/transport.c,
	  man/scheduler.8, scheduler/MAILQv2:
	    - Streamlined MAILQv2 processing -- it should now be as low
	      latency service as possible, even with long-lasting
	      operations blocking at things like input queue scanner.
	    - Implemented a 30 second apopteosis for MAILQv2 sockets.
	    - Implemented MAILQv2 action ETRN -- exactly alike the SMTP-
	      server one.

2000-02-12  Matti Aarnio  <mea@zmailer.org>

	* lib/selfaddrs.c:
	    In *addition* to interface picked addresses, collect also
	    z-environment defined  SELFADDRESSES=  listed addresses.
	    (For the support of an ETRN-CLUSTER.)

	* transports/smtp/smtp.c:
	    A read timeout at response wait after write timeout is now
	    limited to 300 seconds.

	* smtpserver/Makefile.in, smtpserver/smtpserver.h,
	  smtpserver/cfgread.c, smtpserver/smtpserver.c,
	  smtpserver/smtpcmds.c, smtpserver/smtpetrn.c, SiteConfig.in,
	  proto/smtpserver.conf.in, doc/guides/etrn-cluster:
	    Some initial work for an ETRN-CLUSTER.

2000-02-08  Matti Aarnio  <mea@zmailer.org>

	* man/smtpserver.8, smtpserver/smtpserver.h,
	  smtpserver/smtpserver.c, smtpserver/smtpdata.c,
	  smtpserver/smtpcmds.c, smtpserver/smtpauth.c:
	    Created smtpserver runtime command-line option "-l SYSLOG",
	    which is a magic thing to send logfile material through
	    syslog()  facility.  Beware there is *huge* amount of
	    dataflow there!
	    Some updates to smtpserver.8 man-page.

2000-02-04  Matti Aarnio  <mea@zmailer.org>

	* smtpserver/smtpserver.c, lib/taspoolid.c:
	    Changed (again) the logtag prefix for smtpserver's "-l"
	    parameter defined logfile.  Considering enabling it to
	    be also diverted via syslog() to where-ever that goes.
	    (But server process can have only one syslog() session
	     active with one facility..)

2000-02-03  Matti Aarnio  <mea@zmailer.org>

	* transports/smtp/smtp.c, transports/smtp/smtptls.c:
	    Grumble...  Still seeing wrong kind of timeouts..

2000-02-02  Matti Aarnio  <mea@zmailer.org>

	* transports/smtp/smtp.c:
	    An oddball log error - misreported outwritten message header
	    size into smtp client's log file.

	* README.UPGRADING, include/mail.h.in, scheduler/scheduler.c,
	  transports/libta/markoff.c:
	    Prepared for adding _CF_MIMESTRUCT multiline entity into
	    the TA-specsfile.  It will contain preparsed result of what
	    the message structure is - and be able to prevent e.g.
	    decoding  QP when the end result exceeds linelength limits..
	    (And do proper body structure processings where appropriate)

	* transports/smtp/smtp.c:
	    Lengthened the -Ttcpw= default to 5 minutes
	    (RFC 1123: 3 minutes)

	* router/parsedate.c:
	    Armour  lilian()  function against bad MON or DAY inputs.
	    (Especially zero month is deadly..)  However this code is
	    currently completely dead -- not used, so...

	* scheduler/mq2.c, transports/mailbox/mailbox.c,
	  transports/sm/sm.c, transports/smtp/smtp.h,
	  transports/smtp/smtptls.c, transports/smtp/smtp.c,
	  transports/smtp/appendlet.c:
	    Turns out the  sfsetfd()  has a undesirable side-effect,
	    which might be turnable off, but...  Namely it does sfsync()
	    on the stream before setting the fd -- we don't want that.

	* libsh/io.c, router/functions.c, router/prototypes.h,
	  router/rtsyslog.c, smtpserver/smtprouter.c,
	  transports/libta/diagnostic.c:
	    Cleaned up several GCC 2.96 reported/complained things.
	    (Couple of which stopped compilation..)

	* transports/smtp/smtp.c:
	    More of hunting of strange errors at protocol transmission.

	* smtpserver/smtpserver.c:
	    When reporting '-- pipeline input exists', do that
	    immediately after collecting previous input line, not
	    after SYNCing out previous reply.

2000-02-01  Matti Aarnio  <mea@zmailer.org>

	* transports/smtp/appendlet.c, transports/smtp/smtp.h,
	  transports/smtp/smtptls.c,   transports/smtp/smtp.c:
	    More of the same work as yesterday evening/today
	    early morning..

	* transports/smtp/smtp.c, transports/smtp/smtptls.c,
	  transports/libta/swriteheaders.c:
	    Some code rearrangements to better(?) handle stream
	    write errors.

2000-01-31  Matti Aarnio  <mea@zmailer.org>

	* utils/mxverify/mxverify-cgi.c:
	    Move "test with user-suppled address" before the
	    "test with postmaster" case.  In case the Postmaster
	    doesn't exist (which is an error in itself, though..),
	    the user supplied address was tested very least.

2000-01-25  Matti Aarnio  <mea@zmailer.org>

	* transports/smtp/smtp.c, transports/smtp/appendlet.c:
	    Small error test rearrangements so that if  sferror()
	    is set at the output stream, no writing will happen.

2000-01-24  Matti Aarnio  <mea@zmailer.org>

	* transports/libta/swriteheaders.c,
	  transports/libta/fwriteheaders.c:
	    Do proper TAB-expand in entire header strings,
	    if so directed.

	* utils/mxverify/*
	    Made it as stand-alone as possible; it still uses ZMailer's
	    configuration system, but does not need rest of the system
	    for compilation -- all parts it needs are localized copies.

	* transports/smtp/smtptls.c:
	    smtp_sfwrite() didn't break out at write-timeout quite
	    as I had intended..

	* transports/smtp/smtp.c, transports/smtp/smtptls.c:
	    More debug stuff for hunting strance message breaks..

2000-01-23  Matti Aarnio  <mea@zmailer.org>

	* lib/token.c, router/rfc822hdrs.c:
	    Turn all header start spaces to optimized TABs plus spaces.

	* smtpserver/smtpcmds.c:
	    Now (!) people tell me that the most common M$ email
	    clients are absolutely stupid, and won't be able to
	    correlate outgoing SMTP verbs to responses they receive.
	    They just tell to user the error which Z returns, and
	    as it doesn't repeat the address in fault (why should it?),
	    user has no clue...   (So the one-line reports will from
	    now on also mention the received address...)

	* utils/mxverify/Makefile.in, utils/mxverify/mxverify-cgi.c,
	  utils/mxverify/mxverify-cgi.html, utils/Makefile.in,
	  utils/mxverify-cgi.c, utils/mxverify-cgi.html
	    Moved the thing to subdirectory.
	    Now it can be compiled without compiling the *entire*
	    other ZMailer -- just:
		./configure --prefix=/usr
		cd utils/mxverify ; make

2000-01-20  Matti Aarnio  <mea@zmailer.org>

	* utils/listexpand.c:
	    Added parametrization on how large bundles to make.
	    Default is the same old 200..

	* transports/smtp/smtp.c:
	    Turned out that Linux glibc 2.1 getaddrinfo() has some
	    strange bugs when it is left to its devices to scan for
	    a generic address suite -- it doesn't scan only IPv4 and
	    IPv6, but also some others, and if it gets error anywhere,
	    it seems to barf..  Will now scan for IPv4 and IPv6
	    separately :-/  So much for the great transparent API ...

	* utils/mxverify-cgi.c, utils/mxverify-cgi.html:
	    Detected the above problem while playing with this utility,
	    and developed that change here..
	    Reworked quite some things after initial deployment, added
	    that page into CVS for supplementary info.

2000-01-19  Matti Aarnio  <mea@zmailer.org>

	* include/ta.h,           transports/libta/diagnostic.c,
	  transports/smtp/smtp.c, transports/libta/tasyslog.c:
	    Report (at smtp) also the conversion mode used
	    at the reported session.

	* utils/mxverify-cgi.c, utils/Makefile.in:
	    Writing a utility to ease destination domain verification
	    by testing *all* MXes of given domain.

2000-01-17  Matti Aarnio  <mea@zmailer.org>

	* smtpserver/smtpserver.h, smtpserver/smtpserver.c:
	    Accept SMTP verbs which have numbers in them.
	    Treat verb "550" by responding SILENTLY to it -- e.g.
	    don't reply anything when get it.

	* smtpserver/mxverify.c:
	    Treat RBL-type lookups as ERRORS only when the DNS
	    yields A record under mask: 127.0.0.0/24.  There exists
	    a zone:  .ok.orbs.org  which has  127.127.0.0/24 and
	    THOSE are verified to be ok.  If using ORBS, use first
	    the OK zone, only then the RELAYS zone.
	    ( -> On larger blocked zone, an individual OK entry can
	         accept email. )

2000-01-14  Matti Aarnio  <mea@zmailer.org>

	* scheduler/msgerror.c, include/ta.h,
	  transports/libta/diagnostic.c, transports/smtp/smtp.c:
	    Extend the notary report with "X-ZTAID:" which is
	    diagnostic about which TA process did generate the error
	    report.    Allows one to hunt things from the syslog..

	* smtpserver/smtpserver.c:
	    Doing  longjmp()  from within a signal handler isn't
	    kosher -> sigsetjmp()/siglongjmp() and friends..
	    (Not that that signal handler should ever be called in
	     normal operation of the smtpserver..)

	* scheduler/readconfig.c:
	    Pulled back (disabled) code related to selector clause
	    wild-card testing in clause's "channel" part.

	* proto/cf/standard.cf:
	    Fixed recent thoughts mentioned below - coded test end
	    statement ("fi") was missing.

2000-01-07  Matti Aarnio  <mea@zmailer.org>

	* scheduler/threads.c:
	    Sometimes adding new tasks into a long-running thread did
	    cause the "unfed" count to go to *negative* value.
	    Now counting tasks there always when they arrive to
	    the thread, not only when all previous ones have already
	    been fed.. (caring about it only when a process is active
	    on the thread.)

	* proto/cf/aliases.cf, proto/cf/fqdnalias.cf,
	  proto/cf/i-iprouter.cf, proto/cf/i-router.cf,
	  proto/cf/standard.cf, proto/db/dbases.conf:
	    Some collected thoughts about how to do multiple instances
	    of several popular databases (like aliases) in varying DB
	    formats.

	* router/libdb/bind.c, proto/cf/i-smtp.cf:
	    Created sub-mode 'mxlocal' for the BIND database.
	    If local system is lowest MX for given domain, then
	    it yields string (query domain) and zero return code,
	    else NIL and non-zero return code.

	* Makefile.in, bin/usa-itar-stripper.sh:
	    'make dist-usa' creates now
	       - DIRNAME-usa.tar  package (vs. DIRNAME.tar of 'make dist')
	       - crypto-DIRNAME.diff  file

	* transports/smtp/smtp.h, transports/smtp/smtp.c:
	    Seen strange junk commands fed out to the remote
	    systems, trying to determine what is going on..

2000-01-05  Matti Aarnio  <mea@zmailer.org>

	* smtpserver/smtpcmds.c:
	    Change several policy situation '550' codes to '553';
	    temporary failure indicators shall stay as '440'.

2000-01-04  Matti Aarnio  <mea@zmailer.org>

	* smtpserver/smtpserver.h, smtpserver/smtpserver.c:
	    Killed 'HAVE_TCPD_H' code from these files; using
	    smtpserver's policy database is better -- way better..

	* transports/smtp/smtp.c, include/libz.h, lib/parseintv.c,
	  lib/Makefile.in, scheduler/readconfig.c:
	    - Moved  parse_interval()  into library (from scheduler).
	    - Using it at smtp-ta for timeout parameter parsing

	* transports/smtp/smtp.c:
	    If 'DATA' yields '500' series, don't just do RSET + retry
	    at the same stream. (EX_IOERR)

2000-01-03  Matti Aarnio  <mea@zmailer.org>

	* router/libdb/headers.c:
	    Darn..  Can't just disable "date" from known headers,
	    however changeing their semantics to 'nilHeaderSemantics'
	    should do it.

	* scheduler/threads.c:
	    abort() replaced with correct code -- "the thing never to
	    happen *did* happen"...

2000-01-02  Matti Aarnio  <mea@zmailer.org>

	* router/rfc822.c, lib/skip821address.c,
	  transports/libta/ctlopen.c:
	    Have seen one mighty strange local non-delivery,
	    and learned ways to use quotes in addresses which
	    are not always safe from router to scheduler, and to TAs..

	* man/smtp.8, proto/smtp-tls.conf{,.in}, doc/guides/openssl,
	  configure.in, proto/Makefile.in, proto/scheduler.conf.in,
	  proto/post-install.sh.in:
	    - Updated 'smtp.8' man-page
	    - Updated OpenSSL GUIDE
	    - Updated the prototype of  smtp-tls.conf  (and renamed
	      it for autoconf reasons)
	    - Install the  smtp-tls.conf  prototype file
	      (for post-install)
	    - Updated  post-install.sh
	    - Added example usage clause to scheduler.conf.in

	* transports/smtp/smtp.c, transports/smtp/smtp.h,
	  transports/smtp/smtptls.c, transports/smtp/appendlet.c:
	    Reworked the timeout parametrizations somewhat
	    (per what a colleque of mine had asked for)

	* router/libdb/header.c, router/rfc822hdrs.c:
	    Remove the "Date" headers from specially recognized set.
	    Will end PARSING of the headers completely - it is an UA
	    problem, after all.
	    --> WHOOPS! Must fix also  router/rfc822hdrs.c !

	* scheduler/scheduler.c:
	    Properly analyze how many FDs each bidirectional TA
	    connection needs.  One or two.  Calculate the maximum
	    number of TA childs we can run.

	* scheduler/threads.c, scheduler/readconfig.c,
	  scheduler/scheduler.h, scheduler/transport.c:
	    Modified the process state algorithms a bit.
	    - Process will stay in STUFFING until it gets #hungry in
	      that state without that the thread has any 'nextfeed'
	      available.
	    - Only when there are no more things to feed in STUFFING-
	      state, process moves to FINISHING-state
	      ("retryat" processing being sole exception.)
	    - A new vertex to a thread while there are active processes,
	      but 'nextfeed == NULL' will be placed into 'nextfeed'.
	    - A new clause parameter ``WakeupRestartOnly'' works by
	      allowing a newly created thread to be processed
	      immediately, but if existing thread is in ``Retry Delay''
	      state, this new message will not auto-start the thread
	      right away.
	
	* proto/scheduler.conf.in:
	    Explained a lot (more) about the scheduler usage of
	    various selector clause parameters in the initial
	    comment lines.

	* transports/smtp/smtp.c, transports/smtp/smtptls.c,
	  transports/smtp/smtp.h, doc/guide/openssl:
	    Debugged the client-mode STARTTLS, it *works*!

1999-12-31  Matti Aarnio  <mea@zmailer.org>

	* Makefile.in:
	    Version 2.99.52-patch1

	* transports/mailbox/mailbox.c:
	    Spotted lurking SFIO usage bug which caused
	    missing safe buffer zone newlines at the ends
	    of the mailbox stored messages.  At least
	    my MUTT seem to be a happy camper even with
	    this problem present, but perhaps not all
	    are so good..

	* transports/libta/swriteheaders.c:
	    Missed reserving space for TAB-expansions in CHUNKING
	    mode operation of SMTP.  Only against other ZMailers,
	    and a few other rare systems..

1999-12-30  Matti Aarnio  <mea@zmailer.org>

	* Makefile.in:
	    Version 2.99.52

1999-12-30  Matti Aarnio  <mea@zmailer.org>

	* contrib/zmailer-spec/*:
	    SPECS files for RPM generation
	    from XosÉ Vázquez <xose@ctv.es>

	* Makefile.in:
	   Version 2.99.52-pre5

	* scheduler/scheduler.c:
	    At RESYNC processing do lock verification SILENTLY,
	    and do break the lock...

	* transports/mailbox/mailbox.c:
	    When SFIO was introduced here, write to pipes wasn't
	    anymore working quite as it should -- namely EPIPE
	    is something which shall just be *ignored*.  Wrote
	    SFIO write discipline to handle this case.

	* utils/Makefile.in, utils/smtpserver-log-parser.pl:
	    Autoconfigure the perl for that script, and install
	    it during normal system install (and install-bin).

	* transports/smtp/smtp.c:
	    - Some remote servers misbehave by issueing an error
	      to MAIL FROM just because receiver doesn't do proper
	      state clearance at end of DATA phase, but claims
	      that "MAIL FROM already given" :-(  Issue an RSET,
	      and try feeding the thing again.
	    - Subtle dangling pointers seen related to reconnect
	      processing, fixed them now.

	* scheduler/threads.c:
	    Print "mailq -Q" always as is threads are running in
	    multi-TA mode (instead of the default of maxthr=1)

	* scheduler/update.c:
	    An oddball ETRN caused SEGV - not quite sure this fix
	    was right in the long run...

	* libmalloc/botch.c, libmalloc/defs.h, libmalloc/dumpheap.c,
	  libmalloc/malloc.c, include/zmalloc.h, libmalloc/_strdup.c,
	  libmalloc/align.h, libmalloc/globals.c, libmalloc/emalloc.c,
	  libmalloc/malloc.h, libmalloc/strdup.c
	    memory debugging tools -- glibc malloc hooks are better!
	    (See  smtp.c  "_hook" things..)

	* scheduler/mq2.c:
	    Use SFIO instead of STDIO for some debug reports, and
	    do clean them too!
	
	* include/ta.h, transports/libta/ctlopen.c,
	  transports/libta/diagnostic.c, transports/libta/mimeheaders.c,
	  transports/libta/fwriteheaders.c, transports/smtp/smtp.c,
	  transports/libta/swriteheaders.c,
	  transports/libta/routermxes.c:
	    Tracked memory freeup order failure!  D'uh it was difficult!
	    ( ctlclose() did free(d.contents) too early... )

1999-12-29  Matti Aarnio  <mea@zmailer.org>

	* scheduler/scheduler.h, scheduler/prototypes.h,
	  scheduler/mq2.c, scheduler/threads.c, scheduler/transport.c,
	  scheduler/readconfig.c, scheduler/qprint.c,
	  scheduler/update.c, proto/scheduler.conf.in,
	  scheduler/agenda.c:
	    Implemented changes needed for running multiple TAs
	    at threads.

1999-12-28  Matti Aarnio  <mea@zmailer.org>

	* include/netdb.h, libc/getnameinfo.c:
	    Fixes from Eugene Crosser for Cobalt box.

1999-12-23  Matti Aarnio  <mea@zmailer.org>

	* transports/hold/Makefile.in, transports/mailbox/Makefile.in,
	  transports/sm/Makefile.in, transports/smtp/Makefile.in:
	    Modify library linkage orders; in case @LIBMALLOC@ is used,
	    link it *last*.  That should avoid some problems I had
	    recently when running memory-debug TAs..

	* scheduler/transport.c:
	    One more oddball corner case - missed to do *thread*
	    rescheduling at the thread-switch..

	* scheduler/scheduler.c, scheduler/scheduler.h:
	    After some fixed amount of resyncs on a file, throw it away
	    alltogether for later input queue scanner to find.
	
1999-12-22  Matti Aarnio  <mea@zmailer.org>

	* lib/selfaddrs.c:
	    A programming error has lurked here ages -- if system has
	    more than a few (6-8) IP addresses, previous code failed
	    to pick *any*.  Cured things so that it will now pick all.
	
1999-12-21  Matti Aarnio  <mea@zmailer.org>

	* scheduler/scheduler.h, scheduler/transport.c:
	    Report at reclaim() to scheduler main error log if subprogram
	    has returned with non-zero exit status.

	* scheduler/agenda.c, scheduler/threads.c,
	  scheduler/prototypes.h:
	    Moved  QUEUE_ONLY  flag observation inside
	    the  thread_start().

	* scheduler/scheduler.c:
	    Timeserver waking up on select() every circa 0.3 seconds.
	    (Goal is to have *some* reliability at getting a bit more
	     accurate 1 second tick..)

	* scheduler/threads.c:
	    Fixed  'thr->attempts' accounting, threw away a pile of
	    dead (#if 0 ... #endif) code.
	
1999-12-20  Matti Aarnio  <mea@zmailer.org>

	* scheduler/transport.c:
	    Inverted flush_child() return code - to work like specified..

	* scheduler/update.c, scheduler/scheduler.h,
	  scheduler/threads.c, scheduler/transport.c,
	  scheduler/conf.c, scheduler/prototypes.h:
	    More tracking of referrals thru freed memory blocks,
	    and various core logic cleanups.

	* libc/getaddrinfo.c:
	    Include wrapper test fix

1999-12-19  Matti Aarnio  <mea@zmailer.org>

	* scheduler/scheduler.c:
	    Wondered why (at Solaris) the system doesn't run with
	    timeserver process.  Possible fix implemented. (SFIO
	    usage mistake.)

	* scheduler/threads.c:
	    Spotted the final lurking thread-auto-switch bug -- "ho"
	    and "ch" pointers at proc object were not updated at the
	    rewritten  pick_next_thread()  function.

	* transports/smtp/smtp.c:
	    Spotted aplenty of suboptimal diagnostic() calls, and
	    guarded them with   if (rp->lockoffset)  tests.  After
	    a diagnostic is done, that variable is zero.

	* transports/smtp/smtp.c:
	    Consider DNS originating NONAME/NODATA errors to be fatal.
	    (until we again spot something which tells me otherwise..)

	* smtpserver/policytest.c, smtpserver/mxverify.c:
	    If at MAIL FROM or RCPT TO the address domain is not found
	    from the DNS, and code is  EAI_NONAME or EAI_NODATA, we yield
	    500-series result.

	* include/netdb6.h, libc/getaddrinfo.c:
	    Synced  getaddrinfo() API constants with that of Linux
	    glibc 2.1 proper.

1999-12-16  Matti Aarnio  <mea@zmailer.org>

	* scheduler/prototypes.h, scheduler/threads.c,
	  scheduler/transport.c,  scheduler/update.c:
	    Reworked vertex processing some more -- the child feed
	    function (and *only* that) will call  pick_next_vertex().

1999-12-15  Matti Aarnio  <mea@zmailer.org>

	* scheduler/scheduler.c:
	    In sync_cfps() vertex index limits one-off :-(
	
1999-12-14  Matti Aarnio  <mea@zmailer.org>

	* scheduler/scheduler.h, scheduler/prototypes.h,
	  scheduler/update.c, scheduler/transport.c,
	  scheduler/threads.c:
	    Reworked the logic of TA child process feeding and job
	    picking.   This is initial edition - not yet confirmed
	    to *work*.   
	    Killed a *lot* of hairy code -- thus must have done something
	    right...  (Added about 440 lines, removed about 550 lines.)

1999-12-14  Matti Aarnio  <mea@zmailer.org>

	* configure.in:
	    '--disable-pam' option.

	* scheduler/*:
	    Pulled back most of logic changes introduced during last
	    10 or so days, but kept (of course) all SFIO things.

	* smtpserver/smtpserver.c, smtpserver/smtpcmds.c:
	    changed most (all?) 553 and 453 return codes to 550 and 450
	    respectively.

	* smtpserver/zpwmatch.c:
	    Don't call (at all)  pam_acct_mgmt()  function.

1999-12-12  Matti Aarnio  <mea@zmailer.org>

	* scheduler/msgerror.c:
	    Put original (or rewritten) message headers to the end of
	    the acompanying letter - makes things easier for M$ users
	    to ask for advice (and me to give it..)

	* scheduler/scheduler.c:
	    Found curious problems at the resyncing code; sometimes
	    resulting VTX->NGROUP count was zero, and things didn't
	    quite work with that..  Such vertices are now thrown away.

	* scheduler/scheduler.c:
	    A major walk-thru of MIB variables for Recipient counts.
	    Are they now in control ??

	* smtpserver/smtpserver.c, smtpserver/smtpcmds.c:
	    Found out that Lotus SMTPMTA software goes ballistic
	    if it sees response code it doesn't expect -- its writers
	    are stupid and expect everybody to always produce only
	    codes listed at RFC 821 -- without doing the hundred-
	    series "approximative" processing more common in all
	    public source based system.. (beginning with sendmail..)

1999-12-09  Matti Aarnio  <mea@zmailer.org>

	* transports/libta/ctlopen.c, router/rfc822.c,
	  scheduler/scheduler.c, scheduler/threads.c:
	    Immediately obvious bugfixes, once the system is under load..

1999-12-08  Matti Aarnio  <mea@zmailer.org>

	* transports/smtp/smtp.c, transports/mailbox/mailbox.c:
	    Noticed case where still do MIME downgrading in place
	    where we really DO NOT KNOW HOW TO!  Added code to
	    once and for all disable conversions unless the message
	    in question is TEXT/PLAIN.

	* include/mail.h.in, router/rfc822.c, scheduler/scheduler.c,
	  transports/libta/ctlopen.c, include/ta.h:
	    Introduced  _CF_FORMAT  tag to the scheduler/TA spec file.
	    From now on adding new gimmic formats is easier - I hope.

	* include/libta/warning.c:
	    Make sure that writing of the messages will happen in
	    blocking mode socket, and do  fflush()  afterwards!

	* transports/smtp/smtp.h, transports/smtp/smtp.c,
	  transports/smtp/appendlet.c, include/libc.h:
	    ZBUFSIZ macro to replace possibly <stdio.h> originated
	    BUFSIZ macro.  Easier to be consistent and predictable..
	    Added couple missing extern...() function declarations.

	* lib/esyslib.c:
	    At Solaris the  unlink(2) may yield EINTR or EBUSY, do
	    a wrapper to retry the operation when that happens.

	* router/rfc822.c:
	    At Solaris the  unlink(2) may yield EINTR or EBUSY, do
	    a wrapper to retry the operation when that happens.
	    (This is different from  eunlink()  which complains..)

	* smtpserver/smtpserver.c, smtpserver/policytest.c,
	  smtpserver/smtpserver.h:
	    Track successfull configuration, and refuse to accept
	    email if no rudimentary configuration exists.

1999-12-04  Matti Aarnio  <mea@zmailer.org>

	* scheduler:
	  - Some more SFIO fixes which I missed last night
	  - Possibly fixed the 'mailq -Q' reported stored
	    recipient counts. (cosmetics)

	* lib/symbol.c, libc/getzenv.c:
	    Compiler pleasing..

	* ALL OVER THE PLACE:
	  - Replaced *all* stdio usage within the Scheduler with
	    SFIO -- now it can go beyond 255 open file descriptors
	    at Solaris systems... (FILE->_file is 'u_char' there,
	    while Sfio_t->file is a 'short' - huge difference!)
	  - More work on SMTP TA code to eradict last vestiges of
	    alarm(2) based timeout breaks, now SFIO stream discipline
	    routines will handle the timeout gracefully
	  - Some changes to few very commonly used headers, and resulting
	    small call changes all over..

1999-12-02  Matti Aarnio  <mea@zmailer.org>

	* proto/smtp-tls.conf, transports/smtp/smtp.c,
	  transports/smtp/smtp.h, transports/smtp/smtptls.c:
	    - Completed initial write-thru of TLS client mode for
	      the SMTP TA, however *no* testing has been done yet!
	    - Both client and server got (from Postfix) session cache,
	      but that code is *untested*
	
	* smtpserver/smtptls.c, proto/smtpserver.conf.in,
	  smtpserver/cfgread.c, smtpserver/smtpserver.h,
	  smtpserver/smtpserver.c, smtpserver/smtpcmds.c:
	    - Updates to smtpserver for evolved original code
	      from Postfix.
	    - Both client and server got (from Postfix) session
	      cache, but that code is *untested*

	* proto/Makefile.in:
	    With "make dirs" creates $POSTOFFICE/TLSsrvrcache/ and
	    $POSTOFFICE/TLSclntcache/ directories with protection of
	    700 ..    (For the SSL session cache storage.)
	
1999-12-01  Matti Aarnio  <mea@zmailer.org>

	* utils/policy-builder.sh.in:
	    Add some comments to the generated  smtp-policy.dat  file
	    about which source section (file) is beginning..
	    Add some comments to the generated  smtp-policy.dat  file
	    about which source section (file) is beginning..

	* Makefile.in, configure.in, sfio/Makefile.in, sfio/README,
	  sfio/src/lib/sfio/makefile{,.in}, include/ta.h:
	    Autoconfigure key parts of the  SFIO  library make system
	    to fit ZMailer environment.  Use  SFIO  stuff at Transport
	    Agents.

	* transports/libta/writeheaders.c, transports/libta/Makefile.in,
	  transports/errormail/errormail.c, transports/hold/hold.c,
	  transports/sm/sm.c, transports/mailbox/mailbox.c,
	  transports/libta/fwriteheaders.c:
	    Renamed former  writeheaders()  to be  fwriteheaders().

	* transports/libta/swriteheaders.c, transports/libra/Makefile.in,
	  transports/smtp/Makefile.in, transports/smtp/smtp.c:
	    Created modified version of  writeheaders(), namely
	    swriteheaders() which instead of 'FILE *' has 'Sfio_t *'
	    as its 'fp' parameter.  Using that at smtp.c

	* transports/smtp/Makefile.in, transports/smtp/smtp.c,
	  transports/smtp/appendlet.c, transports/smtp/smtp.h:
	    Split up the big monolithic  smtp.c  a bit:
		 608   16378 transports/smtp/appendlet.c
		4182  112512 transports/smtp/smtp.c
		 410   12057 transports/smtp/smtp.h
	    Further smarts at the transport-time conversions will
	    go into the  appendlet.c  alone..
	
1999-11-30  Matti Aarnio  <mea@zmailer.org>

	* router/Makefile.in, router/daemonsub.c, router/functions.c,
	  router/router.c:
	    Moved daemon management functions into own file, and rewrote
	    them somewhat when Linux 2.3.30pre3 caused a hangup..
	    (And cleaned some dead code from  router.c )
	
	* scheduler/mailq.c:
	    Do line-start dot-duplication a'la SMTP...
	
	* utils/smtpserver-log-parser.pl:
	    Synced this tool with my lattest online edition,
	    fairly usable..

1999-11-17  Matti Aarnio  <mea@zmailer.org>

	* router/functions.c:
	    More system rework, now signal handlers don't muck with
	    stdio stuff, and associated trouble (which *might* be
	    problem at some systems).  Report child-process runtime
	    statistics when the child dies.  Use  select()  to detect
	    when children have things to report, if available.
	    A dead router child is reclaimed properly, and new ones
	    are started as the need arises.

	* scheduler/scheduler.c, scheduler/transport.c,
	  scheduler/update.c:
	    Fix message-specific interactive report logging to use
	    vfp_open() routine (which had a feature/security problem
	    in itself). Rearranged several logging points so that
	    'scheduler processing' messages are done correctly.
	    Wrote 'Feeding to child..' report into the transport.c.
	    At update.c rewrote  logstat(),  and dead code now using
	    vfp_open() to write individual recipient statuses; problem
	    being that 'vp->cfp->contents' is NULL at the call time..

	* scheduler/transport.c:
	    mailq interface specification had a case where data can be
	    omitted, and one pointer is thus NULL -- referring via which
	    is an open invitation to trouble (SIGSEGV usually..)

1999-11-16  Matti Aarnio  <mea@zmailer.org>

	* transports/smtp/smtp.c:
	    Noticed that (again) smtp doesn't always timeout in 3 days
	    (or whatever the queue timeout is), turned out EX_TEMPFAIL
	    diagnostics don't always carry timeout value (60 seconds).

	* router/Makefile.in, router/functions.c, router/router.c,
	  proto/cf/standard.cf:
	    Revised the way how several things are done:
	    - files are processed under control of a work-gang leader
	    - logging isn't done anymore via router logscript
	      "dribble" redirection, but via a work-gang leader

1999-11-15  Matti Aarnio  <mea@zmailer.org>

	* Makefile.in:
	    version 2.99.52-pre4

	* configure.in:
	    Autodetect when PAM-support (for SMTP authentication) needs
	    also "-ldl" library, and when not.

	* configure.in:
	    Fix on fix on fix of autodetecting MD5SUM program location.

	* proto/Makefile.in, Makefile.in, proto/post-install.sh.in:
	    An attempt at writing a   post-install  script, which
	    conditionally moves files from respective "proto" subdirs
	    to their proper places.

	* scheduler/mailq.pl:
	    A simple demo core for PERL version of the MAILQv2 query
	    utility..

	* include/md5-global.h:
	    Found the reason why our MD5 instance did produce wrong
	    results at my Alpha... It is very important to truncate
	    intermediate calculations to 32-bits during the processing!

	* lib/selfaddrs.c, libident/identuser.c, scheduler/mailq.c,
	  scheduler/pipes.c, scheduler/transport.c,
	  smtpserver/smtpserver.c, transports/mailbox/mailbox.c,
	  transports/smtp/mprobe.c:
	    Instead of  AF_xxxx  we call  socket parameter  PF_xxx
	    (not: Address Family, but Protocol Family ...)
	
	* man/scheduler.8, man/mailq.1, scheduler/mailq.c,
	  scheduler/threads.c:
	    Updated man-pages a bit (quite a bit!),
	    implemented 'mailq -QQQ'  in MAILQv2 mode.
	    (E.g. 'SHOW SNMP')

1999-11-12  Matti Aarnio  <mea@zmailer.org>

	* configure.in:
	    Autodetect  <sys/un.h>  header file

	* proto/scheduler.conf.in, scheduler/mailq.c,
	  scheduler/mq2auth.c, scheduler/prototypes.h,
	  scheduler/readconfig.c, scheduler/scheduler.c,
	  scheduler/transport.c:
	    * scheduler.conf file can now have:
	        PARAMmailqpath = "UNIX:/path/to/pf_unix/mailq/socket"
		PARAMmailqpath = "TCP:174"
	    * mailq -p /path/to/pf_unix/mailq/port
	    * mailq -p mailq    (check /etc/services for tcp/mailq)
	    * mailq -p 174      (default case)

	    Those are for running multiple schedulers in the system,
	    and allowing each a different mailq port. (Out of PF_UNIX,
	    and PF_INET protocol families..)

1999-11-11  Matti Aarnio  <mea@zmailer.org>

	* scheduler/mq2.c, scheduler/scheduler.c, scheduler/prototypes.h,
	  scheduler/threads.c, scheduler/readconfig.c,
	  proto/scheduler.conf.in, scheduler/mq2auth.c,
	  proto/scheduler.auth:
	    Modified somewhat commands, and how they are selected.
	    Now  "scheduler.auth"  file defines which operations are
	    allowed (a bit-mask).
	
	* proto/Makefile.in:
	    Wrong file referenced; must be  scheduler.auth  !
	    ( not smtpserver.auth! )

	* lib/selfaddrs.c:
	    When  HAVE_SA_LEN  is defined, we used wrong definition
	    for  sa_len  field within the union.

	* transports/libta/tasyslog.c, router/rtsyslog.c:
	    An experiment on alternate TRANSPORT syslog format:
	    if ZENV variable SYSLOGFLG has 'T', the classical ", "
	    separated fields are printed.  If the flag is 't',
	    field separator is TAB-character.   Similarly for ROUTER
	    there are 'R' and 'r' keycodes.
	    (Turns out that either syslogd, or syslog() routine
	     at libc converts all control characters to ^I (in TAB case)
	     pairs..  D'uh...)

1999-11-09  Matti Aarnio  <mea@zmailer.org>

	* utils/makedb/makedb.c:
	    When using NDBM format, if the STORE returns error with
	    errno=ENOSPC, we report that KEY.LEN+DATA.LEN exceed 1kB
	    which NDBM allows...

1999-11-04  Matti Aarnio  <mea@zmailer.org>

	* scheduler/readconfig.c, scheduler/threads.c, scheduler/conf.c,
	  scheduler/mailq.c, scheduler/mq2.c, scheduler/mq2auth.c,
	  scheduler/prototypes.h:
	    'mailq -Q' and 'mailq -QQ' work when scheduler runs
	    with '-M2'  now :)  Authentication wants
		PARAMauthfile = "/path/to/scheduler.auth"
	    into the boilerplate defining section of the scheduler.conf,
	    and that file -- well, see the example. WORK IN PROGRESS!

	* scheduler/mq2.c, scheduler/mq2auth.c:
	    More of the theme...

	* configure.in, utils/Makefile.in, utils/md5sum.c:
	    Initial attempt at writing (from scratch)a MD5SUM
	    program, but for some reason the result is *not* the
	    same as GNU textutils one gives :-/  Perhaps it will
	    not matter in the end, though..

	* scheduler/Makefile.in, scheduler/transport.c, scheduler/mq2.c,
	  scheduler/scheduler.h, scheduler/prototypes.h:
	    Some more work on MAILQ-V2; now needs fleshing out only
	    the real protocol interpreter at  mq2.c: mq2interpret(),
	    and corresponding things in the system..

	* utils/policy-builder.sh.in:
	    Some script tweaks; removed externally sourced 'bad source
	    addresses' list pickups.

1999-11-02  Matti Aarnio  <mea@zmailer.org>

	* include/md5.h, libc/md5c.c:
	    Move call-interface renaming macro into more
	    appropriate place..

	* proto/cf/server.cf:
	    Rectify report codes for EXPN and VRFY.

	* smtpserver/smtpserver.c:
	    Don't do ident query when in interactive mode.

	* smtpserver/smtpserver.c, smtpserver/smtpserver.h:
	    Call  s_setup()  with appropriate fd's for input,
	    and output.  Sometimes we are *not* running with
	    bidirectional socket as the point of contact..

	* scheduler/scheduler.h, scheduler/scheduler.c,
	  scheduler/mailq.c, scheduler/prototypes.h,
	  libc/md5c.c, scheduler/MAILQ-V2:
	    Initial steps to write an interactive command channel
	    via the MAILQ port.

1999-10-30  Matti Aarnio  <mea@zmailer.org>

	* smtpserver/Makefile.in, smtpserver/smtpserver.c,
	  smtpserver/wantconn.c:
	    Reversed the effective kill of the tcp-wrapper after
	    the ./configure got a way not to link it in per default..

	* configure.in:
	    "--with-openssl" (or its more explicite cousins) must now
	       be used to have OpenSSL enabled at the system
	    "--with-tcp-wrappers" (or its more explicite cousins) must
	       now be used to have TCP-Wrapper enabled at the system

	* man/smtpserver.8, proto/smtpserver.conf.in,
	  smtpserver/cfgread.c, smtpserver/smtpserver.h,
	  smtpserver/smtpserver.c,  smtpserver/smtpcmds.c:
	    A "tarpit" feature implementation per an idea from
	    Arjan van de Ven <arjan@NL.UU.NET>, plus
	    Mark Visser <mark@cal026031.student.utwente.nl>.
	    (Who reported of what postfix/vmail can do.)

1999-10-26  Matti Aarnio  <mea@zmailer.org>

	* configure.in:
	    Smarter (?) default picking for  SENDMAILPATH and MAILBOX
	    directory path for those systems which have  <paths.h> file
	    with system specific directory paths...

	* libc/Makefile.in:
	    Fixed $(prefix) usages in 'make install' targets.

	* smtserver/Makefile.in,
	  smtpserver/smtpserver.c, smtpserver/wantconn.c:
	    Essentially killed tcp-wrapper from being used for ZMailer's
	    smtpserver.  SMTPSERVER's policy-database has superior
	    technology for the same thing.

1999-10-20  Matti Aarnio  <mea@zmailer.org>

	* man/Makefile.in:
	    Make the destination directories if they don't exist..

	* router/libdb/bsdbtree.c, router/libdb/bsdhhash.c,
	  utils/makedb/makedb.c:
	    Turns out, 'put' function of  Sleepycat DB 2.x  has
	    changed the return values completely around, and what
	    before was negative for permanent/system error, is now
	    a positive value, and the other way around...
	    (return value for duplicate key is now negative, while
	     it was positive before...)

	* smtpserver/smtpcmds.c:
	    Count incoming message SIZE= option only *once*, as
	    we may be relaying them all, and not storing locally.
	    For that matter, in ISP mode a limited message size
	    where the message quota limits maximum of
	    	rcptcount * msgsize
	    does not make much sense - nor exactly in local storage
	    mode either...

1999-09-30  Matti Aarnio  <mea@zmailer.org>

	* smtpserver/smtpcmds.c:
	    For ETRN processing be slightly more carefull at
	    (not) accepting '@' and '#' special characters
	    in the beginning of the domain name.

	* smtpserver/smtpcmds.c:
	    At MAIL FROM we may reject the email reception, and
	    abort the email -- State change is allowed only if
	    we didn't do the abort..

	* transports/smtp/smtp.c:
	    Seen a case where immediately successive EHLO + HELO
	    both fail, and at *same* target that very same HELO
	    also succeeds...  Most surprisingly, within same session
	    which just rejected one message with an error, simply
	    continuing with an open stream (sort of bug..) we do
	    succesfully deliver email..

1999-09-27  Matti Aarnio  <mea@zmailer.org>

	* scheduler/readconfig.c:
	    If the  channel/host  selector clause contains wild-cards
	    at the 'channel' part, AND the command= parameter contains
	    '$channel' in it (once or more), set CFG_WITHHOST, because
	    such transport agents can't switch over from one channel to
	    another.

	* transports/sm/sm.c:
	    - If write to pipe fails (except with 'gotsigpipe'), cleanup
	      PIPEs to the child process.
	    - Don't be upset even if write to pipe fails with
	      EPIPE/SIGPIPE.

	* router/dateparse.c:
	    Certain pathologic inputs are able to feed extra data to
	    the date parsing, and it turned out to run with month zero,
	    which caused division-by-zero --> core dump...

1999-09-21  Matti Aarnio  <mea@zmailer.org>

	* Makefile.in:
	    Version 2.99.52-pre3

1999-09-17  Matti Aarnio  <mea@zmailer.org>

	* smtpserver/smtpserver.c:
	    Don't call  whoson(),  nor tcp-wrapper libraries in case
	    the smtpserver is not running from a network socket.

1999-09-15  Matti Aarnio  <mea@zmailer.org>

	* configure.in, smtpserver/smtprouter.c:
	    For some proprietary ZMailer instances we realized that
	    we must pass arbitary environment variables down to the
	    router process run underneath the smtpserver.  Ergo,
	    ./configure for  putenv() function, and use it if available.

	* utils/policy-builder.sh.in:
	    Disable completely the old (original) spam-address
	    downloading with Lynx, and its associated tests.
	    Time has passed over them...

1999-09-14  Matti Aarnio  <mea@zmailer.org>

	* proto/smtpserver.conf.in, proto/zmailer.sh.in,
	  smtpserver/zpwmatch-pipe.c, man/smtpserver.8:
	    Documentation entries from Artur Urbanowicz.

	* router/libdb/bind.c:
	    Limited one potential buffer-overflow into more sensible
	    sizes of input.

1999-09-10  Matti Aarnio  <mea@zmailer.org>

	* transports/mailbox/mailbox.c, transports/mailbox/fmtmbox.c,
	  transports/mailbox/mboxpath.c, transports/mailbox/Makefile.in:
	    mboxpath-formatter routine from Eugene Crosser.

1999-09-09  Matti Aarnio  <mea@zmailer.org>

	* lib/symbol.c:
	    Use CRC-31 polynome hash function internally.

	* transports/mailbox/mailbox.c, transports/mailbox/mboxpath.c,
	  man/mailbox.8, man/mboxpath.1:
	    Added -X[X] option to behave alike -P[P] option, but to use
	    CRC32() function.

	* lib/symbol.c, lib/crc32.c, lib/hashtest.c:
	    Moved CRC-31 (?) polynome calculator into separate module
	    outside the  symbol.c;  Entrypoints: 'long crc32(char *s);'
	    and 'long crc32n(char *s, int len);'.

1999-09-08  Matti Aarnio  <mea@zmailer.org>

	* libsh/interpret.c, libsh/expand.c, include/libsh.c,
	  libsh/shconfig.h, libsh/zmsh.c:
	    Hunted around, and fixed with a KLUDGE a problem in $(elements ..)
	    expansion routine.  I am not *quite* sure it is right one for
	    all cases, but detected problems at online "smtp-router" are
	    cured with this.

	* proto/cf/server.cf, proto/cf/aliases.cf, README.UPGRADING,
	  SiteConfig.in:
	    - Fix previously scrambled  server.cf  somewhat
	    - Created global settings controlling two parts of the
	      $(routeuser ..) functionality.

	* smtpserver/smtprouter.c:
	    Cleaned previous hacks.

	* smtpserver/smtpserver.c, smtpserver/smtprouter.c, proto/cf/server.cf:
	    Noticed several problems:
	    - Router reports were not reported thru the proper socket, and
	      that screw up things..
	    - Made some wrappers into the  server.cf  to always issue proper
	      status code in the line; plus always terminating "250 EXPN done",
	      or "250 VRFY done" lines.  Also noticed a bug in the zmsh!
	    - smtpserver main loop got spurious EOF result from protocol input
	      line, when the input was in fact just plain CRLF ... Urgle..

	* smtpserver/zpwmatch.c:
	    More rework at the SHADOW -branch..

1999-09-07  Matti Aarnio  <mea@zmailer.org>

	* smtpserver/smtpserver.c:
	    If (heaven forbid)  s_gets()  routine notes that the input
	    line length overflows the buffer -- i.e. it filled the buffer,
	    and didn't get an EOF or NEWLINE yet, then it will glob up
	    input, until it sees a NEWLINE (and including that newline..)

	* smtpserver/zpwmatch.c:
	    Missed one part in previous HAVE_SHADOW_H related patch :-(

	* proto/smtpserver.conf.in:
	    Place 'ESMTP' at both lines of the 220 message (sigh,
	    PostFix MTA violates RFC 1869 part 4, and probably isn't
	    the only one...)

	* smtpserver/smtpserver.c, smtpserver/smtptls.c:
	    Missed one instance of  read()  from converting to  Z_read()
	    wrapper for OpenSSL call support...

1999-09-05  Matti Aarnio  <mea@zmailer.org>

	* Makefile.in:
	    Version 2.99.52-pre2

1999-09-03  Matti Aarnio  <mea@zmailer.org>

	* doc/guides/smtp-etrn:
	    Spotted a typo error at the ISP side of the document.

	* smtpserver/zpwmatch-pipe.c, smtpserver/smtpserver.h,
	  smtpserver/smtpserver.c, smtpserver/smtpauth.c,
	  smtpserver/cfgread.c, proto/smtpserver.conf.in,
	  man/smtpserver.8, smtpserver/Makefile.in:
	    Integrated Artur Urbanowicz's "use external program
	    for authentication" approach into the baseline system.
	    (Documents could use some additional words about the
	     topic..)

	* smtpserver/zpwmatch.c:
	    Fix  HAVE_SHADOW_H  branch of the code per report
	    from Eugene Crosser.

1999-09-01  Matti Aarnio  <mea@zmailer.org>

	* transports/smtp/smtp.c:
	    Error reports from "." phase were improper, cured.

1999-08-31  Matti Aarnio  <mea@zmailer.org>

	* proto/cf/rrouter.cf:
	    Another missed "$(dequote ...)" call.  Without this,
	    pipe/file stores don't get "magic" 'pipe.*' and 'file.*'
	    local channel tags so that all other cases can safely
	    be run to procmail as the local delivery agent.

1999-08-30  Matti Aarnio  <mea@zmailer.org>

	* Makefile.in:
	    Version 2.99.52-pre1

	* sfio/*
	    Looking for ways to use this thing...

1999-08-27  Matti Aarnio  <mea@zmailer.org>

	* contrib/pipeauth-0.55.tar.gz, contrib/rauth-0.56.tar.gz,
	  proto/smtpserver.conf.in, proto/zmailer.sh.in,
	  smtpserver/cfgread.c, smtpserver/fdstatfs.c,
	  smtpserver/smtpcmds.c, smtpserver/smtpserver.h,
	  smtpserver/zpwmath.c, utils/policybuilder.sh.in,
	  doc/guides/smtp-msa-mode:
	    Heaps of changes from an ISP guy
	    Artur Urbanowicz <artur.urbanowicz@man.lublin.pl>

	* transports/libta/diagnostic.c:
	    Report the 'host' part of the referred channel/host pair
	    for which the diagnostic is being presented.

1999-08-26  Matti Aarnio  <mea@zmailer.org>

	* smtpserver/smtpcmds.c:
	    Fix support for SLOPPY mode "MAIL FROM:<>" source address.

1999-08-24  Matti Aarnio  <mea@zmailer.org>

	* smtpserver/smtpserver.h, smtpserver/smtpserver.c,
	  smtpserver/smtpcmds.c, smtpserver/smtpdata.c, smtpserver/smtprouter.c:
	    Modify (somewhat) buffering issues; small change at  s_setup(),
	    all around change  putc()  to  fputc().

	* libc/mail.c:
	    Do  setvbuf( _IOFBF )  on freshly opened file descriptor.

1999-08-22  Matti Aarnio  <mea@zmailer.org>

	* transports/smtp/smtp.c:
	    An odd-ball case of lacking RSET in PIPELINING mode when
	    none of the recipients were successfull..

1999-08-21  Matti Aarnio  <mea@zmailer.org>

	* proto/cf/fqdnalias.cf:
	    One last missing usage instance of "runas .. cat ..".
	
	* scheduler/msgerror.c:
	    Printout the  MESSAGE/DELIVERY-STATUS  report to the end of
	    the initial text report - because so many (M$) email clients
	    are uterly unable to display them...

1999-08-18  Matti Aarnio  <mea@zmailer.org>

	* configure.in:
	    For Solaris 2.6 (and Solaris 7 ?) autodetect  -lxnet  for
	    socket related functions.

	* smtpserver/zpwmatch.c, utils/listexpand.c:
	    Some cleanup from result of using SUN-CC 4.2 at Solaris 2.6.

1999-08-17  Matti Aarnio  <mea@zmailer.org>

	* README.TCP-WRAPPER:
	    New file.

	* lib/rfc822scan.c:
	    Reorganized the code a bit - now the fast path is
	    straighter code with less odd tests.

	* transports/mailbox/mailbox.c:
	    getpwnam() failure report fix - should not need, but..

	* transports/smtp/smtp.c:
	    Solaris 2.5.1 doing  getsockname()  is doing blocking
	    streams thing even on non-blocking socket :-/ Results
	    are not as nice as with e.g. BSD based systems where
	    same call doesn't block (no need!)  Also some errno
	    saving around.

1999-08-16  Matti Aarnio  <mea@zmailer.org>

	* proto/cf/aliases.cf:
	    When the   ssift  (and tsift)  were changed *not* to
	    strip away quotes, buggeroo... we need *one* place where
	    quotes are stripped -- that is: explicitely..

	* lib/rfc822scan.c:
	    _unfold() had problems at detecting the termination condition.

	* router/rfc822hdrs.c:
	    One fine-tuning of "Received:" header generation; leaves
	    off one space character when no 'from' clause is present.

1999-08-15  Matti Aarnio  <mea@zmailer.org>

	* transports/smtp/smtp.c:
	    Detect better, when the STDIO fwrite() and friends
	    fail -- bdat_sync() was running wild loop in odd
	    situation when the recipient system died from under-
	    neath, and when coming back up, it rejected the pre-
	    existing connections...

1999-08-14  Matti Aarnio  <mea@zmailer.org>

	* smtpserver/smtpserver.c, smtpserver/smtpcmds.c,
	  smtpserver/rfc821scn.c:
	    Done work to get the SLOPPY ('S') mode to work properly
	    with MAIL FROM and RCPT TO contained addresses.

	* utils/makedb/makedb.c:
	    When a duplicate key is give, print out the key value
	    in same form as the debug mode at the smtpserver does it.

	* utils/policy-builder.sh.in:
	    Remove previous static blocking list source entries.

1999-08-08  Matti Aarnio  <mea@zmailer.org>

	* man/smtpserver.8:
	    A bug in the document..  TCP-wrapper service is
	    "smtp-receiver", not "smtp-receive" ...

	* transports/libta/mimeheaders.c:
	    Previous work had some weird problems, reworked, and
	    now it seems to work.

1999-08-06  Matti Aarnio  <mea@zmailer.org>

	* transports/libta/mimeheaders.c:
	    MIME-conversion labeling had problems after the new form
	    of 'Received:' production at the router.

	* smtpserver/smtpserver.c:
	    Added couple of  setvbuf()  calls for stdout, and stderr
	    at the beginning of the smtpserver main() program.  Story
	    is long about what and where...  look at the ZMailer list
	    archive about ccNotes gateway problem.

1999-08-03  Matti Aarnio  <mea@zmailer.org>

	* lib/selfaddrs.c:
	    After example code at the list, did some of my own code tweaks
	    to do comparison of address (IPv4 or IPv6) only, not the entire
	    'struct sockaddr', which contains ports, and other things...
	    (The port might not necessarily be zero in all cases..)

	* proto/cf/aliases.cf, proto/cf/aliases-new.cf, router/functions.c:
	    A potential security problem in the scripts.  I wonder how the
	    "ancient" 2.2.1 did handle this one..  Introduced "cat" builtin
	    to be used within a sequence of:   runas $priv cat "$filepath"  ...
	    Now strategically placed symlinks can't be used to divulge file
	    contents whose access is prohibited from the symlink creator..

1999-07-20  Matti Aarnio  <mea@zmailer.org>

	* configure.in:
	    Minor nit-pick in <sys/socket.h> study.. Must include <sys/types.h>
	    at first as in many systems all headers are not idemponent, and
	    thus have some pre-requisite headers for inclusion..

	* libsh/interpret.c, proto/cf/canon.cf:
	    Don't do implicite dequotation of quotefull strings in ssift and
	    tsift..  ( '"foo@bar"' -> 'foo@bar' )
	
1999-07-19  Matti Aarnio  <mea@zmailer.org>

	* configure.in:
	    Instead  AC_CHECK_HEADER() use AC_CHECK_HEADERS() macro.
	    Former *should* work with single headers, but apparently not..

1999-07-19  Matti Aarnio  <mea@zmailer.org>

	* Makefile.in:
	    Version 2.99.51

	* configure.in, smtpserver/Makefile.in, smtpserver/zpwmatch.c,
	  doc/guides/smtpauth-login-pam-support, man/smtpserver.8:
	    Autoconfigure PAM support for the system.
	    See the  smtpauth-login-pam-support  for mandatory bit
	    of support file(s)...

	* smtpserver/smtpauth.c, smtpserver/zpwmatch.c:
	    Pass also user's UID -- although PAM code does not pick it (yet).

	* compat/rmail/rmail.c, include/libz.h, lib/linebuffer.c,
	  router/functions.c, router/rfc822.c, utils/makedb/makedb.c:
	    GLIBC 2.1 with __USE_GNU active has also 'getline()' function,
	    thus we renamed to   zgetline() ...

1999-07-12  Matti Aarnio  <mea@zmailer.org>

	* Makefile.in:
	    Version 2.99.51-pre3

	* router/rfc822.c:
	    - Empty headers caused problems in printout
	    - At errprint() did some token double-printing, now fixed.

1999-07-08  Matti Aarnio  <mea@zmailer.org>

	* root/prototypes.h, root/rfc822hdrs.c:
	    Still more finetuning of the RFC-822 output folding
	    rules.  Now things look nice in all cases that I have
	    encountered/imagined.

1999-07-07  Matti Aarnio  <mea@zmailer.org>

	* Makefile.in:
	    Version 2.99.51-pre2

	* transports/smtp/smtp.c:
	    - Reworked even more that reconnect mechanism. (core drops)
	    - Noticed that 'No MX, no address' reports are coming
	      out more and more regularly in cases where they should
	      *not* occur.  As I don't seem to be able to coerce
	      the system to do the *right* thing, let it be TEMPFAIL
	      once again...  Rather delayed erroring attempts, than
	      rejections because of wrong reports.

	* scheduler/threads.c:
	    Made debugging zsyslog(()) call to use LOG_ERR instead
	    of LOG_EMERG; latter one broadcasts to everybody in one
	    of my test systems...

	* include/libz.h, lib/rfc822scan.c, lib/token.c, libc/mail.c,
	  router/prototypes.h, router/rfc822.c, router/rfc822.ssl,
	  router/rfc822hdrs.c, router/libdb/header.c:
	    Lots of experimenting with code to get proper RFC822
	    tokenization, and proper folding at the output.
	    Most difficult part seemed to be rfc822scan.c ...

1999-07-05  Matti Aarnio  <mea@zmailer.org>

	* transports/smtp/smtp.c:
	    Reworked the EHLO/HELO reconnect mechanisms.  Now it
	    reconnects to the *same* address where EHLO failed
	    just previously.  Otherwise it could connect to some
	    other address in case the target has several addresses..

	* lib/rfc822scan.c:
	    MKERROR() did crash for some reason in previous form.
	    Modified call a bit and changed it into a static function
	    of its own.  Now it seems to work.  (Compiler bug ??)

	* Makefile.in:
	    Version 2.99.51-pre1

	* smtpserver/smtpcmds.c, smtpserver/smtpserver.h:
	    Limit the length of the "HELO/EHLO" string, and the length
	    of reported reversed hostname in the "rcvdfrom" envelope
	    header, and thus in the resulting "Received:" header.

1999-07-04  Matti Aarnio  <mea@zmailer.org>

	* router/rfc822.c, router/rfc822hdrs.c, router/libta/header.c:
	    A bit more gymnastics to get rid of:
	        Received: from localhost (user '...' uid#1234) by ...
	    and to replace it with:
	        Received: (from localhost user '...' uid#1234) by ...

	* transports/smtp/smtp.c:
	    Fixed the errorneous 'Final-Recipient:' lines in the
	    delivery reports.

	* scheduler/threads.c:
	    Re-enable the kludge-report; if they don't happen, the
	    smtp.c is ok, if they do...

	* lib/rfc822scan.c, lib/token.c, router/rfc822hdrs.c:
	    Multiline compound tokens (topic for recent activities)
	    had still major problems.  Did also modify "Received:"
	    header content generation, although not quite sufficiently
	    in all situations (considering when/how to fold commentary
	    material in 'from' entry.)

1999-07-03  Matti Aarnio  <mea@zmailer.org>

	* man/smtpserver.8, smtpserver/smtpserver.c, smtpserver/smtpcmds.c,
	  smtpserver/smtpserver.h, smtpserver/smtpdata.c, smtpserver/cfgread.c,
	  proto/smtpserver.conf.in:
	    "PARAM min-availspace 5000" -- specify the minimum required
	    available space in the $POSTOFFICE/ directory. In KILOBYTES.

1999-07-02  Matti Aarnio  <mea@zmailer.org>

	* smtpserver/smtpserver.c, contrib/whoson-1.08.tgz:
	    Arkadiusz Mi?kiewicz <misiek@misiek.eu.org>:
	    - update to newer whoson package
	    - adding option "-w" to smtpserver to actually
	      do the query of Whoson.  Allows code being
	      compiled in without it being used...

	* proto/cf/canon.cf, lib/rfc822scan.c:
	    Turns out the best way to fix the 'foo\!faa!fii'
	    problem is not to tinker with tsift patterns at
	    canon.cf, but instead have '\!' pair scanned into
	    token of its own.

1999-07-01  Matti Aarnio  <mea@zmailer.org>

	* proto/cf/canon.cf:
	    Received a patch to UUCP routing problem introduced
	    by the addition of forbidding to spot '\!' pair..

	* include/libz.h, lib/rfc822scan.c:
	    Fix the way how _unfold() works.  Pointer comparison
	    was certainly *wrong* way...

	* router/libdb/ldap.c:
	    Reorganized things:
		Do connect+bind to DB at  ldap_open()
		Do ONLY queries at ldap_search()
		Do dissociation at ldap_close()
	
	* libsh/builtin.c:
	    A bug in handling of  $(lreplace ... )  internal conscell
	    chains polluted wrong objects with call parameters.  Adding
	    one strategic copy-chain solved it.

1999-06-30  Matti Aarnio  <mea@zmailer.org>

	* smtpserver/smtpauth.c, smtpserver/smtpcmds.c, smtpserver/smtphelp.c,
	  smtpserver/smtpserver.h, smtpserver/smtpserver.c:
	    A change in logging; make individual input sessions stand out
	    better by using constructed log line prefix; pppppTTTT[rw#-]
	    where "ppppp" is "%05d" of process pid. "TTTT" are chars in
	    range A thru Z, and are derived from log open time system time-
	    stamp as lowest 4 of base26 "digits" (0 = "A", 25 = "Z").
	    Now doing "egrep ^pppppTTTT smtpserver.log" should pick only
	    the interesting session...

1999-06-29  Matti Aarnio  <mea@zmailer.org>

	* router/dateparse.c:
	     Fixes for Y2K-correct date parsing; although this
	     is dead code whose result is ignored, it still
	     apparently gets called...  Thanks Ken!

	* TODO:
	    Found major pain (problem, if you will) in the
	    LDAP interface code for the router.  It does server
	    connection and DB bind for *every* query :-(
	
	* transports/smtp/smtp.c:
	    Arkadiusz Mi?kiewicz <misiek@pld.org.pl> reported
	    compilation and operation problems in his IPv6
	    environment.  Turns out a  getnameinfo()  request
	    block parametrization bug prevented 'IPv6 AAAA only'
	    hosts from even being *found* for the data lookup.

	* configure.in, config.h.in, acconfig.h, libc.h:
	    Autoconfigure compilation sense of  'socklen_t' for
	    possible use of --with-ipv6-replacement-libc and then
	    smtp.c in mode where  getnameinfo() routine can be
	    debugged...

	* scheduler/threads.c, scheduler/transports.c:
	    Kludgeish "cure" to ``OF=0, HA=lots..'' problem.
	    If the HA exceeds now fixed value (3600 sec), the
	    system does client shutdown, and then recovers.

	* lib/rfc822scan.c:
	    Patch from <zack@bitmover.com> for RFC822 comment
	    nesting.  In the end result the comments disappear
	    entirely (not so great) but now properly nested
	    comments are not flagged as an error!

1999-06-27  Matti Aarnio  <mea@zmailer.org>

	* smtpserver/policytest.c, smtpserver/smtpcmds.c,
	  proto/db/smtp-policy.src, utils/policy-builder.sh.in:
	    Tried to use delayed "rcpt-dns-rbl + test-rcpt-dns-rbl +"
	    policy attributes, and noticed that things didn't work
	    quite the way I had planned  .  Ah well, some testing,
	    and patching, and now it works...   Noticed also that
	    the report out of the machinery used wrong variable in
	    the  RCPT TO report code.

1999-06-26  Matti Aarnio  <mea@zmailer.org>

	* configure.in, ChangeLog, compat/rmail/Makefile.in,
	  compat/rmail/rmail.c, compat/sendmail/Makefile.in,
	  compat/sendmail/sendmail.c, include/listutils.h,
	  include/mailer.h, include/malloc.h, include/zmalloc.h,
	  lib/Makefile.in, lib/splay.c, lib/symbol.c, libc/Makefile.in,
	  libc/mail_alloc.c, libident/Makefile.in, libmalloc/maltrace.c,
	  libmalloc/simumalloc.c, libmalloc/testmalloc.c,
	  libmalloc/teststomp.c, libsh/Makefile.in, libsh/expand.c,
	  libsh/shconfig.h, libsh/trap.c, router/Makefile.in,
	  scheduler/Makefile.in, scheduler/mailq.c, scheduler/scheduler.h,
	  smtpserver/Makefile.in, smtpserver/mxverify.c,
	  smtpserver/smtpserver.h, transports/errormail/Makefile.in,
	  transports/errormail/errormail.c, transports/expirer/Makefile.in,
	  transports/expirer/expirer.c, transports/fuzzyalias/Makefile.in,
	  transports/fuzzyalias/fuzzyalias.c, transports/hold/Makefile.in,
	  transports/hold/hold.c, transports/libta/Makefile.in,
	  transports/libta/ctlopen.c, transports/libta/diagnostic.c,
	  transports/libta/dnsgetrr.c, transports/libta/mimeheaders.c,
	  transports/libta/routermxes.c, transports/libta/tasyslog.c,
	  transports/libta/writeheaders.c, transports/mailbox/Makefile.in,
	  transports/mailbox/mailbox.c, transports/mailbox/mboxpath.c,
	  transports/sm/Makefile.in, transports/sm/sm.c,
	  transports/smtp/Makefile.in, transports/smtp/smtp.c,
	  utils/makedb/Makefile.in, utils/vacation/Makefile.in,
	  utils/vacation/vacation.c:
	    Arkadiusz Mi?kiewicz <misiek@pld.org.pl> reported
	    compilation problems in his environment.
	    - About all Makefile.in template files did need changes
	      so that ZMailer's own include paths preceed ALL other
	    - Changed all include instances of "malloc.h" to "zmalloc.h",
	      although that probably is unnecessary... (and renamed
	      the file, although CVS will show deletion and adding..)
	    - Manage to autodetect OpenSSL shared objects, although does
	      not do full blown shared-library runtime load path define,
	      as that detail tends to vary from system to system :-(
	
1999-06-25  Matti Aarnio  <mea@zmailer.org>

	* transports/mailbox/mailbox.c, configure.in, acconfig.h:
	    configure time option "--with-mboxquotacheck"

1999-06-24  Matti Aarnio  <mea@zmailer.org>

	* transports/smtp/smtp.c:
	    More of "mailq -Q | grep OF=0" tracking.
	    Also several cases of eradicting extra  fflush() calls.

	* smtpserver/smtpdata.c:
	    Do "TRANSLATION" facility with PARANOID mode; and some
	    Asperin, or equivalent to Eugene Crosser...

1999-06-23  Matti Aarnio  <mea@zmailer.org>

	* transports/libta/mimeheaders.c:
	    Do downgrade to QUOTED-PRINTABLE in all cases where it is
	    needed.  Convert to C-T-E: 7BIT and/or C-T: ... ;charset=US-ASCII
	    only when the message is TEXT/PLAIN type.

	* transports/smtp/smtp.c:
	    Change the way how timeouts are handled for the  connect();
	    now does connect() in NON-BLOCKING mode, and uses select()
	    to see when the connection has completed, or timeout occurs.
	
1999-06-22  Matti Aarnio  <mea@zmailer.org>

	* transports/sm/sm.c:
	    Reworked the 'm'ultiple recipients processing. The previous
	    patch looped in place and kept allocation more and more memory.
	    Outch..

1999-06-18  Matti Aarnio  <mea@zmailer.org>

	* transports/sm/sm.c:
	    Internal users reported that somewhen since 2.99.50s5 the
	    'm'ultiple recipients mode has been broken.  A likely fix
	    is supplied.  (I haven't had change to test this.)

1999-06-16  Matti Aarnio  <mea@zmailer.org>

	* smtpserver/policytest.c:
	    More from Eugene Crosser; process %-hack also for those
	    domains we are a relay-target for...
	
	* router/libdb/ndbm.c, router/libdb/ldap.c, router/libdb/dbm.c:
	    Eugene Crosser spotted that I had forgotten to change
	    some close_*() parameters to match new prototypes, which
	    I introduced while debugging BSD DB 2.something at Linux
	    Alpha RedHat 6.0 system.  Eugene sent patches for ndbm.c,
	    and ldap.c.

	* configure.in, smtpserver/Makefile.in, utils/makedb/Makefile.in,
	  utils/vacation/Makefile.in:
	    Introduce new '@LIBLOCALDBMS@' substitution which does not
	    include possible LDAP for applications which *don't* use
	    LDAP in themselves.  (Eugene Crosser report about missing
	    @LIBSOCKET@ substitution because of ldap things at makedb..)

1999-06-14  Matti Aarnio  <mea@zmailer.org>

	* scheduler/transport.c:
	    To sub-process (Transport Agent) pass environment variables:
	       TZ, PATH, ZCONFIG
	    I had thought that syslogd does timestamp formulation, but no...
	    It is within the  syslog()  library routine where that happens!
	    Thus our childs will need at least TZ (SysV-like systems) to know
	    what the local timezone is :-/

	* transports/smtp/smtp.c:
	    Treat "No MX, no A" as a serious error worth discarding the
	    recipient address.

1999-06-13  Matti Aarnio  <mea@zmailer.org>

	* router/libdb/bsdbtree.c (and others during debug):
	    Spotted strange leakage of 'file' objects in the Linux
	    kernel.  Turns out that the BSD DB 2.x at Linux/Alpha
	    glibc-2.1.1 leaks one mmap() page at every db open.
	    Turns out also that every  search_btree()  which
	    misses, did a retry *after* close_btree() call.
	    As a result, routing did need terrible things.
	    Now won't do that db-reopen at search miss with
	    bsd-btree and bsd-hash codes.

	* scheduler/scheduler.h, scheduler/transport.c:
	    Spotted a case of 'very long' "host" information, which
	    naturally crashed the scheduler when scribling over fixed
	    buffer in the stack.  Now using malloc()ed buffers, which
	    are grown in case a need arises.
	

1999-06-12  Matti Aarnio  <mea@zmailer.org>

	* libsh/interpret.c, router/functions.c, router/rfc822.c,
	  router/libdb/bind.c:
	    Code massage to silence the egcs-1.1.2 about "possibly unset
	    variable" -- if there is any code flow before variables are
	    set, then it doesn't know, what has happened.

	* scheduler/readconfig.c, scheduler/scheduler.c:
	    Removed/moved unused variable.

	* transports/smtp/smtp.c:
	    Sigh.. "warning: variable `channel' might be clobbered
	    by `longjmp' or `vfork'"

	* utils/vacation/Makefile.in:
	    [ -l somepath ] is NOT known function, it is:  [ -h somepath ]

1999-06-10  Matti Aarnio  <mea@zmailer.org>

	* README.UPGRADING:
	    Explicitely list all standard commands for different
	    database regenerations.

	* contrib/zmailstats:
	    RE change in the main syslog pattern rule to handle the
	    timestamp format at the beginning of the syslog line.

	* libsh/interpret.c:
	    Tracked memory leakage in case the script did following:
	       ssift "$somevar" in
	         (.*)@(.*)  return "$somevar" ;;
	       tfiss

	* router/functions.c:
	    "stableprocess" routine used wrong argv[] element to
	    pass along to the real "process" script.

	* router/rtsyslog.c:
	    A bit more of compiler pleasing; smaller stack frame
	    when the 8000 byte buffer isn't off the stack..

	* smtpserver/policytest.c:
	    Silenced compiler about storing into constant variable.

1999-06-07  Matti Aarnio  <mea@zmailer.org>

	* lib/selfmatch.c:
	    Revoke the change I did while tinkering with
	    autodetecting <foo@[1.2.3.4]> address being
	    our local one..

	* utils/vacation/Makefile.in:
	    "test -e ..." is perhaps POSIX thing, but not at
	    Solaris /bin/sh :-/

	* router/rfc822.c:
	    A case of NULL pointer referral in form which I hadn't
	    encountered before...  (fqalias.ldap induced case)

	* Makefile.in:
	    'make dist' should dump also symlinks! Boo!

	* ChangeLog, configure.in, acconfig.h, router/libdb/bsdbtree.c,
	  router/libdb/bsdhash.c, smtpserver/policytest.c,
	  utils/makedb/makedb.c, utils/makedb/dblook.c, README.UPGRADING,
	  utils/vacation/vacation.c:
	    BSD DB 2.* interface had subtle difference; KEY and DATA
	    "DBT"s must be  memset(&key,0,sizeof(key))  to avoid nasty
	    surprises...  Wow, that API is -- versatile ...
	
	* router/libdb/bsdhash.c:
	    Fix of old BSD DB 1.85 type behaviour.

1999-06-06  Matti Aarnio  <mea@zmailer.org>

	* Makefile.in, ChangeLog:
	    Version 2.99.50-s19

	* ChangeLog, utils/vacation/Makefile.in, compat/rmail/Makefile.in,
	  compat/sendmail/Makefile.in, doc/guides/openssl:
	    At places 'make install-bin' complained, review/fixup of some
	    Makefile.in:s.  OpenSSL referral document finetuning.

	* ChangeLog, configure.in, acconfig.h, router/libdb/bsdbtree.c,
	  router/libdb/bsdhash.c, smtpserver/policytest.c,
	  utils/makedb/makedb.c, utils/makedb/dblook.c, README.UPGRADING,
	  utils/vacation/vacation.c:
	    Autoconfigure BSD DB 2.* usage into ZMailer.
	    The resulting databases are BINARY INCOMPATIBLE, and thus
	    must be recompiled when upgrading!

	* ChangeLog, configure.in, router/Makefile.in, smtpserver/Makefile.in,
	  router/libdb/Makefile.in, utils/makedb/Makefile.in,
	  utils/vacation/Makefile.in:
	    Two overriders:
	      --with-generic-include="-I/path1 -I/path2 .."
	      --with-generic-library="-L/path1 -L/path2 .."

1999-06-03  Matti Aarnio  <mea@zmailer.org>

	* smtpserver/policytest.c:
	    - Ignore possible 'relaycustomer +' attribute
	    - Autodetect locally active IP interfaces so
	      that a recipient address of  <foo@[1.2.3.4]>  will
	      be successfully matched without having that entry
	      in the  smtp-policy.mx  file..
	    - Do <bar%foo.fi%mea.tmt.tele.fi@[127.0.0.1]> processing
	      fully, and detect that  "foo.fi"  is not acceptable
	      target domain...  (For RCPT TO, that is..)
	    - Some level of '!' path processing implemented..

	* include/libsh.h, libsh/builtins.c, libsh/expand.c,
	  libsh/interpret.c:
	    - Noticed that 'case' statements use  squish()  function,
	      which has its glob-character matching effectively
	      disabled if 'set -f' mode is active, thus 'case' breaks..
	    - Reworked quite a bit on how the expand() handles input
	      conscell chain contained strings, and splits them into
	      white-space (per IFS) separated sequences.  Now the
	      'toplevels' variable in the standard router scripts
	      does not split into lots of *huge* strings of which
	      only the initial few chars are used, and then rest
	      are 'truncated' by means of resetting the 'slen' field;
	      no, now only the initial segment of the string is treated
	      that way (no need to copy it), but all of the subsequent
	      ones are copied over into their separate size matched
	      strings.

	* utils/policy-builder.sh.in:
	    Change a bit comments regarding 'smtp-policy.relay' file
	    content treatment!

1999-06-01  Matti Aarnio  <mea@zmailer.org>

	* scheduler/Makefile.in:
	    Remove  @GETPWLIB@  from scheduler program linkage set.
	    Users used by the scheduler are *only* those in the local
	    system  getpwnam()  yields!

1999-05-30  Matti Aarnio  <mea@zmailer.org>

	* configure.in:
	    Store into '#define CONFIGURE_CMD' also CC and CFLAGS
	    used at the compilation.

	* libsh/expand.c + include/listutils.h, libsh/builtins.c,
	  libsh/interpret.c, libsh/listmalloc.c, libsh/listtrees.c,
	  libsh/variables.c, router/db.c, router/functions.c,
	  router/shliaise.c:
	    After much wondering about profiles (-pg), realized that
	    about 20% of total runtime is spent in fairly complicated
	    recursive list object copying, while the default case of it
	    is a linear list, which should be really simple...  Also,
	    there is absolutely *no* reason to copy CAR() branch in
	    most cases!  In fact we seem NEVER have need for full TREE
	    copying, just current CDR chain!

	    This turned up to supply router speedup of about factor 1.14
	    with vger.rutgers.edu's workloads. (about 12 %)

	    expand(), and its subroutines, are still consuming about
	    16.8% of the total runtime. (860 recipient addresses in the
	    test set, with crossbar() total of 1737 $(router ..) calls,
	    228k calls of expand() -- after all, one for each function
	    call within the script.)  Out of that, perhaps about 7% of
	    the total runtime is amendable to changes without changeing
	    overall system semantics radically...
	    ... for that matter, perhaps for security point of view it
	    could be better to explicitely execute calls that invoke
	    subroutine IO redirection, and shell glob expansion..  With
	    that, the shell script language could be turned into more
	    secure one, and perhaps this 16% could be eliminated entirely ?

	    A historical note from about 1994 shows that router speed for
	    a reasonable test run was about 120 k messages per 24h, or
	    1.39 recipients per second at a SparcStation-10/50.  Syslog
	    monitoring and load factor estimating  at vger.rutgers.edu
	    with (on average) 50 recipient messages seems to indicate
	    a speed of about 15-20 recipients per second at similar
	    hardware, although 1) compiler has evolved, 2) workload is
	    different, 3) router internal machinery has had *radical*
	    changes.

	* include/ta.h, include/libz.h, lib/taspoolid.c, router/prototypes.h,
	  router/rfc822.c, router/rtsyslog.c, scheduler/scheduler.h,
	  scheduler/scheduler.c, scheduler/mailq.c, scheduler/update.c,
	  scheduler/msgerror.c, scheduler/threads.c, smtpserver/smtpdata.c,
	  transports/errormail/errormail.c, transports/libta/tasyslog.c,
	  transports/fuzzyalias/fuzzyalias.c, transports/libta/ctlopen.c,
	  transports/mailbox/mailbox.c:
	    A cascade of changes from wanting to change the basis of
	    taspoolid() generated string..  Now it is parsable back to
	    inode number and input file mtime -- even readable online,
	    although obfuscated...

	    Also renamed lots of variables in the scheduler from  'ctime'
	    to 'mtime', as their function has been for the last few years...

	* transports/smtp/smtp.c:
	    Cleanup slightly the error report when no MXes are found,
	    *nor* address, and yield INSTANT error.

	* libsh/interpret.c:
	    fixing indentation, it seems...

	* proto/db/smtp-policy.src:
	    Per default, don't block even "private internet" networks.

1999-05-28  Matti Aarnio  <mea@zmailer.org>

	* libsh/expand.c:
	    Remove  dupnstr() + freestr() calls by changeing code
	    slightly..  (Circa 5% of runtime in that junk..
	    For that matter, about 13% of runtime is s_copy_tree()
	    calls by that same expand() function... Better to
	    rewrite it alltogether.)

	* libsh/interpret.c:
	    Removed unnecessary strsave() calls from within debugging.

	* router/router.c:
	    With received SIGEXIT/SIGTERM, DON'T die(); this is about
	    getting the profiling data out...

1999-05-27  Matti Aarnio  <mea@zmailer.org>

	* smtpserver/smtpserver.h, smtpserver/policytest.c,
	  smtpserver/policytest.h, proto/cf/canon.cf:
	    - Implemented "simple" '%'-hack test (also '!'-hack)
	    - Implemented 'message "text string"' attribute handling
	    - Canon code ignores '\!' pair in address, however that
	      actually breaks UUCP bang-path processing slightly:
		broken\!case!is!like@this
		working!case\!is!like@this
	      (It is about difficulties of writing an RE for finding
	       the left-most non-quoted bang ...)

	* libsh/tregexp.c, libsh/interpret.c:
	    A bit less copying around, and way smaller initial malloc
	    to avoid need for big memory blocks, which don't seem to be
	    available for later reuse -- memory fragments, you see..
	    (At least I think so..)

	* configure.in:
	    Improve a bit of the testing of  <db_185.h> vs. <db.h>,
	    and  -ldb1  vs.  -ldb  -- perhaps this is glibc 2.1 systems
	    thing only, perhaps this is more common, don't know..

	* utils/vacation/Makefile.in:
	    When installing under a prefix, create  $(prefix)$(VACATIONDIR)
	    in case it doesn't exist before storing anything into it.
	    Also corrected the installed symlink a bit.

	* transports/smtp/smtp.c:
	    One semi-obscure bug in pipelining related smtp_sync() code
	    yielding false positive delivery report, if the remote did
	    support CHUNKING, and the message was sufficiently small,
	    and the remote closed session before replying to MAIL/RCPT*/BDAT
	    sequence completely...
	    ( read: "small" = under 64 kB, which means almoast all emails ... )

1999-05-26  Matti Aarnio  <mea@zmailer.org>

	* scheduler/readconfig.c, scheduler/transport.c:
	    Reworked the handling of   command="..."  tags in the
	    scheduler.conf  file.  Now it handles properly the initial
	    literal environment variable settings.

	* smtpserver/smtpserver.c, scheduler/scheduler.c,
	  include/libz.h, lib/killprev.c:
	    Remove the PIDFILE when the server goes away.
	    (This isn't perfect method, but let it be..)

	* router/functions.c:
	    Created router function:  stableprocess <filename>
	    which is a wrapper on process.cf defined process() with
	    cleanup of gensym generated symbols. (Work In Progress;
	    part of my ideas to completely rework router queue...)

	* router/db.c:
	    Modify cache definitions -- zero them at the local db's

	* router/rfc822.c, transports/libta/ctlopen.c:
	    Apeace Solaris 2.6 / gcc 2.7.2.3 "-O2 -Wall" compilation

	* proto/smtpserver.conf.in:
	    Cleanup (a bit) the default settings

1999-05-25  Matti Aarnio  <mea@zmailer.org>

	* smtpserver/smtpauth.c:
	    Don't log incoming BASE64-encoded passwords.

1999-05-17  Matti Aarnio  <mea@zmailer.org>

	* smtpserver/smtpdata.c:
	    Be a bit sloppy with DATA statement which follows
	    with white-space.. (or whatnot..)  On the other
	    hand, if "-s strict" mode is on, complain!

1999-05-16  Matti Aarnio  <mea@zmailer.org>

	* transports/mailbox/mailbox.c:
	    Add '-U' option for selectively turning on the 'X-UIDL:'
	    creation while storing to mailboxes and files (but it
	    won't be created while sending to a pipe).

	* libsh/listmalloc.c:
	    Some ANSI-C present, which the K&R compiler at SunOS 4.1.4
	    didn't like at all..

1999-05-15  Matti Aarnio  <mea@zmailer.org>

	* README.CRYPTO, bin/usa-itar-stripper.sh, Makefile.in,
	  smtpserver/smtpauth.c, smtpserver/smtpcmds.c,
	  smtpserver/smtpserver.c, smtpserver/smtpserver.h,
	  smtpserver/smtptls.c:
	    Modifications and tools to allow package management
	    to be done with command:  'make dist-usa'
	    The resulting TAR file should be US ITAR compliant.

	* include/listutils.h:
	    K&R compiler reminder; all the world isn't ANSI...

	* transports/mailbox/mailbox.c:
	    Don't generate X-UIDL: header when sending the message
	    thru a pipe...

	* transports/smtp/smtp.c:
	    Hunting the reason for SEGV in case ALRM triggers in
	    a few odd situations.

	* scheduler/transport.c:
	    If the command= line for some channel/host selector
	    tag contains $-expression for ZENV variable, and that
	    variable does not exist, the scheduler did crash..
	
1999-05-14  Matti Aarnio  <mea@zmailer.org>

	* VERSION 2.99.50s18

	* smtpserver/smtpdata.c:
	    BASE64 encoding of 7 chars long name yields a BASE64 string
	    with two '=' chars, that was considered bad by the decoder..
	    ( I think there should be only one '=' char, but Netscape
	      Communicator 4.51 does it that way :-(  )

	* router/functions.c:
	    Old (very old!) 'old-vs-new' scheduler locking scheme
	    causes problem at Solaris 2.6. Peter IP (Toronto) got
	    ZMailer router process pids 6/7/8/9, which the router
	    treated somewhat poorly..

	* configure.in:
	    Autosense OpenSSL at default location, if not otherwise defines.

1999-05-13  Matti Aarnio  <mea@zmailer.org>

	* router/router.c:
	    Move  openlog()  a couple lines down so that also interactive
	    routers will use it.

	* router/rfc822.c:
	    Change the Received: header 'id' information to be the same
	    which syslog() uses, and which is reported at the smtpserver.
	    Eases looking for message spoolids at syslog outputs.

	* transports/smtp/smtp.c:
	    Overhauled error processing in various situations, now an
	    EX_TEMPFAIL condition will use next MX server (if one is
	    available) very much independent of where along the code
	    the problem occurred.   Originally a problem in e.g. connection
	    setup until EHLO/HELO probe was retryable to an MX, but now
	    a much later problem phase (DATA + . yielding 4** code,
	    for example) can do the same.
	
	    Later continued the theme with logging of the smtp client session
	    to one client with weird looking problem:  Ah, finally some clue
	    on the PIPELINING problem; smtp_sync() ignored (or treated poorly)
	    certain way how EXIM responds when it has disk full.  We missed
	    the initial MAIL FROM-> 4** code, and errored with the later
	    "503 No sender yet given"... D'uh..  (Likely this was entirely
	    ZMailer problem, but was it only introduced yesterday, or has it
	    been lurking there all along with PIPELING, and never spotted
	    before ??)  It manifested as never accumulating queue to sites
	    using PIPELINING, and behaving like above..

	* smtpserver/smtpserver.h, smtpserver/cfgread.c,
	  smtpserver/smtpserver.c, smtpserver/smtptls.c,
	  smtpserver/smtpsmds.c, proto/smtpserver.conf.in:
	    Much work again, now to parametrize ways of selectively adding
	    pieces of "Received:" header contained commentary information.
	    Features: ident, whoson, auth-username, tls-cipher, tls-client-cert
	    Added also:  "PARAM AUTH-LOGIN-also-without-TLS" which allows
	    paintext "AUTH LOGIN" to be used without successfull STARTTLS.

1999-05-12  Matti Aarnio  <mea@zmailer.org>

	* smtpserver/smtpserver.c:
	    Fix introduced accidental NULL referral.

	* SiteConfig.in:
	    Partially undo previous change to SiteConfig.in;
	    let the  FORCEPUNT  to be there...

	* scheduler/scheduler.c, scheduler/update.c:
	    Fixed the 'stored recipient count' gauge leakage.

1999-05-10  Matti Aarnio  <mea@zmailer.org>

	DISTRIBUTION: version 2.99.50s17

	* SiteConfig.in, proto/cf/rrouter.cf:
	    Moved "SMARTHOST" into historical bit-bucket.
	    Suggested way is to use "dot-route" to default
	    all non-local traffic to some server.

	* smtpserver/smtpauth.c:
	    The "ok" reply was wrong (253), and M$ clients
	    barfed at the login. Change that to 235 and it
	    works just fine.

	* proto/smtpserver.conf.in, doc/guides/openssl,
	  smtpserver/cfgread.c, smtpserver/smtpserver.h,
	  smtpserver/smtpserver.c, smtpserver/smtptls.c,
	  smtpserver/smtpcmds.c:
	    Interoperability testing dig various weird things.
	    Now I know lots of details about the certificates :)
	    For the juicy bits about server certificates, see
	    file: doc/guides/openssl

1999-05-09  Matti Aarnio  <mea@zmailer.org>

	* Makefile.in:
	    Version 2.99.50s17

	* doc/guides/openssl, doc/guides/configure:
	    A bit of updates...

	* smtpserver/cfgread.c, smtpserver/smtpserver.h,
	  smtpserver/smtpserver.c, smtpserver/smtpcmds.c,
	  smtpserver/smtptls.c, proto/smtpserver.conf.in,
	  doc/guides/openssl:
	    Final hurdles at getting the TLSv1/SSLv[23]
	    support to work at the smtpserver.  Used lots
	    of POSTFIX specific code here, and wondered
	    at several document bugs...

	* here and there...:
	    Some minor things to silence "egcs -Wall -O3 -g"

	* configure.in, acconfig.h, smtpserver/Makefile.in,
	  smtpserver/smtpserver.h, smtpserver/smtpcmds.c,
	  smtpserver/smtpserver.c, smtpserver/smtptls.c:
	    Configuration options to take into use the OpenSSL
	    TLS code -- although this is not yet complete thing..

1999-05-08  Matti Aarnio  <mea@zmailer.org>

	* smtpserver/smtpserver.h, smtpserver/smtpserver.c,
	  smtpserver/smtpcmds.c:
	    Place-holder hooks for 'STARTTLS' related stuff...
	    (once I get the OpenSSL to work at my Alpha ..)

1999-05-07  Matti Aarnio  <mea@zmailer.org>

	* compat/sendmail/sendmail.c, include/mail.h.in,
	  smtpserver/smtpdata.c:
	    Define  _MAILPRIO_HIGH, and sense it in inputs, plus
	    sense "Precedence: high/normal/bulk/junk" to set the
	    mail_priority of  zmailer(3) library.

	* transports/mailbox/mailbox.c:
	    Implemented X-UIDL: header for POP3 UIDL command support;
	    may some day have option which disables creation of that
	    local storage string..
	    Also, did same thing as  sm.c below:

	* transports/sm/sm.c:
	    Cleaned up (a bit) certain  has_header()/delete_header()
	    processing so that all possible multiple instances of same
	    ``header to be deleted'' will be deleted.

1999-05-05  Matti Aarnio  <mea@zmailer.org>

	* smtpserver/fdstatfs.c:
	    A sidestep to a problem with  fstatvfs()  at glibc 2.1.1
	    at Linux/i386/2.1.122 kernel (any 2.2.* kernel, I guess.)

	* configure.in, smtpserver/Makefile.in:
	    Autoconfigure "-lcrypt" library for the use at  @GETPWLIB@
	    cases.  Also have '--with-privateauth' option for the smtpserver
	    in case some magic private things are desired (it is possible..)

	* smtpserver/smtpauth.c, smtpserver/zpwmatch.c, smtpserver/cfgread.c,
	  smtpserver/Makefile.in, man/smtpserver.8:
	    Separate  zpwmatch()  function into its own file.
	    Have 'PARAM smtp-auth' configuration parameter (and document it
	    at the smtpserver man-page) which enables use of SMTP AUTH.
	    The default system uses classical UNIX password analysis.
	    (but see the comments at   zpwmatch.c!)

1999-04-26  Matti Aarnio  <mea@zmailer.org>

	* Makefile.in:
	    Version 2.99.50-s16

	* proto/cf/fqdnaliases.cf:
	    Typo: Missing ending ']' at a '[' test clause.

	* smtpserver/policytest.c:
	    Policytest should accept everything when running in non-network
	    interactive mode.  (Ok, Syntax issues aside..)

	* smtpserver/smtprouter.c, smtpserver/cfgread.c,
	  smtpserver/smtpserver.h, smtpserver/smtpserver.c,
	  proto/smtpserver.conf.in:
	    Supply "PARAM enable-router" parameter to control the availability
	    of interactive router subsystem.  Also strengthened the way how
	    the user input is passed to the interactive router so that it
	    should not allow bad inputs to cause escape into shell at any
	    moment..  However this isn't the only place where the danger may
	    lurk, so per default the "enable-router" is OFF.

1999-04-25  Matti Aarnio  <mea@zmailer.org>

	* smtpserver/smtpcmds.c, smtpserver/smtpserver.c,smtpserver/smtpdata.c:
	    Change the 'multilinereplies' processing around "a bit".
	    Have sensible reports even when single-line mode is used.

	* proto/smtpserver.conf.in, man/smtpserver.8, smtpserver/cfgread.c,
	  smtpserver/smtpserver.h, smtpserver/smtpdata.c,
	  smtpserver/smtpserver.c, smtpserver/smtpauth.c,
	  smtpserver/Makefile.in, smtpserver/smtpcmds.c,
	  smtpserver/policytest.c, smtpserver/policytest.h:
	    Created base work for ESMTP "AUTH LOGIN ..." command
	    processing.  It does receive the input parameter, and
	    decodes the initial input, plus asks for the password,
	    plus decodes that, but then the final hurdle of checking
	    the password is not completed -- all the kwazillion ways
	    of doing it in different systems ...

	    THIS EXTENSION IS CURRENTLY NOT ENABLED IN THE SYSTEM!
	
	* router/rfc822.c:
	    Converted from symbol() to symbol_lookup_db() in place where
	    the data to be looked up is stored in specific spl set.

	* include/ta.h, scheduler/mailq.c, scheduler/msgerror.c,
	  scheduler/prototypes.h, scheduler/qprint.c, scheduler/scheduler.c,
	  scheduler/scheduler.h, transports/libta/ctlopen.c,
	  transports/libta/lockaddr.c:
	    I decided that there is no point in using 'long' to store offsets
	    to transport specification file -- if that file exceeds 2G in
	    32-bit systems we are in deep trouble anyway -- and there is no
	    point in trying to fit this animal into 16-bit machines... Could
	    squeeze around 16 bytes per recipient in the scheduler memory use.
	    (Consider having a million recipients in memory data...)

	* smtpserver/smtpserver.c, smtpserver/smtpserver.h,
	  smtpserver/cfgread.c, smtpserver/smtpcmds.c,
	  proto/smtpserver.conf.in:
	    "PARAM no-multiline-replies" which hides away all RFC-821
	    Appendix E described multiline replies, in case you have
	    no other way to fix your non-conformant clients...
	    The result is often rather jumbled as the last reported line
	    usually isn't very usefull..
	
	* include/mail.h.in, include/ta.h, transports/libta/ctlopen.c,
	  scheduler/scheduler.c:
	    Reserve some space into "r" entries of the TA files for
	    delay state reports.

	* scheduler/scheduler.c:
	    Don't unnecessarily unlink() ETRN requests twice..

1999-04-21  Matti Aarnio  <mea@zmailer.org>

	* ChangeLog:
	    Log these last changes..

	* include/listutils.h:
	    A surprising macro in FreeBSD/OpenBSD clashed with s_push() gcc
	    extended macro code contained variable name (_X), replaced with
	    another name (_tmpX), which hopefully doesn't clash...

	* scheduler/threads.c:
	    Change 'ulong' type to 'u_long', which should please also
	    FreeBSD and OpenBSD..

	* configure.in:
	    Modify tests for <tcpd.h>, and resolver so that systems where
	    all headers are not idemponent will be able to do the test
	    compiles successfully, and thus avoiding false negatives..

	* smtpserver/mxverify.c:
	    Changed IPv6 RBL tests to use "x.x.x....x.x.ip6.rbl.maps.vix.com"
	    domain format.  Those small digits at the top of the address
	    range without "ip6" are clashing with various IPv4 "banned"
	    address spaces...

1999-04-14  Matti Aarnio  <mea@zmailer.org>

	* proto/cf/fqdnaliases.cf:
	    Create fqdnalias:
		foo@bar: foo@bar
	    resolve it..  Without this change, the router
	    will recurse infinitely and crash.  With this,
	    the router will break the loop, but the result
	    will still be stupid:
		smtp bar foo@bar ...

	* smtpserver/mxverify.c:
	    Fatal RBL lookup error -- caused effectively all
	    instances to try for IPv6 lookups which failed
	    consistently.

	* Makefile, Makefile.in:
	    Release 2.99.50s15 (to have a clean point)

1999-04-12  Matti Aarnio  <mea@zmailer.org>

	* include/listutils.h:
	    Small macro change to please gcc 2.7.2.1 at FreeBSD 3.1;
	    but perhaps it is due to some unfortunate #define overwriting
	    my macro contents somewhere else...  I am listening on
	    the reports of the issue.

1999-04-10  Matti Aarnio  <mea@zmailer.org>

	* smtpserver/policytest.h, smtpserver/policytest.c,
	  smtpserver/mxverify.c:
	    A surprise was found in pure IPv6 operational environment
	    regarding RBL policy testing.  Changed things to also do 
	    IPv6 address RBL lookups in case the connection was not by
	    IPv4-MAPPED addresses. (E.g. Lookup for A with zone in same
	    manner as IP6.INT reversers construct it from the address,
	    and then just add 'rbl.maps.vix.com' to the reverse address
	    string in similar manner as IPv4 lookup works.)
	    Of course I don't know what exact format the RBL will use
	    for IPv6 addresses, my quesses are:
b.3.b.7.5.7.e.f.f.f.8.f.0.0.2.0.0.0.e.f.2.0.0.0.0.1.6.2.e.f.f.3.rbl.maps.vix.com.
b.3.b.7.5.7.e.f.f.f.8.f.0.0.2.0.0.0.e.f.2.0.0.0.0.1.6.2.e.f.f.3.ip6.rbl.maps.vix.com.
	    and the implemented thing is the first one of these.
	    The address in question is following:
	mea.ipv6.tmt.tele.fi IN AAAA 3ffe:2610:2:fe00:200:f8ff:fe75:7b3b

	* transports/mailbox/mailbox.c:
	    Another way how  getpwnam()  surprised -- errno value
	    isn't all zero in Linux with glibc 2.1 in all conditions;
	    username contained multiple dots ("a.b.c") yielded errno
	    value ENOENT  :-O  (At OSF/1 EINVAL can be had for valid
	    lookup without found entry...)  Sigh.

	* include/shmmib.h, scheduler/scheduler.c, scheduler/scheduler.h,
	  scheduler/threads.c, scheduler/update.c:
	    Modified monitoring MIB set a bit for the uses of the
	    scheduler.  Made a line in "mailq -Q" to show Counter32,
	    and Gauge32 type variables.  (On the way towards the
	    SNMP MIB..)

1999-04-06  Matti Aarnio  <mea@zmailer.org>

	* libsh/builtins.c:
	    $(elements ...) tinkering; code "cleanup".  (This wasn't the
	    real problem..)

	* include/listutils.h:
	    Test of ``LISTness'' vs. ``STRINGness'' became a bit confused
	    with ELEMENT flag set.  Mask that off when comparing.
	    (THIS was the problem that plagued $(elements ...) )

	* libsh/execute.c:  Just small cleanup.

	* libsh/expand.c:
	    glob() expansion list construction straightening.  Pre-Sort
	    items in reverse, and the list construction will be easy..

	* libsh/interpret.c: functype()
	    Remember always to set the return value variable -- if its
	    pointer is available, otherwise some things behave strangely
	    depening on what happens to be at the stack frame...
	    ( + removed some dead code from the  interpret()  proper.)

	* libsh/listtrees.c: _s_copy_tree()
	    Added a comment (for myself) to explain things a bit.

	* proto/cf/server.cf:
	    Some extra tinkerings for those who want interactive router
	    at their smtpserver.

	* smtpserver/policytest.c: _addrtest_()
	    Selectively test blanket allowance/denial things, so that
	    when  e.g. MAIL FROM:<foo@[1.2.3.4]> the literal IP address
	    can be looked up from the RBL/DUL/whatnot database while
	    not allowing e.g. MAIL FROM to suddently allow input from
	    any possible host just because once a suitable address is
	    given in MAIL FROM data...

	* smtpserver/smtpchild.c:
	    Count the number of childs properly, and always remember to
	    return a value thru the  childcntp  pointer.
	
1999-04-03  Matti Aarnio  <mea@zmailer.org>

	* Makefile.in: 2.99.50-s14

	* proto/cf/aliases.cf:
	    Fixed a typo, which doesn't affect most people at all..

	* scheduler/transport.c:
	    Allow the  command="..."  to define at first some environment
	    variables, before starting the program.  Syntax something like:
	    command="VAR1=value1 VAR2=value2 command -params"
	    No white-space is placeable into the values, all expansions that
	    work for the command parameters will also work at values.

	* transports/mailbox/mailbox.c:
	    A strange DEC Tru64 (a.k.a. DEC OSF/1 a.k.a DEC UNIX) feature
	    in  getpwnam(),  which seems to return errno==EINVAL, when no
	    entry is found at /etc/passwd -- getpwnam() return value is
	    NULL, of course.

	* router/db.c:
	    Changed the way how  D_db ("trace db") works; shows the query-
	    in-progress proceeding.


	* router/router.c:
	    Turn stdout/stderr buffering from NON-BUF to LINE-BUF mode.

	* proto/db/smtp-policy.src:
	    Removed "relaycustomer +" from the  "_full_rights" set.

	* man/Makefile.in, man/smtpserver.8, proto/smtpserver.conf.in,
	  smtpserver/cfgread.c, smtpserver/smtpchilc.c, smtpserver/smtpcmds.c,
	  smtpserver/smtpserver.c, smtpserver/smtpserver.h:
	    - added new PARAMs to disable selected facilities
	    - added new PARAMS to tune a few other facilities
	    - allows limiting the number of parallel smtpserver processes
	    - updated smtpserver.conf.in sample file
	    - updated man-page

	* Makefile.in: 2.99.50-s13

	* include/listutils.h, libsh/builtins.c, libsh/execute.c, libsh/sh.h,
	  libsh/expand.c, libsh/interpret.c, libsh/listmalloc.c, libsh/trap.c,
	  libsh/listtrees.c, libsh/listutils.c, libsh/tregexp.c, libsh/zmsh.c,
	  libsh/variables.c, router/db.c, router/functions.c, router/rfc822.c,
	  router/router.c, router/router.c, router/shliaise.c, include/libsh.h,
	  router/libdb/bind.c, router/libdb/bsdbtree.c, router/libdb/bsdhash.c,
	  router/libdb/dbm.c, router/libdb/gdbm.c, router/libdb/header.c,
	  router/libdb/hostsfile.c, router/libdb/incore.c, router/libdb/ldap.c,
	  router/libdb/ndbm.c, router/libdb/ordered.c, router/libdb/yp.c,
	  router/libdb/unordered.c:
	    A MASSIVE rewrite of internal conscell processing facilities.

	* smtpserver/cfgread.c, smtpserver/smtpserver.c:
	    Accept PARAM keywords even if they are preceded with some
	    white-space at the beginning of the line.

	* router/rfc822.c:
	    Modify privilege data verification; accept also negative values.

	* transports/libta/tasyslog.c, utils/listexpand.c,
	  smtpserver/smtpserver.h:
	    Minor things to apeact some compilation environments

	* compat/sendmail/sendmail.c, configure.in:
	    Use  mkstemp()  function, if it is available

	* smtpserver/smtpserver.c:
	    Utter strictness in local mode is not so good..
	    Turn the strictness selectively off in local mode.

	* Makefile.in:
	    Incremented version number

	* proto/cf/server.cf:
	    Accept "MAIL FROM:<>" from the client.

	* INSTALL:
	    Added a note about UUCICO/uucp uids, and 'zmailer'-group

	* transports/mailbox/mailbox.c:
	    Moved "running as root test down a bit, changed slightly
	    some debug related diagnostic messages.

	* transports/libra/diagnostic.c:
	    If scheduler diagnostics are suppressed, suppress also
	    syslog messages.

	* transports/libta/tasyslog.c:
	    Allow a bit longer diagnostic string to be sent...

	* */Makefile.in, */*/Makefile.in:
	    Change 'libz.a' to 'libzm.a' -- until somebody uses thus named
	    library in some other system, and we can't sidestep it...

	* smtpserver/policytest.c, smtpserver/smtprouter.c:
	    Fix debug related buffer overflow in policytest.c (debug messages
	    scribled over memory -- no user data at the writeout) add a bit
	    more debug things into the  smtprouter.c so that we can see what
	    is sent to the router process.

	* smtpserver/policytest.c, smtpserver/policytest.h,
	  smtpserver/mxverify.c, proto/db/smtp-policy.src:
	    Updated commentary documents a bit at  smtp-policy.src  file.
	    Made policytest stuff to use arbitary size strings as options,
	    and pass such to  rbl_dns_test()  function as a colon-separated
	    list of domain suffixes for where to query for RBL-like data.

	* transports/mailbox/mailbox.c:
	    Hunting an ellusive problem reporting [exit status 0] and
	    not knowing which branch of the thing it really is from.
	    Also matched UTIME/UTIMES test order with other instances
	    in the same code.

	* transports/sm/sm.c, transports/smtp/smtp.c,
	  utils/pop-proxy/pop-proxy.c, scheduler/scheduler.c:
	    Moving arount the  setvbuf()  calls a bit, probably mostly
	    safe without this, but better be absolutely sure..

	* libc/md5c.c:
	    Cleanup of 32- vs. 64-bit platform portability issues.

	* transports/libta/mimeheaders.c, transports/mailbox/mailbox.c,
	  transports/smtp/smtp.c, transports/sm/sm.c, include/ta.h:
	    A bug in how 8-bit containing body was downgraded to
	    Quoted-Printable when the message in question was in
	    fact NOT TEXT/PLAIN !  Aargh!.. (MULTIPART/ZZZ things..)

	* transports/smtp/smtp.c:
	    A Q-P encoding change from Arnt Hulbrandsen

	* transports/mailbox/mailbox.c, router/rfc822.c, lib/selfaddrs.c:
	    Adaptation to match some glibc 2.1 beta compability issues.

	* proto/cf/crossbar.cf
	* utils/listexpand.c
	    Modernization work

	* proto/smtpserver.conf.in
	    Per default turn off 'DEBUG' command

	* contrib/whoson-protocol.txt
	    Protocol document (draft)

	* INSTALL:
	    Added a word about  scheduler.conf  file.

	* doc/guides/smtp-etrn, doc/guides/offline-operation
	    Generalized guide on ETRN usage with ZMailer,
	    and one special case..

1998-11-19  Matti Aarnio  <mea@zmailer.org>

	* Makefile.in:
	    Upped version number into  2.99.50-s11

	* utils/vacation/vacation.c:
	    Fixes for DB(M) handling in the utility, also automated
	    the installation procedure into userspace a bit.

	* configure.in, router/libdb/bsdbtree.c:
	    A bit of experimenting with BSD DB 2.*, which apparently
	    needs major rework to operate properly.  Using <db_185.h>
	    if it is available in place of <db.h>..

	* libc/strsignal.c:
	    FreeBSD 3.0 portability problem fix

	* transports/smtp/smtp.c:
	    - reworked on how much of the message has been transported
	      over the connection at the time of the timeout/whatever
	      failure in the DATA-phase.
	    - report MX-lookups at 'ps' too
	    - setjmp() nesting fixes

	* configure.in, proto/newdb.in proto/Makefile.in:
	    - Autoconfigure the path of 'true' into newdb script
	    - FreeBSD reported problems about shell variable substitution
	      during the install phase

	* smtpserver/smtpdata.c, smtpserver/smtpserver.c,
	  smtpserver/smtpserver.h, smtpserver/smtpcmds.c:
	    - Extra-vigorous protocol syntax checking mode

	* smtpserver/policytest.c:
	    Policytesting failed with 'case 2' of the boilerplate config.

	* man/mailbox.8, transports/mailbox/mailbox.c:
	    - Automatic /bin/sh-less execve() for pipe subprograms
	      which falls back to /bin/sh-full in case some parts of
	      the input string prevent the use of the pure mode.
	      (like '>' and '$' characters in the cmdline.)
	    - pass our locally generated recipient-specific
	      environment into the  execve()  every time..
	    - updated man-page about the subprogram execution environment

	* smtpserver/cfgread.c, smtpserver/smtpserver.c,
	  smtpserver/smtpserver.h, proto/smtpserver.conf.in:
	    The example tells more (in smtpserver.conf)
		#
		# HDR220 metatags:
		#  %% -- '%' character
		#  %H -- SS->myhostname
		#  %I -- '+IDENT' if 'identflg' is set
		#  %V -- VersionNumb
		#  %T -- curtime string
		#  %X -- xlatelang parameter
		#
		PARAM hdr220 %H ZMailer ESMTP-server %V running at ...
		PARAM hdr220 %H (NO UCE)(NO UBE) local time is now %T
		#
	    Also did a bit of cleanup

	* SiteConfig.in:
	    Added a couple of previously undocumented ZENV variables,
	    which are used in the binary code in some places.

	* lib/nobody.c, lib/selfaddrs.c, lib/trusted.c:
	    Some  setreuid() code changes pulled back from way back.
	    SunOS 4.* didn't consider  "(uid_t)-1"  to be the same
	    as "-1" ...

	* smtpserver/smtpserver.c:
	    Missed the call of  settrusteduser()  in one codepath.

1998-10-10  Matti Aarnio  <mea@zmailer.org>

	* configure.in (and configure), utils/vacation/Makefile.in:
	    Autosense possible location of  'vacation'.  If none
	    is found, assume  "/usr/bin/".   At 'make install',
	    install a symlink at that user-space location to point
	    into MAILBIN/vacation.sh

	* utils/vacation/vacation.c:
	    Cleanup of database open/close routines after
	    seeing one case of CORE-dump at nic.funet.fi
	    when a new user took this vacation into use..

	* Makefile.in:
	    Version 2.99.50-s10

	* transports/mailbox/mailbox.c:
	    - Pass "TZ" environment variable to subprocess
	    - Lots of playing with 'sieve' interface

	* transports/smtp/smtp.c:
	    Allow address-literals of form  [addrlit]:portnum,
	    that is you can define explicite route of style:
		sometarget smtp![ip.addr.lit]:5678
	    which will then connect to given host and port.
	    The default port is 25.

	* proto/newdb.in:
	    "while true" does not work everywhere, use: "while /bin/true"

	* proto/cf/rrouter.cf:
	    Support for channel-group 'smtpgw*' with its own peculiar
	    rules.  Originally Sonera internal stuff.
	
	* configure.in (and configure):
	    "--with-privatembox" option added

	* packaging/solaris/*:
	    Solaris 'pkgadd' tools

	* scheduler/scheduler.c, scheduler/scheduler.h,
	  scheduler/threads.c, scheduler/transport.c,
	  scheduler/servauth.h, scheduler/servauth.c:
	    Two new files (servauth.[ch]), and changes elsewere
	    to support them.  Incomplete.

1998-08-14  Matti Aarnio  <mea@zmailer.org>

	* man/mailbox.8, doc/manual/zref-transport-agents.tex:
	    nroff formatting corrections, spelling fixes

	* man/router.8, router/router.c, router/rfc822.c,
	  router/prototypes.h, router/rfc822hdr.c:
	    Router got new commandline option: '-W'
	    Existence of that option activates OLD behaviour of
	    the router where it writes 'Illegal-Object:' headers
	    to the file... The new behaviour passes the faulty
	    lines unmodified; "as is".

	* utils/policy-builder.sh.in:
	    Modifications to handle non-clean spam-domain input better.

1998-08-09  Matti Aarnio  <mea@zmailer.org>

	* transports/smtp/smtp.c:
	    While reviewing new draft-ietf-drums-smtpupd-08.txt,
	    I found out that occasionally some SMTP servers do
	    reply just '250\r\n', which would confuse PIPELINING
	    mode codepaths, very least.  (Although with the
	    ENHANCEDSTATUSCODES that is an unlikely occurrence..)

1998-08-03  Matti Aarnio  <mea@zmailer.org>

	* include/malloc.h, include/zsyslog.h, libsh/builtins.c,
	  libsh/test.c, router/libdb/header.c, libsh/shconfig.h,
	  lib/strmatch.c, lib/pjwhash32.c, lib/selfaddrs.c,
	  libc/fullname.c, include/md5.h, libc/__fopen.c, libc/md5c.c,
	  libc/strtoul.c, libc/gai_strerror.c, libc/getaddrinfo.c,
	  smtpserver/smtpserver.h, smtpserver/smtpserver.c:
	    A burst of activity to fix compilation at SunOS 4.1.*
	    systems with the system's K&R compiler.  (Sigh what a
	    moron for a compiler...  Was the pre ANSI-C era really
	    that awfull ???)  (This is not complete work, more needs
	    to be done before it all goes thru..)

	* utils/policy-builder.sh.in:
	    Add use of '-A' (append) to the policy-building parameters.

	* proto/scheduler.conf.in:
	    Add some comments into the beginning concerning resource
	    usage limitation parameters:  maxta, maxchannel, maxring

	* include/zmsignal.h:
	    Change name of variables from  'sigmask' to 'sigmsk'.
	    SunOS 4.1.* defines 'sigmask' in its <sys/signal.h>
	    as a MACRO...

1998-07-30  Matti Aarnio  <mea@zmailer.org>

	* Makefile.in, compat/Makefile.in, compat/rmail/Makefile.in,
	  compat/sendmail/Makefile.in, proto/Makefile.in,
	  transports/Makefile.in, utils/Makefile.in, utils/makedb/Makefile.in,
	  utils/vacation/Makefile.in:
	    - Adding quite many "@" characters at critical places to
	      SILENCE the "make install" process so that people can
	      have it easier to SEE when something generates error
	      reports, or otherwise wants attention
	    - Those places which do rather unconditionally store new
	      files into $MAILSHARE/ datasets use following new rule:
		Don't overwrite existing files (scripts especially) if
		they ``cmp'' the same as our current file.  If they are
		different, move old to backup, and then write new one there

	* smtpserver/mxverify.c:
	    When compiling on SunOS 4 the T_TXT definition does not
	    exist in system includes, define it ourselves.

	* router/libdb/unordered.c: ("Matthias Urlichs" <smurf@noris.de>)
	    An error in open routine caused lookup always to fail
	    on the FIRST lookup.  Oops...

	* include/libsh.h:
	    Had ANSI prototype there, and a K&R compiler
	    "barfed"...

1998-07-28  Matti Aarnio  <mea@zmailer.org>

	* proto/Makefile.in: (Mark Visser)
	    Missed " ; \ " from the middle of "make db" 
	    sequence.

1998-07-27  Matti Aarnio  <mea@zmailer.org>

	* Makefile.in:
	    Version number: 2.99.50-s8

	* configure.in, acconfig.h:
	    Autoconfigure Eugene Crosser's  whoson  system into
	    the ZMailer smtpserver.

	* configure.in, proto/sm.conf.in:
	    Autoconfigure ``procmail'' path.

	* router/libdb/Makefile.in:
	    Use of "::" on dependency tupe caused unnecessary
	    recompilation of  router/libdb/*.c files.

1998-07-26  Matti Aarnio  <mea@zmailer.org>

	* smtpserver/policytest.c, smtpserver/mxverify.c:
	    Prefix all debug-mode outputs with '000-', which
	    (perhaps) will make it usable even during normal
	    SMTP server session.

	* transports/mailbox/Makefile.in:
	    At "make clean" do remove 'mboxpath' binary too...

	* router/lib/db/ordered.c:
	    Removed "reopen:" goto label errorneously in the
	    previous "compiler pleasing" round as "unused label"..

Sat Jul 25 21:34:11 1998  Matti Aarnio  <mea@localhost.localdomain>

	* proto/db/smtp-policy.relay (new):
	    Added a default boilerplate edition of this file
	    into the package (all comment -- but a lot of it..)

	* proto/db/smtp-policy.src:
	    Edited the comments a bit

	* proto/Makefile.in:
	    Conditional install in 'make db' the above created
	    smtp-policy.relay  file.

1998-07-13  Matti Aarnio  <mea@zmailer.org>

	* utils/policy-builder.sh.in:
	    Mark Visser <mark@cal026031.student.utwente.nl> reported
	    about the clumsiness of the spam-list retrieve and merge
	    code.  His patch went in almoast as is.

	* aclocal.m4, transports/mailbox/mailbox.c:
	    Debian hits again; I don't know which version this is about,
	    but some recent ones have <maillock.h> header, and library
	    libfilelock.{a,so} with similar code to that of the Solaris
	    libmail.a's maillock() stuff.

	* proto/cf/rrouter.cf:
	    Move the "new localpart processing" a bit downwards so that
	    "pipe.*" and "file.*" tricks used with the scheduler configs
	    still work.

1998-07-08  Matti Aarnio  <mea@zmailer.org>

	* */*.h */*.c */*/*.c: (all over the place)
	    Did use "egcs -Wall -W -W***" to get lots of warnings.
	    Tried to fix most of them.  (later heard that the CVS
	    dumpped source is a bit broken in Solaris 2.5.1 ...
	    will have to return to this...)

	* transports/mailbox/mailbox.c, transports/sm/sm.c:
	    Internally the  append_header()  routine has a buffer of 2kB
	    size.  Under no circumstances allow that to be exceeded, thus
	    use patterns like:  "%s.999s"  while formatting something.

1998-07-02  Matti Aarnio  <mea@zmailer.org>

	* transports/smtp/smtp.c:
	    An error report from  Serge Lozovsky <serge@helios.intes.odessa.ua>
	    did show that in non-pipeline mode the smtp-ta did errorneously
	    consider successfull a delivery to remote system that has rejected
	    the only (or all?) recipient address(es).

1998-07-01  Matti Aarnio  <mea@zmailer.org>

	* transports/mailbox/mailbox.c:
	    Lock acquisition code had "faulty" way to unrolling
	    itself.  I begun to suspect this while my  ELM  at
	    rare times complained that it can't remove the .lock
	    file it constructed itself :-O  Turns out, the lock
	    unrolling did unroll also the failed lock -- in case
	    of "dot-lock" that is the "mbox.lock" file..

1998-06-29  Matti Aarnio  <mea@zmailer.org>

	* man/scheduler.8, man/smtpserver.8:
	    Added .SH paragraphs about TCP-WRAPPER into them.

1998-06-27  Matti Aarnio  <mea@zmailer.org>
	
	* TODO, include/libsh.h, include/listutils.h, libsh/builtins.c,
	  libsh/expand.c, libsh/interpret.c, libsh/listutils.c, libsh/regex.h,
	  router/funcsions.c, router/shliaise.c:

	    Conditional removal of code handling "prev" pointer for "setf"
	    function uses at the conscell objects.  Default is NOT to
	    remove them (yet), although experimental systems running code
	    without any "setf" anywhere seem to be successfull, and even
	    reduce the router memory footprint by 2-3 % ...
	
1998-06-26  Matti Aarnio  <mea@zmailer.org>

	* obsolete/*
	    Removed this tree from the CVS, perhaps soon also from the
	    distribution tar files...
	
1998-06-25  Matti Aarnio  <mea@zmailer.org>

	* libc/md5c.c:
	    Some fine-tuning added so that the module will compile at most
	    platforms, but perhaps linking will cause indigection at some
	    systems still (Solaris -lnsl has md5 routines in...)

1998-06-23  Matti Aarnio  <mea@zmailer.org>

	* smtpserver/policytest.c:
	    For a "always_accept" sender, turn DNS based rejections
	    (NXDOMAIN errors) to be hard errors.

	* smtpserver/smtpcmds.c:
	    A mistake in <postmaster@*> recipient policy
	    analysis turned soft DNS error into hard policy
	    rejection...  Outch.

1998-06-22  Matti Aarnio  <mea@zmailer.org>

	* smtpserver/Makefile.in, smtpserver/smtpserver.h,
	  smtpserver/libwhoson.c, smtpserver/whoson.h,
	  smtpserver/whosond.c:
	    Initial hooks/codes for "who-is-on" daemon.

	* include/splay.h, lib/pjwhash32.c, lib/symbol.c:
	    Created symbol-routines which handle arbitary
	    binary key values; key hashes are a bit simple-
	    minded, though...
	
	* scheduler/scheduler.c, man/scheduler.8:
	    Runtime option '-n' -- see the man-page.
	
	* include/policy.c, smtpserver/readpolicy.c,
	  smtpserver/policytest.c, smtpserver/policytest.h:
	    Added 'trustrecipients' attribute.

	* smtpserver/rfc821scn.c:
	    Additional texts to match several error cases that I keep
	    seeing around at SONERA's systems..

	* doc/guides/smtp-policy:
	    Updated the contents to match system a bit more

	* include/md5.h, include/md5-global.h, libc/md5c.c:
	    Included generic MD5 code into the ZMailer's libc.
	    To be used in a few server applications... (including
	    APOP-like session authentication for scheduler cmd
	    interface..)

1998-06-16  Matti Aarnio  <mea@zmailer.org>

	* Makefile.in:
	    PATCHLEVEL 50-s6

	* configure.in, nearly all  Makefile.in  files:
	    Configure option:  --with-generic-include="-I/..."
	    which is added into ALL compilation statements

1998-06-15  Matti Aarnio  <mea@zmailer.org>

	* smtpserver/policytest.c:
	    Moved "P_A_FullTrustNet" attribute recognition up a bit
	    so that "P_A_RelayCustNet" does not blank full_trust mode!

	* utils/policy-builder.sh.in:
	    Added another retrievable spam domain list

	* proto/cf/aliases.cf:
	    A fragment of script (in comment) which is specific for
	    listserv.funet.fi  system.

	* scheduler/msgerror.c:
	    When reporting "Multiple-fault:" type error, tell also
	    which template file is not openable, and ask the recipient
	    to report the case to the postmaster...

	* router/functions.c:
	    - rd_doit() -- don't rename "core*" file into normal
			   spooled file name
	    - run_listexpand():  Did complain when it got 5 arguments
				 and refused to do the work :-(

1998-06-14  Matti Aarnio  <mea@zmailer.org>

	* proto/cf/aliases.cf, proto/cf/fqdnaliases.cf:
	    Match new listexpand parameters.

	* router/functions.c:
	    Added two new parameters to function  listexpand
	    to match underlying   rrouter  script function.

	* libsh/regex.h, libsh/regex.c:
	    Matched against GLIBC  <regex.h>  type defines.

	* transports/smtp/smtp.c:
	    A screwup in DBAT dot-processing algorithm.
	    Basically BDAT phase did line-start dot-duplication,
	    which is all right for DATA phase, but a no-no for
	    the BDAT :-(

1998-06-13  Matti Aarnio  <mea@zmailer.org>

	* proto/cf/aliases.cf:
	    Removing "sender" parameters from alias processing
	    cases.  Copying them from other codes was a mistake
	    with subtle results.
	
	* proto/newaliases.in:
	    Parameter parsing error; didn't honour '-s' option.

1998-06-12  Matti Aarnio  <mea@zmailer.org>

	* smtpserver/smtpserver.c, smtpserver/smtpserver.h,
	  smtpserver/smtpcmds.c:
	    Reviewed, and changed quite many of the ENHANCEDSTATUSCODES
	    code values presented in replies.  Not all DNS errors are
	    POLICY (*.7.*) errors although policy analysis detects them..

1998-06-11  Matti Aarnio  <mea@zmailer.org>

	* proto/makedb.in:
	    Altered the parameter pickup routines to be more generic
	    in view of what *sh shells support: while true; do .. break .. done

	* transports/mailbox/mailbox.c:
	    Mistakes after code movements in  program()  function :-(

	* smtpserver/smtpdata.c, smtpserver/smtpserver.c,
	  smtpserver/smtpcmds.c, utils/smtpserver-log-parser.pl:
	    Make the verbose debug log more readable -- guaranteed
	    session end-points to be findable:
	       ######w \t 221 ...
	       ######- \t ...

	* smtpserver/smtpcmds.c:
	    Change ETRN reply texts a bit; don't anymore speak of TURNME..

1998-06-09  Matti Aarnio  <mea@zmailer.org>

	* proto/cf/aliases.cf, proto/cf/fqdnaliases.cf, proto/cf/p-usenet.cf,
	  proto/cf/rrouter.cf, proto/cf/standard.cf,
	  proto/db/aliases.zmsh.example:
	    Major reorganisation of scripts;
	    - All things that have something to do with local users
	      are clustered into aliases.cf. (Away from  standard.cf,
	      and from  rrouter.cf)
	    - A new calling arguments for  routeuser (aliases.cf,
	      and rrouter.cf)
	    - Smart "+plustail" processing into fqdnaliases.cf
	    - Hooks in between p-usenet.cf, and aliases.cf to handle
	      'newsgroup' database.
	    With these the system can handle usernames that have
	    dots in them, and unifying multiple (in theory: arbitary
	    number of: aliases.zmsh.example) aliases, and other databases.

1998-06-08  Matti Aarnio  <mea@zmailer.org>

	* include/policy.h, smtpserver/policytest.c, smtpserver/policytest.h,
	  smtpserver/readpolicy.c:
	    Altered "relaycustnet" semantics a bit.  Even though it will
	    still allow unlimited inbound feed, it will at first fo DNS
	    verification on MAIL FROM, and RCPT TO headers -- accepts
	    recipients if said recipients have any DNS A/MX entry at all,
	    and likewise with sender...
	    Introduced new attribute:  "fulltrustnet +"  which can
	    be used in case there absolutely is need for not checking
	    input addresses (like in a very high-volume email traffic
	    in between vger.rutgers.edu and nic.funet.fi ...)

	* transports/mailbox/sieve.c, transports/mailbox/mailbox.c,
	  include/sieve.h, transports/mailbox/Makefile.in:
	    Hooks for 'SIEVE' things; ways for the user to define
	    message arrival time filtering.

1998-06-06  Matti Aarnio  <mea@zmailer.org>

	* contrib/spamlist.py, utils/policy-builder.sh.in:
	    New version of  spamlist.py  from Roy Bixler, a bit
	    support for its output format into policy-builder.

1998-06-05  Matti Aarnio  <mea@zmailer.org>

	* transports/sm/sm.c:
	    Added "H" flag to the "sm" facility flags.
	    Altered here the way the BSMTP mode has worked for
	    ages.  Specifically now it requires EXPLICITE 'H' flag
	    to produce HELO/EHLO to the begining of the BSMTP
	    datastream.

	* utils/rotate-logs.sh.in, configure.in, utils/Makefile.in:
	    Made "rotate-logs" utility to be 1) autoconfig, and
	    2) installed every time a "make install" is done.

	* smtpserver/smtpserver.c:
	    Some clients seem to send "QUIT\r", and then close the
	    socket.  This caused indigestion and error logging.
	    Now it will at least tell what the input was, and
	    then have indigestion complaints..

	* proto/zmailer.sh.in, proto/Makefile.in, proto/newdb.in:
	    - Alterations on "zmailer" command, streamlining, adding
	      a "zmailer makedb" function to compile all common database.
	    - Option processing improvements on  newdb  to allow arbitary
	      order of options affecting the underlying  makedb.
	    - Makefile changes to (possibly) improve "make forms"
	      installation processing to be more generic.
	
	* utils/vacation/vacation.c:
	    Add HAVE_DB_H test to be third known/supported database.
	    Will it be sufficient for all environments shall be seen..

	* utils/vacation/convtime.c:
	    Add a couple autoconf includes

1998-06-04  Matti Aarnio  <mea@zmailer.org>

	* proto/newdb.in:
	    Smarter option processing, usage() function.

	* compat/sendmail/sendmail.c:
	    Recognize when no message was collected, and silently
	    ignore such input.

	* compat/sendmail/sendmail.c:
	    - Parse and verify option parameters for -B and -p options
	    - implement -s option (save From_)
	    - wrote a REAL usage() report -- try 'sendmail -?' to see

	* smtpserver/smtpcmds.c:
	    When presenting diagnostics on bad parameters on MAIL command,
	    the server used occasionally response number 455, where it
	    should use 501 -- cosmetic bug, I would say..

1998-06-03  Matti Aarnio  <mea@zmailer.org>

	* proto/zmailer.sh.in, proto/newaliases.in, proto/newdb.in,
	  proto/newfqdnaliases.in, utils/makedb/makedb.c:
	    - "makedb" got "-s" option so that in alias mode (-a) it
	      will not utter final statistics report
	    - Created command "zmailer newdb" which generates four
	      well known flatfile databases into their respective
	      binary views. (localnames, routes, aliases, fqdnaliases)
	      If all goes ok, this command prints no statistics of
	      databases.  (You could guess: somebody asked for this :) )
	    - Others just recognize the "-s" option, and pass it around
	      properly.

	* router/functions.c:
	    Removed large chunk of dead code (#if 0 ..)

	* proto/Makefile.in:
	    Fixed configuration file back-reference

	* smtpserver/smtpcmds.c:
	    When printing HELO-string into rcvdfrom comment, quote
	    also "(", and ")" characters.

	* smtpserver/smtpserver.c:
	    Revised that 'smtpserver -i' mode code so that
	    it should work on a wider array of systems.

1998-06-02  Matti Aarnio  <mea@zmailer.org>

	* smtpserver/smtpserver.c, smtpserver/smtpcmds.c:
	    More Roy Bixler patches.  Moved some code around so
	    that the system will always know when it truly is
	    connected to a network socket. The server will not
	    produce "rcvdfrom " envelope header in case it is
	    not running on a network socket.

	* Most  Makefile.in  files:
	    Reworked on "prefix=nnnnn make install" installation.
	    Now it creates the target parent directories if needed.

	* Makefile.in, ChangeLog:
	    Version 2.99.50-s5 -- are we now safe ??

	* transports/mailbox/mailbox.c:
	    Added a bit earlier test for "user" /dev/null so that
	    that target can be "delivered" to without privilege
	    check.
	
	* router/rfc822.c:
	    More gymnastics on getting the possibly missing "From: "
	    header generated in all possible situations.

1998-06-01  Matti Aarnio  <mea@zmailer.org>

	* proto/newaliases.in, proto/newdb.in, proto/cf/i-routes.cf,
	  proto/cf/standard.cf, proto/newfqdnaliases.in:
	    Synced 'newdb' usages to supply explicite '-l' option,
	    Modified scripts to require /bin/sh, not MAILBIN/router !

	* router/rfc822.c:
	    If the message had no 'From: ' header, generate one for it.

	* proto/cf/standard.cf:
	    Add "bitnet" and "uucp" into the default toplevels list.

	* proto/cf/rrouter.cf, proto/cf/i-bitnet.cf:
	    Updated BITNET routing rules;  nic.funet.fi  is Finland's
	    *only* BITNET host these days, and works as BITNET-bound
	    email gateway.

	* libsh/builtins.c, proto/cf/aliases.cf, proto/cf/aliases-new.cf:
	    Whoops, two mistakes in  aliases.cf -- wrong name at
	    lappend parameter, and lappend internal functionality
	    at empty target variable content was faulty (SIGSEGV..)

	* configure.in, libc/setregid.c, libc/Makefile.in,
	  transports/mailbox/mailbox.c:
	    Within mailbox.c there is one instance of fork(), and
	    following it are some setgid()/setuid() statements.
	    Setting real-uid/real-gid is not sufficient for systems
	    with NFS-mounted home directories...

	    Changed those calls to be  setregid() and setreuid(),
	    which should work far better, but I have no idea about
	    its portability to for example  SunOS 4.1.*  series.
	
	* proto/Makefile.in, proto/cf/SMTP.cf.in, configure.in:
	    Default router.cf is altered to have protocols 'routes',
	    and 'smtp'.  Per default the system install will not
	    have UUCP in routing stage anymore.

	* smtpserver/smtpdata.c:
	    Oops: At DATA processing the content-policy was tested
	    only if the last RCPT policy analysis yielded All-OK (0)
	    status.

1998-05-26  Matti Aarnio  <mea@zmailer.org>

	* proto/newdb.in:
	    The script is in fact pure /bin/sh script, don't ask for
	    running the router on it.

	* proto/cf/aliases.cf, proto/cf/consist.cf, proto/cf/crossbar.cf,
	  proto/cf/aliases-new.cf:
	    Replaced all uses of 'setf' with  'lappend' and 'lreplace',
	    where appropriate.

1998-05-25  Matti Aarnio  <mea@zmailer.org>

	* libsh/builtins.c:
	    Finetuning of  sh_lreplace()  gadget.

1998-05-19  Matti Aarnio  <mea@zmailer.org>

	* proto/db/smtp-policy.src, utils/policy-builder.sh.in:
	    Define a new alias tag:  _localnames
	    to be used with "localnames" source file.
	    It does not have "relaycustomer +" tag in it, thus just
	    simply doing "MAIL FROM:<foo@local.host.name>" will not
	    allow wide-open relaying...

	* libsh/trap.c:
	    printf() argument castings into ones that are likely
	    supersets of all existing instances -- mainly casting
	    to  long ...

	* proto/cf/standard.cf:
	    relation 'localnames' got '-m' option, which was missing :-/
	    (detected when one system didn't react at changes in the
	     localnames file/database)

	* lib/rfc822scan.c:
	    A bug in error processing caused certain pathologic cases
	    to follow NULL pointer... Outch.  Sample case detected
	    by Alexis Yushin.

	* lib/symbol.c:
	    Removed conditionally builtin "pjwhash32()" function in
	    favour of same function in separate file.

	* libsh/builtins.c:
	    First stab at 'lappend' function

	* Makefile.in:
	    Don't demand automatic dependency on "configure: configure.in",
	    which would run autoconf, as CVS extraction gets dates reversed
	    (or otherwise screwed up..)

	* configure.in, smtpserver/Makefile.in, smtpserver/smtpserver.c:
	    Comment away "-lelf" and "-lkvm" autoconfig tests, and
	    removed all instances of loadaver_current() uses.
	    I don't believe there to be any worthwhile point in it.

	* configure.in:
	    Fixes for "-lresolv" tests so that IRIX6.4 is happy.

1998-05-14  Matti Aarnio  <mea@zmailer.org>

	* All (very nearly) Makefile.in files, plus
	  configure.in:
	    Support CPPFLAGS input environment for the configure,
	    and store it into all Makefiles that do compilation.
	    It is intended to carry "-I/.." options for CPP phase
	    so that some illogically placed headers can be found.

	* utils/makedb/makedb.c:
	    Missed  'l' and 'u' from  getopt() parameters; Oops..
	    (Andrew Tridgell <tridge@samba.anu.edu.au> reported)

	* scheduler/msgerror.c:
	    Had one fseek() lying around from another branch
	    of flow control -- but the "fp" parameter pointed
	    to NULL :-/  (Andrew Tridgell reported)

	* transports/smtp/smtp.c:
	    Two instances of  zsyslog()  with  LOG_ALERT  changed
	    to  LOG_ERR -- the detected errors are not ALERT level
	    stuff. (Andrew Tridgell reported)

1998-05-13  Matti Aarnio  <mea@zmailer.org>

	* utils/makedb/makedb.c:
	    Fixes on policy parser error reports, and generic duplicate
	    key error's key printing routine.

	* proto/newaliases.in, proto/newdb.in, proto/zmailer.sh.in:
	    As "makedb" got explicite "-l/-u" options, so did "newdb",
	    and their callers.

	* proto/cf/standard.cf:
	    Relation parameters for db FILES need to have "m" in them,
	    we learned.. (via the hard way, of course).  Now added it.

	* utils/Makefile.in:
	    Conditionalize installing of "policy-builder.sh" script so,
	    that it is no longer overwritten blindly by "make install".

	* smtpserver/smtpcmds.c, smtpserver/policytest.c,
	  smtpserver/policytest.h, smtpserver/readpolicy.c,
	  include/policy.h:
	    Implemented smtp-policy attribute "maxinsize"
	    which has numeric value, and can be used to limit
	    (in source specific manner) incoming message sizes.
	    Implemented also provision for "maxoutsize", which
	    use remains to be seen.. (possibly for running inside
	    smtp transport agent)

	* utils/makedb/makedb.c:
	    Runtime options '-l' and '-u' for explicite lower-/upper-
	    casification of key strings before storing them into db.

1998-05-05  Matti Aarnio  <mea@zmailer.org>

	* smtpserver/mxverify.c, smtpserver/smtpcmds.c:
	    Spotted a case of certain timeouts slipping into
	    hard errors when they definitely should not.
	    Added new report for "Detected temporary DNS error,
	    retrying may help.."

	* scheduler/readconfig.c, scheduler/scheduler.h,
	  scheduler/transport.c, proto/scheduler.conf.in:
	    Selector parameters:
		priority=<n>
		nice=<n>
		syspriority=<n>
		sysnice=<n>
	    Further into at the default scheduler.conf(.in)
	    comments.  Idea thanks to <Nicholas_Briggs.PARC@xerox.com>

	* smtpserver/smtpcmds.c:
	    If ident lookup is not done, don't add ' ident : ..' stuff
	    into the 'rcvdfrom ' envelope header.

1998-05-04  Matti Aarnio  <mea@zmailer.org>

	* Makefile.in:
	    Version 2.99.50-s3

	* transports/smtp/smtp.c:
	    A few cases of calls to  smtp_sync() while SS->smtpfp
	    was already NULLed are now protected.  One can't do
	    any remote syncing when there is no remote...

1998-04-27  Matti Aarnio  <mea@zmailer.org>

	* libc/Makefile.in:
	    Fixes for installation of  zmailer.h, and libzmailer.a
	    (Noted by Eugene Crosser)

	* compat/sendmail/sendmail.c:
	    Usage of "-f<>" option (source as the 'box') creates
	    message with "channel error" for the reported envelope
	    source.  This was for easier debugging of 'channel error'
	    things, but YMMV as the saying goes...

	* proto/Makefile.in:
	    Weird problems in "make mailshare" installing *.conf
	    files.  Perhaps fixed now. (Noted by Eugene Crosser)

	* router/rfc822.c:
	    Alternate scheme for dealing with SMTP MAIL FROM:<>, and
	    lack of "From:" header in the message.

	* Makefile{,.in}:
	    Version: 2.99.50-s2

1998-04-24  Matti Aarnio  <mea@zmailer.org>

	* configure.in, acconfig.h, lib/prversion.c:
	    Store ./configure command parameters into a #define,
	    and present them in places calling  prversion().
	    (Makes sense in several cases, IMO..)

	* configure.in, (most)/Makefile.in:
	    New configuration option:
		--with-getpwnam-library="-L.. -l.."
	    helping overloading of  getpwnam()  (and getpwuid() ?)
	    library calls with your own special ones; if you have some
	    ISP system with backend databases, etc..

1998-04-09  Matti Aarnio  <mea@zmailer.org>

	* configure.in:
	    RedHat 5.0/glibc-2.0.7-6: found   res_init()  in libc, but
	    not others, like  res_mkquery().

	* transports/mailbox/mailbox.c, man/mailbox.8, README.UPGRADING:
	    New option: "-C" to canonify username to what pw_name
	    from  getpwnam()  call yields.  Previously this canonification
	    was done blindly -- does not affect most people, but there are
	    a few weird fellas whose  getpwnam() uses key A, and yields
	    string B in pw_name field..  (These are not only Telecom Finland
	    weirdos..)

1998-04-08  Matti Aarnio  <mea@zmailer.org>

	* Makefile.in:
	    Version 2.99.50-s1

	* transports/mailbox/mailbox.c:
	    New hash-directory option: -P (and -PP)
	    This uses pjwhash32() on the username and then calculates
	    a sub-directory hash from that -- in range of 'A'..'Z'.
	    With two -P's, the hash is two-level deep: /dir/X/Y/uname
	    where X is calculated as 'A'+(hash/26)%26, and Y is 'A'+(hash%26)

	* transports/mailbox/mboxpath.c:
	    A new command with options '-d dirpath', '-P[P]' and '-D[D]'
	    and username parameter.  It calculates same hashes, and reports
	    to  stdout  the path of the mailbox.

	    This is intended for system-wide startup script usage with
	    code something like following for sh:
		MAIL=`mboxpath -P $USER`
	    It is important to use SAME options here as are used at running
	    the mailbox program.

	* lib/pjwhash32.c:
	    Pulled from elsewere a hash-routine to convert a string into
	    a hash-value.  Used at mailbox subdirectory hashing..

	* transports/smtp/smtp.c:
	    "-L localidentity" option fix.  Now it can select from
	    possible multiple local identities.
	    Also corrected similar problem with '-F' option processing.

1998-04-03  Matti Aarnio  <mea@zmailer.org>

	* smtpserver/smtpserver.c, smtpserver/smtpdata.c:
	    Report end of "DATA" and "BDAT" commands too -- the server
	    may be sleeping around on idle-states for a long time..
	
1998-03-27  Matti Aarnio  <mea@zmailer.org>

	* transports/mailbox/mailbox.c:
	    Corrected the use of x.2.2 type of mail status code from
	    "5.2.2" to "4.2.2".  (Persistent transient error.)

	* INSTALL:
	    Warn about configuration phase --prefix="parameter" string
	    size limitations due to usual shell-script execution rules
	    on UNIXes.

	* router/libdb/header.c:
	    Alter the syntax of "Reply-To:" header match that of
	    RFC-822.  Oops since 2.2.1 (and probably before!)

	* router/libdb/bind.c:
	    Just nice for debugging -- report DNS lookup error codes
	    in text instead of "magic" numbers -- "NXDOMAIN" instead
	    of "3", for example.
	
1998-03-26  Matti Aarnio  <mea@zmailer.org>

	* transports/mailbox/mailbox.c:
	    A quota-check hook from Eugene Crosser <crosser@average.org>

1998-03-25  Matti Aarnio  <mea@zmailer.org>

	* smtpserver/smtpcmds.c, smtpserver/smtpserver.c:
	    Limit a bit about how much meta-lines are logged.
	    If policyresult status is zero, don't report it.

	* libident/identuser.c:
	    When connect() yields "ECONNREFUSED", present report
	    "NO-IDENT-SERVICE" instead of "SOCKFAULT1".
	    (Local users at a large SPARC server running 2.6 and
	     sending email with PINE thru SMTP.)

1998-03-22  Matti Aarnio  <mea@zmailer.org>

	* libsh/builtin.c:
	    Function sh_echo() got slight alteration.
	    Now it detects options: [-n] [--] [rest of args]
	    in this order.

	    This in order to be able to write script statements of
	    style:  echo -- "$@"    where the arguments MAY start
	    with first component of "-n" ...

	* proto/cf/canon.cf:
	    Rearrangeing the script a bit, do  $(canon ..) calls
	    in  canonical ()  in case the hostname has at least one
	    dot in it, and the top-level part is not know one.

	* router/db.c:
	    Somebody asked for a method for querying available
	    databases in the router scripts.  Method is:
		relation -T -t dbtype dummyname
	    Return-code 0 means the 'dbtype' is known, and non-zero
	    means it is unknown.

	* lib/selfaddrs.c, transports/smtp/smtp.c:
	    Modify function  matchmyaddress()  to return value 3 for
	    such destination addresses which are of invalid network
	    (Valid range being: 1..223; out of which 127 yields value 2)
	    This was prompted by noticing appearance of faulty DNS
	    data in larger amounts in the network.  Lots of A 0.0.0.0
	    entries especially.

1998-03-20  Matti Aarnio  <mea@zmailer.org>

	* INSTALL, doc/guides/configure, doc/guides/smtp-policy:
	    A bit of rewriting on INSTALL file, new guide file,
	    and update of  smtp-policy  guide.

	* ChangeLog, Makefile.in:
	    Pushing out version 2.99.49p10-s11

1998-03-17  Matti Aarnio  <mea@zmailer.org>

	* proto/cf/rrouter.cf, INSTALL:
	    Match $hostname also with non-lowercase domain
	    address.

1998-03-16  Matti Aarnio  <mea@zmailer.org>

	* scheduler/msgerror.c:
	    In case boiler-plate template was not found,  writeheader()
	    would produce bad error report message which router would
	    not accept for processing.

1998-03-12  Matti Aarnio  <mea@zmailer.org>

	* scheduler/qprint.c:
	    A patch from Andrey Blochintsev to restore the functionality
	    of "mailq -v" with scheduler running with "-H[H]" mode.

	* proto/cf/rrouter.cf, proto/cf/aliases.cf:
	    When user has  .forward  but it is empty, aliasing pushed
	    said user to bitbucket.  Now the .forward is expanded to
	    be  "\username", and no recursed .forward will be entered.
	    Thus the user will stay in the local system.

1998-03-11  Matti Aarnio  <mea@zmailer.org>

	* router/rfc822hdrs.c:
	    A user found pathological case of errors which caused his
	    router process to blow up.  Turned out to be overflow of
	    stack contained array :-(   Outch!
	    Fixed/limited several array/buffer references in the module.

	* transports/smtp/smtp.c:
	    Full-blown pipelining -- will collect replies asynchronously,
	    and merge results into smtp_sync() states while still sending
	    things out.  This limits (sometimes) amount of things kept
	    in the reply pipeline buffers.

	* proto/cf/aliases.cf:
	    Backed off some changes; pushed too much into bitbucket :-(

	* transports/smtp/smtp.c:
	    Alexis Yushin reported that BDAT didn't work in non-pipelined
	    mode :-(  Corrected that.

1998-03-10  Matti Aarnio  <mea@zmailer.org>

	* proto/cf/aliases.cf, proto/cf/rrouter.cf, proto/cf/fqdnaliases.cf:
	    Rewamped $(rrouter ..) and some other scripts after reports
	    regarding mysterious problems with $PUNTHOST.

	* include/shmmib.h, scheduler/prototypes.h, scheduler/scheduler.c,
	  scheduler/scheduler.h, scheduler/update.c:
	    Hooks/preparations for RFC 2249

	* smtpserver/smtpdata.c:
	    Some anti-spam hacks merged in

1998-03-04  Matti Aarnio  <mea@zmailer.org>

	* transports/smtp/smtp.c:
	    Correction to EHLO SIZE processing, aborting message sending
	    if the remote system presents a size limit, and current message
	    size estimate exceeds that value.  Corrections to the way, how
	    active smtp socket peer IP addresses are presented for diagnostic
	    reports.

1998-03-03  Matti Aarnio  <mea@zmailer.org>

	* transports/smtp/smtp.c:
	    Smarter processing for PIPELINING error reports;
	    if PIPELINING mode yields error on MAIL FROM, use
	    that report at all RCPT TO lines.
	    Also support multiline reports from remote servers
	    (up to a few kilobytes long..)

	* smtpserver/smtpserver.h, smtpserver/smtpserver.c,
	  smtpserver/Makefile.in, smtpserver/policytest.h,
	  smtpserver/smtpdata.c, smtpserver/contentpolicy.h,
	  include/mail.h.in, include/policy.h:
	    - Modified several multi-line policy report messages
	      into a narrower form with same text folded on
	      shorter lines
	    - Added hooks for  contentpolicy()  function that
	      will be able to analyze file content for possible
	      acceptable content issues ("SPAM"...)

	* libc/mail.c: mail_fname(FILE * mfp)
	    A new function returning filename of currently open
	    mail related FILE *.

	* Makefile.in:
	    Version 2.99.49p10-s10

	* proto/cf/canon.cf, proto/cf/rrouter.cf:
	    Modifications on canonicalize() routines so that
	    X.400 gateway address of type:  /foo/bar@gate.way
	    will go thru unharmed.
	
	* router/rfc822.c:
	    If there is no "From:" header, and the source
	    channel is "error", create a "From: <>" header.
	    At the same time the source ENVELOPE rewrites
	    itself to be   postmaster@local.host.name  (hmm..)

1998-02-28  Matti Aarnio  <mea@zmailer.org>

	* transports/smtp/smtp.c:
	    Still problems with PIPELINING; doing  smtp_sync()
	    twice wasn't prepared for a thing, and thus in some
	    cases (all cases?) syncing after BDAT didn't quite
	    work ok.

	* proto/cf/rrouter.cf:
	    "lotusgw!" routes_spec() tag -- exact details are
	    in state of flux, but this is for Telecom Finland
	    operations.  Apparently suitable pre-routing at
	    smart MTAs can help a lot with system performance
	    at lotus-smtp-gateways.

1998-02-27  Matti Aarnio  <mea@zmailer.org>

	* Makefile.in:
	    Version id 2.99.49p10-s9

	* scheduler/threads.c, contrib/mrtg/mrtg-zmq:
	    Noticed that "mailq -sQQ" output does not produce
	    consistent results when the scheduler has no jobs
	    in queues, nor any children.  Changed the reporting
	    a bit to give out a line of zeroes, if nothing else.

	    Added a bit more comments and explanations into
	    the  mrtg-zmq  script; it is a tool, but in itself
	    it is NOT sufficient for graph producing, just to
	    produce the data.

	* smtpserver/smtpserver.c:
	    Recognize several error conditions within  s_getc()
	    in connection with read(2) call.

	* transports/smtp/smtp.c, include/ta.h,
	  transports/libta/writeheaders.c:
	    Implemented the outbound RFC 1830 CHUNKING (BDAT)
	    method for message sending; needed revised methods
	    on header writing -- to a buffer.

1998-02-26  Matti Aarnio  <mea@zmailer.org>

	* utils/makedb/dblook.c, utils/makedb/makedb.c:
	    printf format string fixes

	* transports/smtp/smtp.c, transports/libta/diagnostics.c:
	    Carry IP address in WTT data to the DSN reports.
	    Thus will tell exactly which IP addresses tried to
	    connect to each other.

	* smtpserver/smtpcmds.c:
	    Last of Gabor Kissig's router-driven policy facility
	    patches have been incorporated into the server.
	
1998-02-25  Matti Aarnio  <mea@zmailer.org>

	* scheduler/resources.c:
	    Per report from Martin Wendel, AIX 4.2.1 yields
	    surprising values on  getrlimit(RLIMIT_NOFILE, ..)
	    result structure.  Altered things so that we won't
	    use that facility on _AIX systems -- ever.

	* router/functions.c:
	    $(syslog ...) and $(logger ...) functions

1998-02-20  Matti Aarnio  <mea@zmailer.org>

	* scheduler/threads.c (and others):
	    Radical thread-group job-picking reorganizing.
	    More deterministic approach on scheduling with
	    better guarantees of even activation of threads.

	* scheduler/mailq.c:
	    The "-Q" mode receiving of non-Q-mode vertices
	    data streamlined so that it does not require
	    up to infinitely long linebuffers...
	
	* transports/smtp/smtp.c:
	    NULL-ptr reference in logfp output.  Oops...

1998-02-17  Matti Aarnio  <mea@zmailer.org>

	* transports/smtp/smtp.c:
	    A weird error report surfaced, which turned out to be
	    error in PIPELINING smtp_sync() processing.  Remote
	    end gave 250 answers to all MAIL FROM, and RCPT TO lines,
	    but then gave 451 for DATA.  The code had NO handling
	    of DATA command error :-(  (There was apparent assumption
	    that if any RCPT TO is ok, then DATA will be ok too..)

1998-02-16  Matti Aarnio  <mea@zmailer.org>

	* scheduler/scheduler.c, scheduler/update.c:
	    When #resync:ing a file, read it immediately back, but
	    for those vertices that have a lock, issue a delayed
	    "wakeup"..

	* proto/cf/aliases.cf:
	    User's domain identity carrying fixed

	* proto/cf/canon.cf:
	    Unnecessary back-slashes removed
	
	* proto/cf/crossbar.cf:
	    Fine-tunings for rewriting outbound email envelope with source
	    domain at the local host

	* proto/cf/p-usenet.cf:
	    Automatic dbtype configuration

	* router/db.c:
	    Cleaned up the address processing expressions

	* smtpserver/smtpdata.c:
	    Corrected message-id analysis routines a bit
	
1998-02-13  Matti Aarnio  <mea@zmailer.org>

	* proto/zmailer.sh.in, utils/rotate-log.sh:
	    Updates for log-chop processing with various
	    programs -- routers and the scheduler are
	    slightly different animals in this regard..

1998-02-12  Matti Aarnio  <mea@zmailer.org>

	* router/functions.c:
	    Logical expression error within run_dequote() caused
	    faulty processing of string "'" in such manner, which
	    caused process to blow up...

1998-02-05  Matti Aarnio  <mea@zmailer.org>

	* include/libc.h:
	    Prototypes of  inet_ntop()  and  inet_pton()  changed to
	    match the world view -- Solaris 2.6 is now happy with us..

	* proto/cf/p-smtp.cf:
	    Patch by Alexis Yushin for UUCP route handling

	* compat/rmail/rmail.c:
	    Patch by Alexis Yushin for proper use of <sysexits.h> values

	* transports/errormail/errormail.c:
	    An off-by-one fix by Alexis..

Wed Feb  4 19:52:36 1998  Matti Aarnio  <mea@zmailer.org>

	* configure.in:
	    More modifications to support RedHat 5.0 systems, and
	    at same time to support Solaris 2.5.1.
	
	* lib/esyslib.c:
	    erename()/eqrename() tricks to handle Solaris returning
	    EBUSY at inconvinient moments..  Now will retry the thing
	    until successfull (or failed with errno != EBUSY/EINTR)

	* libident/identuser.c:
	    Added setjmp()/longjmp() along with alarm() handling to
	    make sure we have shortish timeout

	* smtpserver/smtpcmds.c:
	    Cosmetic fixes on verbose log file

	* smtpserver/smtpdata.c:
	    Recognize a couple of headers that exist on spam email

	* smtpserver/smtprouter.c:
	    Recognize router subprocess death, and report it with
	    "400 Help...!" message, not silent "250 All fine."

	* smtpserver/smtpserver.c:
	    Report RBL TXT data to the connecting user

	* transports/libta/diagnostic.c:
	    Trunc-back the transport-spec file if its appending
	    fails.

	* transports/smtp/smtp.c:
	    In EHLO/HELO/reconnect/HELO/... connection test attempts
	    do retry all MXes -- but only once each.

Sun Dec 21 14:59:04 1997  Matti Aarnio  <mea@zmailer.org>

	* libc/setreuid.c:
	    AIX code missed "return 0;" at the end.
	    (From: pakrat@raleigh.ibm.com)
	    And also SysVr4 emulation code had missing "return rc;"
	    at its end..

Sat Dec 20 01:05:00 1997  Matti Aarnio  <mea@zmailer.org>

	* smtpserver/smtpchild.c:
	    Altered the child registration and detection mechanism
	    to test for "sneaky" disappearances of subprocesses
	    before getting them registered into the server childs[]
	    table.  Has "tunable" interval on how to monitor on
	    the existence of subprocesses.
	
 	* smtpserver/cfgread.c:
	    Removed "PARAM toplevels", a stillborn thought.

	* libsh/sh.ssl, libsh/sslwalter.c, proto/cf/*.cf{|,.in}:
	    Codified error report on use of  'sift' / 'tfis'
	    syntax in place of 'tsift' / 'tfist' names.  Report
	    mismatching keywords -- like 'ssift' ending with 'tfist'..
	    Fixed all prototype *.cf and *.cf.in files in this regard.

	* libsh/test.c:
	    Don't complain always at failing *stat() calls -- allows
	    things like this without spurious junk at the screen:
	    	if [ ! -f $MAILVAR/db/aliases$DBEXTtest -o \
	          $MAILVAR/db/aliases -nt $MAILVAR/db/aliases$DBEXTtest ]; then
		    # Yes, so update!
		    $MAILBIN/zmailer newaliases
		fi
	
Wed Dec  3 00:39:45 1997  Matti Aarnio  <mea@zmailer.org>

	* router/libdb/gdbm.c, router/libdb/ndbm.c:
	    GDBM sets  gdbm_errno  with value  GDBM_EMPTY_DATABASE
	    if the DB is empty; NDBM does not complain of the situation.
	    GDBM and NDBM had poorly (nee, pathologically) functioning
	    search ( = fetch ) retry routines, rewrote them slightly.

	* smtpserver/smtpserver.c:
	    Lacked  stashmyaddresses(NULL)  call to prime the interface
	    address data.

	* smtpserver/mxverify.c:
	    Considered only the first MX record arriving;  Duh :-(

Sat Nov 29 16:02:48 1997  Matti Aarnio  <mea@zmailer.org>

	* libsh/interpret.c:
	    Finally!  Found the place(s) of leaking memory
	    (conscell + string) in the router.  Now nic.funet.fi
	    does not have infinitely growing router :-)

Mon Nov 24 20:44:27 1997  Matti Aarnio  <mea@zmailer.org>

	* configure.in:
	    Re-organize the --with-ipv6-replacement-libc option
	    processing -- now it finally works.

	* router/libdb/unordered.c, router/libdb/ordered.c:
	    The incore database of filenames (spt_files)
	    reorganization, and code reuse on the open_seq()...

Fri Nov 21 19:48:06 1997  Matti Aarnio  <mea@zmailer.org>

	* utils/makedb/makedb.c:
	    - "-A" option to APPEND more data to same key.
	      This behaves slightly differently for aliases, and
	      for policy -- former being ascii, latter being binary.
	    - Process alias entries in similar manner as the
	      sendmail does them

	* router/libdb/ndbm.c, router/libdb/bsdbtree.c, router/libdb/gdbm.c,
	  router/libdb/bsdhash.c, router/libdb/dbm.c, router/libdb/ordered.c,
	  router/libdb/unordered.c:
	    Retry the DB file open three times with 1 second sleep in
	    between; this to allow certain small window of db file
	    unavailability during  mv  operation of the installation
	    of a new version.

	* libsh/interpret.c:
	    Fix errorneously added  s_free_tree() -- it really is
	    ok to free() only the top cell. Freeing more blows things
	    up..

Tue Nov 11 04:16:41 1997  Matti Aarnio  <mea@zmailer.org>

	* transports/smtp/smtp.c:
	    Extensive revisioning of MX processing in order to eliminate
	    spurious "DNS inconsistensy detected, no MX, no Address" reports.
	    Now it seems the things are under control.

	* smtpserver/smtpserver.c, smtpserver/policytest.c,
	  smtpserver/policytest.h, smtpserver/smtpcmds.c,
	  smtpserver/smtpdata.c,   smtpserver/readpolicy.c,
	  smtpserver/mxverify.c,   include/policy.h:
	    - Initial implementation on  http://maps.vix.com/rbl/
	    - mechanisms to pass some data back from policytest to
	      the smtpserver proper, and to add some logs..

	* transports/mailbox/mailbox.c:
	    Support "-d" option for defining MAILBOX directory at
	    runtime.
	
	* transports/expirer/expirer.c, transports/expirer/manual-expirer.in,
	  transports/expirer/Makefile.in, configure.in:
	    Manual interface for the transport-agent level entity;
	    providing also easier usage for the expirer in case
	    of wanting to expire something from the queues.

	* transports/mailbox/mailbox.c:
	    Non-zero exit codes from pipe subprocesses were considered
	    all bad.  Now things have been altered to treat most of
	    them as EX_TEMPFAIL, and only very few as permanent.
	    Found this problem out by a procmail using collegue, when
	    his home disk filled up, and deliveries bounced with code
	    EX_TEMPFAIL :-O

	* scheduler/scheduler.h, scheduler/transports.c:
	    Store approximation of the argv[] into a per-process array
	    of subprocess states, and in case the transport sub-process
	    exits with EX_SOFTWARE status code, send syslog() message
	    of  MAIL_EMERG, and more verbose stuff to  stderr log file.
	    At syslog config you might consider directing MAIL_EMERG to
	    some people directly, and in realtime..

	* scheduler/msgerror.c:
	    When reporting errors, use correct pointer to the "plain
	    ascii" error report.

	* smtpserver/smtpserver.c, smtpserver/policytest.h,
	  smtpserver/readpolicy.c, smtpserver/policytest.c,
	  include/policy.h:
	    - If the policydatabase can't be opened, delay a bit at
	      the connect formation, but always send syslog MAIL_EMERG
	      in hope of it becoming handled in realtime...
	    - Add new policytest attribute: sendernorelay

	* libsh/interpret.c:
	    In preparation for more debugging, separate things in between
	    sAssign, and sTempAssign executions.

	* router/libdb/yp.c:
	    "struct search_info *" was old style, declaration, new one is
	    "search_info *"

	* smtpserver/policytest.c:
	    Search for the first unquoted at-character in the input
	    address -- for things like:  <"foo@bar.foo"@bar.foo>
	    (Not that I particularly like the idea of supporting this
	     kind of addresses -- people using them are prone for
	     nasty surprises.   And frankly I am afraid they might
	     get past relay-hijack blocking methods too...)

	* smtpserver/smtpserver.c:
	    The same-ip-connect-source registration, and trapping
	    needs a bit of rearrangements -- namely the subprocess
	    must wait enough for it to become registered for sure..
	    Now in front of nearly all exit() calls is sleep(2),
	    which tries to ensure that the subprocess will exist
	    long enough for the main server to be able to register
	    it before subprocess' death.

	* utils/makedb/makedb.c:
	    - policy compilation shall reject all inputs with
	      invalid contents
	    - alias compilation shall treat extended input lines
	      as such where the previous line is has appended ","
	      at the end.

	* router/rfc822.c:
	    Set trace header ("Received:" header) date to be that
	    of the input spool file mtime.
	
Mon Oct 27 09:51:02 1997  Matti Aarnio  <mea@zmailer.org>

	* doc/guides/procmail:
	    Condensed wisdom on how to use procmail in place of the
	    "mailbox" local delivery channel for user deliveries.

	* doc/guides/cyrus-imap:
	    Edit version the "procmail" guide with relevant info regarding
	    CMU Cyrus message store.

	* scheduler/readconfig.c:
	    Match documents about parameterless clauses.

	* compat/sendmail/sendmail.c:
	    Ignore (silently) all '-oXXXX' options we don't recognize.

	* router/libdb/selfmatch.c, proto/cf/rrouter.cf:
	    Corrections for selfmatch routines from
		Darryl Miles <dlm@g7led.demon.co.uk>

	* scheduler/scheduler.c, scheduler/threads.c, scheduler/agenda.c:
	    Use controlled per facility symbol splaytrees, and shrink
	    them when the symbol is no longer needed. (i.e. channel,
	    and hostnames come and go..)

Sun Oct 26 03:30:08 1997  Matti Aarnio  <mea@zmailer.org>

	* include/splay.h, lib/splay.c, lib/symbol.c, router/db.c,
	  router/conf.c, router/prototypes.h, router/router.c,
	  router/libdb/incore.c:
	    Seriously limit the amount of memory needed to handle
	    operative symbols.  Perhaps there is (after all) no
	    need to have infinite memory capacities.
	    (Each object cache has its own namespaces, and when
	     the need for some named object disappears, it is
	     removed from the namespace.)

Wed Oct 22 22:38:10 1997  Matti Aarnio  <mea@zmailer.org>

	* Releasing 2.99.49p8 to public after series of compilation,
	  and running tests at various platforms.  These include:
	  Linux/ELF/libc5, Linux/AXP/glibc2, Solaris 2.5, DEC UNIX 4.0

	* libsh/io.c:
	    glibc loader complained about the use of 'gets()', removed
	    the unused code block.

	* utils/vacation/vacation.c:
	    #include <limits.h>

	* utils/vacation/Makefile.in, libc/myhostname.c:
	    Revised the routine not to use  gethostbyname(), and
	    finally realized that all it missed was -lresolv library..

	* libc/getnameinfo.c, libc/getaddrinfo.c, include/netdb6.h,
	  configure.in:
	    Corrected and completed the --with-ipv6-replacement-libc
	    configuration parameter functionality

	* smtpserver/rfc821scn.c:
	    Corrected  <v6dotnum> object scanning

	* proto/db/localnames:
	    Default content of the file is EMPTY, not nic.funet.fi's
	    hostname listing...

	* proto/Makefile.in:
	    Per default install also files:
		$MAILSHARE/smtpserver.conf
		$MAILSHARE/router.cf
	    if they are not present at the system

	* compat/sendmail/sendmail.c, man/sendmail.8:
	    Sync "-t" option with sendmail, and especially so with
	    the manual page!
	
Mon Oct 20 09:46:04 1997  Matti Aarnio  <mea@zmailer.org>

	* Makefile.in:
	    Version 2.99.49p8  (way too many p6* versions around..)

	* Makefile.in, configure.in, utils/Makefile.in,
	  utils/makedb/Makefile.in, proto/fullnamealiasmaker.pl,
	  proto/newaliases.in, proto/newdb.in, proto/smtpserver.conf.in,
	  utils/makedb/makedb.c, utils/makedb/dblook.c,
	  utils/policy-builder.sh.in:
	    Renamed 'makendbm' to 'makedb', and 'ndbmlook' to 'dblook'.

	* smtpserver/policytest.c, smtpserver/policytest.h,
	  utils/makedb/makedb.c, utils/makedb/dblook.c, router/db.c,
	  router/libdb/search.h, router/libdb/bsdhash.c:
	    Created 'BHASH' type database which is BSD DB_HASH

	* configure.in:
	    - Fix  --without-fsync  option
	    - Fix test on  malloc_d
	    - Add option:  --with-ipv6-replacement-libc

	* include/splay.h, lib/splay.c:
	    Keep track of elements on the splay tree for debug porposes
	    (who is leaking memory at the router..)

	* libc/getaddrinfo.c, libc/getnameinfo.c:
	    Sync with Craig Metz's versions 1.26 and 1.32 respectively.

	* proto/db/smtp-policy.src, smtpserver/policytest.c,
	  smtpserver/policytest.h:
	    Do testing on connection source IP reversal domain too.
	    This allows us to detect certain set of dial-in users who
	    abuse dial-in series to post spams...

	* smtpserver/mxverify.c:

	* transports/smtp/smtp.c:
	    More armour on host connection retry, and giveup on scheduler
	    shutdown.

	* utils/vacation/vacation.c:
	    Do message production without invoking  /usr/lib/sendmail
	
Fri Aug  8 18:04:06 1997  Matti Aarnio  <mea@zmailer.org>

	* Makefile.in:
	    Version 2.99.49p6  (could it be ?)

	* proto/db/smtp-policy.src, doc/guide/smtp-policy, include/policy.h,
	  smtpserver/policytest.c, smtpserver/readpolicy.c, README.SPAM:
	    Updated documentation to match code, added policy parameters:
		'acceptifdns {+|-}'
	    which accepts recipient address when it has MX or A (or AAAA)
	    record in the DNS.

Thu Aug  7 23:00:52 1997  Matti Aarnio  <mea@zmailer.org>

	* Makefile.in:
	    Version 2.99.49p6a3

	* SiteConfig.in, scheduler/scheduler.c, scheduler/update.c:
	    Eugene Crosser's SYSLOGFLGs for the scheduler.

	* scheduler/threads.c, scheduler/update.c:
	    A weird null-pointer derefferrence problem with gcc 2.7.2.1
	    at DEC UNIX 4.0 -- perhaps it is about gcc bug...

	* include/policy.h, proto/db/smtp-policy.src,
	  smtpserver/Makefile.in, smtpserver/mxverify.c,
 	  smtpserver/policytest.c, smtpserver/readpolicy.c,
	  smtpserver/policytest.h, utils/makendbm/makendbm.c:
	    Understand new policy parameters:
		'senderokwithdns {+|-}'
		'acceptifmx {+|-}'
	    of which the first (when existing) uses DNS lookup to
	    verify that the source address is acceptable, and the
	    second uses DNS to check that we are MX for the given
	    target domain. '+' means 'yield SOFT (4XX) error', and
	    '-' means 'yield HARD (5XX) error'...

	* smtpserver/smtpserver.c:
	    Eugene Crosser's syslog fix

	* smtpserver/smtpserver.c, util/policy-builder.sh:
	    If policy database is defined, but can't be opened,
	    smtp-server responds "400 Policy database problem, code=NN"
	    to every command (except 'help' and 'quit').
	    The codes mean: 1: Unknown db format, 2: db open failed

	* smtpserver/smtpcmds.c:
	    A mistake in character counting in RFC821_822QUOTE macro.

	* router/rfc822.c:
	    Detect if scheduler job-description file writing has
	    a fault, and give up.  The job will go into deferred
	    directory, from whence it should be (via cron?) moved
	    back into the router.

	* proto/Makefile.in:
	    Removed various  +XXXX  targets, and touches of them..

	* transports/smtp/smtp.c:
	    When the transport-agent receives 'SIGTERM', it sees if
	    it can die immediately, or if it should take a delayed
	    action on the death issue.  The delayed action is done
	    when the smtp transport is doing '.' write operation,
	    and waiting for the acknowledgement, plus doing diagnostics.

	* utils/vacation/vacation.c:
	    At Alpha, storing LONG_MAX into time_t doesn't work, use INT_MAX.

Mon Aug  4 17:29:26 1997  Matti Aarnio  <mea@zmailer.org>

	* Makefile.in:
	    Version 2.99.49p6a2

	* INSTALL, Makefile.in, proto/Makefile.in:
	    "make install-cf"

	* configure.in, proto/Makefile.in:
	    Make (for installation) proto/scheduler.conf,
	    and its "distclean" removal..

	* router/libdb/bsdtree.c:
	    print_btree() had wrong test in db printout iteration
	    (found while wondering other thing..)

	* utils/makendbm/Makefile.in:
	    Corrected for architecture-subdir compile

	* utils/vacation/vacation.sh.in:
	    Sigh... Give up, and execute the correct binary in case
	    we called user-callable (= wrong) script.

	* router/Makefile.in:
	    Architecture-subdir compile for  rfc822.ssl, and its
	    related use.

	* include/libsh.h, libsh/builtins.c, libsh/trap.c, router/functions.c:
	    Altered  eval()  routine call parameters.
	    Also altered  ZMSH.fc  header format a bit.

Sat Aug  2 19:57:57 1997  Matti Aarnio  <mea@zmailer.org>

	* Makefile.in:
	    Version 2.99.49p6a1

	* router/libdb/ldap.c, router/db.c, router/libdb/search.h,
	  configure.in, config.h.in, router/libdb/Makefile.in.
	  doc/guides/ldap.doc:
	    LDAP db driver by  Lai Yiu Fai <ccyflai@ust.hk>, plus
	    integration, and autoconfig support by yours truly.

	* utils/makendbm/makendbm.c, utils/makendbm/Makefile.in:
	    Massive code rearrange, now "-a" (alias) system does
	    proper continuation line handling too.

	* utils/makendbm/ndbmlook.c:
	    Concise data output dumper code

	* proto/newdb.in, configure.in, SiteConfig.in, proto/cf/*.cf,
	  INSTALL, proto/zmailer.sh.in:
	    Build default database format binary db with command:
	      $MAILBIN/newdb $MAILVAR/db/dbase-basename
	    also have two short-circuit commands:
	      zmailer new-localnames
	      zmailer new-routes

	* libsh/interpret.c:
	    Found, and corrected a bug in ZMSH expression:
	       variable=${1:-defvalue}
	    The mechanism mistreated ARGV values

	* router/db.c:
	    "btree" dbase entry was missing a call to  modp_btree()
	    routine which does exist, but just was never called..

	* router/libdb/selfmatch.c, smtpserver/rfc821scn.c,
	  transports/smtp/smtp.c
	    IETF DRUMS smtpupd draft for IPv6 address literal
	    says:  "[IPv6" SP <rfc-1884-encoded-address> "]"
	    That is, there is SPACE instead of "." after the
	    magic prefix.   Huh!  Quite magic...

	* smtpserver/smtpcmds.c:
	    Handle correctly zero size addresses in MAIL FROM:<>, and
	    (heaven forbid!) RCPT TO:<>.

Fri Jul 25 01:48:13 1997  Matti Aarnio  <mea@zmailer.org>

	* Makefile.in:
	    Version 2.99.49p5

	* All Makefile.in files, configure.in:
	    mechanics to compile in VPATH environment, and to install
	    with  "prefix=/my/tmp/root make install"

	* config.h.in, configure.in, router/db.c, router/libdb/hostsfile.c:
	    Tests for  gethostent() sethostent() and endhostent()

	* include/ta.h, transports/libta/ctlopen.c:
	    New "DSN" object parsing: INPTR=

	* libsh/interpret.c:
	    ssift attribute string dequotation mechanics rewrite
	    (correcting operation, avoiding core-drops..)

	* man/smtpserver.8, smtpserver/cfgread.c, smtpserver/smtpserver.c,
	  smtpserver/smtpserver.h:
	    Syncing man-pages with the reality, new
	        PARAM ListenQueueSize nnn
	    runtime parameter with default value of 20 000.

	* proto/cf/i-smtp.cf, proto/cf/map.cf

	* proto/scheduler.conf, scheduler/scheduler.c:
	    channel/host selector:  chan/*.{fii,foo}

	* proto/scheduler.conf, proto/sm.conf.in, proto/cf/standard.cf
	    'bitbucket' channel

	* scheduler/scheduler.h, scheduler/readconfig.c, scheduler/threads.c:
	    "queueonly" flag by Alexis Yushin <alexis@NL.net>

	* smtpserver/policytest.c:
	    Ascii-mode debug printing routines by
	    Eugene Crosser <crosser@online.ru>

	* moved: support/vacation/ -> utils/vacation/

	* transports/expirer/expirer.c, transport/expirer/Makefile.in:
	    New transport agent with thought of it becoming a tool
	    for the scheduler, but apparently it is also well suited
	    for manual operation.  Docs are missing..

	* transports/libta/writeheaders.c, transports/hold/hold.c,
	  transports/mailbox/mailbox.c, transports/smtp/smtp.c,
	  transports/sm/sm.c:
	    Moved implicite newline after header write out of the
	    writeheaders() routine into each caller.  Thus became
	    able to do smart things with mailbox; ORCPT XTEXT decoding,
	    for example.

	* transports/mailbox/mailbox.c:
	    When writing to a pipe, don't care if the write stops
	    due to some error, but if the pipe end-point process
	    exists with non-zero status, THEN become upset!
	    (Still something mysterious with pipe reports -- I see
	     positive reports even when I don't ask for them..)

	* transports/smtp/smtp.c:
	    Error reporting correction in one rare case, and
	    general streamlining.

Fri Jul  4 14:54:02 1997  Matti Aarnio  <mea@zmailer.org>

	* Makefile.in:
	    Version 2.99.49p4

	* router/rfc822.c:
	    Nuke headers: "Bcc:", "Return-Path:", "X-Orcpt:", "X-Envid:",
	                  and respective "Resent-*:" variants

	* router/libdb/bsdbtree.c:
	    If the db can not be opened ( open_btree() returns NULL ),
	    don't crash on it..

	* scheduler/msgerror.c:
	    In case the report we are composing does have "NOTIFY=NEVER"
	    in effect, but no valid recipients exist, ignore any such
	    NOTIFY value, and return the message in full -- to the system
	    postmaster...

	* transports/mailbox/mailbox.c:
	    Found a bug in let_buffer[] reuse -- it was an "automatic"
	    variable, that is, stack reclaimed it in between message
	    deliveries, and of course were able to corrupt it!
	    I also enlarged the  let_buffer[]  size to be of reasonable
	    size -- 16k to 64k depending on your BUFSIZ value.

	* transports/mailbox/mailbox.c:
	    Add headers "X-Orcpt:" and "X-Envid:" to the message when
	    storing it into a file.  For a pipe the data is passed in
	    envelope variables.  (I got rather fed up with spams this
	    morning, and decided to add a bit more trace as to whom
	    the message has been sent originally..)

	* transports/smtp/smtp.c:
	    Accept non rfc-821 behaviour of the remote server by treating
	    non-conformant reply of form:  "NNN<CRLF>" the same as
	    conformant reply of form: "NNN<SP><CRLF>".

Sun Jun 29 21:36:43 1997  Matti Aarnio  <mea@zmailer.org>

	* Makefile.in:
	    Version 2.99.49p3

	* configure.in, config.h.in, transports/libta/ctlopen.c,
	  transports/mailbox/mailbox.c, transports/sm/sm.c,
	  transports/smtp/smtp.c:
	    Configuration option:  --with-ta-mmap   which uses  mmap()
	    facility to map in pages of the message data.
	    At least at Solaris 2.x it is not advisable to use if you
	    want to have highest possible performance, because the
	    munmap() throws away ALL pages of the file from the system
	    memory, even when other users have those pages in use!
	    For that reason it is much better to rely on plain simple
	    read()/write()  behaviour that let buffer cache to exist.

	* configure.in:
	    Configuration option:  --without-fsync
	    Option that turns off (globally) the use  fsync()  anywhere
	    in the ZMailer.   System configurers can decide what is best
	    for their systems.  It does give definite edge at buffered
	    IO by not forceing every file modification to be commited
	    up to the disk.

	* smtpserver/rfc821scn.c:
	    Alteration at the treatment of "!" and "%" characters. Now
	    they are special, and are analyzed in more profound manner
	    within localpart analysis.


	* smtpserver/smtpchild.c:
	    Register, and analyze properly how many SMTP sessions are
	    currently active (non-reaped) from any given source IP
	    address.
	
	* transports/smtp/smtp.c:
	    Correction into notary-status-code pickup for ENHANCEDSTATUSCODES
	    mode.
	
	* libsh/testeval.c:  (+ several of  proto/cf/*.cf files)
	    New operators into the builtin 'test' function:  -nt, -ot, -ef
	    (file age comparators, and file equality comparator)

	* SiteConfig.in, router/rtsyslog.c, smtpserver/smtpserver.c,
	  transports/libta/tasyslog.c:
	    New ZENV entry:  SYSLOGFLG=
	    which can be used to turn off syslog() logging activity
	    at the  smtp-server/router/transport-agents

	* config.h.in, configure.in, router/router.c, scheduler/scheduler.c:
	    Check of  setgroups()  routine, and at both the router, and
	    the scheduler, use both to clean out the set of supplementary
	    groups the processes have.

	* include/hostenv.h:
	    Concise USE_ALLOCA/HAVE_ALLOCA defines

	* libident/identuser.c:
	    Be a bit more tolerant at what comes back as response
	    for the ident query.

	* libsh/interpret.c, router/functions.c:
	    A bit more smarts into quote containing string processing;
	    Especially when dequoteing string that contains only one
	    char: ' or " ...

	* proto/cf/i-routes.cf:
	    Accept incore database of form:   $MAILVAR/db/routes.zmsh
	
	* router/libdb/headers.c:
	    Allow   "Reply-To:" and "Resent-Reply-To:" to have value: "<>"
	    (sigh...  It is against RFC-822, but I see such usage few times
	     each day...)

	* scheduler/msgerror.c, transports/errormail/errormail.c,
	  transports/fuzzyalias/fuzzyalias.c, transports/mailbox/mailbox.c:
	    Stronger MIME-report boundary generator which isn't merely
	    stocastic, but very likely unique at the creation time.

	* smtpserver/policytest.c, smtpserver/policytest.h:
	    Move policy-database open out from database define
	    routine.

	* smtpserver/policytest.c:
	    - Study "rejectsource" at HELO/EHLO parameter check
	    - For the RCPT TO:<..> study also the full addresses
	      in addition to the domain part

	* smtpserver/smtpcmds.c, smtpserver/smtpserver.c:
	    - Print out the incoming HELO/EHLO parameter as is
	      into comment at  "rcvdfrom"  envelope header along
	      with many other bits of info.
	    - Change policy-rejection responses from:
	        553 5.1.8 ...
	      to:
		553 5.7.1 ...

	* ssl/ssl.c:
	    Conflicting routine name within the ssl.c program: basename()
	    ( Linux libc6 a.k.a. glibc-2.0.4 .. )

	* support/vacation/vacation.sh.in:
	    Modifications into 'vacation start' command behaviour.

	* transports/mailbox/mailbox.c:
	    Found a couple off odd situations where creation of files
	    into non-kosher location was allowed; partly corrected with
	    the purge of supplementary groups at the scheduler, partly
	    with a bit of new code.

	* transports/smtp/smtp.c:
	    Recognize (unknown) smtp response value 571 to be a sign of
	    policy based refusal.

	* utils/makendbm/ndbmlook.c:
	    At Debian systems including <errno.h> causes surprises at
	    parameters called 'errno' ... rename such parameters.

Sun Jun 22 04:57:02 1997  Matti Aarnio  <mea@zmailer.org>

	* Makefile.in:
	    Version 2.99.49p2

	* configure.in:
	    sprintf() return type testing fix
 	
	* include/hostenv.h:
	    Too many files need to include  <string.h>,  thus
	    we added it into  "hostenv.h"... (for SunOS 4.1.x)

	* libc/getaddrinfo.c, libc/getnameinfo.c:
	    "extern int h_errno;" added

	* proto/cf/SMTP+UUCP.cf.in
	    More suitable, and more generic version

	* smtpserver/smtpcmds.c:
	    A fix in ORCPT pseudo-formation in case the original
	    sending system did not use the option..

	* support/vacarion/vacation.c:
	    Properly placed  'extern char * strerror();'

	* transports/libta/diagnostic.c:
	   Again optimize int returning sprintf better, than
	   the old char * returning...

Thu Jun 19 19:41:47 1997  Matti Aarnio  <mea@zmailer.org>

	* Makefile.in
	    Version 2.99.49p1
	
	* configure.in:
	    Reordered (and changed default) of  --with-libmalloc=
	    option parameters

	* lib/selfaddrs.c:
	    Detected that SunSoft SunPro C 3.0 didn't define
	    '__svr4__', but does '__SVR4' -- automatic Solaris
	    support failed due to that..

	* libsh/listmalloc.c:
	    Debugged, and got it finally working..  (something for
	    Zmailer 3.0 ...)

	* smtpserver/smtpcmds.c:
	    Freed memory blocks that were not malloc()ed at all..

	* transports/libta/diagnostic.c:
	    'notarybuf' can be a NULL pointer, prepare for it!

	* utils/makendbm/makendbm.c:
	    Just some casts to please SunOS 4.1.x compilation

Fri Jun 13 22:41:04 1997  Matti Aarnio  <mea@mea-koti.tmt.tele.fi>

	* Makefile.in:
	    Version 2.99.49

	* README.PERFORMANCE:
	    Added some notes about what performance figures we have achieved
	    with this beast

	* ALL SOURCE FILES (more or less):
	    - Threw in 'const' before 'char *', and got a LOT of changes all
	      around
	    - Converted lots and lots of places of 'unsigned char' into
	      'char' -- in very few cases also chopped off extra-high
	      bits loading unsigned chars from strings when needed.
	    - Added function prototypes all around, and fixed a couple
	      real bugs in rarely used parts of the system
	    - changed all instances of 'struct conscell' into 'conscell'
	      (typedefed object) for a later jump in altering the
	      conscell object handling sometime later in the developement.

	* lib/strlower.c, lib/strupper.c:
	    New library routines

	* smtpserver/readpolicy.h, smtpserver/policytest.c,
	  smtpserver/policytest.h, README.SPAM, man/smtpserver.8:
	    Integrated policytest()/policytestaddr() routines with
	    compiled in logics of earlier Gabor Kissigs interactive
	    router subprocess based system without the need to run
	    the router as a subprocess...

	* utils/makendbm/makendbm.c, utils/makendbm/ndbmlook.c:
	    Integrated support for policy-db compilation

	* proto/db/smtp-policy.src, utils/policy-builder.sh:
	    Sample policy database (header), and sample policy-db
	    builder

	* scheduler/update.c, transports/libta/diagnostic.c:
	    "ok3" status message for cases where transporter was
	    able to relay the DSN into to the next link, thus we
	    have no mandate to report successfull relaying, like
	    "ok2" and "ok" would do.

Fri Jun 13 22:41:04 1997  Matti Aarnio  <mea@mea-koti.tmt.tele.fi>

	* Makefile.in:
	    - Version 2.99.48p4

	* doc/design/zmog.tex:
	    - Corrected two typos, and were able to compile it
	      with command "tex zmog"

	* lib/selfaddrs.c, libc/inet_ntop.c, libc/inet_pton.c,
	  libident/identuser.c, router/libdb/bind.c,
	  router/libdb/selfmatch.c, smtpserver/smtpserver.c,
	  transports/smtp/smtp.c:
	    Modified plain '#ifdef AF_INET6' into more complex:
	    '#if defined(AF_INET6) && defined(INET6)'

	* transports/libta/diagnostic.c:
	    Under some obscure reasons, autoconfig of the sprintf()
	    return value did get it wrong at SunOS 4.1.4..
	    Coded the diagnostic without conditional optimization
	    based on the return value type.

	* libc/getaddrinfo.c, libc/getnameinfo.c, include/netdb6.h:
	    Pulled from 2.99.49beta10 -- with seriously rewritten
	    DNS code.

	* transports/smtp/smtp.c:
	    Allow talking to self host in case the destination port is
	    a non-standard port -- not port 25, that is.

Wed May 28 11:03:42 1997  Matti Aarnio  <mea@zmailer.org>

	* Makefile.in:
	    - Version 2.99.48p3

	* config.h.in, configure.in, configure:
	    Pulled these from 2.99.49beta7:
	    - timezone autoconfiguration
	    - IPv6 in use with ONLY an explicite  --with-ipv6  option!

	* transports/sm/sm.c, transports/smtp/smtp.c,
	  transports/mailbox/mailbox.c:
	    "readalready" cache handling in case the MMAP is not
	    recognized properly (IBM AIX has problems at the auto-
	    detection of that feature..)

	* smtpserver/smtpserver.c, smtpserver/smtpcmds.c,
	  smtpserver/smtpdata.c:
	    - Wrong parameters in one logging call at the  BDAT  processing,
	    - Rearranged typeflush() calls, and pipeline status reporting.

Fri May  2 16:10:28 1997  Matti Aarnio  <mea@zmailer.org>

	* Makefile.in:
	    - Version 2.99.48p2
	
	* BUGS
	    Noticed problem at scheduler ETRN -> results in
	    busy spin...

	* man/aliases.5:
	    A new man-page...

	* proto/cf/fqdnaliases.c:
	    Missing quotes from the script

	* proto/scheduler.conf:
	    Sample scheduler.conf file with tags for three
	    different channel = local  -cases:
	      - local/file*
	      - local/pipe*
	      - local/*
	    The "local/*" may be run with "sm" to use procmail,
	    or cyrus (for example) for deliveries to users.
	    The "sm" (procmail in particular?) is unable to do
	    pipe-feeds, nor storing to files, it seems.
	    (Also gave an example of 'punt' on smtp..)

	* smtpserver/smtpcmds.c:
	    Removed obsolete special case ESMTP token: X-TURNME

	* transports/errormail/errormail.c, transports/sm/sm.c,
	  transports/mailbox/mailbox.c, transports/hold/hold.c,
	  transports/fuzzyalias/fuzzyaliases.c, transports/libta/lockaddr.c,
	  transports/smtp/smtp.c:
	     "Make sure we are properly positioned at the start
	      of the message body"  (lseek() things)

	* transports/mailbox/mailbox.c:
	    Save  errno  before doing library calls -- did yield wrong
	    error in case the 'dotlock' was busy.
	
Thu Apr 24 21:00:28 1997  Matti Aarnio  <mea@zmailer.org>

	* Makefile.in:
	    - Version 2.99.48
	    - SiteConfig->zmailer.Config processing  sed  script
	      modifications so that even HP-UX sed does it right..

	* proto/cf/rrouter.cf:
	    Test for a "|.+" was coded wrong, and it never
	    matched for pipes causing stripping of possible
	    ">" from within the pipes..

	* router/router.c:
	    - logit() routine written with different armouring
	      against overlong input, which causes overlong
	      syslog() output, which causes some syslogs to
	      blow up..

	* transports/libta/mime2headers.c:
	    Properly flexible way to do DEFCHARSET definition
	    in runtime also for "MIME-2" (e.g. headers) part.

	* transports/libta/mimeheaders.c:
	    Missing "," from the canned "X-Warning" messages

	* transports/mailbox/dotlock.c:
	    HP-UX has 'long gethostid()' defined in its includes.

	* transports/mailbox/mailbox.c:
	    - Correction on long-term problem on PIPE running,
	      where the pipes practically did not work at all :-/
	    - Expanded diagnostics (while debugging that previous
	      bug...)
	
	* transports/smtp/smtp.c:
	    - ssfgets() got a bit more state into  SmtpState  block
	    - Most (nearly all) sprintf()s are output length limited
	      with "%.200s" -type of format strings

Wed Apr 23 17:58:19 1997  Matti Aarnio  <mea@zmailer.org>

	* Makefile.in:
	    Version 2.99.48-970423

	* configure.in:
	    - Rearranged libresolv autoconfiguration
	    - Test for possible need of -lresolv to satisfy the
	      access to the structure:  _res
	    - Corrected the  RFC822TABS (--without-rfc822-tabs) option
	    - Do GCC optimizer resistant test on existence of
	      external objects, e.g. char *sys_siglist[];
	
	* include/ta.h, transports/libta/tasyslog.c:
	    New parameter (msg) to the  tasyslog()  routine

	* include/zsyslog.h:
	    Yield an error if the system does not have proper
	    <syslog.h>  (TODO: Have acceptable substitutes for
	    that case..)

	* libc/mail.c, smtpserver/smtpdata.c:
	    The  mail_close()  routine is a wrapper for an internal
	    routine that returns information regarding the last status
	    of the spool file for the  smtpserver  to be able to report
	    that at the message reception.

	* router/libdb/header.c, man/zmailer.3:
	    Define the  "rcvdfrom" to require a  "user@address" type of
	    parameter

	* smtpserver/smtpcmds.c:
	    Store the "rcvdfrom" information from the IDENT information.

	* router/rfc822.c, router/router.c:
	    If the system can't resolve internal uname->uid/uid->uname
	    mappings (getpwnam() fails ?), then defer the message.

	    If the message has a "rcvdfrom" header, and the message is
	    not submitted by any of the "trusted" UIDs, replace the "rcvdfrom"
	    information with a new one we fabricate

	* router/rfc822.c, router/rtsyslog.c:
	    router's syslog (rtsyslog()) has a new parameter

	* smtpserver/smtpserver.c:
	    - Don't syslog() anything, unless indicating an error!
	    - Recognize IN6_IS_ADDR_V4MAPPED() type of addresses, and
	      do reversal lookup in proper IPv4 manner.

	* transports/libta/diagnostics.c, transports/libta/tasyslog():
	    - notary_setwttip() to behave in similar manner to notary_setwtt(),
	      but to define the IP address that the host has, and we have made
	      a connection with.
	    - tasyslog() takes that information as a parameter
	    - tasyslog() has new sprintf() format strings with output width
	      limitations

	* transports/libta/mimeheaders.c:
	    Rewrote (somewhat) the text of the "X-Warning:" -lines

	* transports/mailbox/mailbox.c:
	    - The recipient address is properly dequoted, and localized
	      for feeding to the local processing (to a file, pipe, or
	      to store at somebodys mailbox)
	    - HP-UX 9.x oriented: 'fflush() returns an error in case
	      the FP points to a PIPE, but lets hope it won't set ferror()
	      unless it really is an error!'

	* transports/sm/sm.c:
	    - Process bigger let_buffer[]s than before
	    - If the system reads more than one bufferfull, always remember
	      to zero the  'readalready'.

	* transports/smtp/smtp.c:
	    - Report the  notary_setwttip()  along with  notary_setwtt() data
	      for the diagnostics
	    - smtp pipelining code rearrangement completion

	* transports/libta/tasyslog.c:
	    Don't be shy about telling what the return message of the
	    transporter was when tasyslog()ing it, and the code was OK.

Mon Apr 13 19:15:31 1997  Matti Aarnio  <mea@mea-koti.tmt.tele.fi>

	* Makefile.in:
	    Version 2.99.48

	* BUGS:
	    More TODO notes (and a few removed)

	* Makefile.in:
	    More DISTCLEANFILES entries, 

	* SiteConfig.in:
	    New entry:  DEFCHARSET=XXX

	* compat/sendmail/sendmail.c, include/zsyslog.h, ...
	    Replaced all syslog() related things with our own
	    include header, and z** -macroes.

	* config.h.in:
	    IPv6 header tests, RFC822TABS definition.

	* configure.in:
	    - PERL path test
	    - Tests for several different (N|G)DB(M) formats
	    - IPv6 related header tests
	    - Test for the need of resolver library
	    - Configure time option to say wether ot not to use
	      TABs in the RFC-822 headers -- At tele.fi we have
	      customers that CAN'T handle TABs :-(  (The makers
	      of the software with problems agree they made a
	      mistake, but it has quite a bit of installations...)
	    - Attempt to auto-detect  TCP-Wrapper's  tcpd.h, and
	      libwrap.a from several possible locations.
	    - Auto-generate several new files...

	* include/ta.h, transports/libta/lockaddr.c:
	    New parameter: 'int mypid'

	* include/zmsignal.h:
	    - SIGNAL_RELEASE() rewrite for BSD
	    - SIGNAL_HANDLE*() with SA_NODEFER active!

	* lib/esyslib.c:
	    erename() did miss ending 'return 0;'

	* lib/selfaddrs.c:
	    - Better IPv4 self-address detection (IPv6 still partial..)

	* lib/taspoolid.c:
	    - When presented a path, pick only the last part, not "/path"..

	* libc/getaddrinfo.c, libc/getnameinfo.c:
	    - first stabs at the integration of these new ways to
	      pick addresses..

	* libident/identuser.c:
	    - more and more adaptations for our smtpserver use (and
	      to be generic IPv4/IPv6 ident query interface..)

	* smtpserver/*.c, smtpserver/Makefile.in:
	    - Split the server in "zillion" bits from the original
	      monolithic file
	    - Integrated reception time character translation routines
	      as implemented by: Eugene Crosser <crosser@average.org>

	* router/Makefile.in:
	    - New source module:  rtsyslog.c

	* router/rtsyslog.c:
	    Sendmail-like syslog messages
 	
	* router/conf.c:
	    Configure-time option to be able to control the presentation
	    of TABs in the message headers.

	* router/db.c, router/libdb/selfmatch.c, router/libdb/Makefile.in,
	  router/libdb/search.h:
	    - New relation, which can be used to match local addresses
	      in destination addresses of form:   <foo@[1.2.3.4]>
	    - The "relation" command presents lists of available
	      database routines when it is called without arguments

	* router/rfc822.c, router/rtsyslog.c:
	    - Present the addresses in properly quoted format in
	      the transport-specification file
	    - rtsyslog() -- sendmail-like syslog report (still partial)

	* scheduler/msgerror.c:
	    New diagnostic scalar variable: time-of-last-attempt

	* scheduler/threads.c:
	    Change in age-order comparison code, some systems had
	    the qsort() to SIGSEGV..

	* scheduler/transport.c:
	    - Count '#idle' as a command.
	    - FD_* -> _Z_FD_* macro renameing

	* transports/libta/Makefile.in:
	    Missing semicolons

	* transports/hold/hold.c:
	    - Process according to the HOST parameter too, if present!
	    - Understand: NS/AAAA

	* transports/libta/ctlopen.c:
	    - close-on-exec flag set on
	    - Recoded the size estimate -- don't present the incoming
	      message transport envelope size -- at nic.funet.fi it
	      can be well over 100 kB, and the message itself is often
	      mere 1kB or so..  Some systems choke on such a "large"
	      messages..

	* transports/libta/diagnostic.c:
	    - Log the time of the diagnostics write to the TA-spec file
	      into the diagnostics string

	* transports/libta/dnsgetrr.c:
	    IPv6 things

	* transports/libta/mimeheaders.c:
	    Runtime option on what the default character set is at the
	    system (so that everybody need not to use UNKNOWN-8BIT, or
	    ISO-8859-1, or ...)

	* transports/mailbox/mailbox.c:
	    - Runtime option on default charset, when forcibly MIMEfying
	    - Basis for properly localized "user" identity

	* transports/sm/sm.c:
	    - charset system option processing

	* transports/smtp/smtp.c:
	    - charset system option processing
	    - smtp-pipelining processing with explicite flags on when
	      the parameter is really a recipient address, and when
	      the errors are severe, and when not..
	    - ssfgets() -- a timeouting version of  fgets(), which when
	      timeouting, sends a NOOP (or QUIT+close()) to the possibly
	      open SMTP session
	    - Various timeouts are processed with  setjmp()/longjmp(),
	      however NOT with POSIX  sigsetjmp()/siglongjmp(), which
	      in fact doesn't much help, unless you know for sure that
	      you can accept the signal mask that the sigsetjmp() has
	      saved for you...
	    - Use my interface-derived name for the HELO/EHLO parameter
	    - smtp_sync() internal logic refurnished
	    - calling error of  ranny()  on the randomization of the MX-
	      entries of same preferrence

	* proto/db/aliases.in, utils/autoanswer.pl.in:
	    - Alias of 'autoanswer: "|$MAILBIN/autoanswer.pl"'
	    - Autoconfiguring the runtime path of PERL
	    - New routine to do automatic replying to whoever
	      sent the original query

Sat Mar 15 02:54:06 1997  Matti Aarnio  <mea@mea-koti.tmt.tele.fi>

	* Makefile.in
	    Version 2.99.47
	
	* BUGS:
	    Notes on what is missing on IPv6 front yet..

	* config.h.in, configure.in:
	    HAVE_SA_LEN -- BSD 4.4 sockaddr sa_len -field

	* configure.in:
	    - Some rearrangements to try to autodetect  tcpwrapper
	      library in the system
	    - Detect (and possibly provide replacements) of IPv6
	      basic API functions:  inet_ntop(), inet_pton(), getaddrinfo(),
	      getnameinfo(), gai_strerror(), freeaddrinfo()

	* include/libc.h, include/netdb6.h, libc/gai_strerror.c,
	  libc/getaddrinfo.c, libc/getnameinfo.c, libc/inet_ntop.c,
	  libc/inet_pton.c:
	    Spare-copies of these routines in case a  -linet6, or
	    libc containing them is not in use...

	* compat/sendmail/sendmail.c:
	    Ignore sendmail option -odb (as well as -obd)...

	* include/ta.h, include/dnsgetrr.h:
	    Separate DNS query routine protos into their own file

	* libresolv/gethnamaddr.c:
	    Modified entrypoints to provide parameter on which to return
	    the TTL value of the queried data.

	* router/conf.c:
	    Add 4th default name for possible "daemon" --> "daemons" on
	    some newest SGIs..

	* scheduler/msgerror.c:
	    Moved repeated (big!) codesegment into separate procedure,
	    and schrunk the error reporter a bit with that...

	* scheduler/transports.c:
	    Oh my...  _FD_SET et.al. are defined on some systems! Renamed them.

	* scheduler/update.c:
	    Cosmetic changes actually..  (while debugging msgerror.c)

	* smtpserver/rfc821.c:
	    New  rfc821_v6dotnum() -routine.

	* smtpserver/smtpserver.c:
	    - Bug in 2.99.46psomething, which broke ENVID= parameter
	      parsing routine..
	    - Initial cut on IPv6 things

	* transports/hold/hold.c, transports/smtp/smtp.c,
	  transports/libta/dnsgetrr.c:
	    - First partial stabs at IPv6
	
Mon Feb 17 22:30:06 1997  Matti Aarnio  <mea@mea-home.tmt.tele.fi>

	* transports/mailbox/dotlock.c:
	    A HPUX `gethostid()' routine from <dd@mv.us.adobe.com>
	    (David DiGiacomo) via Sven Goldt <goldt@informatik.tu-muenchen.de>
	    who found out why the mailbox program keeps crashing on
	    the HPUX.

Fri Feb 14 20:29:25 1997  Matti Aarnio  <mea@zmailer.org>

	* lib/esyslib.c: erename(), eqrename()
	    Rewrote  eqrename()  cleanly in model of Andy Poling's
	    ideas -- he observed surprising amounts of duplicate
	    delivery while using  rename(2) instead of link(2)/unlink(2)
	    systemcalls for acquiring a lock on the messages.

	* transports/smtp/smtp.c:
	    Classify "DNS inconsistency, No MX, no A" message
	    a bit better.  There are four main categories, and
	    the "we are the best mx" could be divided still..

	* libsh/interpret.c:
	    Count on how many recursions we have done, and if exceed
	    some limit (like 100), we are highly likely doing something
	    seriously wrong.  Abort before getting a SIGSEGV from stack
	    overflow error. (All is rotten, but the diagnostics of the
	    death is a lot easier...)

	* proto/cf/aliases.cf:
	    Loop-cut 'expansions' testing keying was flawed, and
	    a person with a '.forward' was able to cause a serious
	    loop that lead to memory exhaustion in pretty short order..

Sat Feb  8 00:19:06 1997  Matti Aarnio  <mea@zmailer.org>

	* compat/sendmail/sendmail.c, configure.in, lib/esyslib.c,
	  libs/Makefile.in, router/rfc822.c, smtpserver/relaytest.c,
	  smtpserver/relaytest.h, smtpserver/smtpserver.c,
	  utils/makendbm/makendbm.c, proto/scheduler.conf, ChangeLog:
	    A heap of "minor" fixes to all around to improve this
	    compilability in various systems besides my RedHat Linuxes.

Thu Feb  6 19:00:24 1997  Matti Aarnio  <mea@zmailer.org>

	* Makefile.in:
	    patchlevel 46 -- time for a release..

	* router/functions.c, proto/aliases.cf, proto/crossbar.cf, proto/canon.cf:
	    New router-zmsh routines:  $(dequote .. ) $(condquote .. )
	    To provide support for having an alias entry like this:
		"The Space Head": st-tng
	    (And simplify the scripts to remove special patterns tried
	     for space-processing...)

Wed Feb  5 10:02:20 1997  Matti Aarnio  <mea@mea-koti.tmt.tele.fi>

	* utils/makendbm/makendbm.c:
	    Runtime option (switch)  -a  to process alias-like input
	    (keys are RFC-821-quoted strings) that follows format:
	       keyname: LWSP value,value2,value3
	    Thus allowing feeding the output of  printaliases  routine
	    to  makendbm for creating some real dbase, instead of indirectly
	    indexed ordered flat ascii file..

	* libsh/sh.ssl:
	    A new way to code white-space into '*sift' patterns by using
	    paired quotes:  'text with " dbl quote'"' and single quote"
	           Strings: -111111111111111111111--222222222222222222-
	    There '-' are ignored, and chars of '1', and '2' are taken in.
	
	* proto/cf/aliases.cf, proto/cf/crossbar.cf:
	    Recognize (with special pattern) that the local address contains
	    spaces, and do add quotes to it! (Similarly for 'internet' rewrite
	    rule..)
	
	* INSTALL, proto/cf/fqdnalias.cf, proto/newfqdnaliases.in,
	  proto/db/fqdnaliases:
	    A new routeing mechanism:  fqdnalias

	* Overview:
	    Added one new performance benchmark result

	* README.UPGRADING, scheduler/update.c, transports/libta/ctlopen.c,
	  transport/libta/diagnostic.c:
	    Due to a change at  transports/libta/diagnostic.c, and its
	    counterpart within  scheduler/update.c, new transport agents
	    might not work with old scheduler -- it is a matter of linking
	    the TA with the new library.

	* compat/sendmail/sendmail.c, smtpserver/smtpserver.c:
	    Do proper RFC821->RFC822 syntax quoting of possible backslashfull
	    addresses:  \rfc821@domain --> "\rfc822"@domain

	* config.h.in, include/syslog.h, libc/syslog.c
	    HAVE_SYSLOG_H -- mark also if (or if not) we have <syslog.h>
	    in the system.

	* libident/identuser.c, include/identuser.h:
	    A thorough rewamp of things -- to make sure no buffer overflows
	    will occur due to a hostile data..

	* include/libz.h, lib/rfc822scan.c, router/functions.c,
	  router/rfc822.c, router/rfc822hdrs.c:
	    When doing address list expansions, process each LINE of the
	    input as a sole container of the address -- if there is some
	    address like:  "@foo.domain" in a line, previously this became
	    catenated with the next line as: "@foo.domain:faa@fii"

	* include/ta.h, transports/libta/tasyslog.c:
	    New generic tasyslog() to log out transport-agent
	    report in similar manner to that of the  sendmail(8).

	* proto/Makefile.in:
	    Build/don't build some new/old dirs.
	    Especially builds the hash-subdirs for the scheduler!

	* lib/Makefile.in, lib/taspoolid.c:
	    New generic tasyslog() support routine to build unique
	    spoolids by catenating a base-64 encoded mtime of the
	    email contents file, and the inode number of that file.

	* lib/prversion.c:
	    Year change -- Copyright 1992-1997

	* proto/cf/aliases.cf:
	    Handle all variants of list  owner-, -owner, and -request
	    address injections neatly.  Does not set list outbound
	    sender to be  owner-listname, though!  (See aliases-vger.cf)

	* proto/cf/rrouter.cf:
	    - recognize addresses that start with a pipe character, and
	      DON'T mess with them with the focus testings!
	    - Handle backquote-prefix properly (i.e. strip it..)
	    - Detect feed to files (or X.400 address..)
	    - If the `fullnames' database, nor `newsgroup' database
	      found anything, try handling it in aliases database.

	* router/libdb/headers.c:
	    Moved two headers into "unknown" category, where we won't be
	    checking on them:  keywords, references

	* router/libdb/ordered.c, router/libdb/unordered.c:
	    scan over the first token with  skip821address() -- now I can
	    do aliases with quotes on the left-side, and spaces in them!

	* router/rfc822.c:
	    Bugfix: wrong pointer picked for recipient attribute causing
	    more or less mysterious crash..

	* router/rfc822hdrs.c:
	    New form of the generated Message-Id:
	      <yyyymmddhhmmssZspoolid+seq@mydomain>
	    It is slightly shorter than the previous one, and definitely
	    a lot more sortable..

	* scheduler/msgerror.c:
	    - Slight improvement on handling spacefull 'host' object
	      (and 'user' object too..)
	    - Threw away a 'dnsrecipient' information pointer, and
	      updated error log writers/parsers for it.

	* scheduler/scheduler.c, scheduler/scheduler.h, scheduler/update.c:
	    Will not keep 'contents' of the TA-spec file in memory for very
	    long -- only up to the initial scheduling input of the message.

	* smtpserver/relaytest.h smtpserver/relaytest.c:
	    Some more code -- "flesh on the bones", but not yet usable..

	* smtpserver/smtpserver.c:
	    Tried to alter the code to carry around a 'content' package
	    so that perhaps someday the smtp-server can be threaded (or
	    some such), and each thread runs with its own content.

	* transports/libta/diagnostic.c, transports/mailbox/mailbox.c,
	  transports/smtp/smtp.c:
	    Doing 'sendmail(8)' like syslog data preparation
	
Sat Jan 25 15:18:08 1997  Matti Aarnio  <mea@mea-home.tmt.tele.fi>

	* libsh/interpret.c, libsh/tregexp.c:
	    Trace  SSIFT/TSIFT statements with clearly differentiated
	    "trace compare/trace match" statements -- namely report
	    "tcomparing 'pattern' and 'string'" for the  TSIFT, and
	    "scomparing 'pattern' and 'string'" for the  SSIFT
	    (and "smatched"/"tmatched" for matches likewise..)

	* proto/cf/rrouter.cf:
	    Where that trace change was motivated... was something
	    that I had implemented sloppily in a ssift statement...
	    Namely I noticed, that the "fullname expansion traps
	    ':include:/path/to.file' into itself, and fails".  Then
	    I had decided to implement a test for RE "^[^.:]+\.[^.]+$"
	    (where the starting/ending limiters are implicite in ssift!)
	    but that RE has a fault of matching only ONE dot -- so no
	    "foo.bar.bat" is matched with it, while it correctly does
	    not match cases where the part before that dot has a colon
	    (from ":include:").

	    Now I test at first for explicite case of ":include:", and
	    only then test for dotfull names.

	    I am still uncertain if we should not rewrite it entirely
	    differently -- to move also fullname/newsgroup map tests
	    inside the $(routeruser ..) routine, and thus be able to
	    allow  sendmail -like aliases where dotfull names can be
	    in the standard aliases as well.

	* smtpserver/smtpserver.c, proto/smtpserver.conf,
	  smtpserver/Makefile.in, smtpserver/relaytest.h,
	  smtpserver/relaytest.c:
	    Some more coding of multi-db-format query lookups of
	    service limitation mechanisms.

	* utils/makendbm/ndbmlook.c:
	    Yet another parametrization error in the DB code..
	    (A non-fatal one, I presume.. affected only GDBM)

Sat Jan 18 07:11:07 1997  Matti Aarnio  <mea@zmailer.org>

	* Makefile.in:
	    Patchlevel 45

	* Makefile.in:
	    Command: "make install-bin" will not overwrite existing ZCONFIG
		     file!

	* compat/sendmail/sendmail.c:
	    Accept (and silently ignore)  "-ob*" -options.

	* configure.in, config.h.in:
	    - Have  --with-yp  -option
	    - Test for  res_init()  instead of  gethostbyname()  to see
	      if the system provided libraries are enough, or if more are
	      needed (like  -lresolv)
	
	* libsh/interpret.c:
	    - fapply() to accept up to 30 parameters in a linked list

	* proto/Makefile.in:
	    Remove the creation of "MAILBIN/bin/", which is about same
	    as creating   "MAILSHARE/bin/bin/", which is stupid...

	* router/libdb/ordered.c:
	    - test mmap() error return in a bit more generic way
	    - scan the buffer for the number of lines by executing
	      a bit better constrained scan - than the previous one was..

	* router/shliaise.c:
	    - Got rid of  svstack[]  arrays in  l_apply(), and  s_apply()
	      routines

	* scheduler/Makefile.in:
	    - If using TCP-Wrapper stuff, have related INCLWRAP, and LIBWRAP
	      definitions in use -- for the mailq access control
	
Tue Dec 24 00:23:32 1996  Matti Aarnio  <mea@zmailer.org>

	* all transporters:
	    Process  SIGQUIT as marker for desire of termination.
	    That is, equal to earlier SIGTERM behaviour, but with
	    a bit less urgent death.

	* scheduler/scheduler.c, scheduler/threads.c, scheduler/transport.c:
	    An attempt to create an orderly shutdown; send the
	    scheduler signal SIGQUIT will activate this behaviour.

	* Makefile.in:
	    When "make dist", at first do  "chmod -R a+rX" to turn on
	    all read-, and some x-bits.

	* SiteConfig.in, configure.in:
	   Autoconfigure preferred DBTYPE, and default extension for it.
	   From  SiteConfig.in  it will propagate to  /etc/zmailer.conf
	   (or where ever that one is..)

	* compat/rmail/Makefile.in, compat/sendmail/Makefile.in,
	  router/Makefile.in, scheduler/Makefile.in, smtpserver/Makefile.in,
	  transports/mailbox/Makefile.in, transports/sm/Makefile.in,
	  transports/smtp/Makefile.in, utils/makendbm/Makefile.in,
	  support/utils/Makefile.in:
	    Autoconfigure  MAILBIN= -entry (for installing)

	* utils/makendbm/makendbm.c:
	    Corrections for BSD DB B-tree database parametrization.

	* proto/cf/aliases.c:
	    Instead of using memory-hog script of (listaddresses ...),
	    do use the builtin (listexpand ...) routine.

	* proto/cf/rrouter.cf:
	    Do "ssift/in/tfiss" test on $address.

	* proto/smtpserver.conf, smtpserver/smtpserver.c,
	  smtpserver/Makefile.in, smtpserver/relaytest.c,
	  smtpserver/relaytest.h:
	    - On STREAMs machines accept several rather mystic error
	      states for  accept() -- with a shrug.. No need to exit(1)
	      on such things as ENOSR, or EPROTO (No STREAMS Resources,
	      Error on STREAMS PROTOcol, ...)
	    - Don't log to console ( openlog( ... LOG_CONS ... ) )
	    - Accept any input - any at all - for the HELO parameter.
	      Be a bit more picky with EHLO...
	    - Relay-control facility -- to whom we accept email to
	      (must be out customer, or the sender is our customer)
	    - Introduce new "PARAM" tokens -- several of them:
		- "help" - string for the HELP-response main-text,
			   up to 20 lines
		- "maxsize"		- max-size we accept
		- "reject-percent-kludge"  - flag
		- "accept-percent-kludge"  - ditto
		- "relaytargets"	- db-file definition
		- "relaycustnets"	- ditto the rest
		- "rejectnets"
		- "rejectsource"
		- "rejecttarget"

	* router/libdb/bsdtree.c, router/libdb/gdbm.c, router/libdb/ndbm.c,
	  router/libdb/unordered.c:
	    Modification test trips when the open file has link-count of
	    ZERO -- somebody mv(1)ed a new database on top of the old one!

	* scheduler/msgerror.c:
	    - An armour against WTT being NUL (upgradeing something?)
	    - Recognizing a situation where we are sending an error
	      report on error report -- marking that with altered subject

	* scheduler/scheduler.c, scheduler/threads.c:
	    Improve the freeze-out mode, it was able to spawn kids
	    in the freeze-out mode, though it did not feed them.

	* scheduler/transport.c:
	    Alter mailq() printout fork ending to be _exit(0)

	* transports/errormail/errormail.c:
	    Use the 'host' parameter if one is supplied. Always
	    pass it to the diagnostics subroutines.

	* transports/mailbox/mailbox.c:
	    - Fix processing the "lastchar" things.
	    - append_header() without extra "\n"

	* transports/sm/sm.c:
	    - append_header() without extra "\n"

	* transports/smtp/smtp.c:
	    New options:
		-F punthost  -- Send all mail to denoted host
		-L localname -- At multi-homed machine, bind() to named
				interface before doing connect()
	

Tue Dec  3 19:17:28 1996  Matti Aarnio  <mea@zmailer.org>

	* smtpserver/smtpserver.c:
	    Missing a couple of fflush()es -- moved the EXPN and
	    VRFY routines into separate subroutines.  Now have
	    ONE fflush() after each of the calls.

Mon Dec  2 18:38:09 1996  Matti Aarnio  <mea@zmailer.org>

	* utils/makendbm/makendbm.c:
	    Yet another parameter error in case the system can do
	    both NDBM and BTREE -- autch!

	* smtpserver/smtpserver.c:
	    Be silent about log-files when started up as
	    "/usr/lib/sendmail -bs" by somebody who can not
	    write into the default log files.

	* Makefile.in:
	    Version 2.99.43

	* router/libdb/bind.c, transports/libta/dnsgetrr.c,
	  transports/smtp/smtp.c, transports/hold/hold.c:
	    Uses of "sizeof(u_long)" have been eliminated (as well
	    as "sizeof(u_short)" in favour of numeric constants:
	    4 and 2 respectively.

	* transports/libta/mime2headers.c:
	    Disabled the new MIME2 code.  Nothing but grief... :-(

	* transports/libta/mimeheader.c:
	    One missing setting of a variable.

	* transports/smtp/smtp.c:
	    Missing space at DSN RET= parameter writing.

Wed Nov 27 21:23:12 1996  Matti Aarnio  <mea@zmailer.org>

	* transports/smtp/smtp.c:
	    Once more (SmtpState -block).. Clear it with memset(),
	    then init those few non-zeroes.

	* smtpserver/smtpserver.c:
	    Finally fixed the VRFY and EXPN behaviours; now
	    they work as they should.

Tue Nov 26 15:17:03 1996  Matti Aarnio  <mea@zmailer.org>

	* transports/smtp/smtp.c:
	    SmtpState -block needed some more initializations.
	    Missing one: verboselog

Mon Nov 25 16:21:15 1996  Matti Aarnio  <mea@zmailer.org>

	* transports/hold/hold.c:
	    Calling convention of  getrrtype() was changed (a bit),
	    and I forgot to update it here too.

Thu Nov 21 20:37:19 1996  Matti Aarnio  <mea@zmailer.org>

	* Makefile.in:
	    Version 2.99.42

	* transports/smtp/smtp.c:
	    Massive rewrite of calling conventions within the SMTP
	    client -- passing around a state-variable containing
	    state of the smtp session (though not the message..)
	    Corrected one bug at PIPELINING code.

	* transports/mailbox/mailbox.c, transports/sm/sm.c,
	  transports/smtp/smtp.c, include/ta.h,
	  transports/libta/mime2headers.c:
	    Routine  headers_to_mime2()  got new parameter.

	* proto/cf/aliases.cf:
	    Yet couple more fixes -- when processing  .forward
	    an empty (addressless) file needs to expand to the
	    original user, NOT to "\$user" -> $user ...

	* scheduler/mailq.c:
	    Explanation on "Transport queue is empty" condition.

	* scheduler/readconfig.c:
	    Now configuration file can have spaces around parts of
	    attribute tokens:  'name=value'  'name = value'
	    Unquoted '#' causes end of line to be comment, and thus
	    ignored.

	* scheduler/scheduler.c, scheduler/threads.c, scheduler/update.c:
	    A "-p" (procselect) option to run only selected threads,
	    but not to log in possible error reports (debug stuff)

	* scheduler/scheduler.c:
	    If a "TURNME"-request is processed, and the request
	    does not have acompanying entry in "queue" (cfp->mid
	    is not set), process it gracefully, and unlink().

	* smtpserver/debugreport.c:
	    Corrections on  type()  parameters.

	* smtpserver/smtpserver.c:
	    More informative reports on message exceeding fixed limit

	* transports/errormail/errormail.c:
	    Builtin error message fix

	* transports/libta/mimeheaders.c:
	    Make sure the Content-Transfer-Encoding is converted
	    from Q-P to 8BIT when it is in that value..

	* transports/mailbox/mailbox.c:
	    - Support 'dirhashes' (runtime command-line option: -D)
	    - If the message has no 'To:' header, add sendmailish
	      'Apparently-To:' -header.
	    - The sendmailish "Return-Receipt-To:" processing produces
	      now proper and up to date  MULTIPART/REPORT

	* transports/sm/sm.c:
	    Produce proper DSN return values for various subprogram
	    error messages.

	* utils/makendbm/makendbm.c:
	    Correction on 'dbasename' variable specification

Thu Nov 14 22:37:18 1996  Matti Aarnio  <mea@zmailer.org>

	* router/rfc822.c, router/libdb/headers.c, BUGS:
	    Treat "Return-Path:" -header with respect -- and
	    DELETE it when sending it thru the system.  It is
	    stored into the user's mailbox by the FINAL DELIVERY
	    AGENT, it does not exist outside user's mailbox!

Wed Nov 13 16:48:00 1996  Matti Aarnio  <mea@zmailer.org>

	* proto/cf/aliases.cf:
	    Aargh... quotation-rules on ZMSH are "a bit" different
	    from SH, and I keep forgetting it.  Everything broke
	    when I added some newlines here & there...  Now added
	    '\' (back-slashes) to cover them.

	* utils/makendbm/makendbm.c, utils/makendbm/ndbmlook.c:
	    Got rid of the need for some referred things, uses
	    strerror() instead.

	* transports/mailbox/mailbox.c, libc/mail.c, scheduler/msgerror.c:
	    Use  fsync()  when finishing off the write to the mailbox/file.

	* transports/libta/ctlopen.c:
	    Initialize  notifyflgs  properly for the case that no
	    NOTIFY parameter is present (assume: FAILURE)

	* transports/errormail/errormail.c:
	    If no reports sent, generate still OKs for each non-
	    generated report..

	* transports/sm/sm.c:
	    Handle "channel error" at the sender..

Tue Nov 12 17:47:34 1996  Matti Aarnio  <mea@zmailer.org>

	* config.h.in, configure.in:
	    Test for  fsync()  at the system.

Mon Nov 11 18:56:21 1996  Matti Aarnio  <mea@zmailer.org>

	* Makefile.in:
	    Released version 2.99.41

	* SiteConfig.in:
	    Some new default values; FORCEPUNT, SCHEDULEROPTIONS

	* compat/rmail/rmail.c, compat/sendmail/sendmail.c:
	    Re-coded "to " and "todsn " -envelope generation,
	    added "env-end" -envelope header.

	* libc/strsignal.c:
	    Using AC test  SYS_SIGLIST_DECLARED

	* include/ta.h, transports/libta/skip821address.c,
	  scheduler/scheduler.c, transports/libta/ctlopen.c:
	    Declare and use  skip821address() -routine.
	    Enables to have embedded spaces in 'host', and in 'user'
	    parts of the parameter line.

	* lib/loginit.c, router/router.c, scheduler/scheduler.c:
	    "Name-space pollution" -- "log" is reserved name,
	    and cannot be used as a name of a global variable..

	* libc/mail.c:
	    Final corrections for automatic filename index array
	    reallocing -- off-by-one, and 32/64 bit troubles..

	* libc/syslog.c:
	    Compile it always in -- somewhat difficult at SunOS 4.1.4,
	    but it seems to work even when debugging fails..
	    Also uses  *sNprintf -routine, that is one with explicite
	    way to tell the max space at the buffer.

	* libsh/io.c:
	    #define NO_FLOAT_CONVERSION -- don't do FP conversions,
	    can get rid of the need to use "-lm" at the router at
	    DEC UNIX 4.0 ...

	* proto/cf/TELE-FI.cf:
	    Sample of "router.cf" we use at Telecom Finland

	* proto/cf/aliases.cf:
	    Renoved  aliases.cf  that can do PUNTHOST AFTER checking
	    at system aliases, but it will NEVER look at user home
	    directories...

	* proto/forms/delivery:
	    Changes at the message text (and subject).  Now it is
	    more generic to apply also for positive acks.

	* proto/scheduler.conf, proto/sm.conf:
	    Sample entries for using CYRUS IMAP-server injector as
	    local server (Tom Samplonius <tom@sdf.com>)

	* router/db.c, router/libdb/bsdbtree.c, router/libdb/search.h:
	    Additional DB engine: BSD LIBDB B-Tree

	* router/db.c:
	    At "pathalias" -driver one can have (at $MAILSHARE/db/routes)
	    "." to denote "match everything on this", and thus to make
	    outgoing routes with single entry at routes db:
			.  smtp!firewall

	* router/functions.c:
	    A glitch-fix for run_expandlist() -routine generating
	    NOTARY ORCPT data

	* router/libdb/ndbm.c:
	    "extern int errno" (SunOS 4.1.4)

	* router/rfc822.c:
	    Fix on detecting ERRTO pointer value change, and moving
	    "eVerbose" envelope header detection a bit up, plus adding
	    several "verbose-log" printouts.

	* scheduler/msgerror.c:
	    - New routine  decodeXtext() to decode XTEXT objects coming
	      as DSN parameters.
	    - Some sanity-checks added for error report address picking.
	      (core-drops at vger.rutgers.edu)

	* scheduler/scheduler.c:
	    - Lowercase the whole input string with "channel host",
	      then later sort those lines with  strcmp()  instead
	      of  cistrcmp() ...
	    - Fix parsing the NOTIFY= parameter -- wrong index..

	* scheduler/update.c, scheduler/scheduler.c:
	    Unconditionalize the syslog()

	* smtpserver/smtpserver.c:
	    - Moved code around to have definitions before uses.
	    - Fix one call-variant of "type()" definition.

	* transports/errormail/errormail.c:
	    - Decode XTEXT
	    - Produce DSN definitions on the reports with NOTIFY=NEVER..

	* transports/libta/writeheaders.c:
	    Always double-dot-quote the headers, though it should never
	    be needed...

	* transports/mailbox/mailbox.c:
	    Present POSITIVE DSN reports!

	* transports/sm/sm.c:
	    - Unless using option "H", convert headers to "MIME-2"
	    - Generate several possible variants of BSMTP, which one
	      can thus feed via UUCP to remote system

	* transports/smtp/smtp.c:
	    Write out in a bit larger chunks than 1 k to the network..

	* utils/makendbm/makendbm.c:
	    Support 3 different DB-formats: NDBM, GDBM and B-tree
	    ALL POSSIBLY AT THE SAME TIME

	* transports/libta/mime2headers.c:
	    Debugged the REAL MIME-2 header producer to produce
	    some real MIME-2 format headers..

Mon Nov  4 22:45:37 1996  Matti Aarnio  <mea@zmailer.org>

	* Makefile.in:
	    Released version 2.99.40

	* compat/sendmail/sendmail.c, include/mailer.h, router/rfc822.c,
	  router/router.c, scheduler/msgerror.c, scheduler/scheduler.c,
	  smtpserver/smtpserver.c, support/vacation/vacation.c,
	  transports/libta/warning.h
	    Unconditionalized  syslog() -- we have one bundled in
	    from BSD sources.

	* configure.in, config.h.in, and several sprintf()s all over:
	    We test for possible   snprintf(),  and will use it!

	* configure.in, libc/setreuid.c, libc/Makefile.in:
	    Build setreuid() unconditionally, because at AIX
	    the libc has one, but it is rather broken..

	* transports/Mailbox.in, transports/fuzzyalias/
	    A fuzzy-match transporter for creating suitable error
	    reports.  Made by Thomas Knott.

	* include/ta.h, router/rfc822.c, router/shliaise.c,
	  scheduler/msgerror.c, scheduler/scheduler.c,
	  scheduler/scheduler.h, scheduler/update.c,
	  transports/libta/ctlopen.c, transports/libta/diagnostic.c:
	    DSN notary parameter processing in smarter ways

	* lib/token.c:
	    - copyToken(): If the token size is over 50k chars, copy the first
			   50k of it.
	    - printdToken(): "print" the token into limited size buffer,
			     but will expand the buffer if needed.

	* libc/mail.c, libc/mail_alloc.c:
	    Have dynamically allocated list of mail-files associated with
	    the mailbox files being created.

	* libsh/io.c:
	    Initialization of  std_printf  variable a bit difficult.

	* libsh/listutil.c:
	    s_equal1() -routine.  Matches only one conscell at any time.

	* libsh/tregexp.c, router/shliaise.c:
	    Prepared to use  printdToken() into limited size buffer.
	    Will expand the buffer if needed.

	* router/functions.c:
	    DSN parameter processing at  run_listexpand()  routine.

	* router/libdb/yp.c:
	    Fix -- has to strsave() a string returning from YP.

	* smtpserver/loadaver.c:
	    - "-lkvm" using systems (Solaris 2.5 on report) do not
	      compile without it.
	    - Usage of kvm_open() et.al. does actually need closure
	      of /dev/kvm for not to overflow scant memory reading
	      resources.

	* smtpserver/smtpserver.c:
	    Error in  type821err()  routine -- forgot to report
	    without "\r\n" at the channel output.

	* transports/mailbox/mailbox.c:
	    Support "Return-Receipt-To:" -header when running mailbox
	    with option switch "-S" (a.k.a: Sendmailism)

	* transports/smtp/smtp.c:
	    - revise return status codes
	    - recognize relaying of DSN armoured SMTP message to
	      systems without DSN facility
	    - recognize remote declaring ENHANCEDSTATUSCODES, and
	      use them in our own report

Tue Oct 22 18:51:07 1996  Matti Aarnio  <mea@zmailer.org>

	* Makefile:
	    Version 2.99.39

	* transports/libta/ctlopen.c:
	    Parser bugfixes, and DSN data parsing

	* transports/mailbox/mailbox.c, transports/sm/sm.c:
	    DSN stuff, diagnostic response fixes

	* transports/smtp/smtp.c:
	    DSN stuff for sending, and for receiving.
	
	* transports/errormail/errormail.c:
	    Use DSN parameters to the fullest we can.

	* transports/hold/hold.c:
	    DSN parameters, fixes on returned diagnostics

	* scheduler/msgerror.c, scheduler/scheduler.c, scheduler/scheduler.h,
	  scheduler/update.c:

	* router/libdb/header.c:
	    "notaryret" envelope entry

	* router/shliaise.c:
	    Generic ``build_gensym()'' routine to bring together
	    stuff previously duplicated all over.

	* router/functions.c, router/prototypes.h, router/rfc822.c:
	    The ``listexpand''-function got more DSN flags, and
	    builtin MANDATORY ORCPT data generation.
	    Basic rfc822() processor got more NOTARY stuff

	* include/mail.h.in, include/mailer.h, include/ta.h:
	    NOTARY DSN stuff

	* libc/mail.c:
	    Changed name (and params) of mail_close_scheduler() to
	    be more generic  mail_close_alternate()

	* compat/sendmail/sendmail.c, man/sendmail.8:
	    More options to match with  sendmail-8.8:  -N -R -B -U -V
	    (NOTARY DSN stuff)
	
	* INSTALL:
	    A bit more verbose explanation on  /etc/group,  and
	    "zmailer"-group, and purpose of "nobody" -account.

	* smtpserver/smtpserver.c:
	    Fixes to:
	      - ident processing
	      - IETF NOTARY DSN mechanisms -- will ALWAYS create  ORCPT= entry!
	        Does an in-depth syntax analysis of DSN parameters

	* libident/identuser.c:
	    Changes at the return values at various error conditions

	* transports/libta/ctlopen.c:
	    Fix on DSN NOTARY parameter scanning
	
Thu Sep 12 22:19:58 1996  Matti Aarnio  <mea@zmailer.org>

	* configure.in, Makefile.in, utils/makendbm/makendbm.c,
	  utils/makendbm/ndbmlook.c, support/vacation/vacation.SH:
	    A RedHat 3.0.3 Linux with some additions from more
	    recent "Rembrandt" release caused several changes
	    into the autoconfig, and makendbm system.

Fri Aug 23 11:32:43 1996  Matti Aarnio  <mea@nic.funet.fi>

	* transports/mailbox/mailbox.c:
	    Solaris mailloc() became tested (and fixed) when
	    I was teaching utu.fi UNIX admin to handle the
	    ZMailer..

	* configure.in, configure:
	    Forgot to move certain resolver related defines into
	    a bit more generic place (Solaris test results)

	* lib/selfaddrs.c, lib/Makefile.in:
	    Moved  stachmyaddresses(), and  matchmyaddresses()  from
	    smtp.c into a bit more generic location -- library, and
	    uses ZENV variable  SELFADDRESSES to list COMMA SEPARATED
	    the names (or IP address literals: 1.2.3.4) of the local
	    host.  The goal is to get a list of all interfaces at the
	    current host so that, SMTP knows them, and at MX selection
	    recognizes local system.

Mon Aug 19 19:02:19 1996  Matti Aarnio  <mea@nic.funet.fi>

	* (all over the place):
	    lseek() offset parameter changed from  long  to off_t.
	    This affects especially BSD/OS.

	* compat/sendmail/sendmail.c:
	    Sometimes the "-v" option processing does not stop at all,
	    because some transport agents (?) write more to the verbose
	    logfile AFTER the scheduler has written its own "scheduler done"
	    line so that it is not the last line read from the file.

Sun Aug 18 19:10:44 1996  Matti Aarnio  <mea@nic.funet.fi>

	* INSTALL, README, README.PERFORMANCE, README.UPGRADEING,
	  SiteConfig.in, man/*.[138]:
	    Documentation update

	* Makefile.in:
	    Version 2.99.37 for release

	* compat/sendmail/sendmail.c, libc/mail.c, smtpserver/smtpserver.c,
	  router/libdb/ndbm.h, scheduler/transport.c, router/db.c,
	  transports/libta/ctlopen.c
	    <fcntl.h> testing check

	* router/functions.c, router/rfc822.c:
	    Add "env-end\n" into the boundary of envelope, and
	    message body.

	* router/rfc822.c:
	    Add a bit more smarts (copied from the scheduler) at
	    reading recipient addresses from canned messages.

	* include/ta.h, transports/libta/lockaddr.c,
	  transports/libta/ctlopen.c, transports/libta/diagnostics.c:
	    Parameter changes at  lockaddr()
	
	* libc/whathost.c:
	    More fixes at more systems  (and less memory leakage)

	* libmalloc/externs.h, libmalloc/getmem.c, libmalloc/malloc.h,
	  libsh/io.c:
	    (back)porting to SunOS 4.1.4 with oddly configured gcc-2.6.3
	    It did indeed spew error messages at some files...

	* scheduler/mailq.c:
	    Initial preparations for two-way interactive querying of system
	    status

	* scheduler/mailq.c, scheduler/msgerror.c, scheduler/prototypes.h,
	  scheduler/scheduler.c, scheduler/scheduler.h, scheduler/threads.c,
	  scheduler/transport.c, scheduler/update.c:
	    Scheduler work-spool can now be hashed into one, or two levels
	    of indirect hashesh.  See ``-H'' option at man-page.

	* smtpserver/smtpserver.c:
	    ENCHANGEDSTATUSCODES -facility.

	* transports/mailbox/mailbox.c:
	    - Runtime configurable selection of locking methods.
	    - Corrected a file creation race condition

	* transports/smtp/smtp.c:
	    When doing PIPELINING, use some additional smarts as to when
	    there is any need to do system calls -- SMTP commands are sent
	    in larger chunks, and replies are not to be expected before
	    they are sent, nor forever after..
	    (Just reducing the number of syscalls when using PIPELINING.)

Fri Aug  9 15:13:25 1996  Matti Aarnio  <mea@nic.funet.fi>

	* Makefile.in:
	    Version 2.99.36 for release
	    (pre-release installed at: Linux/ELF, DEC OSF/1, Solaris 2.5)
	
	* router/libdb/ndbm.c, utils/makendbm/makendbm.c,
	  config.h.in, configure.in:
	    Macro/function  dbm_error() is not available at BSD DB <ndbm.h>
	    compability package.  Have to use  errno  in that case.
	
	* libs/Makefile.in, router/Makefile.in, router/libdb/Makefile.in:
	    Changed the name of the router libdb to be  libzmdb.c,
	    because BSD DB library name is  'libdb.a', and linking
	    with '-ldb' causes a name-space collision...

	* scheduler/qprint.c, transports/mailbox/mailbox.c:
	    Changed the precedence of 'HAVE_UTIME' to preceed
	    test of 'HAVE_UTIMES' -- or rather, if system has
	    both, just using the 'HAVE_UTIME' variant.

	* libc/whathost.c:
	    Completed the rewrite with minimized memory leakage.

	* smtpserver/fdstatfs.c:
	    Completed the autoconfig sensing of the system

	* configure.in, config.h.in, router/libdb/ndbm.c:
	    More tests at variations of different DB libraries.
	    Especially supporting systems with BSD DB in disguise
	    of NDBM ( RedHat Linux 3.0.3 )

Thu Aug  8 17:27:00 1996  Matti Aarnio  <mea@nic.funet.fi>

	* all over the place:
	     #ifndef strchr
	      extern char *strchr()   ((and friends))
	     #endif
	    IBM AIX (compilers) are ``different'' again...

	* libresolv/*.[ch]:
	    Done 4.9.4-patch1  things to the resolver.

	* Makefile.in:
	    - Version 2.99.35
	    - When makeing 'all', at first removed 'libs/libtag',
	      and then proceeds with system creation, thus ensuring
	      that libraries are remade -- ONCE -- if needed.
	    - compiles  support/vacation/vacation  too

	* libc/whathost.c:
	    AIX  mntctl() things (modelled after GNU fileutils 3.13
	    code for similar use..)

	* libc/Makefile.in, libc/whathost-test.c:
	    Now have easier to use test to see, if the NFS-server
	    recognition works at various platforms.

	* support/vacation/*:
	    Autoconfiguration support for the bundled vacation.
	    Installation (make install) is not really mature.

	* configure.in config.h.in:
	    - Sense 'timezone' variable with  'altzone' variable
	      at system libc
	    - Sense sizes of (void*) and (long)
	    - Sense gethostbyname() at system libc without any other
	      libraries
	    - Corrected the sense of NDBM at -ldbm -library

	* lib/allocate.c:
	    Alignments per system native parameters:
		- SPARCs always 8 bytes (double floats)
		- other 32-bit machines in 4 bytes
		- 64-bit machines in 8 bytes

	* lib/rfc822date.c:
	    Timezone recognition when there is ``timezone'' variable,
	    but not ``altzone'' (POSIX said some people.. Linux has this)

	* libmalloc/align.h:
	    Recognize in a bit more generic way 64-bit machines (SGIs)

	* libsh/Makefile.in:
	    LIBDEB fixup

	* libsh/builtins.c, libsh/execute.c, libsh/expand.c,
	  libsh/interpret.c, libsh/listutils.c, libsh/regex.c,
	  libsh/sslwalker.c, libsh/variables.c, libsh/zmsh.c,
	  router/db.c, router/functions.c, router/libdb/bind.c,
	  router/libdb/dbm.c, router/libdb/header.c,
	  router/libdb/ndbm.c, router/libdb/gdbm.c, router/prototypes.h,
	  router/rfc822.c, router/rfc822walk.c, router/router.c,
	  scheduler/scheduler.c, scheduler/transport.c,
	  smtpserver/rfc821scn.c, smtpserver/smtpserver.c, ssl/ssl.c:
	    IRIX 6.1 compiler was rather picky...  Minor cosmetics
	    actually (like mismatch of enumerated variable vs. ints)

	* bin/mkdep.in, bin/mklibdep.in:
	    Autoconfig stuff (CPPDEP substitution)

Fri Aug  2 11:29:39 1996  Matti Aarnio  <mea@nic.funet.fi>

	* libresolv/portability.h:
	    One test to add SVR4 sensing at Solaris 2.4
	    (with GCC 2.7.0)

	* Makefile.in:
	    Version 2.99.34 -- compilation tested at:
		- Solaris 2.4 (without bundled libresolv!)
		- DEC OSF/1

	* (many files):  bzero() changed to memset()
	  for SysVR4 port issues (Solaris 2.4) EXCEPT
	  AT LIBRESOLV!

	* libc/getdtblsiz.c, libc/setreuid.c:
	    Portability things for Solaris 2.4 without UCBLIB!

	* configure.in, config.h.in lib/rfc822date.c:
	    Testing for variable 'altzone', and tm_gmtoff
	    field at struct tm.  Made also small test program
	    into lib -directory (make rfc822date-test)

Thu Aug  1 15:05:53 1996  Matti Aarnio  <mea@nic.funet.fi>

	* Makefile.in
	    Version 2.99.33a2 (and good night folks..)

	* compat/sendmail/sendmail.c:
	    Removed "Boptcount = 0", which was accidental artefact
	    from one earlier version of "-B" -option processing.
	    (compabilities with Alman's sendmail)

	    Processing of  SMTPOPTIONS zenv-variable needs to remove
	    the quotes from the parameter -- but it is a bit dangerous
	    in case there is something like:
		SMTPTOPTIONS="-l '/some/path/with space'"
	    lets hope not...

	* configure.in:
	    The dup2() -test appears to act as compilation environment
	    checkup :-)  Great, added comments of that effect at the error
	    message.

	* smtpserver/smtpserver.c:
	    Tested the built-in tcp-wrapper at nic.funet.fi, now
	    it works as expected. (daemon name:  smtp-input)
	    FYI: The  allow/deny rules are as follows:
	       1) does it match at allow ?  Yes, return allow.
	          not ? proceed to second test
	       2) does it match at deny ?  Yes, return deny.
	          not ? return allow.

	* router/rfc822.c: sequencer()
	  transports/mailbox/mailbox.c, scheduler/msgerror.c,
	  scheduler/scheduler.c, scheduler/scheduler.h:
	    One particular weird mail file was able to cause
	    100% mortality rate at the router -- NULL pointer
	    dereference..  (Andy Poling <andy@realbig.com>)
	    That prompted a larger go-around and checking at
	    what happens when SMTP input arrives as  MAIL FROM:<>
	    and is destined somewhere.   Fixes made at:
	      - router
	      - scheduler
	      - mailbox
	    In need of checking/fixing:
	      - sm
	      - errormail
	      - hold
	    (ok, perhaps only the 'sm')

	* Makefile.in
	    Version 2.99.33a1

	* config.h.in, configure.in:
	    Created  --with-tcp-wrappers=DIRPATH  option,
	    changed names of two others to:
			--with-sendmailpath=PATH
			--with-rmailpath=PATH

	* smtpserver/smtpserver.c, smtpserver/wantconn.c:
	    Wietse Venema's  wantconn.c  for builtin tcp-
	    wrapper behaviour -- suboptimal in efficiency,
	    though... (but better than: inetd -> tcpd -> sendmail
	    -> smtpserver, which is 1 fork + 3 execs..)
	    The magic name at hosts.deny/hosts.allow files
	    is:  smtp-input

	* smtpserver/smtpserver.c:
	    Fixes to file-descriptor usage so that things should
	    work just fine with all options.. (*should*..)

	* router/libdb/header.c:
	    Made "Keywords:" -header unknown per regards of the
	    router -- it need not to touch, not comment on it.
	
	* compat/sendmail/sendmail.c, include/mailer.h,
	  router/libdb/header.c, smtpserver/smtpserver.c:
	    Process properly the -Bbodytype parameter, and store
	    it into the message envelope. It is known to the router,
	    though nothing is done with it.  Also the SMTP-server
	    does store that info into the message envelope.

	    Also for "sendmail -bs", when invokeing  smtpserver,
	    feed it the arguments from  SMTPOPTIONS  environment
	    variable ( via  getzenv() )

Wed Jul 31 12:03:01 1996  Matti Aarnio  <mea@nic.funet.fi>

	* transports/smtp/smtp.c:
	    Minor fixes at how the   smtp_sync()  works with the
	    PIPELINING server -- now the reports do make sense to
	    the ordinary message sender. (well, not exactly)

	* Makefile.in:
	    Version 2.99.32 -- and releasing it
	
	* *Makefile.in (practically them all)
	    Adjusted dependency processing, now can do 'make depend'
	    any time, though needs GCC-based  CPPDEP="gcc -MM"  to
	    work properly...

	* scheduler/resources.c:
	    Autoconfigured various resource update mechanisms.

Tue Jul 30 11:36:24 1996  Matti Aarnio  <mea@nic.funet.fi>

	* Makefile.in:
	    Releasing 2.99.31 -- let others to have the experience too..

	* INSTALL:
	    Giving some additional tips at the initial configuration
	
	* lib/linebuffer.c, router/rfc822.c:
	    Improved the error detection, and recovery so that now
	    non-conformant input is a reason to stop the parse of
	    headers (or envelope), and everything after it goes to
	    the message body without looseing anything of it.

	    The envelope header "env-end" has special meaning:
	    It ends parse of envelope, and after it,  makeLetter()
	    routine expects to get RFC-822 headers.  If it does not,
	    the input goes to the body.
	
	* libsh/io.c, smtpserver/smtpserver.c, libc/syslog.c, 
	  transports/libta/diagnostics.c, config.h.in, configure.in,
	  transports/smtp/smtp.c, transports/libta/mimeheaders.c:
	    HAVE_STDARG_H, and all related stuff, in case the
	    varargs is not supported..

Mon Jul 29 01:15:13 1996  Matti Aarnio  <mea@nic.funet.fi>

	* configure.in libs/Makefile.in (and most other)Makefile.in
	    Made several new  --with-*  -configuration options:
		--with-system-malloc
		--with-bundled-resolver
	    Neither are defaults.

	    Test for existence of  <varargs.h>/<stdarg.h>,
	    to do yet: converting sources to use the knowledge..

Fri Jul 26 10:06:30 1996  Matti Aarnio  <mea@nic.funet.fi>

	* Makefile.in:
	    Version number 2.99.31

	    The package has now compiled smoothly at:
	      - Solaris 2.5 with Sun unbundled cc, and gcc-2.7.2
	      - Sun Sunos 4.1 with cc
	      - DEC OSF/1 v3.2D with 'cc', and 'cc -migrate'
	      - i486 Linux 2.0.4/libc-5.4.2 with gcc 2.7.2

	* libident/Makefile.in, libident/identuser.c:
	    Canonized the parameter defines for that library module

	* configure.in, libresolv/Makefile.in, libresolv/inet_ntoa.c
	    Added that routine into resolver library package, as it
	    is not always present in the system, and we might need
	    it -- especially in format where it is guaranteed to be
	    structure passing convention compatible with our other
	    code...

	* libresolv/Makefile.in:
	    Sun Solaris 2.5 does not like 'ld -x -r'..
	    Me neither, actually.  Commented it away.

	* libresolv/herror.c:
	    One missing forward declaration.

Thu Jul 25 02:59:13 1996  Matti Aarnio  <mea@nic.funet.fi>

	* Makefile.in, configure.in, and related autoconfig stuff:
	    Fixes to get autoconfiguration to work at Sun Solaris,
	    DEC OSF/1 v3.2D, Linux (kernel 2.0), and SunOS 4.1.

	    Running this in production mode at  nic.funet.fi
	
	    Released version 2.99.30  for public 

	* router/rfc822.c:
	    Revised the  run_rfc822(), makeLetter(), and sequencer()
	    way to handling  squirrel()/defer()/reject()

	    Created a new standard error form:  loopexceeded
	    which is given when there are way too many "Received:"
	    lines at the message (50 is our limit;  router/conf.c)
	

	* libresolv/
	    Copied pretty much as is the   bind-4.9.4-REL/res/
	    (resolver) subdirectory, and relevant headers into
	    our local "include/" -tree.  Then edited those
	    C-files a bit, and got system independent resolver,
	    which will be loaded statically, of course.
	
Wed Jul 17 16:49:02 1996  Matti Aarnio <mea@mea2.pp.utu.fi>

	* (all over the place..) Makefile.in:
	    Releasing version 2.99.29 with a bit less warnings,
	    and more usability -- it very nearly works at my
	    Laptop now...

Mon Jul 15 21:42:40 1996  Matti Aarnio  <mea@nic.funet.fi>

	* Makefile.in:
	    Releasing version 2.99.28 with dire warnings!
	
	* configure.in, configure, Makefile.in, ...
	  (nearly all files got touched!)
	    Using GNU-Autoconfig system

Wed Jun 19 15:18:03 1996  Ken Pizzini <ken@spry.com>

	* smtpserver/smtpserver.c, smtpserver/rfc821scn.c,
	  router/rfc822.c:
	    - SMTP-server dying with SIGALRM without cleanup
	    - Accept braindead SMTP-input, and correct it
	        "<foo@foo   >" (trailing white-space cleanup)
	    - bug in  router/rfc822.c  at recognizing the end of
	      the envelope headers, and begin of rfc822 headers
	      in case the line-end was  CR LF  instead of plain LF ..

Tue Jun 11 14:34:05 1996  Jerzy Sobczyk  <J.Sobczyk@ia.pw.edu.pl>

	* libsh/execute.c:
	    Change at the ENDGRANDCHILD() -macro to clean (reap) up
	    the intermediate child process from becoming a zombie.

Mon Jun 10 11:35:41 1996  Matti Aarnio  <mea@nic.funet.fi>

	* INSTALL:
	    Some additional documentation details as suggested by
	    Arnt Gulbrandsen.

	* smtpserver/smtpserver.c:
	    Revised a bit of message logging, and other things.
	    There were difficulties that manifested at Sun Solaris,
	    while same code worked at DEC OSF/1 :-(    (At Solaris
	    the server process simply died a horrible death..)

Tue Jun  4 18:52:08 1996  Matti Aarnio  <mea@nic.funet.fi>

	* libsh/interpret.c:
	    Removed one  setlevel(MEM_SHCMD,...)  that caused memory
	    to be freed too agressively in some cases, and which in
	    turn was able to corrupt memory, when it was taken into
	    use a bit later:  for x in $(/bin/cat /etc/group); do ... ; done

Fri May 31 15:30:01 1996  Matti Aarnio  <mea@nic.funet.fi>

	* smtpserver/smtpserver.c:
	    Re-implemented the "TURNME"-command.  Apparently I have
	    misplaced the previous version source..  well, this is
	    cleaner code anyway.

	    Added an alias "ETRN" for the "TURNME".

	* lib/mail.c: mail_close_scheduler()
	    A variant of  mail_close()  routine, which sends the file
	    straight to the scheduler.  (For "TURNME")

Tue Apr 23 14:14:55 1996  Matti Aarnio  <mea@nic.funet.fi>

	* compat/sendmail/sendmail.c:
	    Add ignorance of "-B8BITMIME" into option processing...
	    (We do it always, no need to tell it at the call..)
	    (sendmail 8.7)

Mon Apr 22 08:15:20 1996  Matti Aarnio  <mea@nic.funet.fi>

	* scheduler/scheduler.c:
	    Got the  ``mytime()'' -server running also with Linux,
	    and all other systems that have at least an ability to
	    mmap() a file.

	    Implemented a ``_CF_TURNME'' primitive parsing.

	* smtpserver/smtpserver.c:
	    Implemented a "TURNME"-command, which produces ``_CF_TURNME''
	    primitive for the scheduler -- and sends it straight to there
	    without going via the router..

Fri Apr 19 16:13:34 1996  Matti Aarnio  <mea@nic.funet.fi>

	* transports/mailbox/mailbox.c:
	    At  putmail(), move the newline addition testing AFTER
	    the  appendlet()  processing.  That way the message is
	    always added at the end of the file, and only 0-2 newlines
	    are added after that at the end of the message -- if needed.

	    At least ELM got mystified with the earlier processing,
	    where the newlines were added at the front of the message.

	* scheduler/scheduler.c: (the "time server")
	    A bit more generic approach, works at at bit more platforms,
	    than only at OSF/1, and SunOS 4.1.x ...

Tue Apr  9 11:39:12 1996  Matti Aarnio  <mea@nic.funet.fi>

	* Makefile:
	    Released version 2.99.27

	* Makefile:
	    Add a ".PRECIOUS:" -tag for produced Makefiles, thus
	    avoiding destruction of them at some awkward moments,
	    when pressing "Ctrl-C" would delete one of them..

	* compat/sendmail/sendmail.c:
	    Option "-q" to take options (discarded anyway)

	* hostenv/AIX4.1:
	    Add "WAITPID=", and "ANSI_TYPES="

	* hostenv/Linux:
	    Added a warning about mmap() being broken in 1.2.x -kernels
	    (well, probably broken...)

	* hostenv/OSF1v3.2-Alpha:
	    Added "STDC_HEADERS=" -- for ANSI-C-headers

	* hostenv/SunOS4.1:
	    Added  "BZERO="

	* include/listutils.h, libsh/listutils.c:
	    newcell() is now a routine, and not a macro..
	    (In preparation of LISP-like guts rewrite..)

	* router/rfc822.c:
	    If the returned address reference has no protection info
	    (a NULL-pointed object), print out "-".

	* scheduler/scheduler.c: (and all others)
	    Changed all "time(&now)" to be "mytime(&now)",
	    and created a shared-memory server on which there is
	    a redularly running server at the other side updateing
	    system time into given variable, and the real scheduler()
	    can read that data.  Makes a lot less syscalls at the
	    scheduler (At SunOS 4.1 the  gettimeofday()  syscall
	    does take some 80 usec...)

	* scheduler/transport.c, scheduler/conf.c:
	    Implemented a "forkrate-limit", which blocks the fork
	    from happening, if over N fork()s have been done during
	    the same second.  The count does reset at the next second
	    for N more childs..  Default for the N is 10.

	    Create  flush_child()  routine to handle some of the awkward
	    non-completed outputs from the scheduler to the childs.

	* scheduler/qprint.c:
	    "Q-mode" at the reporting -- no reports in the traditional way.
	    Also avoid a null-pointer deferrence.

	* scheduler/scheduler.c:
	    Parse scheduler 'Q'-mode argument, handle gracefully the
	    main scheduler inner loop exit.

	* transports/mailbox/mailbox.c:
	    Move the mailbox-file time-stamp reset into after the write
	    of the time. (Linux has peculiar read-time stamping due to
	    unified-buffer-cache system.)

	* transports/libta/lockaddr.c:
	    FCNTL-locking -- for systems starved by the IO-capacity..
	    (INCOMPLETE!)

	* transports/smtp/smtp.c
	    Added "-P"-option to turn off the PIPELINING use.

	    Do unusual, and overwrite also the environment variables, when
	    updateing info-area at the memory image for the benefit of
	    BSD-derived systems where such data update is possible for
	    reporting program state outside.

	    Detect "#idle", and report it outside.

	    Working implementation of PIPELINING full-duplex mode for
	    the SMTP-protocol.

	* utils/makendbm/makendbm.c:
	    Support also the GDBM, if it is available, and no NDBM is.


Fri Feb  9 02:32:01 1996  Matti Aarnio  <mea@nic.funet.fi>

	* Makefile:
	    Releasing 2.99.26

	* README.UPGRADING:
	    Noted change in canned error message headers

	* smtpserver/rfc821scn.c:
	    Give a bit more meaningfull report for case of "<foo@foo.foo.>",
	    which is "spurious dot at the end of the address"..

Tue Feb  6 00:54:37 1996  Matti Aarnio  <mea@nic.funet.fi>

	* proto/forms/*, scheduler/msgerror.c,
	  transports/errormail/errormail.c:
	    Added third header tag:  "ADR" which expects to find
	    recipient address (to be placed into "to " envelope line)
	    in there

	* smtpserver/smtpserver.c, smtpserver/rfc821scn.c:
	    If the input to HELO/EHLO was syntactically incorrect,
	    always trap it!  Although don't always cause full abort..
	    Actually giving meaningfull report at each input, and
	    storing "Bad.HELO.Input" into "rcvdfrom" entry..

	* include/hostenv.h:
	    Macro  FILENO(x)  was revised a bit to work properly
	    on SunOS 4.1, which has the problem, need to revise
	    it for other systems, if need be..  (IF the STDIO file
	    descriptor is stored on a signed char, the default
	    propagation of an fd over 127 makes it NEGATIVE, which
	    causes some real trouble..)

	* lib/rfc822date.c: (Tom Samplonius)
		- gettimeofday() does not return timezone information on
		  most BSD systems as "...time zone information does not
		  belong in the kernel..".  Also, this call is redundant,
		  since timezone information is the already retrieved
		  struct tm

		- I removed the
			"if (prettyname) sprintf(cp+5, " (%s)", ts->tm_zone);" 
		  statement because it is contained in the else part of a
		  "if (prettyname) .." block and can never be executed.

		- I removed the NO_TM_ZONE stuff in the USE_BSDTIMEZONE
		  section.  This seems like a bad thing, however it seems
		  to be required by AIX 3.2 though.  I don't know whether
		  AIX 3.2 is actually still used, or whether newer versions
		  of Zmailer actually build on it.  AIX 3.2 may be able to 
		  use the tzname[] global variable to get the name instead. 


	* include/mailer.h, router/libdb/header.c,
	  smtpserver/smtpserver.c, scheduler/msgerror.c,
	  transports/errormail/errormail.c:
	    Added new  HeaderClass  object:  env-eof / end-end
	    (two spellings) which is intended to be the last
	    entry of the transport envelope headers.

	* include/ta.h, transports/libta/lockaddr.c,
	  transports/libta/ctlopen.c, scheduler/msgerror.c:
	    Routine  lockaddr()  uses now MMAP()ed memory
	    on systems where it is available.  Less syscalls
	    on low-power machines..

	* include/zmsignal.h:
	    Ah well... truly portable signal processing appears
	    to be rather elusive target.. Now Solaris, and some
	    versions of BSD work again.

	* libc/__fopen.c, libc/siglist.c:
	    Couple FreeBSD related patches from Tom Samplonius

	* libsh/builtins.c:
	    Don't remember what system it was, but got a report
	    of failing signal processing/wait()ing.  Altered
	    feature testing into hostenv/* -feature USE_UNIONWAIT ..

	* router/db.c, router/libdb/dbm.c, router/libdb/gdbm.c,
	  router/libdb/header.c, router/libdb/core.c,
	  router/libdb/ndbm.c, router/libdb/ordered.c,
	  router/libdb/search.h, router/libdb/unordered.c,
	  router/libdb/yp.c:
	    "db -c database-file" --> outputs the number of
	    elements in the database.

	    Also incorporated a bunch of Nicholas Briggs patches
	    (NIS -- USE_YP) for his environment.

	* router/functions.c:
	    Rewrote (minimized) the  rd_stability() related data
	    amount used at sorting..

	* scheduler/msgerror.c:
	    Small changes to get it better online with IETF NOTARY-WG's
	    report format..

	* scheduler/update.c, scheduler/scheduler.c:
	    Understands "#resync .." reqests, drops the
	    info pertained to the jobspec, and returns
	    to the problem sometime later (via normal
	    job scan..)
	    
	* transports/smtp/smtp.c, smtpserver/smtpserver.c:
	    Implemented RFC XXXX of PIPELINING, which gives us
	    radical speed-increase on case the sourcing system
	    can do PIPELINING, and we have a need to transfer
	    a large number of recipients in envelope.


Tue Jan 23 11:49:58 1996  Matti Aarnio  <mea@nic.funet.fi>

	* transports/libta/lockaddr.c:
	    Reduce the number of systemcalls by one -- write
	    whole lock info in one go.. (instead of two)

Mon Jan 22 09:34:35 1996  Matti Aarnio  <mea@nic.funet.fi>

	* scheduler/transport.c:
	    Moved a piece of code to ``nonblocking.c''

	* transports/libta/nonblocking.c:
	    New file containing fcntl()s to turn file blocking
	    on and off..  ( fd_nonblockingmode() / fd_blockingmode() )

	* smtpserver/smtpserver.c:
	    - Added EHLO response "PIPELINING"
	      (server-side was easy..)
	    - Made sure that if no RCPT TO:<> -addresses
	      are given, will issue an "550"-error at the
	      "DATA"-phase.

	* transports/libta/diagnostic.c:
	    Minimize the "ok"-case report size, as filling
	    pipe of the report-back channel does not help
	    at all to keep the system running at full blast..
	    (average report size has been 110-120 chars, and
	     the pipe-size is usually 4096..  It doesn't fit
	     as many reports as it fits jobs.)

	* include/zmsignal.h:
	    SIGACTION does not always have the luxury of
	    SA_INTERRUPT defined at the system includes
	    (odd at that.. but Solaris is odd anyway..)

Fri Jan 19 19:42:16 1996  Matti Aarnio  <mea@nic.funet.fi>

	* Makefile:
	    Release 2.99.25

	* include/zmsignal.h:
	    Changed the order of tested alternates, now:
		- BSDish SIGVEC stuff
		- POSIXy SIGACTION stuff
		- ... when all else fails.. (SVR3)
	    (BSD and POSIX interchanged -- because OSF/1 3.2 didn't
	     like SIGACTION stuff with SA_INTERRUPT, while Linux is
	     happy -- and SunOS 4.1 needs SA_INTERRUPTs..)

	* router/functions.c: rd_doit()
	    Made a mistake at pid-renaming scheme, which caused
	    errorneous results to flood systems, and even to kill
	    the scheduler, when filename length became obscenely
	    large -- overflowling a stack-allocated buffer, and ...

	* scheduler/update.c, scheduler/threads.c:
	    Use, and bookkeeping of  feed_child() had a ``one off''
	    error in them causing occasional scheduler/ta deadlocks.
	    (both waiting each other to tell more..)

	* scheduler/transport.c: feed_child()
	    Feed the child only when the  "proc->fed == 0", that
	    is, as we set the flag, (and thread_start() clears it),
	    we won't feed same message twice, and cause potentially
	    excessive "#DBGdiag " loggings..
	    (Messages are not lost, it just disturbs postmaster's
	     peace of mind..)

	* hostenv/SunOS4.1, hostenv/OSF1v3.2-Alpha:
	    Turn back on the "MMAP=" settings, lack of them
	    does hurt more, than they did themselves..

Thu Jan 18 11:25:50 1996  Matti Aarnio  <mea@nic.funet.fi>

	* include/zmsignal.h:
	    SunOS 4.1 uses sigaction() in posixy style (sometimes
	    at least), and thus the programs jammed in weird ways.
	    Autch...   Added  SA_INTERRUPT into sa_flags..

	* Releasing 2.99.24 to the public

	* libsh/interpret.c: findfreefd()
	    It did `fstat()' in a loop, which is a bit heavy to my
	    liking..  changed it to use  fcntl(fd, F_GETFL), which
	    at most platforms is quite light-weight indeed..

	* scheduler/transport.c: stashprocess()
	    Clear the procinfo structure when preparing to store process
	    info to it.  Had forgotten to zero one new variable in it,
	    and caused mysterious halt gridlocks at scheduling..

	* scheduler/transport.c: mux()
	    Because the select-loop can take ages at slower machines,
	    added  queryipccheck()  calls after each  readfrom()  call..
	    Now the responsivity to the management interface should
	    improve..

	* transports/mailbox/mailbox.c:
	    When delivering to a file, errors at the storing (filesystem
	    full, for example!) did ZERO-TRUNCATED the target file.. Oops..
	    (Existing file-size was looked up at lseek(fd,0,SEEK_SET)
	     position, which happened to be at zero, of course..)

	* transports/libta/warning.c, transports/libta/lockfile.c,
	  transports/libta/ctlopen.c:
	    Changes at error reporting to get rid of "Misformed diagnostics"
	    entries at the scheduler log..

	* transports/smtp/smtp.c:
	    Altered the log-file writing a bit, now each line
	    gets prefix of format:
		("%05d%c%05d",getpid(),randchar,seqnum++)
	    and the log should be  sort(1)able  to see all sessions
	    in happening order -- and sessions with reused pids should
	    have differing randchar anyway --> no two SMTP-sessions
	    should be intermixed within each other.

	* scheduler/scheduler.c:
	    The new ``-S'' option causes startup to be all synchronous,
	    and will not start scheduling before all of the queue is
	    read in.

	* scheduler/qprint.c, scheduler/threads.c, scheduler/mailq.c:
	    New queue report -- old one is suppressed per default.

	    ----------- sample -----------
bash# mailq -sQQ
0 entries in router queue: idle
70 messages in transport queue: working
smtp/*.de/0
                Threads: 6 Procs: 19/6 Plim: 19 Flim: 150 Rcpts: 47 Idle: 13
smtp/*.net/0
                Threads: 1 Procs: 1 Plim: 10 Flim: 150 Rcpts: 1 Idle: 0
hold/*/0
                Threads: 1 Procs: 1 Plim: 20 Flim: 150 Rcpts: 2 Idle: 0
...
Kids: 64   Idle: 48   Msgs: 67   Thrds: 20   Rcpnts: 128   Uptime: 1m16s
	    -------- end sample ----------

Tue Jan 16 13:04:08 1996  Matti Aarnio  <mea@nic.funet.fi>

	* transports/smtp/smtp.c: getmxrr()
	    Wrong analysis of MXes causing occasional core, and
	    deliveries to wrong machines..

	* router/rfc822.c: makeLetter()
	    After a  ``getline()'' do see if the input has a terminating
	    CRLF character pair. If it has, convert it to LF-only..
	    This makes system to process peacefully messages which have
	    CRLF at their line change, which certainly is not UNIX style..

	* scheduler/msgerror.c:
	    Minor case improvement into ``delivery expired without
	    diagnostics having been returned to the scheduler''
	    (caused most likely by an overfed transport-agent..)

	* scheduler/*:
	    Still more performance related tuning, and bug hunting
	    at vger.rutgers.edu -- now that small machine appears
	    to be able to push some 200 000 messages in a day (1..n
	    recipients of same message at same remote host count as
	    one message), and linux-related lists are flowing out at
	    furious rate..  :-)

	    Profiling does tell weird things :-)  Most of the time was
	    spent at   thread_linkin(), which took 2.3 ms/call, but
	    was called some 200 000 times..  Small change there speeded
	    it up to 0.3 ms/call, and it made cistrcmp() to top..

	* router/functions.c:
	   Altered multi-router locking mechanism a bit.
	   Now it will use format:  inode-pid
	   which should be unique within one machine.

Thu Jan 11 13:52:06 1996  Matti Aarnio  <mea@nic.funet.fi>

	* Makefile:
	    Release 2.99.24 -- into testing at vger at first..

	* hostenv/SunOS4.1, hostenv/OSF1v3.2:
	    Commented OFF the "MMAP" feature -- the systems can do it
	    just fine, but we need to see, if systems perform better,
	    when not using it... (low-memory machine problems)

	* transports/hold/hold.c, transports/errormail/errormail.c,
	  transports/smtp/smtp.c, transports/mailbox/mailbox.c,
	  transports/sm/sm.c:
	    Accept input of queued up multiple job descriptors, which
	    MIGHT meet an fatal input error so that the last entry does
	    not end with a '\n'.  Reject such an entry silently.

	* transports/smtp/smtp.c:
	    When getting a bunch of job-descriptors with host selector
	    on the input, and if the last reported diagnostic was a
	    "retryat" failure, do silently drop them, until the given
	    retry-time is reached.

	* transports/hold/hold.c:
	    Understand hold-definition: "ns:host.name.there/any" right..

	* scheduler/readconfig.c, scheduler/scheduler.c, scheduler/mailq.c,
	  scheduler/qprint.c, scheduler/scheduler.h, scheduler/threads.c,
	  scheduler/transport.c, scheduler/update.c
	    Radical changes at the scheduling algorithms..
	      - "ageorder" config flag: makes vertices within the thread
		to be kept, and processed in the order of spool-file ctime.
	      - "overfeed=NN" config flag: tells how many entries are fed
	        to the transport client in one go so that it may "eat from
		the pipe" for the job definitions.

	* scheduler/msgerror.c:
	    Make it to tolerate old (pre 2.99.22) errors, and thus allow
	    smooth upgrade from old system to the new one.

	* lib/prversion.c:
	    Year has changed, updateing copyright statements a bit.

	* include/hostenv.h, lib/loginit.c, libc/mail.c, libsh/interpret.c,
	  libsh/io.c, libsh/trap.c, router/functions.c, router/libdb/ordered.c,
	  router/libdb/unordered.c, router/rfc822.c, router/rfc822hdrs.c,
	  router/shliaise.c, scheduler/mailq.c, smtpserver/smtpserver.c,
	  transports/mailbox/mailbox.c, transports/smtp/smtp.c:
	    On some machines exceeding 128 FDs on the scheduler (or elsewere)
	    causes some rather fatal things to occur, namely the variable
	    storing the fd in the STDIO descriptor is signed char, while it
	    should be at least ``unsigned char'', or preferrably ``short''
	    ( SunOS 4.x .. )

Wed Jan  3 10:24:59 1996  Matti Aarnio  <mea@utu.fi>

	* proto/cf/rrouter.cf, proto/cf/canon.cf:
	    Got rid of ``UUCPACTION'' and ``BITNETACTION'', let them
	    be resolved via  $MAILSHARE/db/routes:
			.bitnet	smtp!some.old.relict
			.uucp	smtp!uunet.uu.net
	    (And if you REALLY have BITNET routing database, it can
	     handle  <foo@node.bitnet> just fine..)

	    Also commented away the  IN% -matching, which after all
	    was my local hack to handle VMS users coming to UNIX..
	    .. but as we are killing the VMS, there is no need for
	    that hack anymore ..

	* proto/cf/server.cf:
	    The quadprint() -routine needed a bit of an addition to
	    handle non-found user->fullname mappings -- using same
	    method as the mailbox uses when delivering:  If given
	    "UsEr" does not match, lowercase it, and try again.
	    (If lowercased version doesn't match, yield an error..)

	* scheduler/update.c:
	    Hunting up and down for accesses to invalidated memory
	    blocks, found one at the end of the  u_retryat()..

	* scheduler/msgerror.c:
	    Plugged memory leakage (strdup()ed string)

Sat Dec 30 02:33:23 EET 1995  Matti Aarnio  <mea@nic.funet.fi>

	* Makefile:
	    Releasing 2.99.23

	* router/router.c:
	    Added "nosyslog" variable, and "-S" option, which
	    together disable (per default) router from syslog()ing
	    everything to syslog in addition to some logfile used
	    per default...

	* transports/smtp/smtp.c:
	    Rearranged diagnostics reporting, now it will correctly
	    report the status of the connection problems in addition
	    to the interactive transaction problems.

	* scheduler/threads.c, scheduler/transport.c:
	    When feeding a task, clear "vtx->ce.pending" -flag,
	    thus having the queue-reports not to show spurious
	    "thread-/channelwaits"...

	* transports/libta/mime2headers.c, transports/libta/mimeheaders.c
	    Split it into two, and took friend's MIME-2 encoder into
	    it... not yet truly in use.

	* routers/, and scheduler/
	    Several fixes to get it to compile again at OSF/1
	    (well, I didn't compile EVERYTHING before releasing
	     2.99.22 ..)

	* Makefile:
	    Releasing 2.99.22

	* Large changes to  scheduler -- trying to make it
	  a bit smarter at the retry (whole thread retries)

	* Some IETF-NOTARY-changes to the scheduler, and transporters

	* router, scheduler, and smtpserver will now abort, if
	  they fail to write any content to their respective
	  ``pidfile''.

Fri Dec 15 15:54:44 1995  Matti Aarnio  <mea@nic.funet.fi>

	* transports/mailbox/mailbox.c:
	    Add a "setpwent()" just before looking up named user,
	    at least on SunOS4.1 (vis NIS) this apparently makes
	    difference ??

Sat Dec  2 03:05:36 1995  Matti Aarnio  <mea@nic.funet.fi>

	* transports/smtp/smtp.c:
	    Fixed the treatment of maxpref picking at the MX handling.
	    (Darren Kinley <darrenk@nds.fonorola.net>)

	* router/shliases.c, proto/cf/aliases.cf, proto/cf/standard.cf:
	    Looked into ways of making the duplicate removal once
	    again setting a global XXXX

Sat Nov 25 18:39:56 1995  Matti Aarnio  <mea@nic.funet.fi>

	* lib/rfc822scan.c, router/rfc822.ssl, router/rfc822walk.c:
	    Teached the syntaxes a new special token: "::" like
	    exists in the DECNET addresses..

Thu Nov 23 16:34:50 1995  Matti Aarnio  <mea@nic.funet.fi>

	* scheduler/msgerror.c, scheduler/update.c, scheduler/scheduler.c,
	  scheduler/scheduler.h, include/ta.h include/mail.h, all TAs,
	  transports/libta/diagnostic.c:
	    Altered error messages (and a couple other things) to match
	    more evenly with IETF NOTARY-WG's error report format, including
	    status codes, etc.  If old errors are fed to the scheduler, it
	    WILL crash!  See  README.UPGRADING  about 2.99.22 ...

Fri Nov 17 13:22:18 1995  Matti Aarnio  <mea@nic.funet.fi>

	* router/rfc822.c:
	    Changed rules on when to add "To:"/"Resent-To:" headers
	    at all...  If any "To:" or "Resent-To:" header exists,
	    DO NOT add "(Resent-)To:" -header.  Makes list expansion
	    a much more forgiving to humans..

	* transports/smtp/smtp.c, transports/libta/dnsgetrr.c,
	  lib/hostent.c:
	    - Randomize the order of MXes with same preferrence
	    - Randomize the order of A-records before connecting
	      to anywhere (multiple addresses on same host)
	    The goal is to distribute the load to all servers of
	    the target domain, when it lists multiple servers..

Fri Nov 10 12:54:30 1995  Matti Aarnio  <mea@nic.funet.fi>

	* Makefile:
	    Release 2.99.21

	* Updated: README.UPGRADE, INSTALL, Overview, README,
	           README.solaris, Config.osf1-funet, Config.solaris
	* Switched:  scheduler -> scheduler-old, scheduler-new -> scheduler

	* hostenv/FreeBSD-2.0:
	    Some minor tweaks by Tom Samplonius, we shall see how they
	    blend in..

	* include/hostenv.h:
	    Unconditionally include <sys/param.h>, to be used
	    elsewere to detect some system dependent things.

	* Config, Config.osf1-funet:
	    Using best C-compiler on AXP platform with hardest
	    optimization switches...  It makes compiler apparently
	    to halt sometimes, but after 3-4 CPU MINUTES, those
	    larger modules are compiled -- the result is truly
	    magnificent :-)
	    (That compiler does need substantial amounts of memory
	     to run, at least 200M to "ulimit -m" -- max memory size!)
	    A bit later: Decreased optimization demands by small
	                  amounts -> smaller code (less inlining),
			  and faster compile..  A LOT faster..

	* lib/rfc822scan.c:
	    Tolerate a case where "\" ends the line on which we are
	    scanning tokens.  (PINE originates such sometimes?)

	* scheduler-new/threads.c:
	    Last (?) of the thread bugs fixed -- this one occurred
	    rarely at UTU.FI SPARC server.  Some sort of timing
	    thing, which turned out to happen very infrequently..

Mon Nov  6 12:09:28 1995  Matti Aarnio  <mea@nic.funet.fi>

	* smtpserver/smtpserver.c:
	    - Wrong code on "HELP" responses: 241, changed to  214
	    - EXPN and VRFY changed to demand HELO/EHLO before
	      being usable

	* hostenv/SunOS5.*:
	    Added the forgotten  "SVR4MNTENT=" -entry.

	* scheduler-new/
	    Still more hacking on all fronts (eh, source modules)

	* transports/libta/ctlopen.c:
	    Reset the ctlsticky's internal state in the begin of its use..

	* transports/mailbox/mailbox.c:
	    Do something with the  SIGALRM -- don't just SIG_DFLT it
	    (which means program aborting itself), rather use it to
	    break infinite wait on where you were (NFS lockf() )

	    Also reset the [re]uid to zero (root) before opening a
	    control file -- things work better that way..

	    Moved BIFF into the delivery loop, we shall see...

	* transports/smtp/smtp.c:
	    Still leaked SMTP connection file-descriptors, last one
	    plugged now ?  (on target host change..)

Mon Oct 30 11:52:34 1995  Matti Aarnio  <mea@nic.funet.fi>

	* transports/libta/mimeheaders.c:
	    Small change to MIME-2 processing (it is imperfect,
	    actually "broken", but lets not be too purists..)
	    Now a quoted token will not contain enclosing parents,
	    that is, "QUOTABLE)" -> "=?xxxx?Q?QUOTABLE?=)", and
	    not like it was:        "=?xxxx?Q?QUOTABLE)?=", which
	    breaks the headers really badly..

	* scheduler-new/transports.c:
	    Put  pipes_shutdown_child(tofd)  into suitable places
	    instead of  close(tofd),  because  socketpair() "pipe"
	    does break at normal close()...

Tue Oct 24 22:30:50 1995  Matti Aarnio  <mea@nic.funet.fi>

	* Released 2.99.20

	* include/ta.h, transports/*/*.c
	    Changed the way the  diagnostic() call works,
	    now the SMTP transporter can send a "retryat +NNN "
	    request.  It is used for rescheduling entire thread
	    for a bit later time -- now fixed at 60 seconds.

	* scheduler-new/
	    Revised somewhat the internal logics, introduced
	    active use of "retryat" comminication primitive
	    from the transport agents to the scheduler.

	    Fixed (?) the timeout problem reported from Hongkong,
	    also fixed another "PROC NOT IN IDLE CHAIN", which was
	    caused by childs dying prematurely for some reason.

Wed Oct 18 09:10:07 1995  Matti Aarnio  <mea@nic.funet.fi>

	* Released 2.99.19

	* hostenv/*, scheduler-new/pipes.c, scheduler-new/transport.c,
	  scheduler-new/threads.c, scheduler-new/Makefile.in:
	    If the system can do a bi-directional pipe, at least
	    a socketpair(), we need only ONE fd per child.  Enable
	    by hostenv define  SOCKETPAIR=
	    (TODO: SysV has STREAMS-pipes, add support for them into
	           the  scheduler-new/pipes.c, then all three existing
		   methods are covered... )
	    ( scheduler-new/pipes.c  is a new module.. )

	* scheduler-new/threads.c, scheduler-new/transports.c:
	    Finally found (?) the reason, why running childs are lost,
	    and mis-calculated occasionally.  (It turned out to occur
	    most frequent with  error-channel, but had nothing to do
	    with any channels per se..)

	    Anyway, sometimes a child is killed, and the recovery
	    was mis-treated, but the reporting-fd still had data!
	    Thus every now and then, while a process was gone, but fd
	    (and thus a pid-slot) was still in use, and the process
	    was thought to be valid for "feeding a child", for example..

	* transports/smtp/smtp.c:
	    When doing close() due to change of host, or a final close, don't
	    just close(), do "QUIT" + close()!

Fri Oct 13 17:21:27 1995  Matti Aarnio  <mea@nic.funet.fi>

	* hostenv/IRIX53, router/prototypes.h, scheduler*/mailq.c:
	    IRIX-5.3 diffs from  Darryl Miles <dlm@r-net.u-net.com>

	* scheduler-new/
	    - Still more hammering at it with DEC ATOM-tools Third Degree :)
	      Now only memory leakages around are in the system libc! (Brr...)
	    [ well, new leaks introduced later, but that is another story.. ]

Thu Oct 12 20:23:26 1995  Matti Aarnio  <mea@nic.funet.fi>

	* smtpserver/smtpserver.c:
	    Fixed an error in SMTP EXPN, and VRFY.

	* scheduler-new/
	    - fixed expiry processing (when multiple recipients exist for
	      the message)
	    - fixed process counters -- idle_cleanup() leaked pids..

Mon Oct  9 11:07:25 1995  Matti Aarnio  <mea@nic.funet.fi>

	* scheduler{,-new}/transport.c:
	    Improved (?) support for IBM AIX systems
	    (select() system call.)

	* include/hostenv.h, hostenv/*:
	    STDLIB= -> USE_STDLIB -> include <stdlib.h> in  hostenv.h
	    UNISTD= -> USE_UNISTD -> include <unistd.h> in  hostenv.h

	* router/rfc822.c, router/rfc822hdr.c:
	    Hide away (effectively removed) "resent"-processing, so that
	    if there are headers in there, no new "Resent-" headers are
	    added just because some "Resent-Message-Id:" -exists, but no
	    "Resent-To:"...

Wed Oct  4 15:15:03 1995  Matti Aarnio  <mea@nic.funet.fi>

	* Released 2.99.18

	* transports/smtp/smtp.c:
	    Two fixes to a case where system doesn't have working mmap()

	    One change so that report() routine tells more meaningfull info.

	* router/router.c:
	    Rid the USE_BSDGETPGRP, and use USE_BSDSETPGRP instead.
	    It is too much hassle to change all hostenv files to
	    handle this othervice..

	* scheduler-new/:
	    Hacking continues at all fronts, still there is some
	    discrepancy in between data-structure counters, and
	    values counted, when chains are traversed!

	    Now the scheduler has an option to create performace
	    monitor log:  -l logfile.name

	    The file looks like this:
		812819196 167223-3 0 12 ok smtp/ugcs.caltech.edu
		812819197 167227-1 0 11 ok smtp/udcf.gla.ac.uk
		812819212 167231-3 0 7 ok smtp/sci.fi
	    Columns are: - spool-file creation time (ctime)
			 - spool-id (filename)
			 - time difference from creation of spool file
			   to route file creation (secs)
			 - time difference from creation of route file
			   to delivery of the message (secs)
			 - what happened (ok/error/expiry)
			 - recipient channel/host

	* Makefile:
	    Better integration into the whole, I hope.
	    Someday soon the "scheduler-new" will be changed
	    to be "scheduler", and current "scheduler" becomes
	    "scheduler-old" ...

Sun Oct  1 15:57:39 1995  Matti Aarnio  (mea@oh1mqk)

	* Dumped 2.99.17 -- and a bit later revised scheduler-new..

	* libsh/Makefile{.in,}: (Michael Thompson <mickey@diva.com>)
	    Fix to an awk script embedded into the Makefile.

	* scheduler-new/
	    It works !    Old configuration information is out of date.
	    There are still open issues, see associated commentary files..

Fri Sep 29 09:22:50 1995  Matti Aarnio  <mea@nic.funet.fi>

	* transports/smtp/smtp.c:
	    Odd, SMTP response "552 permanent resource limitation"
	    did trigger ONLY an EX_TEMPFAIL, which caused retry..
	    Does now EX_UNAVAIL, which causes snappy reject.

Wed Sep 27 22:00:28 1995  Matti Aarnio  <mea@notebook.mea.utu.fi>

	* Makefile:
	    Changed subdirectory makefile re-generation method slightly.
	    Now if the production fails, it won't (I hope) scramble the
	    original file...

	* compat/rmail/Makefile, compat/sendmail/Makefile:
	    Install "rmail", and "sendmail" into $MAILBIN !
	    Let sysadm to add symlinks from where-ever the
	    original locations are to the $MAILBIN/ ..

	* proto/zmailer.sh:
	    The script will check that   $MAILBOX  points to a directory
	    so that the ZMailer can't be started on a mis-configured
	    system... (.. at least of that part.)

	* transports/libta/mimeheaders.c:
	    Recognize "KOI8*" -fonts as alias to US-ASCII, when content is
	    7-bit only..

	    Recognize also when HEADERS need MIME-2, that is, coding 8-bit
	    chars in headers (subject et.al.) into MIME-2 format..

	* transports/libta/writeheaders.c:
	    If converted headers exist, write them ALWAYS!

	* transports/mailbox/mailbox.c, transports/sm/sm.c,
	  transports/smtp/smtp.c:
	    Use  strdup()  instead of  strsave().  Makes difference,
	    when it occurs on a transporter waiting for next work..

	* transports/smtp/Makefile*:
	    For "install"-target, make sure also "mprobe" exists.

	* transports/smtp/smtp.c:
	    If headers have 8-bit chars, we may need to convert them to
	    MIME-2 (RFC-xxxx) "coded words"

	    If EHLO+HELO fails, open same machine again, and do HELO
	    only, if THAT too fails, try next MX...

	    Report (into log-file) about connection making, and
	    possible errors therein..

	* scheduler/
	    Lots of small changes - prototypes for functions.

	* scheduler/mailq.c,     scheduler/qprint.c,
	  scheduler-new/mailq.c, scheduler-new/qprint.c,
	  scheduler/scheduler.h, scheduler-new/scheduler.h:
	    Noticed that qprint on Linux didn't like at all the reported
	    vertices from AXP machine, where vertex storage address was
	    well ABOVE 4 G (max value for unsigned 32-bit long at i486..)

	    Now the vertex structure has a field where qprint() can
	    store incrementing SMALL integer unique one for each
	    vertex.  The vertex identifiers start now from 1 each
	    time the mailq is run...

	* scheduler-new/
	   The face-lift project continues, it CAN do most of the things
	   already, but it is somewhat sloppy at process scheduling, and
	   tracking.

Tue Sep 19 11:00:52 1995  Matti Aarnio  <mea@nic.funet.fi>

	* transports/smtp/smtp.c:
	    A set of options that change their values during the
	    runtime are reset before  smtpconn().

	    If  "EHLO"+"HELO"-pair crashes (like it does with some
	    SMTP-servers), open a new connection, and do "HELO" only.

Mon Sep 18 10:42:37 1995  Matti Aarnio  <mea@nic.funet.fi>

	* Makefile:
	    Dumped version 2.99.16 after public demand..

	* smtpserver/smtpserver.c:
	    Extended the trappings of errno's from  accept().
	    On Linux we have seen (among others)  ECONNRESET,
	    which earlier did cause swift exit(1), because
	    only EINTR was tolerated...  ( .. and incidentally
	    the EINTR didn't happen at all, because the signals
	    are of syscall-restarting nature..)

	* transports/smtp/smtp.c:
	    When writing to a log-file, write also info regarding
	    connection attempts so we can look when remote systems
	    are unreachable...

	    Fix the '-8' -flag when the message content isn't
	    MIME, but we want to be 8-bit transparent..

Sat Sep  9 01:13:20 1995  Matti Aarnio  <mea@nic.funet.fi>

	* scheduler-new/ :
	    The scheduler will have complete ``face-lift'',
	    before this is over...  Now made separate work
	    copy, and left 2.99.15 version with old name..

Sat Sep  9 01:04:55 1995  Eugene Crosser <crosser@online.ru>

	* transports/mailbox/mailbox.c:
	    More generic (?) approach of UID/GID handling, we hope.

	* router/libdb/search.h:
	    Changed one "void *" to "char *", because Sun Solaris
	    C-compiler (SparcWorks ?) didn't like to do pointer
	    arithmetics with void pointer..

Fri Sep  1 11:37:09 1995  Matti Aarnio  <mea@nic.funet.fi>

	* transports/smtp/smtp.c:
	    Thomas Knott spotted (and fixed) a bug on email processing
	    when sending 8-bit mail over an ESMTP connection, and the
	    system does not support MMAP service..

	* include/mailer.h:
	    Added macroes:  STREQ() and STREQN() (case SENSITIVE string equal)

	* router/rfc822.c:
	    The ``FindHeader()''-macro uses now case SENSITIVE lookup
	    of the header lines. Thus "From "-lines will not match those
	    of "from "..  (Nothing breaks, I hope..)

	* libsh/io.c: PUTC(), vsiodoprnt()
	    Two subtle one-off errors which DEC OSF/1 ATOM-tool
	    "Third Degree" detected. These caused actually buffer
	    overflows :-( (by one byte), which in turn caused
	    far later errors, which looked rather weird..

	* scheduler/ - all files :)
	    Made prototype functions for all inter-twined routines
	    used in the scheduler, cleaned out several unused ones.
	    (Not yet doing things quite like I want, but better..)

	* hostenv/FreeBSD-2.0:
	    Contributed by Tom Samplonious.


Fri Aug 25 13:24:30 1995  Matti Aarnio  <mea@nic.funet.fi>

	* Release of code version 2.99.15
	  A big pile of changes all around, summary below:

	* Incorporated (finally!) Lehigh's AIX-port into the main source.
	  I don't know how clean it is, but...

	* hostenv/Linux, hostenv/OSF1v3.0-Alpha, hostenv/OSF1v3.2-Alpha:
	    Added "MMAP=", and "STRERRNO=" for Alphas, "STRERRNO="
	    only for Linux (on which the mmap() is a bit troublesome..)
	    Added also "RESOLV_LIB=-lresolv" to Alphas.

	* doc/zmdirs.{fig,ps}, doc/zmsched1.{fig,ps}:
	    Couple pictures telling about directory, and file relations
	    within the ZMailer.

	* include/sysprotos.h:
	    DEBUG_FOPEN -things for debugging FILE * leakage..

	* libauth/authuser.c:
	    Fixed variable declarations.

	* libc/__fopen.c:
	    Compile the library always, just the USE of it is left to user
	    applications compilation.

	* libc/strerror.c:
	    Verify that error number is in valid range -- detected
	    a case of errors where the returned errno was 8800+, and
	    got most peculiar error results...

	* libsh/execute.c:
	    Small changes to ensure compilability with multiple compilers;
	    apparently somehow the optimizers (gcc-2.7.0, and DEC's
	    "cc -migrate" both on Alpha) generated skewed code, which
	    produced wrong result.

	* libsh/tregexp.c:
	    The "trace regexp", and "trace matched" (I think) regexp
	    TRACE routines produced parts of their output to wrong place
	    (to stdout via  putchar() -routine) thus causing trouble when
	    trying to trace large-scale processing.  Now all output from
	    this file goes to some "char *" -buffers, or to stderr.

	* proto/cf/aliases.cf:
	    Had one split line, and other minor changes.

	* proto/cf/aliases3.cf:
	    Yet another slightly edited version of the default "aliases.cf"
	    (untested!)

	* proto/zmailer.sh:
	    The prototype of the "zmailer" -command got rid of vestiges
	    related to "$POSTOFFICE/scheduler/" -directory.

	* router/functions.c run_listexpand():
	    New option "-p", tried to use  "router()" -entrypoint, but
	    apparently it wasn't very successfull.  Hmm..

	* router/libdb/bind.c:
	    Problems related to 64 bit machine, where "u_long" is rather
	    much larger, than expected "u_int"'s size...

	* router/rfc822.c:
	    Changed directory scheme to match that of the scheduler by
	    getting rid of "$POSTOFFICE/scheduler/" -directory

	* scheduler/agenda.c:
	    Fixes on time-stamp processing, adding up-to-date code
	    into time handling -- setting all variables that are later
	    read from.

	* scheduler/mailq.c:
	    Got rid of "$POSTOFFICE/scheduler/", and to some extend
	    replaced it with "$POSTOFFICE/transport/".

	* scheduler/msgerror.c:
	    Use new directory/file-paths.

	* scheduler/scheduler.c:
	    Use new directory/file-paths

	    Read files from the directory into time-stampted queue
	    (with file's st_ctime), and accept into it only those
	    that are not already in processing.

	    Parse _CF_SENDER -entries from the scheduled job, and
	    use that address (well, last one of them) as an address
	    for sending error replies to.

	* scheduler/scheduler.h:
	    Replaced "int rptwait" with "int hungry", though neither
	    are in use...

	* scheduler/transport.c:
	    Use new directory/file-paths.

	    Prepare for using bi-directional communication in between
	    scheduler, and transporters -- so that scheduler starts
	    a transporter, and gives it synchronously one job at the
	    time, and waits for "#hungry\n" -message before feeding
	    another...

	* scheduler/update.c:
	    Use new directories/file-paths.

	    Support "#hungry\n" -messages

	* smtpserver/rfc821scn.c:
	    Accept domain name components.

	    Increase the  listen()  queue size.

	* smtpserver/smtpserver.c:
	    Voice complaint, when user tries to feed us:
		MAIL FROM: someone@somewhere
	    that is, when the input is against the RFC-821 syntax..

	* transports/errormail/errormail.c, transports/hold/hold.c,
	  transports/mailbox/mailbox.c, transports/sm/sm.c,
	  transports/smtp/smtp.c
	    Support the new "#hungry\n" -style "feed me" messages.

	    Fixed a couple "if (foo = faa)" vs. "if (foo == faa)"
	    errors in the source.


Tue Jun  6 23:35:34 1995  Matti Aarnio  <mea@nic.funet.fi>

	* transports/sm/sm.c, transports/smtp/smtp.c,
	  transports/hold/hold.c, transports/mailbox/mailbox.c,
	  transports/errormail/errormail.c:
	    Amended acceptable command-entry format to be:
		spool/file/name [ \t host.data ] \n
	    This in preparation to alter scheduler to keep
	    TWO pipes open for each running transporter,
	    and to feed them ONE JOB at the time.

	    To achieve syncronization the report-back format
	    is amended with a blank line after the last response
	    from entries in a file. (That is, an extra "\n".)

Sat Apr 15 02:05:18 1995  Matti Aarnio  <mea@nic.funet.fi>

	* transports/sm/sm.c:
	    Fixes on MIME QP-decode conversion mode.
	    Now QP-decode works right.

	    (Somewhat earlier..)
	    Added also couple lseek()s to that the message
	    is now processed with correct headers..

Sun Mar 26 20:56:22 1995  Matti Aarnio  <mea@hamsterix.funet.fi>

	* (almoast all files..)
	    "A bit" more of 64-bit stuff.
	    A change on  splay-tree symbol format caused severe
	    repercussions to occur, namely a widely-held assumtion
	    that "sizeof(void*) == sizeof(int)" caused serious trouble :-(

Thu Mar 23 00:56:05 1995  Matti Aarnio  <mea@hamsterix.funet.fi>

	* transports/libta/ctlopen.c ctladdr():
	    A bit more generic way to scan for control addresses...
	    a way which does not miss the beat when there is 8-bit
	    chars on tokens...

	* router/functions.c:
	    Re-arranged the usage/setting of  errors_to -variable.
	    Now it should not cause spurious errors on free()-time!

	* transports/mailbox/mailbox.c putmail():
	    Parametrize putmail() with "w" (for pipes) and "a+"
	    (for files).  OSF/1 3.2 had problems when pipe was
	    fdopen()ed with "a+"... :-/

	    Instead of using  getservbyname("biff","udp"), do hard-wire
	    the BIFF-port to the client -- sometimes (SunOS 4.1.3 w/ NIS)
	    that library call is extremely SLOW to return...

	    A SCO-user reported, that MMDF-format is:
		C-A C-A C-A C-A
		message1
		C-A C-A C-A C-A
		C-A C-A C-A C-A
		message2
		C-A C-A C-A C-A
		...
	    Instead of (like it was coded here):
		C-A C-A C-A C-A
		message1
		C-A C-A C-A C-A
		message2
		C-A C-A C-A C-A
		...
	    Oops about that...

Thu Feb  9 20:28:22 1995  Matti E. Aarnio  (mea@oj287.astro.utu.fi)

	* Dump 2.99.13

	* router/rfc822.c makeLetter():
	    Process all headers, don't just SQUIRREL() away
	    when there is mal-formed envelope information.
	    This way the messages will not just disappear
	    into $POSTOFFICE/postman -directory.

	    One particular bogon format is perhaps detectable..
	    ">From ..." as the FIRST line.  Such case is possible,
	    when a faultly configured  sendmail/smail  feeds
	    our system via SMTP, but is configured to feed UUCP..

	* scheduler/transport.c:
	    Changed all references to number of open files in
	    the system to use common reference platform from
	    library call  resources_query_nofiles().

	    This mattered especially when the  cpids[]-array was
	    allocated by using   resources_query_nofiles(), and
	    other references to it were limited by  FD_SETSIZE
	    (for example), but THAT happened to be larger (like
	    2 or 4 times) than the allocation size...

Wed Feb  8 00:51:59 1995  Matti E. Aarnio  (mea@oj287.astro.utu.fi)

	* transports/smtp/smtp.c:
	    Yet one more loose thread on the SMTP connection closure
	    survivability.  (Detected by an SIGSEGV on NULL ptr..)

	* transports/mailbox/mailbox.c main():
	    New option: "-h 'hostname'"
	    Assists the success with scheduler configuration containing
	    "byhost", when scheduling this piece of email.
	    (Such scheduling may be used to run "Zillions" of parallel
	     mailboxes -- "maxchan=20, maxhost=1, byhost", and thus
	     have each email recipient processed individually.
	     This REQUIRES that the router stores something personal
	     to each recipients "host"-field, not just "-"...)

	    When this option is not used, it defaults to the original
	    behaviour, where "mailbox" delivers ALL "local/*" -channel
	    emails of the file during one invocation.

	* transports/libta/ctlopen.c ctlopen():
	    Revised a bit the "Cannot open control file..." -message
	    by removing a potential `printf("%s",NULL);' -case..

	* libc/myhostname.c:
	    An extra indirection causing  getmyhostname() to yield
	    wrong data in place of FQDN hostname...
	    Hmm..  Wrestling it to be more commonly available,
	    (various platforms) was a bit difficult -- even inbetween
	    SunOS and Solaris-2..

	* transports/smtp/smtp.c:
	    Rewamped the connection tear-down code.  Now it SHOULD
	    happily use same connection for multiple emails.

Tue Feb  7 00:47:26 1995  Matti E. Aarnio  (mea@oj287.astro.utu.fi)

	* Dump 2.99.12

	* scheduler/scheduler.h, scheduler/scheduler.c, scheduler/agenda.c,
	  scheduler/transport.c:
	    Actual long-standing (ever since 1.0 ?) problem was the usage
	    of wrong filepath in the transport.c:tscan(), but without
	    some external help, the right one was not available..
	    (Scrambled especially the "-s" option!)

	    For fixing it was necessary to realize, that
		1) Each file is scheduled only once for each thread
		2) thus can be created a pointer into CTLFILE-block
		   which points to the CURRENT thread-vertex
		   (a companion for "mark" used for tscan() )
		3) the current vertex pointer can now contain an entry
		   to the path where the file is linked to
	    With these pointers in places,  transport.c:tscan()  and
	    after it, the client scheduling, can finally be done reliably.


	* scheduler/scheduler.c, scheduler/transport.c:
	    Once more, re-wamped the SIGCHLD processing, as
	    2.99.11 generated scheduler zombies on SunOS 4.1.x

Mon Feb  6 03:33:03 1995  Matti E. Aarnio  (mea@oj287.astro.utu.fi)

	* Dump 2.99.11

	* scheduler/transport.c:
	   The  waitandclose() is called when the file-descriptor
	   is closed, or the read causes an error.  (EINTR is no
	   error..)

	* libc/getopt.c:
	    Wrong system-wide definition file -- must be "hostenv.h"
	    instead of "libsupport.h"..

Sun Feb  5 03:12:02 1995  Matti E. Aarnio  (mea@oj287.astro.utu.fi)

	* scheduler/resources.c:
	    sysconf()-calls appear to be problematic -- on Solaris
	    it yields wrong data :-/

	    Wow, must check if scheduler uses stdio anywhere,
	    if not, it can run (On Solaris) 1024 fds..

	* scheduler/{transport.c,scheduler.c,scheduler.h}:
	    Defined "USE_SIGREAPER" in the  scheduler.h, and
	    when it is defined (no reason to take it off ?)
	    uses wait() immediately on the childs, and if
	    it matches to actual transporter child, marks
	    it as reaped on  cpids[] -array.
	    End of "Scheduler Zombies" ?

Sat Feb  4 17:34:14 1995  Matti E. Aarnio  (mea@oj287.astro.utu.fi)

	* hostenv/00README, include/libz.h, include/mailer.h, lib/pwdgrp.c:
	    Inverted the test, and changed the variable name..  Now if we
	    ever DO need to use our own version of  getpw{nam,uid}() and
	    getgrnam(), we can define  ZGETPWNAM on the host environment.
	    I doubt we ever do.  (This change removed one COMMON problem
	    on porting to other platforms..)

	* transports/smtp/smtp.c:
	    Revised the timeouts.  Now output will abort if it can't
	    write at the rate of 1kB/5 minutes, rearm after every kilobyte.
	    If commands don't respond within 5 minutes (earlier was 10 minutes)
	    it also timeouts -- except with "." to "250 OK", which is 10 mins.
	    ( RFC 1123 )

	* smtpserver/smtpserver.c:
	    Timeout parameters, now it dies out pretty fast if the
	    remote end does not feed data in fast enough...
		20 minutes for in between SMTP commands
		10 minutes for a kilobyte of SMTP DATA.

	* smtpserver/smtpserver.c mgets():
	    Something funny with response buffer realloc(); It did scramble
	    the pointer to the chars in the buffer (GCC 2.5.8 on SPARC),
	    and eventually caused a SIGSEGV..  Amazingly small change
	    fixed it :-/

	* A LOT changes right and left, NATIVE port to OSF/1v3.0 on Alpha.
	  Files affected:
		Config.osf1, hostenv/OSF1v3.0-Alpha, lib/rfc822date.c,
		compat/sendmail/sendmail.c, libc/getopt.c,
		include/authuser.h, nclude/limits.h, include/mailer.h,
		libauth/authuser.c, libauth/authuser.h, libmalloc/assert.h,
		livmalloc/externs.h, libsh/execute.c, libsh/interpret.c,
		libsh/sslwalter.c, libsh/trap.c, router/libdb/bind.c,
		router/db.c, router/functions.c, router/prototypes.h,
		router/rfc822.c, router/rfc822hdrs.c, router/router.c,
		scheduler/mailq.c, scheduler/msgerror.c, scheduler/update.c,
		scheduler/scheduler.c, scheduler/transport.c,
		smtpserver/smtpserver.c, transports/mailbox/mailbox.c,
		transports/smtp/smtp.c

	* (no file):
	    Noticed that Rayan Zachariasen no longer has an account on
	    U of Toronto.

Thu Jan 19 02:34:02 1995  Matti E. Aarnio  (mea@oj287.astro.utu.fi)

	* Makefile:
	    Patchlevel=10, DUMP

	* transports/smtp/smtp.c main(): 
	    Fixup of parameters of the  getopt() call.

Wed Jan 18 13:29:50 1995  Matti E. Aarnio  (mea@oj287.astro.utu.fi)

	* router/functions.c run_listexpand():
	    When "rrouter" evaluation meets a duplicate removal,
	    it returns a list of "()" -- so, an object without
	    contents.  (Again SIGSEGV..)

	* libc/mail.c mail_close():
	    When ZENV-variable  ROUTERDIRS does have invalid elements,
	    use the last valid element (or the default of "router")
	    as the directory name.
	    ( "sendmail", and "smtpserver" are affected by this! )
	    ( Sure, nobody enters invalid elts into the dirlist ? Heh.. )

	* transports/smtp/smtp.c writemimeline():
	    Did wrong thing, when outputing QP coding, had a one-off
	    with "column" variable, when it was a question about
	    line prefixing "."...  (Auch!)

Tue Jan 17 10:53:02 1995  Matti E. Aarnio  (mea@oj287.astro.utu.fi)

	* hostenv/Linux, hostenv/SunOS5.3:
	    "GETPWNAM=" -- MUST BE DEFINED, as the otherwise default
	    of iterating with  getpwent() is BAD MEDICINE!
	    This has been the reason for several odd problems on POSIX,
	    and alike, systems!
	    ( "include/mailer.h"  has "#define getpwname zgetpwnam" to
	      map the normal library call to ZMailer wrapper.. )

	* scheduler/scheduler.c:
	    A missing "int wrkcnt;" variable declaration..
	    (How on earth it did slip into the dump ?)

Fri Jan 13 13:59:07 1995  Matti E. Aarnio  (mea@oj287.astro.utu.fi)

	* Makefile:
	    PATCHLEVEL=9, dump for public tests.

Thu Jan 12 12:31:02 1995  Matti E. Aarnio  (mea@oj287.astro.utu.fi)

	* router/functions.c:
	    When the  $ROUTERDIRS  is defined, but not all dirs
	    in it do exist, skip the nonexistent ones.
	    (It was FAST core-drop time at nic.funet.fi ..)

	* Makefile:
	    When cleaning, DO NOT delete libmalloc/version.c !
	    That file is separate from all other version.c's !

	* router/router.c main():
	    Altered XMEM-compile-option related usage of "fileno()" macro.
	    Actually got rid of it...

Wed Jan 11 14:22:14 1995  Matti E. Aarnio  (mea@oj287.astro.utu.fi)

	* router/rfc822.c run_rfc822():
	    Open the mail-file as O_RDONLY ( fopen(file,"r") ) instead of
	    "r+" (O_RDWR), thus under no circumstances allow our internal
	    bugs to cause leakage of logs (!) into the mail-body !
	    (Original code claimed the "r+" is needed for locks to succeed,
	     however  link()/rename() -"lock" works quite well without...)

	* scheduler/scheduler.c, scheduler/transport.c, man/scheduler.8:
	    A runtime option "-N ##" to set how many file-handles
	    are to be left open when a client is started.  On most
	    systems that number is low -- under 10 or so, however
	    on Solaris it must be far higher..   Default value (32)
	    works for me (on Solaris), however I have had comments
	    that it isn't enough (on Solaris) :-/

	* router/functions.c run_listexpand():
	    Changed somewhat the address parser -- finally (?) got it right!

	* router/rfc822hdrs.c pureAddressBuf(): (NEW)
	    Outputs pure address into a buffer for usage as router argument.

	* router/libdb/ordered.c, router/libdb/unordered.c, router/db.c:
	    - Moved  readchunk()  to the end of the  .../unordered.c from
	      router/db.c
	    - Teached "db" to flag a case of using "Indirect" post-
	      processor for things other than ordered/unordered relations.

	* libmalloc/, (libmalloc-o/)
	    Mark Moraes'  malloc-1.17.
	    The previous one is in  libmalloc-o, until deleted..

	* transports/smtp/smtp.c, transports/sm/sm.c:
	    When translating to QP, always translate
	    the last SPACE/TAB on the line.

	* transports/libta/mimeheaders.c  check_conv_prohibit():
	    Added another KLUDGE meaning to the "Content-conversion:"
	    header... "forced-qp", which forces QP output.
	    (Applied only into SMTP so far..)

Tue Jan 10 13:46:33 1995  Matti E. Aarnio  (mea@oj287.astro.utu.fi)

	* smtpserver/smtpserver.c:
	    Analyze headers a bit more.  Now complain immediately,
	    if subjected to 8-bit characters in any header aside of
	    "Subject:".  (Because for example PP will choke on us,
	    when we forward such a message and there is no MIME-HDRS
	    encoding on them..)

	    We can't (easily/portably) do the MIME-HDRS encoding for
	    the user, because we don't know his/her character-set.
	    (We can assume, of course, but it would not be universally
	     usable..  Hmm..  UNKNOWN-8BIT ?)

	* transports/sm/sm.c:
	    New option: -Q to create "narrow-QP-encoding", that is,
	    to encode TABs and SPACEs in QP.  Without this the QP-encoding
	    is created leaving them untouched..

Mon Jan  9 16:16:36 1995  Matti E. Aarnio  (mea@oj287.astro.utu.fi)

	* transporter/mailbox/mailbox.c:
	    If the host does not have  /var/spool/rwho/ -directory,
	    DO NOT complain about it (with exit()!) Failing to RBIFF
	    is NO fault!

	* scheduler/transport.c:
	    Before bind()ing  querysocket, do set  SO_REUSEADDR, so
	    it won't complain just because of old lingering connection
	    trails...

Sun Jan  8 22:26:35 1995  Matti E. Aarnio  (mea@oj287.astro.utu.fi)

	* router/functions.c, router/rfc822.c:
	    Restore my old (and cumbersome)  "errors_to"  trick
	    on list expansion.  Even though it causes the error
	    address for ALL messages cascading from one source
	    to expand into the LAST expansion's owner, it is better,
	    than no trap at all..  (the rfc822.c:sequencer() needs
	    a serious rewrite with those attributes..)

Fri Jan  6 01:59:09 1995  Matti E. Aarnio  (mea@oj287.astro.utu.fi)

	* Makefile:
	    Patchlevel: 8

	* router/functions.c: rd_{in,}stability(), run_daemon():
	    Revised a bit when it became evident, that the
	    multi-directory picking did not work anymore.

	* smtpserver/smtpserver.c:
	    Process the incoming message for headers.
	    Set "mail_priority" according to what you find
	    on the (possibly) existing "Precedence:" -header:
		- (nothing)	0
		"bulk"		1
		"junk"		9

	* doc/draft-*:
	    Pulled in new IETF SMTP related drafts (and some other)

	* README.UPGRADING:
	    Noted a change on 2.98 when the   proto/cf/*.cf -files
	    were altered to have a new way of processing the
	    "thishost" relation from $MAILVAR/db/localnames -file.

	* smtpserver/smtpserver.c:
	    "-M ###" -option: Absolute maximum (size) ever accepted
	    Code reorganize (a bit), load-aver blocked-access code
	    "421" instead of "400".

	* hostenv/*, libsh/execute.c, scheduler/transport.c,
	  smtpserver/smtpserver.c:
	     WAITPID coding for POSIX.1 waitpid() with WNOHANG ..

Thu Jan  5 00:28:45 1995  Matti E. Aarnio  (mea@oj287.astro.utu.fi)

	* libc/getzenv.c, libc/mail.c, libc/whathost.c, router/functions.c,
	  router/rfc822.c, router/router.c, scheduler/mailq.c,
	  scheduler/msgerror.c, scheduler/update.c, smtpserver/smtpserver.c,
	  utils/listexpand.c, compat/rmail/rmail.c, compat/sendmail/sendmail.c,
	  transports/errormail/errormail.c, transports/libta/ctlopen.c, 
	  transports/smtp/smtp.c, transports/libta/diagnostic.c,
	  transports/libta/lockaddr.c, transports/libta/markoff.c,
	  transports/mailbox/mailbox.c, transports/sm/sm.c, 
	  transports/hold/hold.c:
	    Converted to use   #include "mail.h"  instead of
	    the previous  #include <mail.h>

	* smtpserver/smtpserver.c, lib/detach.c, lib/loginit.c,
	  libauth/authuser.c, libsh/execute.c, libsh/trap.c,
	  libsh/zmsh.c, router/functionc.c, scheduler/scheduler.c,
	  compat/sendmail/sendmail.c, transports/hold/hold.c,
	  transports/errormail/errormail.c, transports/sm/sm.c,
	  transports/mailbox/mailbox.c:
	    Converted to use the new  "zmsignal.h"

	* include/zmsignal.h: NEW FILE
	    Created a file with all the signal handling that
	    various programs appear to need:
		SIGNAL_HANDLE(SIG,HANDLER)
		SIGNAL_HANDLESAVE(SIG,HANDLER,SAVEVAR)
		SIGNAL_HOLD(SIG)
		SIGNAL_RELEASE(SIG)
		SIGNAL_IGNORE(SIG)
	    (..	and  "#define SIGNAL_TYPE void" if it is not defined
		when using this header file --  libauth/authuser.c ! )

	* transports/smtp/smtp.c appendlet(): 
	    When decoding MIME QP on flight we MUST prepare to
	    meet pathologic input, namely a last line with
	    trailing "=" (so, no trailing "\n" ...)
	    When that occurs, we must inject the "\n"..

	* router/functions.c: run_listaddrs(), run_listexpand():
	    Changed (a bit) of the error message those two
	    can mail out.  "From: Error Channel  <MAILER-DAEMON>",
	    and "Precedence: junk".

	* scheduler/msgerror.c scnotaryreport(): 
	    Changed the function name -- clashed with libta.a ..
	    Made sure it becomes called only when there is real
	    NOTARY-DATA available, not in a case when the NOTARY-
	    DATA is "" ...

	* lib/rfc822scan.c, router/shliase.c:
	    Been wrestling with proper procedures for handling
	    one particular errorneous address ("From:" -line)
	    which used to cause router coredump..

	* transports/mailbox/mailbox.c:
	    Got a report that the new MAILVAR-misconfig-reporter
	    misses a case of valid  MAILVAR when the user does not
	    (yet) have a mailbox file in the mail-spool.  Hmm..
	    (Have not been able to reproduce this SunOS 4.1.3U1
	     reported error on my Solaris, have to try SunOS yet..)

	* libsh/interpret.c fapply():
	    When analyzing argument list (lisp-list), used wrong
	    data source for the for-loop continuation..
	    (Affected  "runas"  facility running "filepriv"...)

Mon Jan  2 00:03:33 1995  Matti E. Aarnio  (mea@oj287.astro.utu.fi)

	* transports/hold/hold.c:
	    From way back in history a "hold/home" -condition,
	    though I am not sure it really is that usefull.

	* Makefile:
	    Patchlevel: 7

	* README.UPGRADING: (new file)
	    Made some notes on what changes the ZMailer has had
	    during its evolution, and thus what things users should
	    be aware when upgrading from the previous versions.

	* router/libdb/ordered.c:
	    Removed the "seq_remap()" from here too.

Fri Dec 30 23:36:03 1994  Matti E. Aarnio  (mea@oj287.astro.utu.fi)

	* Makefile:
	    Patchlevel: 6

	* Dependencies:
	    Changed the order of *dbm -entries.  The lattest GDBM (1.7.3)
	    has compability functions with DBM and NDBM.  Thus their
	    linkage-order can be used to chooce which *DBM is really used.
	    (And especially if there is a wish to use genuine NDBM in
	     parallel with GDBM!)

	* router/libdb/gdbm.c, man/router.8:
	    Updated it truly to GDBM 1.7.3, and sent wishfull thoughts
	    to the bug-gnu-utils@prep.ai.mit.edu  for a real  gdbm_filefno()
	    function...  The present one is, well, err...
	    Added a few words of advice to the man-page of the router.

	    Using GDBM from a non-standard include/library location is
	    a bit painfull, having following kind defines on hostenv/XXX
	    may help:
		GDBM_INCL=	-I/opt/gnu/include
		GDBM_LIB=	-L/opt/gnu/lib -lgdbm
	    (The example assumes your GNU-things are on  /opt/gnu/ ..)


	* hostenv/Ultrix*, libmalloc/getmem.c:
	    Defined a  NO_MADVICE  cpp-define to have USE_MMAP usable on
	    Ultrix 4.3A (well, I am guessing, I don't have the machine).
	    On a case I got a report about, the system does not have
	    madvice(2) while <sys/mman.h> has defined MADV_RANDOM, why ???
	    Some odd library to be included ?

	    I DO NOT KNOW IF Ultrix3.* HAS MMAP() AT ALL!
	    It is historic stuff anyway, which nobody uses anymore, right ?

	* router/libdb/unordered.c, man/router.8:
	    Disabled/removed  seq_remap() and its associated  fstat()
	    call.  It is better to use "-m" on the relation definition.
	    (Documented it, as if it would be enough to teach people..)

	* libsh/trap.c:
	    Changed the message of pre-compiled FC-file magic mismatch
	    into something which is clearer - I hope.  It reports about
	    automatically recompiling the CF files to FC files, nothing
	    else.

	* smtpserver/smtpserver.c, smtpserver/Makefile, smtpserver/fdstatfs.c:
	    Localized all  *stat*fs()  versions into one file, which now
	    returns valid (?) data for the most systems that are around.
	    (Prompted by "Yet Another Special Case" -- Ultrix..)

Thu Dec 29 08:31:42 1994  Matti E. Aarnio  (mea@oj287.astro.utu.fi)

	* Makefile:
	   Patchlevel: 5

	* smtpserver/smtpserver.c:
	    Gives "a bit" mystic result-codes when the EHLO
	    response generation procedure is unable to create
	    a mail-spool-file  -- it was used earlier to
	    determine available free storage, but when I became
	    informed that using it in the "SIZE" code would mean:
	    "this server will never accept more than this size.."
	    which for such a dynamic quantity is clearly wrong..

	* transports/smtp/smtp.c:
	    Leaked file-descriptors -- the SMTP channel connections..
	    ( smtpopen() leaked them, to be precise.. )

	* Makefile:
	    Patchlevel: 4

	* transports/smtp/smtp.c, transports/sm/sm.c,
	  transports/mailbox/mailbox.c, router/libdb/unordered.c:
	    The case of NOT having  USE_MMAP  had things missing
	    (being non-tested, but one Ultrix version was done with it..)

Wed Dec 28 01:51:49 1994  Matti E. Aarnio  (mea@oj287.astro.utu.fi)

	* router/functions.c run_listexpand():
	    Fixed (again) an uninitialized "al" variable.
	    Odd that I THOUGHT of having it fixed at the master source...
	    (I thought this was a bug in ssift/tsift, but no.)

	* Makefile:
	    Set version to be: 2.99.3

	* transports/mailbox/Makefile:
	    Remove the reference to  dotlock.o -- it is INCLUDED into
	    the  mailbox.c, thus no separate compilation!

	* router/rfc822.c, router/rfc822hdrs.c:
	    Gave a deep look to the analysis of "Sender:" -header.
	    In a case when the provided "Sender:" is junk, like:
		to demo
		From: demo2
		Sender: demo3-[12]
	    it used to pick up the mal-formed "Sender:" header, which
	    is stamped as  BadHeader ! .. and used that junk on a call
	    to the router() -- amazingly the router() didn't crash on it..

	    Now it is a bit more persistent on picking up only valid
	    headers (so headers which are not stamped as "BadHeader"),
	    and use them.  If no valid sender header is found, one
	    mkSender() was added for creating a valid sender-header
	    as a last-ditch measure..

	* scheduler/transports.c:
	    Upped the number of FDs for a child-processes from 10 to 32.
	    Solaris childs were unable to mmap() all the necessary dynamic
	    libraries :-/

	* libsh/builtins.c: sh_elements()
	    Replaced it with the new Toronto (22e4) version.

	* libsh/{interpret.c,sh.ssl,sslwalker.c,optimizer.c,zmsh.c}:
	    Found out that  tsift DID NOT work :-/  A lot of wrestling
	    and spotting of tiny details got it finally running...

Sat Dec 24 00:46:15 1994  Matti E. Aarnio  (mea@oj287.astro.utu.fi)

	* Makefile:
	    Did set version number to be  2.99mea

	* Overview, INSTALL, README, README.solaris, README.HP-UX,
	  SiteConfig*, Config*, hostenv/00README, doc/guides/*, man/*:
	    Updates, but no real DOCUMENTING!
	    (that is, no new ZMOG...)

	* lib/nobody.c:
	    A bit of SVR4 features -- will automagically be able to
	    use correct value for "nobody" uid, if no ZENV variable
	    NOBODY is set -- or if it is set to "NOBODY=nobody"

Fri Dec 23 08:50:14 1994  Matti E. Aarnio  (mea@oj287.astro.utu.fi)

	* Dependencies:
	    Added "kvm" to the "smtpserver", and "gdbm" to several
	    others.  ALSO DOCUMENTED THE FILE!

	* smtpserver/loadaver.c:
	    Made some TRUE load-average extracters:
		- __linux__
		- SunOS 4.x
		- SunOS 5.x

	* scheduler/resources.c:
	    Made some TRUE resource codes for various platforms:
		- _POSIX_SOURCE
		- __linux__
		- SUNs (SunOS & Solaris)

	* transports/smtp/smtp.c smtpopen():
	    Trevor Paquette  spotted a missing execution path on
	    case when '-E' parameter is used for the smtp transporter,
	    and there is no "ESMTP" on the remote host initial banner.
	    (But my fix is different with less code duplication..)

	* libsh/execute.c, libsh/interpret.c, libsh/io.c,
	  scheduler/msgerror.c, smtpserver/smtpserver.c,
	  transports/sm/sm.c, transports/smtp/smtp.c,
	  router/functions.c, compat/sendmail/Makefile.in
	    Several changes by Byron Rakitzis to suit BSDI
	    (and probably most of the current BSD 4.4)

	    Added also new variable for the  Config:
		SENDMAILLIB=/usr/lib
	    becase for BSDI, BSD4.4, etc. it is desired to be:
		SENDMAILLIB=/usr/sbin

Thu Dec 22 10:38:26 1994  Matti E. Aarnio  (mea@oj287.astro.utu.fi)

	* transports/smtp/smtp.c, transports/mailbox/mailbox.c:
	    Pulled some more bits from Edwin Allum's Zmailer-2.2e4

	* router/libdb/bind.c:
	    From  Edwin Allum's  Zmailer-2.2e4  a resolved
	    retry tuneup -- to speed the resolver to give up
	    when there is no data coming up..

Thu Dec 15 23:29:59 1994  Matti E. Aarnio  (mea@oj287.astro.utu.fi)

	* scheduler/mailq.c:
	    Altered a bit the style of "nonlocal" settings.
	    Now the thing should not jam on "localhost" being
	    unavailable, because DNS says so...

	* hostenv/*:
	    Copied in  Edwin Allum's configs for IRIXes, and
	    Guy Middleton's AIX3.2 -- and added DOTLOCK scheme
	    ( + some comments )  to SunOS4.1

	* sendmail/sendmail.c:
	    fchown() call was missing GROUP parameter.
	    Added there "-1"

	* transports/mailbox/mailbox.c:
	    Created   probably_x400()  -function, and altered error
	    reports on anonymous delivery to a file ("/...") to reflect
	    possible X.400 addresses, when such is likely.
	    ("/X=XXXX/Y=YYYY/...")

	    Merged in Ken Lalonde's/Edwin Allum's  DOTLOCK facility.

	* proto/zmailer.sh:
	    Small change on the parameters of the router startup:
		was:	... router -dkn$NROUTERS
		new:	... router -dkn $NROUTERS
	    Now it should start more than 9 routers...
	    (On some platforms there is a behaviour where former
	     would not start 10 routers, only one, while the later
	     would start all 10.. -- On Solaris 2.3 it works with
	     both ways, SunOS 4.1.3 (I think) had problems. )

	* libsh/interpreter.c, libsh/sh.ssl, ....
	    Altered   sift/in/tfis  construction to do STRINGWISE
	    regexpr matches with GNU regex engine, and converted
	    the old behaviour to name:  tsift/in/tfist

	    -- a bit later altered the names to be:
		sift/in/tfis	-- Tokens - compability alias
		tsift/in/tfist	-- Tokens  (new PRIMARY name)
		ssift/in/tfiss	-- Strings (new name)

Wed Dec 14 09:12:16 1994  Matti E. Aarnio  (mea@oj287.astro.utu.fi)

	* transports/smtp/smtp.c:
	    When doing verbose trace to a host without any MX-records,
	    Solaris 2.3 crashed the smtp transport -- printf() doesn't
	    like NULLs as string pointers...

	* transports/libta/lockaddr.c, transports/libta/ctlopen.c,
	  include/mail.h, scheduler/scheduler.c, scheduler/mailq.c,
	  router/rfc822.c:
	    In attempt to create a state-preserving safe multi-invocation
	    transaction locking:

	    A PID based locking -- THIS ALTERS THE SCHEDULER FILE FORMAT
	    AND THUS OLDER  TRANSPORTERS  MUST NOT BE USED IF THE ROUTER
	    IS NEW!  (The scheduler must also match!)
	    Recipient-definition line (lock location) was altered:
		Old:  "r~...."
		New:  "r~PPPPPP...."
	    where "~" is lock-flag, and "PPPPPP" is space for storing
	    transport-client PID -- or 6 spaces, when there is no lock.

	    From now-on, if there is a lock-state on some recipient, the
	    scheduler tests to see if there is a process (pid) processing
	    it, and continues with next job, dropping the locked one for
	    a moment.

	    All NEW jobs arrive both to the $POSTOFFICE/scheduler/,
	    and the $POSTOFFICE/transport/, collecting them happens
	    from the $POSTOFFICE/scheduler (so the current queue need
	    not to be touched), however while there are locked files
	    running, the scheduler will re-scan the $POSTOFFICE/transport/
	    directory every 5 minutes.  If a file from that scan has
	    its i-node number in  spt_mesh[L_CTLFILE] -database, it
	    is skipped (it is an active file, not some previously locked
	    one).

	* transports/smtp/smtp.c: deliver()
	    Oops on parameter processing, the forced 8-bitness didn't
	    happen..

	* router/libdb/bind.c, transports/smtp/smtp.c, transports/hold/hold.c:
	    resolver usage got a little change -- to avoid screwing up
	    request size parameter when doing retry.. (size storage variable
	    was also used as a return value storage -> query screwed up on
	    the retry..)

	* proto/cf/*.cf:
	    Many files, minor changes...  (And a couple major ones)

Tue Dec 13 13:26:05 1994  Matti E. Aarnio  (mea@oj287.astro.utu.fi)

	* smtpserver/loadaver.c:  NEW
	    A stub for getting the system load-average

	* smtpserver/smtpserver.c:
	    Respond with a
	  "400 Sorry, system is too loaded for email reception at the moment"
	    when the system load-average (from  loadavg_current())
	    is over a given threshold value
	    (XX: that message is most likely wrong.. )
	    (Yes, correct one: "421")

	* router/functions.c: run_listexpand()
	    The pseudo-lisp is tough stuff to get right...
	    Finally it does any arbitary expansion with very
	    little memory consumption :-)

	    => Rendered the  util/listexpand.c  obsolete...

Mon Dec 12 20:42:59 1994  Matti E. Aarnio  (mea@oj287.astro.utu.fi)

	* router/libdb/ordered.c, router/libdb/unordered.c,
	  router/libdb/search.h:
	    Use  USE_MMAP  capability and map the textual database
	    file into memory for later use -- will need less syscalls
	    for the lookup...

	* transports/smtp/smtp.c: writemimeline()
	    Counter each byte twice on the output when producing Q-P
	    encoded output -> output was circa 35 chars wide...  Oops..

Fri Dec  9 08:15:15 1994  Matti E. Aarnio  (mea@oj287.astro.utu.fi)

	* transporters/smtp/smtp.c:
	    One missing "break;" on  getopt() processing.  Oops..
	    Thanks to Terry Combs <combstm@appstate.edu> for the fix
	    (and I guess he uses the "-E" option..)

	* scheduler/
	    The Scheduler got some revampings into the  mux()/ipcpause()
	    routines, and their invocations so that inter-reaper delay
	    should shorten -- should do it via signal handler ?

	* router/libdb/header.c:
	    Re-defined the envelope environment entry "authinfo"
	    to be of  nilUserSemantics -> it will accept any input

	* router/rfc822hdrs.c: hdr_print()
	    Changed the printout of  DateTime -header so that
	    when a previously existing header is available, use
	    it as is, but skip the leading white space -> no
	    more EXTRA SPACE/TAB every time a message goes thru
	    the Zmailer.

	* util/listexpand.c:
	    Add envelope environment entry "via listexpand" to the
	    produced (new) file, thus the output will be like this:

	    Received: by nic.funet.fi via listexpand id <92706-1>;
		Fri, 9 Dec 1994 08:01:41 +0200
	    Received: by nic.funet.fi id <92690-3>; Fri, 9 Dec 1994
		08:01:37 +0200

	* transports/sm/sm.c:
	* transports/smtp/smtp.c:
	    "USE_MMAP"-version had problems at scanning for/advancing/
	    pointing to proper  location in the input file.
	    The net result was a loop in sm, and wrong contents in smtp.

	* smtpserver/smtpserver.c:
	    *Sigh* Solaris signal handling is more complex than "just"
	    "signal(SIGCHLD,reaper)" in the BSD... (a generic problem)
	    Luckily it is enough to handle it with  signal(SIGCHLD,SIG_IGN)
	    which works pretty much everywhere.


Fri Nov 25 09:41:24 1994  Matti E. Aarnio  (mea@oj287.astro.utu.fi)

	* transports/smtp/smtp.c:
	    One NULL passage to the  sprintf()  caused crash on Solaris,
	    same one prints "(null)" on SunOS...

	* lib/cfgets.c:
	    Forgot to keep an eye on counted length, and thus were
	    able to overflow the buffer...  Uargh..  ("--n;" missing..)

Wed Nov 16 22:57:22 1994  Matti E. Aarnio  (mea@oj287.astro.utu.fi)

	* router/functions.c: run_daemon()
	    Use  rewinddir()  instead of seekdir().
	    The rewinddir() works better on BSDI systems very least,
	    and apparently works on a major part of the systems
	    (I have yet to come by a system where it doesn't work..)

Fri Nov 11 11:44:28 1994  Matti E. Aarnio  (mea@oj287.astro.utu.fi)

	* hostenv/README  -- some documenting things (barely begun..)

	* transports/libta/ctlopen.c, include/ta.h, transports/smtp/smtp.c,
	  transports/mailbox/mailbox.c, transports/sm/sm.c:
	    Made a case of using  mmap()  to map into memory the
	    sharable (R/O) parts of the mail-file..

	* router/rfc822hdrs.c: mkMessageId()
	    Altered the created message-id format a bit, previous
	    timezone name "(ett)" will now be presented as "ett", and
	    the file will get a unique sequential number on it as well
	    (unique within each instance of the routing process.)

Thu Nov 10 10:01:55 1994  Matti E. Aarnio  (mea@oj287.astro.utu.fi)

	* Implemented  "Content-Conversion: prohibited" -header
	  to the transporters:
		transports/sm/sm.c
		transports/smtp/smtp.c
		transports/libta/mimeheaders.c
		transports/mailbox/mailbox.c
	  (follow the suite of the Sendmail+Emil..)

	* Eradicted  bcopy()  from the sources.  We can use  memcpy()
	  (possibly inline, possibly optimized library stuff) easily.
	  Files:
		lib/linebuffer.c	lib/token.c
		libc/bcopy.c		libc/whathost.c
		libsh/expand.c		libsh/io.c
		libsh/zsh.c		router/functions.c
		router/rfc822hdrs.c	scheduler/transport.c
		scheduler/readconfig.c	scheduler/mailq.c
		router/libdb/bind.c	transports/smtp/smtp.c
		transports/mailbox/mailbox.c
		support/nfslock/nfslock.c
	  Didn't eradict  bcopy() from  support/vacation/vacation.c !
	  It is a bit sensitive issue in there...

	* Incorporating patches for OSF1v2.0 by 
	  Franz Fischer <fischer@lpr.e-technik.tu-muenchen.de>
	     lib/allocate.c,		libc/getdtblsiz.c
	     libsh/io.c,		router/libdb/bind.c
	     router/prototypes.h,	router/router.c
	     scheduler/msgerror.c,	smtpserver/smtpserver.c
	     transports/smtp/smtp.c,	utils/makendbm/makendbm.c
	     utils/makendbm/ndbmlook.c
	  Those were some ALPHA related problems on the DNS handling,
	  and related declarations...  Also a couple "beauty points"
	  at the makendbm tools.

	* router/libdb/gdbm.c, hostenv/Linux
	    Finally re-tried compiling Zmailer on Linux, and caught
	    problems...  GDBM has changed since my previous touch
	    with it.

Mon Oct 10 01:07:24 1994  Matti E. Aarnio  (mea@oj287.astro.utu.fi)

	* router/functions.c  run_expandlist():
	    New "lisp-like" function to combine the functions of
	    the  listaddresses, and  zsh-script routine  maprrouter().
	    With this the router core expansion should minimize.

Fri Oct  7 16:21:53 1994  Matti E. Aarnio  (mea@oj287.astro.utu.fi)

	* lib/allocate.c:
	    Replaced one reference to  bcopy()  with  memcpy()..

	* transports/sm/sm.c:
	    Edited in the same routine as is in the  transports/smtp/smtp.c
	    to handle MIME conversions -- some details do vary..

	* transports/libta/mimeheaders.c, include/ta.h,
	  transports/smtp/smtp.c:
	    Still more restructuring, now clean (?) way to make
	    all the TEXT/PLAIN conversions on transfer:
	      -- 8BIT -> QP
	      -- 7BIT -- no change
	      -- QP   -> 8BIT (if the target is "force_8bit" ...)

Thu Oct  6 09:10:09 1994  Matti E. Aarnio  (mea@oj287.astro.utu.fi)

	* transports/smtp/smtp.c:
	    Restructured header pre-processing, now it can
	    downgrade "TEXT/PLAIN; CHARSET=ISO-8859-*"+"C-T-E: 8BIT"
	    into "TEXT/PLAIN; CHARSET=US-ASCII"+"C-T-E: 7BIT", when
	    it notices that message body is all in 7-bits..

	* transports/libta/mimeheaders.c downgrade_charset():
	    A new procedure

	* man/*
	    Some updates to man-pages..

	* SiteConfig*, Makefile{,.in}, libc/Makefile{,.in}:
	    "make install" so that it installs also  libzmailer.a
	    into user-defined  LIBRARYDIR, and  zmailer.h  into
	    user-defined INCLUDEDIR..

Thu Sep 29 09:55:40 1994  Matti E. Aarnio  (mea@oj287.astro.utu.fi)

	* transports/mailbox/mailbox.c:
	    Mailbox access-time preservation test was the wrong way :-(

Wed Sep 28 16:22:40 1994  Matti E. Aarnio  (mea@oj287.astro.utu.fi)

	* transports/mailbox/mailbox.c:
	    Nasty rewrite bug, which nobody had found for ages..
	    (Nobody but myself uses the MIME-rewritters ?)

Mon Sep 26 09:09:15 1994  Matti E. Aarnio  (mea@oj287.astro.utu.fi)

	* Dump 2.97mea

	* transports/mailbox/mailbox.c:
	    - MMDF-style mailbox separators with '-M' option!
	    - MIME-processing is now line oriented to facilitate
	      easier improving of it into handling beasts like
	      "message/alternate"  with multiple bodies..

Thu Sep 22 18:55:47 1994  Matti E. Aarnio  (mea@oj287.astro.utu.fi)

	* transports/smtp/smtp.c, transports/sm/sm.c, transports/hold/hold.c,
	  transports/mailbox/mailbox.c, transports/errormail/errormail.c,
	  scheduler/msgerror.c, scheduler/update.c, scheduler/transport.c,
	  scheduler/scheduler.c, smtpserver/smtpserver.c, libc/whathost.c,
	  lib/detach.c, transports/libta/warning.c, libmalloc/malloc.c,
	  libmalloc/getsize.c, libc/getdtblsiz.c, libsh/regexp.c,
	  libsh/execute.c, libsh/interpret.c, lib/rfc822date.c, router/db.c,
	  router/functions.c, transports/libta/ctlopen.c, hostenv/Linux:
	    Did port to Linux
	    (Various POSIX.1 problems..
	     Usually solved by "#include NDIR_H" ..)

	* transports/libta/buildbndry.c:
	    Added sequence "=_" into the boundary, thus rendering
	    it such which most likely will not be generated by any
	    MIME-compliant system in their message texts.

	* Makefile, libsh/Makefile, proto/Makefile:
	    Got rid of  /bin/ed  on file editing.
	    Instead uses AWK and SED. (Portability problems
	    to Linux caused this..)

	* Config, SiteConfig, bin/mklibsupport, ...
	    Configuring changed somewhat:
		- Compiler/compilation dependent things are on
		  file  Config
		- Site policy things (location of directories) are
		  on file  SiteConfig

	* transports/mailbox/mailbox.c ( putmail() ):
	    When CREATING a (mailbox) file, create it with ATIME of 0,
	    that is, "NEVER READ"...

Fri Sep 16 12:04:25 1994  Matti E. Aarnio  (mea@oj287.astro.utu.fi)

	* router/functions.c ( run_filepriv() ):
	    Added option  -M maxfilepriv  to the  $(filepriv XXX) to
	    get rid of a need to have system-wide compiled value for it.
	    Now I think we can create a system with  644 for ~user/.forward
	    and 664 for $MAILSHARE/lists/...  My users did ask for it..

Thu Sep 15 17:03:58 1994  Matti E. Aarnio  (mea@oj287.astro.utu.fi)

	* transports/mailbox/mailbox.c ( putmail() ):
	    Added ONE space to the FROM_ line:

	      From SPC from@addr SPC SPC date
				     ^^^ NEW
	    (To be compatible with competition -- err..  sendmail..)

Sat Sep 10 02:37:31 1994  Matti E. Aarnio  (mea@oj287.astro.utu.fi)

	* After a few days of testing at MAILHOST.UTU.FI, dumped 2.96..

	* smtpserver/smtpserver.c:
	    More fixes to the complex SMTP-option handling..

	* scheduler/readconfig.c:
	    SIGUSR1 -- rereadconfig() -- did crash on memory
	    corruption due to double-freeing a buffer.

	* scheduler/*.c:
	* transports/libta/ctlopen.c:
	    More fixes on the DSN, and related topics.

	* transports/mailbox/mailbox.c:
	    A message from  "channel error" (SMTP MAIL FROM:<>, or alike)
	    got bad UNIX mailbox header.  Now the "From_"-address is
	    always "postmaster" under such circumstances.

	* transports/smtp/smtp.c:
	    Do recognize the "DSN" (and "XDSN") magic tokens of NOTARY-DSN
	    capability on the remote system.
	    (Missing: actual DSN interaction..)

	* router/rfc822.c: ( sequencer() )
	* router/libdb/header.c:
	    Will accept DSN parameters, and carry them as attributes
	    to the router tasks, and in the end will output them to
	    the channels.  The scripts need to address problems on the
	    DSN data alteration, when it comes to list-expansions.
	    (Specs are developing..)

	    Thought: Internal list-expansion needs to be expanded into
		     a full-scale C-code which invokes router for the
		     recipients, and feeds them all the necessary attributes.
		     That way it will (perhaps) be SMALLER with its memory
		     usage as compared to the present   maprrouter()
		     script function.

	* router/rfc822hdrs.c, router/rfc822.c:
	    rfc822date() returns delivered UNIX-time in RFC822
	    format INCLUDING TIMEZONE CORRECTION, but we actually
	    want to create it only when it doesn't already exist,
	    otherwise it shall be left alone.
	    Trouble on translating to the local TZ is on several
	    mismatches in the time-zones, and frankly it is too
	    painfull to be really usefull.  When the full header-
	    string is there already, off we go and use it.

	* router/rfc822.ssl, router/rfc822walk.c, router/rfc822hdrs.c:
	    Parse and "understand" "Received: ... convert XXX;" -token!

Fri Sep  2 11:35:53 1994  Matti E. Aarnio  (mea@oj287.astro.utu.fi)

	* scheduler/scheduler.c:
	* scheduler/scheduler.h:
	    Initial code for parsing DSN related transporter header
	    entries.

	* scheduler/msgerror.c:
	* scheduler/scheduler.h:
	    Print out  "Original-Envelope-Id:", and "Original-Rcpt:",
	    if data is available (if not, be quiet about them.)

	* smtpserver/smtpserver.c:
	    Accepts (and syntax-checks!) IETF-NOTARY-DRPT parameters,
	    and checks upon illegal characters on the input line, like
	    feed of control/8-bit chars on the SMTP protocol line..
	    (ASCII 0:es are also flagged!)

	* include/mail.h:
	    _CF_RCPTNOTARY-tag -- "DSN parameters for preceeding recipient"
	    _CF_DSNENVID-tag   -- "DSN ENVID data"

	* include/mailer.h:
	    enum HeaderClass got new elts:
		eToDSN, eEnvid

	* router/libdb/header.c:
	    Learned to recognize new transport envelope headers:
		todsn, envid

	* include/ta.h:
	* transports/libta/ctlopen.c:
	    "struct ctldesc" has now "envid" field, and it
	    gets filled in on the  ctlopen()  parser..
	    There is also "dsnflags", which also gets filled..

Thu Sep  1 11:13:03 1994  Matti E. Aarnio  (mea@oj287.astro.utu.fi)

	* libsh/optimizer.c:
	    Bad interaction with  USE_ALLOCA() -- the  ncode[]
	    array MUST be returnable to the callers scope, thus
	    it can't be alloca() buffer...

Mon Aug 29 22:45:09 1994  Matti E. Aarnio  (mea@oj287.astro.utu.fi)

	* Dump 2.95mea, and put it running at NIC.
	  Public release tomorrow ?

	* transports/smtp/smtp.c:
	    EHLO-processing had parameter bug on  smtpwrite()...

	* scheduler/msgerror.c:
	* scheduler/scheduler.c:
	   Still more wrestling with NOTARY error reporting..
	   Now it prints REWRITTEN headers also from within
	   scheduler's error reporter...

Sun Aug 28 22:26:26 1994  Matti E. Aarnio  (mea@oj287.astro.utu.fi)

	* transports/mailbox/mailbox.c:
	* transports/smtp/smtp.c:
	* transports/libta/diagnostics.c:
	    More wrestling with NOTARY error reporting..

	* transports/errormail/errormail.c:
	    More wrestling with NOTARY error reporting..
	    Will write out REWRITTEN headers -- so that there
	    is local "Received:" entry as well!

	* scheduler/msgerror.c:
	    Still more wrestling with NOTARY error reporting..

Wed Aug 24 02:00:17 1994  Matti E. Aarnio  (mea@oj287.astro.utu.fi)

	* Dumped 2.94mea

	* smtpserver/rfc821scn.c:
	    Address like:  <test@test_vms.domain>  is to be accepted,
	    even though it is illegal, if you have a strict look at
	    the standards..

	* transports/mailbox/mailbox.c:
	* transports/smtp/smpt.c:
	    Testing NOTARY message production.

	* transports/libta/diagnostics.c:
	    Produce the NOTARY diagnostics ( notaryreport() )

	* scheduler/transport.c:
	    Had a peek as to why some machines (SunOS 4.1.3 most notably)
	    can't run more than about 50 (!) channel programs at a time!
	    (Marco Hernandez @ CREN.ORG reported this problem..)
	    At the moment:  NO IDEA  :-/
	    (20 hours later:
			Each scheduler file is kept open when it is in
			active processing, each active transporter has
			a diagnostics pipe back to the scheduler, and some
			systems have SIGNED CHARs as FD storage in FILE-
			structures..

			If transporters run with GANG-SCHEDULER, that is
			multiple files are spooled to same transporter,
			all those files must be kept open by the scheduler
			until the transporter acks them back..	)
	    (1-Jan-95: Most likely it is Open-Files resource limitation..)

	* scheduler/msgerror.c, scheduler/update.c,
	  transports/libta/diagnostic.c:
	    Revised report-back format, as well as error
	    reporting procedure fairly completely.

	    Now the transporters CAN report IETF-NOTARY data, and the
	    scheduler will then use it to report on the return email.
	    (Exact format evolves still, but one thing is sure:
	     it shall not contain \n's, nor \t's!)

	    Transporter main error reporter is  scheduler/msgerror.c,
	    NOT the  transports/errormsg/errormsg.c !
	    The later can be used for some trivialities, though..
	    (How the heck it can get NOTARY data ? -- solved three
	     days later..)

Tue Aug 23 21:52:18 1994  Matti E. Aarnio  (mea@oj287.astro.utu.fi)

	* transports/smtp/smtp.c:
	    An error in EHLO response analysis did omit the
	    final response line, which in one case did have
	    effect:
		250-XXXXX
		250 8BITMIME
	    Thus SMTP didn't learn that the receiver is 8-bit
	    capable..

	    Added an option to  smtp:  -E   -- try EHLO only if
	    the remote system has "EHLO" on one of its initial
	    message lines...  If not, don't do it.
	    Default case is to do  EHLO  ALWAYS, and if it fails
	    ("500 Unknown command", or hangup.., use HELO..)

	* transports/errormail/errormail.c:
	* scheduler/msgerror.c:
	    Skip over the Zmailer envelope lines in the original
	    email so that the file to be written out does not
	    contain anything but RFC-822 (+MIME) headers..

Wed Aug 17 14:12:06 1994  Matti E. Aarnio  (mea@oj287.astro.utu.fi)

	* utils/listexpand.c:
	    Wrote this to test how much 650 email recipients
	    will really expand the memory of the router.
	    Instead of running a built-in expansion within
	    the aliases.cf, this is to be called externally to
	    produce similar remapping and resubmitting the file
	    back to the router. (Via a trip thru scheduler, that is)
	    	    Internal expansion: 32 MB
	    	    External expansion: 3.5 MB (yes, only about 10 %!)

	* libsh/trap.c (eval): 
	    Carelessness on referring to the "savefile" buffer.
	    It can be NULL ptr under some occasions.
	    ( -> newaliases  crashed )

Tue Aug 16 17:04:43 1994  Matti E. Aarnio  (mea@oj287.astro.utu.fi)

	* Freezing and dumping 2.93mea

	* *.cf -files:
	    Processing of addresses which turn to be LOCAL to the
	    machine will with sample files (proto/cf/) produce
	    results like:
	    	(local nobody /dev/null 123)
		(local postmaster root 0)
		(local somealias "|/path/to/program args" 1234)
	    instead of the old style:
	        (local - /dev/null 123)
		(local - root 0)
		(local - "|/path/to/program args" 1234)
	    (These DO NOT contain my earlier quote additions, which
	     were for helping on expansions of esoteric addresses.
	     Oh well..  'Wrong' set of source scripts..)


	* many files..
	    FINALLY the mystic crashes on "router recipient" got
	    explained.  Stdio uses its own file descriptors, and
	    it takes only so many (resource: filehandles) leaked
	    (non closed) stdio buffers to use them all up, and even
	    though there are lotsa free fd's, there is no free
	    stdiobuf..  Mainly  router/functions.c: run_listaddrs()

	    Now the beast is written in portable manner, which only
	    assumes UNIX fd semantics (and that  dup() and dup2() work)

	    Mystic  libc/__fopen.c -file becomes used, if you define
	    -DDEBUG_FOPEN, Then it traces the usage of stdio files..

	* router/functions.c: run_daemon()
	    Fixed the memory allocation/freeup.  Memory that gets
	    freed explicitely is to be picked up from  MEM_MALLOC
	    space, not from anywhere else (did cause some cores..)

	* libs/ -- all libraries, most Makefile's, ..
	    All library files (*.a) get collected into one directory,
	    the "libs/"-directory.

	* transports/libta/mimeheaders.c:
	    Occasionally a transported file had:
	    	Content-Type: text
	    which caused carelessly written code to crash when
	    subtype (as in "text/plain") was not present at all..

	* hostenv/SunOS4.1:
	    Define  GETDTABLESIZE so that  libc/getdtblsiz.c won't
	    get compiled into a code and thus override system library
	    routine..

	* hostenv/SunOS5.2:
	    Use only  "MAILLOCK"  on Solaris, not the LOCKF at all!

	* transports/mailbox/mailbox.c:
	    On Solaris the file locking shall not be used on
	    "/dev/null"..
	    Incorporated  Edwin Allum's Solaris patches into
	    the code -- maillock() et.al.

	* transports/smtp/smtp.c:
	    Some minor tuneups on detecting when to downgrade headers,
	    and when not to.

	* libsh/interpret.c:
	    Under some conditions under-read varstack.  PURIFY test
	    use did help me to detect that at all..

      ( * At some non-defined point in history did dump
          zmailer-2.92 --- 940802 it appears to be.	)

Wed Jul 27 02:31:28 1994  Matti E. Aarnio  (mea@oj287.astro.utu.fi)

	* Freeze and dump zmailer-2.91mea-940727.tar.gz

	* many files..
	    Converting   emalloc(strlen(buf)+1) + strcpy()
	    to  strsave()  did cause amazing amount of problems.
	    They aren't all gone (don't know for sure, though),
	    and some others may have surfaced.

	* transports/errormail/errormail.c, scheduler/msgerror.c:
	    Alter error reporting towards that of the IETF NOTARY
	    working group draft -- not yet there by million miles,
	    I am afraid..
	    THIS ALTERED ALSO THE SYSTEM ERROR MESSAGE FILES!

	* */Makefile{,.in}:
	    Lotsa things..  Mainly on getting things to compile
	    ALL the related libraries before linking them in.

	* transports/libta/ctlopen.c, transports/libta/mimeheaders.c,
	  transports/libta/writeheaders.c, ...
	    Improve email header conversion facilities.
	    Proper email BODY conversion is still missing..
	    (text/plain gets processed, but  other formats
	     call for improvements..)

Mon Jun 27 07:24:44 1994  Matti E. Aarnio  (mea@oj287.astro.utu.fi)

	* transports/libta/mimeheaders.c :
	    Improved processing of "Content-Type:", and
	    added "Received: .... convert rfc822-to-XXXX;..."
	    clauses.  ( to "quoted-printable" and to "8bit")

	* BUGS, ChangeLog, README, README.solaris, INSTALL :
	    Updated documentation, worklist, ....


Sun Jun 26 01:31:54 1994  Matti E. Aarnio  (mea@oj287.astro.utu.fi)

	* Freeze and dump   zmailer-2.90-940626.tar.gz

	* router/functions.c (run_listaddrs):
	    An empty "include" file (empty .forward, as was the case)
	    caused SIGSEGV due to a NULL-ptr dereference.
	    Created smarter error handling.

	* router/rfc822.ssl:
	    Teached "AMailboxList" to understand '<>' as a valid
	    address ("channel error" source..) as is often case
	    with error-messages from mailers..  Now it accepts:
			From: <>

	    That unearthed a lot of problems elsewere with NULL-pointer
	    dereferrence and now don't even remember where everywhere...
	    ( s_copy_tree() at least )

Sat Jun 25 01:31:54 1994  Matti E. Aarnio  (mea@oj287.astro.utu.fi)

	* libsh/builtins.c, libsh/path.c, libsh/vcall.c,
	  router/functions.c, router/rfc822.c:
	    USE_ALLOCA -- use alloca() for some local buffer allocations
	                  which don't need to be preserved over the scope
			  of stack-frame existance.

	* hostenv/ :
	    Don't select on own  getopt() vs. system supplied one.
	    Use the own one always.

	* libsh/interpret.c:
	    Improve interaction with the  getopt()

	* libmalloc/ :
	    Improved the integration with the Zmailer -- this is a new
	    version of the "Toronto Malloc", and quite a headache to
	    integrate..

Tue Jun 21 09:52:21 1994  Matti E. Aarnio  (mea@oj287.astro.utu.fi)

	* router/rfc822.c (run_rfc822): 
	    Argument processing bombed -- possibly due to usage of
	    the GCC, possibly due to something else.


Tue Jun 21 09:52:21 1994  Matti E. Aarnio  (mea@oj287.astro.utu.fi)

	* Created this file to track changes

	  Building Zmailer 2.90xxx -- that is, alphas/betas of 3.0

	* Pre-ChangeLog transcript follows:


Various features/fixes done at Univ of Turku by Matti Aarnio <mea@utu.fi>


Compiling with  GCC 2.3.3, and 2.4.5 with -Wall  -- generated a lot of
warnings, which one after another have been eradicted..  Found also some
real bugs with that.  (BUT NOT ALL!)

I am compiling it on SunOS 4.1.3 with  GCC 2.5.6, and "-traditional"
option..


Referred <Emil> is IDA's big-brother (IDA-sendmail's MIME processing toolbox)


Multilevel incoming mail priorizing into router:
	- zmailer(3) has  mail_priority  variable, which must be set
	  to desired value before  mail_close() is called.
	  Value 0 means normal behaviour (and is the default).
	  Any positive value means picking further down into
	  ROUTERDIRS Z-environment variable.  (See zmailer(3), and router(8))

	- compat/sendmail/sendmail accepts  -Pnn, which is feed to
	  mail_priority (see above)  As an alternate, it also honours
	  environment variable   MAILPRIORITY which has numeric value.
	<Maybe "Precedence:" header should be processed ?>

	- Router processes at first all files from the  POSTOFFICE/router/
	  directory, and once it is empty, it looks into alternates.
	  If alternate had anything to work upon, directory scanning returns
	  to the first level dir.
	  As an end result, the further messages are into the alternate
	  directories, that less frequently they get processed.

router/functions.c:
router/conf.c:
router/dateparse.c:
router/rfc822.c:
router/router.c:
	- Implemented first real multi-router system with working locks.
	- Extended it with ROUTERDIRS - multiple priority levels.
	- Added some {}'s into dateparse.c
	- Added configurability of  $(filepriv ...) into conf.c
	- Accepted and inserted a patch on RFC header processing which
	  blew on "header"-line like:  ": some text"
	  (Some programs inserted such junk into HEADERS - tin among them.)
	  Source: "Michael S. Shappe" <mss1@cornell.edu>
	- Added option  -E  into $(listaddresses ...) creating
	  an "Errors-To:" header, and making sure the SMTP
	  'MAIL FROM:<>' contains that address.
	<Should use Emil ?>

router/libdb/bind.c:
	- added query-type 'any' to be used in place of '-t cname' on
	  DNS canonization. (In manner of  BSD sendmail.)

smtpserver/smtpserver.c:
	- SMTP-server does check syntax of RFC821 inputs, specifically
	  it checks "MAIL FROM:< .... >" and "RCPT TO:< .... >" syntaxes,
	  and is adamant with them.  -- many misconfigured PC-mail programs
	  have been found with it...   --  rfc821scn.c  does most of it.
	- Uses  Remote Authentication Service (RFC 1413) to (try to)
	  see who is it, who contacts us.  (See also: "libauth/*")

	- SMTP-server supports RFC 1425-1428   EHLO greeting (in place of
	  HELO command), and related  8BITMIME, and SIZE extensions.
	  Summa summarum:  Now we advertice that we can accept 8-bit SMTP,
	  not just blindly accept it..
	- SMTP-server fully uses RFC 1427 SIZE feature (if user defines it),
	  and thus can report "insufficient storage space at the moment",
	  if sender tries to send email which is far too big..
	<Should check MIME-compiance of the message, if it has 8-bit stuff
	 in it, and not give   250 Ok  if check fails.  Also maybe should
	 check syntax of RFC822 headers, and complain at the "." time, if
	 that check fails..  Precedence can be found from PP.>
	<Should use Emil ?>


transports/libta/routermxes.c (new)
	- router can feed target "mx" information, same as it got when
	  analyzing routing, to the actual transporter program.
	  In place of a  hostname,  it codes:  ((mxer)(mxer mxer)(mxer))
	  (This is into the router results!)

transports/libta/ctlopen.c
transports/libta/mimeheaders.c (new)
	- new way to read in the headers, and to handle them when
	  rewriting them.  Original was to get them in as single
	  multiline string.  This splits them to individual lines
	  and keeps track of them in that way..


transports/smtp/smtp.c:
	- Better support for local sender verbose trace
	- If connection setup fails (channel open timeout, or remote
	  closes the channel upon our face -- whatever before HELO),
	  we try to talk to next assigned MX target.
	- Support of RFC 1425-1428  8BITMIME transport
	- Uses RFC 1427 SIZE=, if receiving system knows it (EHLO protocol)
	- Downgrades message to "Content-Transfer-Encoding: QUOTED-PRINTABLE",
	  1) "Content-Transfer-Encoding: 8BIT" is present
	     in the primary headers,
	  2) remote system has no  8BITMIME capability,
	  3) message contains 8-bit characters.
	- Downgrades message header to "Content-Transfer-Encoding: 7BIT",
	  if message data is 7-bit, and said header is present.
	- If "C-T-E:" was turned to "7BIT", and "Content-Type:" was
	  "text/plain; charset=ISO-*", then update "C-T:" to have
	  "charset=US-ASCII" -- simplifies things (?)
	- Doesn't do full job of analyzing things like "Content-Type:",
	  rather assumes that "C-T-E:" is present on "C-T: text/plain"
	  messages, and any complex things are built properly.
	- setsockopt() arguments corrected.
	<Should use Emil>

transports/sm/sm.c:
	- Support for local sender verbose trace
	- Downgrades messages in same manner as smtp does, if "sm"
	  doesn't have "-8" in its options when running some subchannel.
	<Should use Emil>


transports/mailbox/mailbox.c:
	- Allow local addresses to be   user@domain, and use that kind
	  of addresses on storing mails to mailboxes.
	<Really should only do header rewrites into FQDN format, and
	 have local users feed to via scheduler as   `username' (non FQDN)>
	- Use proper NFS locking  ( lockf() )
	<Should use Emil>
	- Partial MIME converter:
		A  text/plain; Quoted-Printable  message will be converted
		into  8BIT  format, IF the "mailbox" program is called with
		argument: "-8"!  (If that argument is not present, nothing
		new is done.)

libc/libc.a:
	- mail_open() does a  whathost() to figure out NFS-mounted
	  postoffices.  <Guy Middleton>
	- using free()d storage -- Matthias Urlichs, et.al. in   mail.c
	- whathost.c  generalizes NFS mountpoint figuring system.
	- mail_close() is affected by  mail_priority variable, as well
	  as  ROUTERDIRS  Z-environment.  See  zmailer(3)

libauth/*:
	- RFC 1413 using identd protocol using library.
	  (Host configuration option  USE_AUTH)


compat/sendmail/sendmail:
	- Accept (and ignore) options:  -oem, -J, -em
	- Accept option -Pnn, see above about  mail_priority (zmailer(3))
	- Making sure "to <address>" -lines contain only valid
	  characters -- well, don't contain newlines!
	- Accept "From " (FROM-SPACE) input (sendmailism), and
	  drop such line away, if next line looks like a real header.
	- Do binary (-t option) processing buffer at a time, instead of
	  a character at a time..
	<Check MIME-headers, and correct 8-bit handling ???>
	<Check submitted headers (syntactically), and barf if fail ???>

compat/rmail/rmail:
	- Bill Wisner's rmail patch applied.


lib/rfc822scan.c:
	- Nested comments fix -- don't remember who
	- Kicked out bit-stripping -- headers are 7-bit stuff!

lib/linebuffer.c:
	- Explicit exits with  ferror() amd feof() conditions!
	  Suggested by  haa@cs.hut.fi
	- Made a serious mistake, and two weeks later found it..
	- accepted a patch from  Ken Lalonde <ken@cs.toronto.edu>,
	  finally did it correctly !

ssl/ssl.c:
	- array space reservation one-off, fix by 	Matthias Urlichs

utils/makendbm/
	- wrote whole package

utils/zmstats.perl
	- wrote this small piece

utils/fullnamealiasmaker.perl
	- wrote this (larger) piece

support/vacation/
	- extended to behave somewhat like SunOS  vacation(1), only better :)

scheduler/mailq.c:
	- Moved function   getmntpt()  to  (new file) libc/whathost.c
