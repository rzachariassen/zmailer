dnl -*- sh -*-
dnl Process this file with autoconf to produce a configure script.
#
# This autoconfigure input was modelled after GNU fileutils  configure.in,
# and modified by hand by <matti.aarnio@nic.funet.fi>  for the ZMailer
#

#
# Things to do:
#   AC_DEFINE(NO_SECURITY_PAM)  # Done with:  --disable-pam
#   AC_DEFINE(NO_SHADOW)        # ???
#   AC_DEFINE(CHECK_MB_SIZE)    # mailbox.c feature using external function
#

#
# This autoconfigure input was taken from  GNU fileutils  configure.in,
# and modified by hand by <matti.aarnio@nic.funet.fi>  for the ZMailer
#
# Parts are also from scotty-2.0.2 configuration
# Parts from other sources long forgotten, and many
# new things invented by myself...
#
# ZMailer is almost as a versatile systems feature tester as
# the best (or worst) other beats, like  SSH ...   About the
# only things that ZMailer does not need are PTY allocation
# mechanisms ...
#

AC_PREREQ(2.57)
AC_COPYRIGHT([ZMailer autoconfiguration setup
copyright 1996-2003 by Matti Aarnio <mea@nic.funet.fi>])
AC_REVISION($Revision$)

# In version numbers, USE NO HYPHENS!
AC_INIT(ZMailer, [2.99.57.pre3], [zmhack@nic.funet.fi])

AC_PREFIX_DEFAULT([/opt/zmailer])

AC_PROG_CPP
AC_ISC_POSIX
AC_AIX
AC_MINIX

#----------------------------------------------------------------------------
#       Check if we should use gcc if available on this machine.
#----------------------------------------------------------------------------
use_gcc=0
AC_ARG_WITH(gcc, [  --with-gcc              use gcc for compilation],
        use_gcc=1)
if test "$use_gcc" = 0 ; then
    CC=${CC-cc}
else
    AC_PROG_CC
    if test "$CC" = "gcc" ; then
        CC="gcc -Wall"
    fi
fi

AC_LANG(C)


AC_SUBST(MKDIR)
MKDIR="mkdir -p"

# AC_PROG_GCC_TRADITIONAL
AC_PROG_MAKE_SET

# things get pretty tought, if the dup2() is not available ...
AC_CHECK_FUNC(dup2,
        AC_DEFINE(HAVE_DUP2,1,[Checking that our compiler works; the dup2() exists at all UNIXes..]),
        AC_MSG_ERROR([Bizzare -- the system does not have dup2()!  Is your C-compiler working ? (See config.log)])
)



if test "x$prefix" = "xNONE" ; then
  AC_MSG_RESULT([!!!])
  AC_MSG_RESULT([!!! You did not define  --prefix=DIR  -parameter !!!])
  AC_MSG_RESULT([!!!])
  AC_MSG_RESULT([!!! Define the  --prefix=DIR -parameter to tell the subtree,])
  AC_MSG_RESULT([!!! where the ZMailer system is to be installed.])
  AC_MSG_RESULT([!!!])
  exit 1
fi

defROUTEROPTIONS='-dWkn 4'
defSMTPOPTIONS='-sve -l ${LOGDIR}/smtpserver'
defSCHEDULEROPTIONS='-S -H'
defNNTPSERVER='nntp'
ac_default_zmconfig="${ZCONFIG-$prefix/zmailer.conf}"


AC_MSG_RESULT([***])
AC_MSG_RESULT([*** You can set  ZCONFIG  environment variable to define])
AC_MSG_RESULT([*** the location of the (default) $prefix/zmailer.conf -file])
AC_MSG_RESULT([*** (You can use also   --with-zconfig=  -parameter)])
AC_MSG_RESULT([***])
AC_MSG_RESULT([*** Consider also setting following parameters:])
AC_MSG_RESULT([***   --mandir=DIR     -- for man-pages])
AC_MSG_RESULT([***   --libdir=DIR     -- for libzmailer(3)])
AC_MSG_RESULT([***   --includedir=DIR -- for libzmailer(3)])
AC_MSG_RESULT([*** (They can be outside the --prefix=DIR -tree)])
AC_MSG_RESULT([***])
AC_MSG_RESULT([*** You can also set CC, CFLAGS, and CPPFLAGS  environment variables])
AC_MSG_RESULT([*** to choose the C-compiler, and its options, especially at systems])
AC_MSG_RESULT([*** where there are multiple choices to use ...])
AC_MSG_RESULT([*** (Also doing CPPFLAGS="-I/local/include" may be something you need])
AC_MSG_RESULT([***  to find oddly located headers of some utility libraries.)])
AC_MSG_RESULT([***])

sleep 3  # delay a bit, then continue..

AC_SUBST(PROGS)dnl

AC_PATH_PROG(LN, ln, ln)dnl
AC_PATH_PROG(MV, mv, mv)dnl
AC_PATH_PROG(RM, rm, rm)dnl
AC_PATH_PROG(TRUE, true, true)dnl
AC_PATH_PROG(PERL, perl, perl)dnl
AC_PATH_PROG(GZIP, gzip, gzip)dnl
AC_PATH_PROG(PKGCONFIG, pkg-config)dnl
AC_SUBST(LIBPROGS)dnl

AC_SUBST(CPPDEP)
CPPDEP=${CPPDEP-"gcc -MM"}

AC_MSG_RESULT([** Using C compiler: $CC])
AC_MSG_RESULT([** Using CFLAGS:     $CFLAGS])
AC_MSG_RESULT([** Using CPPDEP:     $CPPDEP])

dnl AC_DEFINE_UNQUOTED(CONFIGURE_CMD,"$0 $ac_configure_args")
AC_DEFINE_UNQUOTED(CONFIGURE_CMD,
                   "CC='$CC' CFLAGS='$CFLAGS' $0 $ac_configure_args",
		   [Configuration command line])

AM_GNU_GETTEXT([external])
AM_GNU_GETTEXT_VERSION(0.11.5)

AC_PROG_RANLIB
AC_PATH_PROG(AR, ar, ar)dnl
AC_PATH_PROG(LD, ld, ld)dnl
AC_PROG_YACC
AC_PROG_LN_S
AC_HEADER_MAJOR

AC_C_BIGENDIAN
AC_C_INLINE
AC_CHECK_SIZEOF(void *)
AC_CHECK_SIZEOF(short)
AC_CHECK_SIZEOF(int)
AC_CHECK_SIZEOF(long)
AC_CHECK_SIZEOF(double)

OrigCPPFLAGS="$CPPFLAGS"

AC_SUBST(PERLINSTALLDIRS)
AC_SUBST(PERLDESTINSTALLDIRS)
PERLINSTALLDIRS=""
PERLDESTINSTALLDIRS=""
use_perlinstalldirs=0
AC_ARG_WITH(perl-installdirs, [  --with-perl-installdirs=\"/prefix/path\"
                             Perl module installation thingie.],
        use_perlinstalldirs=1)
if test "$use_perlinstalldirs" = 1; then
  PERLINSTALLDIRS="PREFIX=$with_perl_installdirs"
  PERLDESTINSTALLDIRS="PREFIX=\$(DESTDIR)$with_perl_installdirs"
fi

# AC_SUBST(PERLINSTALLPREFIX)
# PERLINSTALLPREFIX="/usr" # When nothing else is known...
# if test -x "$PERL" ; then
#
# fi

AC_SUBST(PERLEMBEDCCOPTS)
AC_SUBST(PERLEMBEDLDOPTS)

AC_ARG_WITH(embed-perl,      [  --with-embed-perl       Do embed perl into system],
        embed_perl=1)
if test "$embed_perl" = 1 ; then
  PERLEMBEDCCOPTS="`$ac_cv_path_PERL  -MExtUtils::Embed -e ccopts`"
  PERLEMBEDLDOPTS="`$ac_cv_path_PERL  -MExtUtils::Embed -e ldopts`"
  AC_DEFINE(DO_PERL_EMBED,1,[We do embed perl into system])
  AC_MSG_RESULT([Embedding perl, with:])
  AC_MSG_RESULT([  CCOPTS=$PERLEMBEDCCOPTS])
  AC_MSG_RESULT([  LDOPTS=$PERLEMBEDLDOPTS])
fi


AC_SUBST(GENINCL)
use_genincl=0
AC_ARG_WITH(generic-include, [  --with-generic-include=\"-I/...\"
                            Include option for local overriders],
        use_genincl=1)
if test "$use_genincl" = 1; then
  GENINCL="$withval"
  CPPFLAGS="$CPPFLAGS $withval"
fi
AC_SUBST(GENLIB)
AC_ARG_WITH(generic-library, [  --with-generic-library=\"-L/...\"
                            Library directory option for local overriders],
        use_genlib=1, use_genlib=0)
if test "$use_genlib" = 1; then
  GENLIB="$withval"
  LIBS="$LIBS $GENLIB"
fi


AC_SUBST(ZMAILERCFGFILE)
use_zcfg=0
AC_ARG_WITH(zconfig, 
[  --with-zconfig=PATH     define the path and name of the zmailer.conf -file
                          Set ZCONFIG environment, and then use --with-zconfig=no
                          to disable usage of existing zmailer.conf -file to
                          load existing defaults. ],
        use_zcfg=1)
load_zcfg=1
AC_ARG_WITH(zconfig-noload,
[  --with-zconfig-noload   Don't pre-load old values from possibly existing
                          ZCONFIG file.],
        load_zcfg=0)
if test "$use_zcfg" = "0" ; then
        ZMAILERCFGFILE="${ZMAILERCFGFILE-$ac_default_zmconfig}"
        use_zcfg=1
else
    if test "$withval" != "no" ; then
        use_zcfg=1
        ZMAILERCFGFILE="$withval"
    else
        use_zcfg=0
        ZMAILERCFGFILE="${ZMAILERCFGFILE-$ac_default_zmconfig}"
    fi
fi
AC_MSG_RESULT([Using ZMailer parametrization file path: $ZMAILERCFGFILE])

if test -r $ZMAILERCFGFILE -a "$load_zcfg" != "0" ; then
  # Source the previous configuration values for various environment parameters
  . $ZMAILERCFGFILE
  AC_MSG_RESULT([   The file exists, we use its values as defaults])
fi

AC_SUBST(MAILBOX)
use_mailbox=0
AC_ARG_WITH(mailbox,      [  --with-mailbox=DIR      define the path of the mailbox directory],
        use_mailbox=1)
if test "$use_mailbox" = 0 ; then
    # No explicite value given, make some guesses as to where it might be..
    for DEFMAILBOX in /var/mail /var/spool/mail /usr/mail /usr/spool/mail x
    do
        if test -d $DEFMAILBOX ; then
            break
        fi
    done
    if test "DEFMAILBOX" = x ; then
    DEFMAILBOX=/var/spool/mail
    if test -r /usr/include/paths.h ; then
      tt=`egrep _PATH_MAILDIR /usr/include/paths.h | cut -d'"' -f2`
      if test "$tt" != "" -a -d $tt ; then
        DEFMAILBOX=$tt
      fi
    fi
  fi
    MAILBOX="${MAILBOX-$DEFMAILBOX}"
else
    MAILBOX="$withval"
fi
AC_MSG_RESULT([Using ZMailer MAILBOX directory path: $MAILBOX])

AC_SUBST(POSTOFFICE)
use_postoffice=0
AC_ARG_WITH(postoffice,   [  --with-postoffice=DIR   define the path of the postoffice directory],
        use_postoffice=1)
if test "$use_postoffice" = 0 ; then
    # No explicite value given, make some guesses as to where it might be..
    # XX: Should see what the MAILBOX value is, and then default between
    # XX: the /usr, and the /var -trees.
    for DEFPOSTOFFICE  in /usr/spool/postoffice /var/spool/postoffice
    do
        if test -d $DEFPOSTOFFICE ; then
            break
        fi
    done
    POSTOFFICE="${POSTOFFICE-$DEFPOSTOFFICE}"
else
    POSTOFFICE="$withval"
fi
AC_MSG_RESULT([Using ZMailer POSTOFFICE path: $POSTOFFICE])


AC_SUBST(MAILSHARE)
use_mailshare=0
AC_ARG_WITH(mailshare,    [  --with-mailshare=DIR    define the path of the mailshare directory],
        use_mailshare=1)
if test "$use_mailshare" = 0 ; then
    eval MAILSHARE="${MAILSHARE-$prefix}"
else
    MAILSHARE="$withval"
fi
AC_MSG_RESULT([Using ZMailer MAILSHARE directory path: $MAILSHARE])

AC_SUBST(MAILVAR)
use_mailvar=0
AC_ARG_WITH(mailvar,      [  --with-mailvar=DIR      define the path of the mailvar directory],
        use_mailvar=1)
if test "$use_mailvar" = 0 ; then
    eval MAILVAR="${MAILVAR-$prefix}"
else
    MAILVAR="$withval"
fi
AC_MSG_RESULT([Using ZMailer MAILVAR directory path: $MAILVAR])

AC_SUBST(MAILBIN)
use_mailbin=0
AC_ARG_WITH(mailbin,      [  --with-mailbin=DIR      define the path of the mailbin directory],
        use_mailbin=1)
if test "$use_mailbin" = 0 ; then
    eval MAILBIN="${MAILBIN-${MAILSHARE}/bin}"
else
    MAILBIN="$withval"
fi
AC_MSG_RESULT([Using ZMailer MAILBIN directory path: $MAILBIN])

AC_SUBST(LOGDIR)
use_logdir=0
AC_ARG_WITH(logdir,       [  --with-logdir=DIR       define the path of the log directory],
        use_logdir=1)
if test "$use_logdir" = 0; then
    LOGDIR=${LOGDIR-/var/log/mail}
else
    LOGDIR="$withval"
fi
AC_MSG_RESULT([Using ZMailer LOGDIR directory path: $LOGDIR])

AC_SUBST(ROUTEUSER_IN_ABNORMAL_UNIX)
use_routeuser=0
AC_ARG_WITH(routeuser-is-abnormal,    [  --with-routeuser-is-abnormal={yes,no} define if your system doesn't get
                          homedirs for users from getpwnam() call in router.
                          Giving here 'no' will produce errors at routing for
                          nonexistent users, not waiting until doing delivery
                          attempt at mailbox.],
        use_routeuser=1)
if test "$use_routeuser" = 0; then
    # When not defined, ASSUME ABNORMAL UNIX, unless  ZCONFIG file
    # was read in, and it had some value for this..
    ROUTEUSER_IN_ABNORMAL="${ROUTEUSER_IN_ABNORMAL-abnormal}"
elif test "$withval" = no; then
    # "no" given, it is NORMAL UNIX, and the router shall produce
    # error messages!
    ROUTEUSER_IN_ABNORMAL_UNIX=
else
    ROUTEUSER_IN_ABNORMAL_UNIX=abnormal
fi
# There might be old (non-substituted) value lurking...
if test "$ROUTEUSER_IN_ABNORMAL_UNIX" = "@ROUTEUSER_IN_ABNORMAL_UNIX@"
then
    ROUTEUSER_IN_ABNORMAL_UNIX=abnormal
fi
AC_MSG_RESULT([Using ZMailer ROUTEUSER_IN_ABNORMAL_UNIX value: '$ROUTEUSER_IN_ABNORMAL_UNIX'])



AC_SUBST(NNTPSERVER)
use_nntpserver=0
AC_ARG_WITH(nntpserver,   [  --with-nntpserver=HOST  define the domain name of the nntp server],
        use_nntpserver=1)
if test "$use_nntpserver" = 0; then
    NNTPSERVER="${NNTPSERVER-$defNNTPSERVER}"
else
    NNTPSERVER="$withval"
fi
AC_MSG_RESULT([Using ZMailer NNTPSERVER host name: $NNTPSERVER])

if test "x$INEWSBIN" = "x" ; then
  AC_PATH_PROG(INEWS, inews, inews)
else
  AC_SUBST(INEWS)
  INEWS="$INEWSBIN"
fi
AC_MSG_RESULT([Using ZMailer INEWS program path: $INEWS])

AC_SUBST(SCHEDULEROPTIONS)
SCHEDULEROPTIONS="${SCHEDULEROPTIONS-$defSCHEDULEROPTIONS}"
AC_MSG_RESULT([Using ZMailer SCHEDULEROPTIONS='$SCHEDULEROPTIONS'])
AC_SUBST(ROUTEROPTIONS)
ROUTEROPTIONS="${ROUTEROPTIONS-$defROUTEROPTIONS}"
AC_MSG_RESULT([Using ZMailer ROUTEROPTIONS='$ROUTEROPTIONS'])
AC_SUBST(SMTPOPTIONS)
SMTPOPTIONS="${SMTPOPTIONS-$defSMTPOPTIONS}"
AC_MSG_RESULT([Using ZMailer SMTPOPTIONS='$SMTPOPTIONS'])

AC_SUBST(SENDMAILPATH)
use_sendmailpath=0
AC_ARG_WITH(sendmailpath,   [  --with-sendmailpath=PATH The location of the 'sendmail'],
        use_sendmailpath=1)
if test "$use_sendmailpath" = 0 ; then
  # Ok, no value given, make some guesses; /usr/sbin ??
  for SENDMAILDEF in /usr/sbin/sendmail /usr/lib/sendmail x ; do
    if test -x $SENDMAILDEF ; then
        break
    fi
  done
  if test "$SENDMAILDEF" = x ; then
    SENDMAILDEF=/usr/sbin/sendmail
    if test -r /usr/include/paths.h ; then
      tt=`egrep _PATH_SENDMAIL /usr/include/paths.h | cut -d'"' -f2`
      if test "$tt" != "" -a -x $tt ; then
        SENDMAILDEF=$tt
      fi
    fi
  fi
  SENDMAILPATH="${SENDMAILPATH-$SENDMAILDEF}"
else
    if test -d "$withval" ; then
        SENDMAILPATH="$withval/sendmail"
    else
        SENDMAILPATH="$withval"
    fi
fi
AC_MSG_RESULT([Using ZMailer SENDMAILPATH: $SENDMAILPATH])

oldRMAILPATH="$RMAILPATH"
AC_SUBST(RMAILPATH)
use_rmailpath=0
AC_ARG_WITH(rmailpath,   [  --with-rmailpath=PATH    The location of 'rmail'],
        use_rmailpath=1)
if test "$use_rmailpath" = 0 ; then
  # Ok, no value given, make some guesses; /usr/bin ?? (last is default)
  for RMAILDEF in /sbin/rmail /usr/sbin/rmail /usr/bin/rmail /bin/rmail; do
    if test -x $RMAILDEF ; then
        break
    fi
  done
  if test "x$oldRMAILPATH" = x ; then
    RMAILPATH="$RMAILDEF"
  else
    RMAILPATH="$oldRMAILPATH"
  fi
else
  RMAILPATH="$withval"
fi
AC_MSG_RESULT([Using ZMailer RMAILPATH: $RMAILPATH])

AC_SUBST(VACATIONPATH)
use_vacationpath=0
AC_ARG_WITH(vacationpath,   [  --with-vacationpath=PATH The location of the 'vacation'],
        use_vacationpath=1)
if test "$use_vacationpath" = 0 ; then
  # Ok, no value given, make some guesses; /usr/sbin ??
  for VACATIONDEF in /bin/vacation /usr/ucb/vacation /usr/bin/vacation ; do
    if test -x $VACATIONDEF ; then
        break
    fi
  done
  VACATIONPATH="${VACATIONPATH-$VACATIONDEF}"
else
    if test -d "$withval" ; then
        VACATIONPATH="$withval/vacation"
    else
        VACATIONPATH="$withval"
    fi
fi
AC_MSG_RESULT([Using ZMailer VACATIONPATH: $VACATIONPATH])


oldSELFADDRESSES="$SELFADDRESSES"
AC_SUBST(SELFADDRESSES)
AC_ARG_WITH(selfaddresses,   [  --with-selfaddresses=NAME,NAME  Comma separated list of names],
        use_selfaddresses=1)
if test "x$use_selfaddresses" != "x" ; then
    SELFADDRESSES="$withval"
else
    SELFADDRESSES="$oldSELFADDRESSES"
fi
AC_MSG_RESULT([Using ZMailer SELFADDRESSES: $SELFADDRESSES])

oldBINDADDR="$BINDADDR"
AC_SUBST(BINDADDR)
AC_ARG_WITH(bindaddr,   [  --with-bindaddr=SPEC    Bind to specific local interface
                          possible format: [0.0.0.0], [IPv6.0::0], iface:eth0:1],
        use_bindaddr=1)
if test "x$use_bindaddr" != "x" ; then
    BINDADDR="$withval"
else
    BINDADDR="$oldBINDADDR"
fi
AC_MSG_RESULT([Using ZMailer BINDADDR: $BINDADDR])

AC_SUBST(SYSLOGFLG)
AC_ARG_WITH(syslogflg,  [  --with-syslogflg=FLGS   A set of flag-characters for subsystems
                          doing (or not doing) their loggings via syslog.],
    SYSLOGFLG="$withval")
if test -z "$SYSLOGFLG" ; then
  SYSLOGFLG="RT"
fi
AC_MSG_RESULT([Using ZMailer SYSLOGFLG: $SYSLOGFLG])

AC_SUBST(SNMPSHAREDFILE)
AC_ARG_WITH(snmpsharedfile,  [  --with-snmpsharedfile=/path/to/file  Path of SNMP shared file. (use default!)],
    SNMPSHAREDFILE="$withval")
if test -z "$SNMPSHAREDFILE" ; then
    SNMPSHAREDFILE="$POSTOFFICE/.zmailer.SNMP.block"
fi

AC_MSG_RESULT([Using ZMailer SNMPSHAREDFILE: $SNMPSHAREDFILE])

AC_SUBST(DOMAIN_AWARE_GETPWNAM)
AC_ARG_WITH(domainawaregetpwnam,  [  --with-domainawaregetpwnam=[0|1]  Does local getpwnam(3) understand domains ?],
    DOMAIN_AWARE_GETPWNAM="$withval")
AC_MSG_RESULT([Using ZMailer DOMAIN_AWARE_GETPWNAM: $DOMAIN_AWARE_GETPWNAM])

sleep 2  # Sleep a bit here too

AC_SUBST(LIBMALLOC)
AC_SUBST(MALLOC)
AC_SUBST(MALLOCEXT)
MALLOCEXT=""
AC_ARG_WITH(system-malloc,[  --with-system-malloc    use system malloc instead of our own],
        use_system_malloc=1)
AC_ARG_WITH(libmalloc,
[  --with-libmalloc=LIBNAME define the name of the malloc library
                           possible values: malloc, malloc_d, system (default)],
        use_libmalloc=1)
if test "x$use_system_malloc" = x1 ; then
  LIBMALLOC=""
  MALLOC="system"
else
  if test "x$withval" = xmalloc_d -o "x$withval" = xmalloc ; then
    LIBMALLOC="-l$withval"
    MALLOC="$withval"
    if test "$withval" = "malloc_d" ; then
      MALLOCEXT="_d"
    fi
  else
    if test "x$withval" = xsystem -o "x$use_libmalloc" != x1; then
      LIBMALLOC=""; MALLOCEXT=""
      MALLOC="system"
    else
      eval LIBMALLOC="-l${MALLOC-malloc}"
      if test "x$LIBMALLOC" = "x-lmalloc_d"; then
        MALLOC="malloc_d"; MALLOCEXT="_d"
      else
        if test "x$LIBMALLOC" = "x-lmalloc"; then
          MALLOC="malloc"
        fi
      fi
    fi
  fi
fi
AC_MSG_RESULT([Using ZMailer malloc library of type: $MALLOC])

#
# Following is rather painfull to do fully automatic, thus I choose
# to do it in dumb way -- explicitely, INCLUDING LINKER STUFF !
#

AC_SUBST(HAVE_YP)
AC_ARG_WITH(yp, [  --with-yp                Have YP/NIS in system, and want to use it],
        AC_DEFINE(HAVE_YP,1,[Have YP/NIS in the system, and want to use it]))

AC_SUBST(LIBNIS)
LIBNIS=""
AC_ARG_WITH(yp-lib, [  --with-yp-lib='-L... -lyp'  Linker arguments for the YP/NIS in the router],
        LIBNIS="$withval")

#AC_CHECK_HEADERS(rpc/rpc.h rpcsvc/yp_prot.h rpcsvc/ypclnt.h)
#if test "$ac_cv_header_rpc_rpc.h" = yes                        \
#       -a "$ac_cv_header_rpcsvc_yp_prot_h" = yes       \
#       -a "$ac_cv_header_rpcsvc_ypclnt_h" = yes ; then
#    # Ok, we have the headers, do we have the libs ?
#    # Asch....  Lets just presume that headers match with libs
#    # (and for Solaris the needed  -lnsl  comes with  connect() )
#    AC_DEFINE(HAVE_YP)
#fi

AC_HEADER_SYS_WAIT
AC_FUNC_WAIT3
AC_CHECK_FUNCS(waitpid getrusage wait4)
AC_CHECK_FUNCS(getenv putenv setenv unsetenv setproctitle)

#
#  Study shared library generation
#
#AC_SUBST(SHLIB_CFLAGS)
#AC_SUBST(SHLIB_LD)
#AC_SUBST(SHLIB_SUFFIX)
#AC_SUBST(DL_LIBS)
#AC_SUBST(LD_FLAGS)


AC_TYPE_GETGROUPS
AC_TYPE_MODE_T
AC_TYPE_OFF_T
AC_TYPE_SIGNAL
AC_TYPE_SIZE_T
AC_TYPE_UID_T
AC_CHECK_TYPES([ino_t, u_int16_t, u_int32_t, uint16_t, uint32_t])

AC_C_CONST
AC_HEADER_STDC

# Timezones are always a pain in... everybody has their own ways :-(
AC_CHECK_HEADERS(sys/time.h termios.h)
AC_HEADER_TIME
AC_STRUCT_TIMEZONE
AC_STRUCT_TM
AC_STRUCT_TM_GMTOFF

# AC_STRUCT_ST_BLOCKS
# AC_STRUCT_ST_BLKSIZE

AC_MSG_RESULT([Scanning possible database libraries in preferrence order:])
AC_MSG_RESULT([   NDBM, GDBM, BSD DB 1.x, SleepyCat DB 2.x/3.x/4.x])
AC_MSG_RESULT([ ( Hash, Hash, Hash, BTree,      BTree )])
AC_MSG_RESULT([Last one of them found will be system default DB format.])

DEFDBTYPE="$DBTYPE" # From possible entry in  zmailer.conf above...
AC_SUBST(DBTYPE) # Default db-type, unless we figure out something.
AC_SUBST(DBEXT)  # Default db-extension (pag/db) for FILE OPEN
AC_SUBST(DBEXTtest) # Default db-extension (pag/db) for FILE AGE TESTS

AC_CHECK_HEADERS(ndbm.h gdbm.h db.h db1/db.h db_185.h db3.h \
		 db2/db.h db2/db_185.h db3/db.h db3/db_185.h db4/db.h \
		 ldap.h)

dblocation=""

without_ndbm=0
AC_ARG_WITH(ndbm,  [  --without-ndbm           Disable search for, and use of NDBM, even if it could be found],
		   without_ndbm=1)
LIBNDBM=""
t_have_dbm_error=no
if test "$ac_cv_header_ndbm_h" = yes -a $without_ndbm = 0; then
  t_found_at="nowhere"
  if test "$ac_cv_lib_c_dbm_open" = yes ; then
    LIBNDBM="-lc"
    t_found_at="libc"
    DBTYPE="ndbm"
  elif test "$ac_cv_lib_dbm_dbm_open" = yes ; then
    LIBNDBM="-ldbm"
    t_found_at="dbm library"
    DBTYPE="ndbm"
  elif test "$ac_cv_lib_ndbm_dbm_open" = yes ; then
    LIBNDBM="-lndbm"
    t_found_at="ndbm library"
    DBTYPE="ndbm"
  elif test "$LIBNDBM" = "" ; then
    if test "$ac_cv_lib_db1_dbm_open" = yes ; then
      LIBNDBM="-ldb1"
      t_found_at="db1 library"
      DBTYPE="ndbm"
    elif test "$ac_cv_lib_db2_dbm_open" = yes ; then
      LIBNDBM="-ldb2"
      t_found_at="db2 library"
      DBTYPE="ndbm"
    elif test "$ac_cv_lib_db3_dbm_open" = yes ; then
      LIBNDBM="-ldb3"
      t_found_at="db3 library"
      DBTYPE="ndbm"
    elif test "$ac_cv_lib_db_dbm_open" = yes ; then
      LIBNDBM="-ldb"
      t_found_at="db library"
      DBTYPE="ndbm"
    fi
  fi

  t_oldLibs="$LIBS"

  if test "$LIBNDBM" = "" ; then
    LIBS="$t_oldLibs -lc"
    AC_TRY_LINK([], [dbm_open();],  ac_cv_lib_c_dbm_open=yes,
                                    ac_cv_lib_c_dbm_open=no)
    if test "$ac_cv_lib_c_dbm_open" = yes; then
      # Has it in the libc!
      LIBNDBM="-lc"
      t_found_at="libc"
      DBTYPE="ndbm"
    fi
  fi

  if test "$LIBNDBM" = "" ; then
    LIBS="$t_oldLibs -lndbm"
    AC_TRY_LINK([], [dbm_open();],  ac_cv_lib_ndbm_dbm_open=yes,
                                    ac_cv_lib_ndbm_dbm_open=no)
    if test "$ac_cv_lib_ndbm_dbm_open" = yes; then
      # Has it in the ndbm library!
      LIBNDBM="-lndbm"
      t_found_at="ndbm"
      DBTYPE="ndbm"
    fi
  fi

  if test "$LIBNDBM" = "" ; then
    LIBS="$t_oldLibs -ldbm"
    AC_TRY_LINK([], [dbm_open();],  ac_cv_lib_dbm_dbm_open=yes,
                                    ac_cv_lib_dbm_dbm_open=no)
    if test "$ac_cv_lib_dbm_dbm_open" = yes; then
      # Has it in the dbm library!
      LIBNDBM="-ldbm"
      t_found_at="dbm"
      DBTYPE="ndbm"
    fi
  fi

  if test "$LIBNDBM" = "" ; then
    LIBS="$t_oldLibs -ldb1"
    AC_TRY_LINK([], [dbm_open();],  ac_cv_lib_db1_dbm_open=yes,
                                    ac_cv_lib_db1_dbm_open=no)
    if test "$ac_cv_lib_db1_dbm_open" = yes; then
      # Has it in the db1 library!
      LIBNDBM="-ldb1"
      t_found_at="db1"
      DBTYPE="ndbm"
    fi
  fi

#  if test "$LIBNDBM" = "" ; then
#    LIBS="$t_oldLibs -ldb2"
#    AC_TRY_LINK([], [dbm_open();],  ac_cv_lib_db2_dbm_open=yes,
#                                    ac_cv_lib_db2_dbm_open=no)
#    if test "$ac_cv_lib_db2_dbm_open" = yes; then
#      # Has it in the db2 library!
#      LIBNDBM="-ldb2"
#      t_found_at="db2"
#      DBTYPE="ndbm"
#    fi
#  fi

  if test "$LIBNDBM" = "" ; then
    AC_MSG_RESULT([??? Has <ndbm.h>, but dbm_open() is not at libc, libndbm, nor at libdb ???])
  fi

  LIBS="$t_oldLibs"

  if test "$t_found_at" != nowhere ; then
    # If we have BSD DB's compability mode in use, it does not have
    # dbm_error() function.  Check at it!
    LIBS="$LIBS $LIBNDBM"
    AC_TRY_LINK([#include <ndbm.h>], [DBM *db;int i = dbm_error(db);], t_have_dbm_error=yes)
    LIBS="$t_oldLibs"
    AC_MSG_RESULT([Located NDBM's  dbm_open()  routine at $t_found_at])
  else
    AC_MSG_RESULT([Didn't locate NDBM dbm_open() routine.   Maybe something better exists...])
    AC_MSG_RESULT([(This is for support of the original NDBM library in old systems, not])
    AC_MSG_RESULT([about API compability in e.g. GDBM and SleepyCat.)])
  fi
  if test "$t_found_at" != nowhere; then
    dblocation="$dblocation;$t_found_at"
  fi
fi

if test -n "$LIBNDBM" -a $without_ndbm = 0; then
  if test -z "$ac_cv_ndbm_dbm_pagfno" ; then
    LIBS="$LIBS $LIBNDBM"
    AC_TRY_LINK([#include <sys/types.h>
#include <ndbm.h>],
                [DBM *tdbm; int fd = dbm_pagfno(tdbm);],
                ac_cv_ndbm_dbm_pagfno=yes,
                ac_cv_ndbm_dbm_pagfno=no)
    LIBS="$t_oldLibs"
  fi
  if test "$ac_cv_ndbm_dbm_pagfno" = no ; then
     AC_MSG_RESULT([<ndbm.h> sighted, but linkage of dbm_pagfno() function fails.  ndbm will not be used])
  else
    AC_DEFINE(HAVE_NDBM,1,[Have old BSD NDBM in the system, and want to use it])
    if test "$t_have_dbm_error" = yes; then
      AC_DEFINE(HAVE_DBM_ERROR,1,[Function  dbm_error()  exists in the system])
    fi
  fi
fi

dnl without_sdbm=0
dnl AC_ARG_WITH(sdbm,  [  --without-sdbm           Disable search for, and use of SDBM, even if it could be found],
dnl 		   without_sdbm=1)
dnl LIBSDBM=""
dnl # Sometimes it is in libc, sometimes at separate lib...
dnl # Umm...
dnl if test "$ac_cv_header_sdbm_h" = yes -a $without_sdbm = 0 ; then
dnl   AC_MSG_RESULT([Note:  SDBM  support is not really integrated!])
dnl   AC_MSG_RESULT([Note2: Usually the <sdbm.h> is installed as  <ndbm.h> and the library])
dnl   AC_MSG_RESULT([       is installed as  libdbm.a, and it is indistinguishable])
dnl   AC_MSG_RESULT([       (at source level) from a real NDBM.])
dnl   t_found_at="nowhere"
dnl   if test "$ac_cv_lib_c_dbm_open" = yes ; then
dnl     LIBSDBM=""
dnl     t_found_at="libc"
dnl     DBTYPE="ndbm"
dnl   else
dnl     if test "$ac_cv_lib_sdbm_dbm_open" = yes ; then
dnl       LIBSDBM="-lsdbm"
dnl       t_found_at="sdbm library"
dnl       DBTYPE="ndbm"
dnl     else
dnl       AC_TRY_LINK([], [dbm_open();], ac_cv_lib_c_dbm_open=yes,
dnl                                      ac_cv_lib_c_dbm_open=no)
dnl       if test "$ac_cv_lib_c_dbm_open" = no; then
dnl         if test "x$ac_cv_lib_sdbm_dbm_open" = x; then # not set
dnl           t_oldLibs="$LIBS"
dnl           LIBS="$LIBS -lsdbm"
dnl           AC_TRY_LINK([], [dbm_open();], ac_cv_lib_sdbm_dbm_open=yes,
dnl                                          ac_cv_lib_sdbm_dbm_open=no)
dnl           LIBS="$t_oldLibs"
dnl           if test "$ac_cv_lib_sdbm_dbm_open" = yes; then
dnl             LIBSDBM="-lsdbm"
dnl             t_found_at="sdbm library"
dnl             DBTYPE="ndbm"
dnl           else
dnl             AC_MSG_RESULT([??? Has <sdbm.h>, but dbm_open() is not at libc, nor at libsdbm ???])
dnl           fi
dnl         else
dnl           if test "$ac_cv_lib_sdbm_dbm_open" = yes ; then
dnl             AC_MSG_ERROR([config.cache inconsistency! (sdbm) Delete it, and redo!])
dnl           fi
dnl         fi
dnl       else # Has it in the libc!
dnl         LIBSDBM=""
dnl         t_found_at="libc"
dnl         DBTYPE="ndbm"
dnl       fi
dnl     fi
dnl   fi
dnl   AC_MSG_RESULT([Located SDBM's  dbm_open()  routine at $t_found_at])
dnl   if test "$t_found_at" != nowhere; then
dnl     dblocation="$dblocation;$t_found_at"
dnl     AC_DEFINE(HAVE_SDBM,1,[System has dbm_open()  in -lsdbm, and want to use it.])
dnl   fi
dnl fi

LIBGDBM=""
# Sometimes it is in libc, sometimes at separate lib...
# Umm...
without_gdbm=0
AC_ARG_WITH(gdbm,  [  --without-gdbm           Disable search for, and use of GDBM, even if it could be found],
		   without_gdbm=1)

if test "$ac_cv_header_gdbm_h" = yes -a $without_gdbm = 0 ; then
  t_found_at="nowhere"
  if test "$ac_cv_lib_c_gdbm_open" = yes ; then
    LIBGDBM="-lc"
    t_found_at="libc"
  else
    if test "$ac_cv_lib_gdbm_gdbm_open" = yes ; then
      LIBGDBM="-lgdbm"
      t_found_at="gdbm library"
      DBTYPE="gdbm"
    else
      AC_TRY_LINK([], [gdbm_open();], ac_cv_lib_c_gdbm_open=yes,
                                      ac_cv_lib_c_gdbm_open=no)
      if test "$ac_cv_lib_c_gdbm_open" = no; then
        if test "x$ac_cv_lib_gdbm_gdbm_open" = x; then # not set
          t_oldLibs="$LIBS"
          LIBS="$LIBS -lgdbm"
          AC_TRY_LINK([], [gdbm_open();], ac_cv_lib_gdbm_gdbm_open=yes,
                                          ac_cv_lib_gdbm_gdbm_open=no)
          LIBS="$t_oldLibs"
	  if test "$ac_cv_lib_gdbm_gdbm_open" = yes; then
            LIBGDBM="-lgdbm"
            t_found_at="gdbm library"
            DBTYPE="gdbm"
          else
            AC_MSG_RESULT([??? Has <gdbm.h>, but gdbm_open() is not at libc, nor at libgdbm ???])
            
          fi
        else
          if test "$ac_cv_lib_gdbm_gdbm_open" = yes ; then
            AC_MSG_ERROR([config.cache inconsistency! (gdbm) Delete it, and redo!])
          fi
        fi
      else # Has it in the libc!
        LIBGDBM="-lc"
        t_found_at="libc"
        DBTYPE="gdbm"
      fi
    fi
  fi
  AC_MSG_RESULT([Located GNU GDBM's  gdbm_open()  routine at $t_found_at])
  if test -z "$ac_cv_gdbm_fdesc" ; then
    t_oldLibs="$LIBS"
    LIBS="$LIBS -lgdbm"
    AC_TRY_LINK([], [gdbm_fdesc();], ac_cv_gdbm_fdesc=yes, ac_cv_gdbm_fdesc=no)
    LIBS="$t_oldLibs"
  fi
  if test "$ac_cv_gdbm_fdesc" = yes ; then
    AC_DEFINE(HAVE_GDBM_FDESC,1,[New thing in GDBM 1.8.0: gdbm_fdesk()])
    AC_MSG_RESULT([The GDBM has  gdbm_fdesc()  function!])
  fi
  if test "$t_found_at" != nowhere; then
    dblocation="$dblocation;$t_found_at"
    AC_DEFINE(HAVE_GDBM,1,[Have GNU DBM, and want to use it])
  fi
fi

#LIBDB1=""  # CAN INHERIT FROM ENVIRONMENT!
# Sometimes it is in libc, sometimes at separate lib...
# Umm...
if test "$ac_cv_header_db_185_h" = yes ; then
  t_found_at="nowhere"
  if test "$ac_cv_lib_c_dbopen1" = yes ; then
    LIBDB1=""
    t_found_at="libc(1)"
    DBTYPE="btree"
  elif test "$ac_cv_lib_db1_dbopen1" = yes ; then
    LIBDB1="-ldb1"
    t_found_at="db1 library"
    DBTYPE="btree"
  else
    if test "x$ac_cv_lib_c_dbopen1" = x ; then # not set
      AC_TRY_LINK([], [dbopen();], ac_cv_lib_c_dbopen1=yes,
                                   ac_cv_lib_c_dbopen1=no)
    fi
    if test "$ac_cv_lib_c_dbopen1" = no ; then
      if test "x$ac_cv_lib_db1_dbopen1" = x ; then # not set
        t_oldLibs="$LIBS"
        LIBS="$LIBS -ldb1"
        AC_TRY_LINK([], [dbopen();],  ac_cv_lib_db1_dbopen1=yes,
                                      ac_cv_lib_db1_dbopen1=no)
        LIBS="$t_oldLibs"
        if test "$ac_cv_lib_db1_dbopen1" = yes ; then
          LIBDB1="-ldb1"
          t_found_at="db1 library"
          DBTYPE="btree"
        else
          AC_MSG_RESULT([??? Has <db_185.h>, but dbopen() is not at libc, nor at libdb ???])
        fi
      elif test "$ac_cv_lib_db1_dbopen1" = yes ; then
        AC_MSG_ERROR([config.cache inconsistency! (db1) Delete it, and redo!])
      fi
    else # Has it in the libc!
      LIBDB1=""
      t_found_at="libc(2)"
      DBTYPE="btree"
    fi
  fi
  if test "$t_found_at" = nowhere ; then
    AC_MSG_RESULT([Didn't locate BSD DB 1.x  dbopen()  anywhere, although <db_185.h> file exists.])
  else
    AC_MSG_RESULT([Located BSD DB 1.x  dbopen()  routine at $t_found_at])
    if test "$LIBDB1" != "" -a "$LIBDB1" = "$LIBNDBM" ; then
        # Well, both at the same library ( -ldb ), which propably
        # means that  <ndbm.h>  is just an emulation mode at BSD DB.
        LIBNDBM=""
      AC_MSG_RESULT([Note: It looks like your NDBM is actually BSD DB compability wrapper at])
      AC_MSG_RESULT([      libdb -library. If so, your NDBM databases are actually BSD DB_HASH ones..])
    fi
    if test "$t_found_at" != nowhere; then
      dblocation="$dblocation;$t_found_at"
      AC_DEFINE(HAVE_DB1,1,[Has BSD DB 1.x, and want to support it])
    fi
  fi
fi

dnl Possible backwards compability library is detected above, but we believe
dnl that following code can be *still* able to locate  dbopen()  from another
dnl library which contains call API (ABI?) compatible interface, however which
dnl does not necessarily contain binary compatible DATABASE which would use
dnl same binary layout as old BSD DB 1.85 version did...

if test "$ac_cv_header_db_h" = yes -o "$ac_cv_header_db1_db_h" = yes ; then
  t_found_at="nowhere"
  if test "$ac_cv_lib_c_dbopen" = yes ; then
    LIBDB1=""
    t_found_at="libc(3)"
    DBTYPE="btree"
  elif test "$ac_cv_lib_db1_dbopen" = yes ; then
    LIBDB1="-ldb1"
    t_found_at="db1 library"
    DBTYPE="btree"
  elif test "$ac_cv_lib_db_dbopen" = yes ; then
    LIBDB1="-ldb"
    t_found_at="db library"
    DBTYPE="btree"
  else
    if test "x$ac_cv_lib_c_dbopen" = x ; then # not set
      AC_TRY_LINK([], [dbopen();], ac_cv_lib_c_dbopen=yes,
                                   ac_cv_lib_c_dbopen=no)
    fi
    if test "$ac_cv_lib_c_dbopen" = no ; then
      if test "x$ac_cv_lib_db1_dbopen" = x ; then # not set
        t_oldLibs="$LIBS"
        LIBS="$LIBS -ldb1"
        AC_TRY_LINK([], [dbopen();],    ac_cv_lib_db1_dbopen=yes,
                                        ac_cv_lib_db1_dbopen=no)
        LIBS="$t_oldLibs"
        if test "$ac_cv_lib_db1_dbopen" = no ; then
          t_oldLibs="$LIBS"
          LIBS="$LIBS -ldb"
          AC_TRY_LINK([], [dbopen();],    ac_cv_lib_db_dbopen=yes,
                                          ac_cv_lib_db_dbopen=no)
          LIBS="$t_oldLibs"
        fi
        if test "$ac_cv_lib_db1_dbopen" = yes ; then
          LIBDB1="-ldb1"
          t_found_at="db1 library"
          DBTYPE="btree"
        elif test "$ac_cv_lib_db_dbopen" = yes ; then
          LIBDB1="-ldb"
          t_found_at="db library"
          DBTYPE="btree"
        else
          AC_MSG_RESULT([??? Has <db.h>, but dbopen() is not at libc, at libdb, nor at libdb1 ???])
        fi
      elif test "$ac_cv_lib_db_dbopen" = yes ; then
        AC_MSG_ERROR([config.cache inconsistency! (db) Delete it, and redo!])
      fi
    else # Has it in the libc!
      LIBDB1=""
      t_found_at="libc(4)"
      DBTYPE="btree"
    fi
  fi
  if test "$t_found_at" = nowhere ; then
    AC_MSG_RESULT([Didn't locate BSD DB 1.x  dbopen()  anywhere, although <db.h> file exists.])
  else
    AC_MSG_RESULT([Located BSD DB 1.x  dbopen()  routine at $t_found_at])
    if test "$LIBDB1" != "" -a "$LIBDB1" = "$LIBNDBM" ; then
        # Well, both at the same library ( -ldb1 ), which propably
        # means that  <ndbm.h>  is just an emulation mode at BSD DB.
        LIBNDBM=""
      AC_MSG_RESULT([Note: It looks like your NDBM is actually BSD DB compability wrapper at])
      AC_MSG_RESULT([      libdb -library. If so, your NDBM databases are actually BSD DB_HASH ones..])
    fi
    if test "$t_found_at" != nowhere; then
      dblocation="$dblocation;$t_found_at"
      AC_DEFINE(HAVE_DB1,1,[Have BSD DB 1.x at alternate location])
    fi
  fi
fi

dnl
dnl Ok, a third case; SleepyCat's BSD DB 2.*;  db_open() et.al.
dnl

#LIBDB2=""  # CAN INHERIT FROM ENVIRONMENT!
if test "$ac_cv_header_db_h" = yes -o "$ac_cv_header_db2_db_h" = yes ; then
  t_found_at="nowhere"
  if test "$ac_cv_lib_c_db_open2" = yes ; then
    LIBDB2=""
    t_found_at="libc(5)"
    DBTYPE="btree"
  elif test "$ac_cv_lib_db2_db_open2" = yes ; then
    LIBDB2="-ldb2"
    t_found_at="db2 library"
    DBTYPE="btree"
  elif test "$ac_cv_lib_db_db_open2" = yes ; then
    LIBDB2="-ldb"
    t_found_at="db library"
    DBTYPE="btree"
  else
    if test "x$ac_cv_lib_c_db_open2" = x ; then # not set
      AC_TRY_LINK([], [db_open();], ac_cv_lib_c_db_open2=yes,
                                    ac_cv_lib_c_db_open2=no)
    fi
    if test "$ac_cv_lib_c_db_open2" = no ; then
      if test "x$ac_cv_lib_db_db_open2" = x ; then # not set
        t_oldLibs="$LIBS"
        LIBS="$LIBS -ldb2"
        AC_TRY_LINK([], [db_open();], ac_cv_lib_db2_db_open2=yes,
                                      ac_cv_lib_db2_db_open2=no)
        LIBS="$t_oldLibs"
        if test "$ac_cv_lib_db2_db_open2" = no ; then
          LIBS="$LIBS -ldb"
          AC_TRY_LINK([], [db_open();], ac_cv_lib_db_db_open2=yes,
                                        ac_cv_lib_db_db_open2=no)
          LIBS="$t_oldLibs"
        fi
        if test "$ac_cv_lib_db2_db_open2" = yes ; then
          LIBDB2="-ldb2"
          t_found_at="db2 library"
          DBTYPE="btree"
        elif test "$ac_cv_lib_db_db_open2" = yes ; then
          LIBDB2="-ldb"
          t_found_at="db library"
          DBTYPE="btree"
        else
          if test "$ac_cv_lib_c_db_open2"   != yes -a \
                  "$ac_cv_lib_db_db_open2"  != yes -a \
                  "$ac_cv_lib_db2_db_open2" != yes      ; then
            AC_MSG_RESULT([Has <db.h> or <db2/db.h>, but db_open() is not at libc, nor at -ldb or -ldb2])
          fi
        fi
      else
        if test "$ac_cv_lib_db_db_open2" = yes ; then
          AC_MSG_ERROR([config.cache inconsistency! (db2) Delete it, and redo!])
        fi
      fi
    else # Has it in the libc!
      LIBDB2=""
      t_found_at="libc(6)"
      DBTYPE="btree"
    fi
  fi
  if test "$t_found_at" = nowhere ; then
    AC_MSG_RESULT([Didn't locate SleepyCat DB 2.x  db_open()  anywhere, although <db.h> file exists.  SleepyCat DB 2.x will not be used.])
  else
    AC_MSG_RESULT([Located SleepyCat DB 2.x  db_open()  routine at $t_found_at])

    dblocation="$dblocation;$t_found_at"
    AC_DEFINE(HAVE_DB2,1,[Have SleepyCat DB 2.x, and want to support it])

    AC_DEFINE(HAVE_DB_OPEN2,1,[2 parameter ->open() method])
    AC_DEFINE(HAVE_DB_CLOSE2,1,[2 parameter ->close() method])


    # Does (db->cursor)(...) have 3 or 4 args ?
    if test -z "$ac_cv_db_cursor_4" ; then # not set
      if test "$ac_cv_header_db2_db_h" = yes ; then
        AC_TRY_COMPILE([#include <db2/db.h>],[DB *db; DBC *curs;
int err = (db->cursor)(db, NULL, &curs, 0);],
                       ac_cv_db_cursor_4=yes, ac_cv_db_cursor_4=no)
      elif test "$ac_cv_header_db_h" = yes ; then
        AC_TRY_COMPILE([#include <db.h>],[DB *db; DBC *curs;
int err = (db->cursor)(db, NULL, &curs, 0);],
                       ac_cv_db_cursor_4=yes, ac_cv_db_cursor_4=no)
      else
        AC_MSG_RESULT([  Hmm.. No <db2/db.h>, nor <db.h> ??])
      fi
    fi
    if test "$ac_cv_db_cursor_4" = yes ; then
      AC_MSG_RESULT([  (db->cursor)() method function seems to want 4 args.])
      AC_DEFINE(HAVE_DB_CURSOR4,1,[Has 4 parameter db->cursor() method])
    else
      AC_MSG_RESULT([  (db->cursor)() method function seems to want 3 args.])
    fi
  fi
  if test -n "$LIBDB2" -a "$LIBDB2" = "$LIBNDBM" ; then
        # Well, both at the same library ( -ldb2 ), which propably
        # means that  <ndbm.h>  is just an emulation mode at BSD DB.
        LIBNDBM=""
    AC_MSG_RESULT([Note: It looks like your NDBM is actually BSD DB compability wrapper at])
    AC_MSG_RESULT([      libdb -library. If so, your NDBM databases are actually BSD DB_HASH ones..])
  fi
fi

dnl
dnl Ok, fourth case; SleepyCat's BSD DB 3.*;  db_create() et.al.
dnl

#LIBDB3=""  # CAN INHERIT FROM ENVIRONMENT!
if test "$ac_cv_header_db_h" = yes -o "$ac_cv_header_db3_db_h" = yes ; then
  t_found_at="nowhere"
  if test "x$LIBDB3" != x ; then
    t_found_at="$LIBDB3 library"
    DBTYPE="btree"
    AC_MSG_RESULT([   external non-void  LIBDB3  value found: '$LIBDB3'; will use it.])
  elif test "$ac_cv_lib_c_db_create" = yes ; then
    LIBDB3=""
    t_found_at="libc(7)"
    DBTYPE="btree"
  elif test "$ac_cv_lib_db3_db_create" = yes ; then
    LIBDB3="-ldb3"
    t_found_at="db3 library"
    DBTYPE="btree"
  elif test "$ac_cv_lib_db_db_create" = yes ; then
    LIBDB3="-ldb"
    t_found_at="db library"
    DBTYPE="btree"
  else
    if test "x$ac_cv_lib_c_db_create" = x ; then # not set
      AC_TRY_LINK([], [db_create();], ac_cv_lib_c_db_create=yes,
                                      ac_cv_lib_c_db_create=no)
    fi
    if test "$ac_cv_lib_c_db_create" = no ; then
      if test "x$ac_cv_lib_db_db_create" = x ; then # not set
        t_oldLibs="$LIBS"
        LIBS="$LIBS -ldb3"
        AC_TRY_LINK([], [db_create();], ac_cv_lib_db3_db_create=yes,
                                        ac_cv_lib_db3_db_create=no)
        LIBS="$t_oldLibs"
        if test "$ac_cv_lib_db3_db_create" = no ; then
          LIBS="$LIBS -ldb"
          AC_TRY_LINK([], [db_create();], ac_cv_lib_db_db_create=yes,
                                          ac_cv_lib_db_db_create=no)
          LIBS="$t_oldLibs"
        fi
        if test "$ac_cv_lib_db3_db_create" = yes ; then
          LIBDB3="-ldb3"
          t_found_at="db3 library"
          DBTYPE="btree"
        elif test "$ac_cv_lib_db_db_create" = yes ; then
          LIBDB3="-ldb"
          t_found_at="db library"
          DBTYPE="btree"
        else
          if test "$ac_cv_lib_c_db_create"   != yes -a \
                  "$ac_cv_lib_db_db_create"  != yes -a \
                  "$ac_cv_lib_db3_db_create" != yes       ; then
            AC_MSG_RESULT([Has <db.h> or <db3/db.h>, but db_create() is not at libc, nor at -ldb or -ldb3])
          fi
        fi
      else
        if test "$ac_cv_lib_db_db_create" = yes ; then
          AC_MSG_ERROR([config.cache inconsistency! (db3) Delete it, and redo!])
        fi
      fi
    else # Has it in the libc!
      LIBDB3=""
      t_found_at="libc(8)"
      DBTYPE="btree"
    fi
  fi
  if test "$t_found_at" = nowhere ; then
    AC_MSG_RESULT([Didn't locate SleepyCat DB 3.x  db_create()  anywhere, although <db.h> file exists.  SleepyCat DB 3.x will not be used.])
  else
    AC_MSG_RESULT([Located SleepyCat DB 3.x  db_create()  routine at $t_found_at])
    dblocation="$dblocation;$t_found_at"
    AC_DEFINE(HAVE_DB3,1,[Have SleepyCat DB 3.x, and want to support it])
    AC_DEFINE(HAVE_DB_CREATE,1,[SleepyCat DB 3.x/4.x db_create() function exists])
    AC_DEFINE(HAVE_DB_CLOSE2,1,[2 parameter db->close() method])
    AC_DEFINE(HAVE_DB_CURSOR4,1,[4 parameter db->cursor() method])
  fi
  if test -n "$LIBDB3" -a "$LIBDB3" = "$LIBNDBM" ; then
        # Well, both at the same library ( -ldb3 ), which propably
        # means that  <ndbm.h>  is just an emulation mode at BSD DB.
        LIBNDBM=""
    AC_MSG_RESULT([Note: It looks like your NDBM is actually BSD DB compability wrapper at])
    AC_MSG_RESULT([      libdb -library. If so, your NDBM databases are actually BSD DB_HASH ones..])
  fi
fi

dnl
dnl Ok, fifth case; SleepyCat's BSD DB 4.*;  db_create() et.al.
dnl

#LIBDB4=""  # CAN INHERIT FROM ENVIRONMENT!
if test "$ac_cv_header_db_h" = yes -o "$ac_cv_header_db4_db_h" = yes ; then
  t_found_at="nowhere"
  if test "x$LIBDB4" != x ; then
    t_found_at="$LIBDB4 library"
    DBTYPE="btree"
    AC_MSG_RESULT([   external non-void  LIBDB4  value found: '$LIBDB4'; will use it.])
  elif test "$ac_cv_lib_c_db_create" = yes ; then
    LIBDB4=""
    t_found_at="libc(9)"
    DBTYPE="btree"
  elif test "$ac_cv_lib_db4_db_create" = yes ; then
    LIBDB4="-ldb4"
    t_found_at="db4 library"
    DBTYPE="btree"
  elif test "$ac_cv_lib_db_db_create" = yes ; then
    LIBDB4="-ldb"
    t_found_at="db library"
    DBTYPE="btree"
  else
    if test "x$ac_cv_lib_c_db_create" = x ; then # not set
      AC_TRY_LINK([], [db_create();], ac_cv_lib_c_db_create=yes,
                                      ac_cv_lib_c_db_create=no)
    fi
    if test "$ac_cv_lib_c_db_create" = no ; then
      if test "x$ac_cv_lib_db_db_create" = x ; then # not set
        t_oldLibs="$LIBS"
        LIBS="$LIBS -ldb4"
        AC_TRY_LINK([], [db_create();], ac_cv_lib_db4_db_create=yes,
                                        ac_cv_lib_db4_db_create=no)
        LIBS="$t_oldLibs"
        if test "$ac_cv_lib_db4_db_create" = no ; then
          LIBS="$LIBS -ldb"
          AC_TRY_LINK([], [db_create();], ac_cv_lib_db_db_create=yes,
                                          ac_cv_lib_db_db_create=no)
          LIBS="$t_oldLibs"
        fi
        if test "$ac_cv_lib_db4_db_create" = yes ; then
          LIBDB4="-ldb4"
          t_found_at="db4 library"
          DBTYPE="btree"
        elif test "$ac_cv_lib_db_db_create" = yes ; then
          LIBDB4="-ldb"
          t_found_at="db library"
          DBTYPE="btree"
        else
          if test "$ac_cv_lib_c_db_create"   != yes -a \
                  "$ac_cv_lib_db_db_create"  != yes -a \
                  "$ac_cv_lib_db4_db_create" != yes       ; then
            AC_MSG_RESULT([Has <db.h> or <db4/db.h>, but db_create() is not at libc, nor at -ldb or -ldb4])
          fi
        fi
      else
        if test "$ac_cv_lib_db_db_create" = yes ; then
          AC_MSG_ERROR([config.cache inconsistency! (db4) Delete it, and redo!])
        fi
      fi
    else # Has it in the libc!
      LIBDB4=""
      t_found_at="libc(10)"
      DBTYPE="btree"
    fi
  fi
  if test "$t_found_at" = nowhere ; then
    AC_MSG_RESULT([Didn't locate SleepyCat DB 4.x  db_create()  anywhere, although <db.h> file exists.  SleepyCat DB 4.x will not be used.])
  else
    AC_MSG_RESULT([Located SleepyCat DB 4.x  db_create()  routine at $t_found_at])
    dblocation="$dblocation;$t_found_at"
    AC_DEFINE(HAVE_DB4,1,[Have SleepyCat DB 4.x database, and want to support it])
    AC_DEFINE(HAVE_DB_CREATE,1,[SleepyCat DB 3.x/4.x db_create() function exists])
    AC_DEFINE(HAVE_DB_CLOSE2,1,[2 parameter db->close() method])
    AC_DEFINE(HAVE_DB_CURSOR4,1,[4 parameter db->cursor() method])
  fi
  if test -n "$LIBDB4" -a "$LIBDB4" = "$LIBNDBM" ; then
        # Well, both at the same library ( -ldb4 ), which propably
        # means that  <ndbm.h>  is just an emulation mode at BSD DB.
        LIBNDBM=""
    AC_MSG_RESULT([Note: It looks like your NDBM is actually BSD DB compability wrapper at])
    AC_MSG_RESULT([      libdb -library. If so, your NDBM databases are actually BSD DB_HASH ones..])
  fi
fi


AC_SUBST(INCLLDAP)
LIBLDAP=""
INCLLDAP=""
if test "$ac_cv_header_ldap_h" = yes ; then
    AC_MSG_RESULT([Found  <ldap.h>, setting up defaults])
    INCLLDAP=""
    LIBLDAP="-lldap -llber"
fi
use_ldap=0
AC_ARG_WITH(ldap-prefix,[  --with-ldap-prefix=/usr  Prefix of UMich/NetScape LDAP includes, and library
                           the directories are  PREFIX/include/ and PREFIX/lib/],
        [ use_ldap=1
    AC_DEFINE(HAVE_LDAP_H,1,[HAVE_LDAP_H, 1])
    LIBLDAP="-lldap -llber"
    if test "$withval" != "/usr" ; then
        LIBLDAP="-L$withval/lib $LIBLDAP"
        INCLLDAP="-I$withval/include"
    fi
])
AC_ARG_WITH(ldap-include-dir,[  --with-ldap-include-dir=/.. Directory of UMich/NetScape LDAP includes],
        [ use_ldap=1
    AC_DEFINE(HAVE_LDAP_H,1,[HAVE_LDAP_H, 2])
    LIBLDAP="-lldap -llber"
    if test "$withval" != "/usr/include" ; then
        INCLLDAP="-I$withval/include"
    fi
])
AC_ARG_WITH(ldap-library-dir,[  --with-ldap-library-dir=/... Directory of UMich/NetScape LDAP libraries],
        [ use_ldap=1
    AC_DEFINE(HAVE_LDAP_H,1,[HAVE_LDAP_H, 3])
    LIBLDAP="-lldap -llber"
    if test "$withval" != "/usr/lib" -a "$withval" != "/lib" ; then
        LIBLDAP="-L$withval/lib $LIBLDAP"
    fi
])

if test -z "$INCLLDAP" -a -z "$LIBLDAP" ; then
   # No Explicite setup, lets do some auto-tests
   if test -n "$PKGCONFIG" ; then # RedHat ??
     INCLLDAP="`$PKGCONFIG --cflags-only-I openldap`"
     LIBLDAP="`$PKGCONFIG --libs openldap`"
   fi
fi

if test -z "$INCLLDAP" ; then
  # No Explicite setup, lets do some auto-tests
  LDAPH=/usr/local/include/ldap.h
  if test -r $LDAPH ; then
    AC_DEFINE(HAVE_LDAP_H,1,[HAVE_LDAP_H, 4])
    LIBLDAP="-L /usr/local/lib -lldap -llber"
    INCLLDAP="-I/usr/local/include"
  fi
  LDAPH=/usr/include/ldap.h
  if test -r $LDAPH ; then
    AC_DEFINE(HAVE_LDAP_H,1,[HAVE_LDAP_H, 5])
    LIBLDAP="-lldap -llber"
    INCLLDAP=""
  fi
fi

AC_ARG_WITH(ldap,  [  --with-ldap              Enable search for, and use of LDAP],
		   use_ldap=1)
if test $use_ldap = 0 ; then
    # AC_DEFINE(HAVE_LDAP_H,1,[HAVE_LDAP_H, 4])
    if test -n "$LIBLDAP" -o -n "$INCLLDAP" ; then
      LIBLDAP=""
      INCLLDAP=""
#     AC_MSG_RESULT([*** Automatic tests found some LDAP, but no --with-ldap  option is given.])
    fi
else
    if test -z "$LIBLDAP" -a -z "$INCLLDAP" ; then
	AC_MSG_RESULT([*** Automated tests didn't find LDAP libraries])
	AC_MSG_ERROR([*** THE  --with-ldap  IS CONSIDERED FAILED])
    fi
fi
if test -n "$LIBLDAP" -o -n "$INCLLDAP" ; then
    # LDAP related INCL or LIB references aren't completely empty.
    AC_DEFINE(USE_LDAP, 1, [Support of LDAP isn't explicitely disabled])
fi

# Lets build a nice single substitute variable
AC_SUBST(LIBDBMS)
AC_SUBST(LIBLOCALDBMS)
# GDBM must be last as if we have LIBDB at the system instead of real
# LIBNDBM, we still have ndbm routines, but want to use (likely)
# ones from LIBDB instead of LIBGDBM...
# .. and we have explicite "-lc" for NDBM in case it is at LIBC, as otherwise
# the linkage order will make a surprise for us by overloading GDBM's
# compability layer instead of the real NDBM.
sep=""
if test "$LIBNDBM" != "" ; then
  LIBDBMS="$LIBDBMS$sep$LIBNDBM"
  LIBLOCALDBMS="$LIBLOCALDBMS$sep$LIBNDBM"
  sep=" "
fi
dnl if test "$LIBSDBM" != "" ; then
dnl   LIBDBMS="$LIBDBMS$sep$LIBSDBM"
dnl   LIBLOCALDBMS="$LIBLOCALDBMS$sep$LIBSDBM"
dnl   sep=" "
dnl fi

if test "$LIBDB4" != "" ; then
  LIBDBMS="$LIBDBMS$sep$LIBDB4"
  LIBLOCALDBMS="$LIBLOCALDBMS$sep$LIBDB4"
  sep=" "
elif test "$LIBDB3" != "" ; then
  LIBDBMS="$LIBDBMS$sep$LIBDB3"
  LIBLOCALDBMS="$LIBLOCALDBMS$sep$LIBDB3"
  sep=" "
elif test "$LIBDB2" != "" ; then
  LIBDBMS="$LIBDBMS$sep$LIBDB2"
  LIBLOCALDBMS="$LIBLOCALDBMS$sep$LIBDB2"
  sep=" "
elif test "$LIBDB1" != "" ; then
  LIBDBMS="$LIBDBMS$sep$LIBDB1"
  LIBLOCALDBMS="$LIBLOCALDBMS$sep$LIBDB1"
  sep=" "
fi

if test "$LIBGDBM" != "" ; then
  LIBDBMS="$LIBDBMS$sep$LIBGDBM"
  LIBLOCALDBMS="$LIBLOCALDBMS$sep$LIBGDBM"
  sep=" "
fi
if test "$LIBLDAP" != "" ; then
  LIBDBMS="$LIBDBMS$sep$LIBLDAP"
  sep=" "
fi

if test "$dblocation" = "" ; then
  AC_MSG_RESULT([>>> OOPS!  You don't have any kind of modern DBMs in your])
  AC_MSG_RESULT([>>>        system!  We will not use ancient single-db using])
  AC_MSG_RESULT([>>>        <dbm.h> even if you had it.  Now you have only])
  AC_MSG_RESULT([>>>        relation (external) db types: ordered, unordered])
fi

# ... this is pointless test ...
#if test "$DBTYPE" = "" -a "$DEFDBTYPE" != "" ; then
#  DBTYPE="$DEFDBTYPE" # Use old value as a default..
#fi

case "$DBTYPE" in
 dbm)   DBEXT=""
        DBEXTtest=".pag"
        ;;
 ndbm)  DBEXT=""
        DBEXTtest=".pag"
        ;;
 sdbm)  DBEXT=""
        DBEXTtest=".pag"
        ;;
 gdbm)  DBEXT=".gdbm"
        DBEXTtest=".gdbm"
        ;;
 btree) DBEXT=".db"
        DBEXTtest=".db"
        ;;
 *)     DBEXT=".dat"
        DBEXTtest=".dat"
        ;;
esac

AC_MSG_RESULT([>>>  LIBDBMS      = '$LIBDBMS' ])
AC_MSG_RESULT([>>>  LIBLOCALDBMS = '$LIBLOCALDBMS' ])
AC_MSG_RESULT([>>>  DBTYPE       = '$DBTYPE' ])
AC_MSG_RESULT([>>>  DBEXT        = '$DBEXT' ])
AC_MSG_RESULT([>>>  DBEXTtest    = '$DBEXTtest' ])



AC_CHECK_HEADERS(string.h fcntl.h limits.h errno.h unistd.h stdlib.h \
		 sys/param.h sys/statfs.h sys/fstyp.h mnttab.h mntent.h \
		 sys/statvfs.h sys/vfs.h sys/mount.h sys/filsys.h \
		 sys/fs_types.h utime.h sys/file.h \
		 sys/utsname.h maillock.h arpa/inet.h \
		 dirent.h sys/ndir.h sys/dir.h ndir.h )


AC_HEADER_DIRENT
AC_STRUCT_DIRENT_D_INO
AC_FUNC_CLOSEDIR_VOID
AC_CHECK_FUNCS(dirfd)


AC_TRY_COMPILE([
#ifdef HAVE_DIRENT_H
# include <dirent.h>
#else /* not HAVE_DIRENT_H */
# define dirent direct
# ifdef HAVE_SYS_NDIR_H
#  include <sys/ndir.h>
# endif /* HAVE_SYS_NDIR_H */
# ifdef HAVE_SYS_DIR_H
#  include <sys/dir.h>
# endif /* HAVE_SYS_DIR_H */
# ifdef HAVE_NDIR_H
#  include <ndir.h>
# endif /* HAVE_NDIR_H */
#endif /* HAVE_DIRENT_H */
],[ DIR *dp; dp->dd_fd = 0; ],[
 AC_DEFINE([USE_DIRFD_DD_FD],1,[Can do  dirfd()  by referring to  dd_fd])
 AC_MSG_RESULT([Found  DIR  data field: dd_fd])
])

AC_TRY_COMPILE([
#ifdef HAVE_DIRENT_H
# include <dirent.h>
#else /* not HAVE_DIRENT_H */
# define dirent direct
# ifdef HAVE_SYS_NDIR_H
#  include <sys/ndir.h>
# endif /* HAVE_SYS_NDIR_H */
# ifdef HAVE_SYS_DIR_H
#  include <sys/dir.h>
# endif /* HAVE_SYS_DIR_H */
# ifdef HAVE_NDIR_H
#  include <ndir.h>
# endif /* HAVE_NDIR_H */
#endif /* HAVE_DIRENT_H */
],[ DIR *dp; dp->d_fd = 0; ],[
 AC_DEFINE([USE_DIRFD_D_FD],1,[Can do  dirfd() by referring to  d_fd])
 AC_MSG_RESULT([Found  DIR  data field: d_fd])
])



AC_SUBST(AUTHLIB)

use_pam=1
AC_ARG_WITH(pam,   [  --disable-pam            Disable PAM(3) facility autoconfig ],
        [if test "$withval" = no; then
           use_pam=0
         else
           use_pam=1
         fi], [use_pam=1])

if test "$use_pam" = 1 ; then
    AC_CHECK_HEADERS(security/pam_appl.h shadow.h)
    if test "$ac_cv_header_security_pam_appl_h" = "yes"; then
        # Some systems need only "-lpam", others need also "-ldl"
        t_oldLibs="$LIBS"
        LIBS="$LIBS -lpam"
        AC_TRY_LINK([#include <stdio.h>], [pam_end(NULL,0);],
                    AUTHLIB="-lpam" ,
                    AUTHLIB="-lpam -ldl");
        LIBS="$t_oldLibs"
    else
        if test "$ac_cv_header_shadow_h" = "yes"; then
            AC_TRY_LINK([], [getspnam("foo");],
                            AUTHLIB="",
                            AUTHLIB="-lshadow")
        else
            AUTHLIB=""
        fi
    fi
fi

#
# Following set of tests is rather weird... Some people don't agree on
# where to place these IPv6 related headers :-(
# The API specs say: <netinet/in.h>,  but some people disagree...
#

AC_CHECK_HEADERS(netinet/in.h netinet/tcp.h sys/un.h sys/socket.h)
if test "$ac_cv_header_netinet_in_h" = no ; then
    AC_MSG_RESULT([%%% AIEEE!  NO  <netinet/in.h>  HEADER ?!])
fi

AC_TRY_COMPILE([#include <sys/types.h>
#include <sys/socket.h>],[socklen_t sl = 2;],
        AC_DEFINE(HAVE_SOCKLEN_T,1,[System has  soclken_t  type]))

AC_ARG_WITH(ipv6,[  --with-ipv6              Have IPv6 in system, and want to use it],
        AC_DEFINE(INET6,1,[Want to use IPv6, in case it is supported in the system])
        ac_with_ipv6=yes
        )

if test "$ac_with_ipv6" = yes; then
  if test "x$ac_cv_af_inet6" = "x"; then
    AC_TRY_LINK([#include <sys/types.h>
#include <sys/socket.h>],
                [int af = AF_INET6;],
                ac_cv_af_inet6=yes, ac_cv_af_inet6=no)
    if test "$ac_cv_af_inet6" = yes; then
        AC_TRY_LINK([#include <sys/types.h>
#include <sys/socket.h>
#include <netinet/in.h>],
                    [/* Has AF_INET6, but does one have all related things ? */
                     struct in6_addr sin6;],
                    ac_cv_struct_in6_addr=yes, ac_cv_struct_in6_addr=no)
        AC_MSG_RESULT([We have <sys/socket.h> defining  AF_INET6, but do we have properly ..])
        AC_MSG_RESULT([.. structured <netinet/in.h> headers with 'struct in6_addr' ? $ac_cv_struct_in6_addr])
        if test "$ac_cv_struct_in6_addr" != yes; then

            AC_CHECK_HEADERS(netinet/in6.h)
            if test "$ac_cv_header_netinet_in6_h" != "yes" ; then
                AC_CHECK_HEADERS(netinet6/in6.h)
                if test "$ac_cv_header_netinet6_in6_h" != "yes" ; then

                    AC_CHECK_HEADERS(linux/in6.h)
                    if test "$ac_cv_header_linux_in6_h" != "yes" ; then
                        AC_MSG_RESULT([***  You have a SOME system with  <sys/socket.h>  defining AF_INET6, however])
                        AC_MSG_RESULT([***  the system does not have all required includes ])
                        AC_MSG_RESULT([***  for the compilation to succeed. ])
                        AC_MSG_RESULT([***  I know of some releases of Linux 2.0.* systems doing this.])
                        AC_MSG_RESULT([***  If you have one, edit the  <linux/socket.h>,  and])
                        AC_MSG_RESULT([***  remove the define of   AF_INET6 ])
                        AC_MSG_ERROR([AF_INET6 feature error])
                    fi
                fi
            fi
        fi
    fi
  else
    if test "$ac_cv_af_inet6" = yes; then
        # We were successfull at creating these cached variables above,
        # thus we can (with confidence) do following, and only one is
        # defined as an end result..
        if test "$ac_cv_header_netinet_in6_h" = yes; then
            AC_DEFINE(HAVE_NETINET_IN6_H)
        fi
        if test "$ac_cv_header_netinet6_in6_h" = yes; then
            AC_DEFINE(HAVE_NETINET6_IN6_H)
        fi
        if test "$ac_cv_header_linux_in6_h" = yes; then
            AC_DEFINE(HAVE_LINUX_IN6_H)
        fi
    fi
  fi
fi # End of:  --with-ipv6


AC_CHECK_HEADERS(varargs.h stdarg.h)
AC_CHECK_FUNCS(flock lockf lstat)

without_fsync=0
AC_ARG_WITH(fsync,[  --without-fsync          Do not use fsync() even if you have it],
        without_fsync=1)
if test $without_fsync = 0; then
        AC_CHECK_FUNCS(fsync)
fi

without_maillock=0
AC_ARG_WITH(maillock,[  --without-maillock       Do not use maillock() even if you have it],
        without_maillock=1)
if test without_maillock = 0; then
        AC_FUNC_SVR4_MAILLOCK  
else
        AC_DEFINE(HAVE_DOTLOCK,1,[The mailbox access is based on traditional "dot-locking" protocol])
fi
              

AC_CHECK_FUNCS(mkdir mktime mkstemp rename rmdir strcpy strdup strstr \
                strchr strrchr setvbuf strerror strsignal setreuid \
                setregid sigprocmask sigpending sigsuspend gethostid)
# If the system does not have the following (library) calls,
# we use emulations (replacements):
AC_REPLACE_FUNCS(mkdir mktime rename rmdir strcpy strdup strstr \
                 strchr strrchr setvbuf strerror strsignal strtoul)

AC_CHECK_DECLS([sys_siglist])

AC_CACHE_CHECK([existence of char **sys_siglist], ac_cv_arr_sys_siglist, [
AC_TRY_LINK([extern char *sys_siglist[]; static char *s;], [s = sys_siglist[2]; ],
                [ac_cv_arr_sys_siglist=yes])
])
if test "$ac_cv_arr_sys_siglist" = yes ; then
    AC_DEFINE(HAVE_SYS_SIGLIST,1,(Linkage against extern char *sys_siglist[] works))
fi


# Additional tests for the emulations..
AC_CHECK_FUNCS(index rindex)
# more tests..
AC_CHECK_FUNCS( endgrent fchdir ftime getcwd getgroups setgroups \
                getmntinfo gettimeofday isascii memcpy memchr mkfifo   \
                getpgrp setsid seteuid setuid setegid setgid \
	        setrlimit fchown utimes utime sysconf fpathconf )
# Networking stuff is in deep trouble, if sockets are not found..
AC_CHECK_HEADERS(netdb.h syslog.h sys/resource.h \
                 protocols/rwhod.h select.h sys/select.h \
		 ifaddrs.h locale.h )

AC_CHECK_FUNCS(select syslog getdtablesize setpriority \
	       getifaddrs freeifaddrs setlocale)

AC_CHECK_HEADERS(sys/loadavg.h) dnl Solaris 8, BSD uses <stdlib.h>
dnl AC_CHECK_FUNCS(getloadavg) dnl BSDs and Solaris 8, at least..

AC_LINK_IFELSE([AC_LANG_PROGRAM(
[[#ifdef HAVE_SYS_LOADAVG_H
#include <sys/loadavg.h>
#endif
#ifdef HAVE_STDLIB_H
#include <stdlib.h>
#endif
int tester()
{
    double loads[3];
    return getloadavg(loads, 3);
}
]])],[
	AC_DEFINE(HAVE_GETLOADAVG,1,[BSD-style load-avg pickup])
	AC_MSG_RESULT([Have BSD-style  getloadavg(double [3], int)  function])
    ],[
	AC_MSG_RESULT([No  getloadavg(double[3],int)  type of function ?])
    ])


#
# Test to see, if we have BSD4.4  sa_len -field in the "struct sockaddr*"
#
AC_STRUCT_SA_LEN

AC_CHECK_FUNC(res_init)  # Can be found without any libs ?  Or needs BIND libresolv ?
AC_CHECK_FUNC(res_mkquery)

AC_SUBST(LIBRESOLV)
AC_SUBST(INCLRESOLV)
AC_SUBST(LIBRESOLVA)
use_resolvopt=0
AC_ARG_WITH(bundled-libresolv,   [  --with-bundled-libresolv Use bundled libresolv source],
        use_resolvopt=1)
if test "$use_resolvopt" = 0 ; then
    if test $ac_cv_func_res_mkquery = yes ; then
        LIBRESOLV="" #  res_mkquery() is at system libc
        AC_MSG_RESULT([Using no -lresolv; res_mkquery() in libc ?])
    else
        LIBRESOLV="-lresolv"
        AC_MSG_RESULT([Using system supplied -lresolv -- hope it works..])
    fi
    AC_DEFINE(HAVE_GETHOSTBYNAME,1,[gethostbyname() function exists])
    AC_DEFINE(HAVE_RESOLVER,1,[System has (bundled) resolver library])
    INCLRESOLV=""
    LIBRESOLVA=""
else
    # We have bundled BIND 4.9.4 resolver, which can make things
    # so much simpler to ourselves (except at BSD machines..)
    AC_DEFINE(HAVE_GETHOSTBYNAME,1,[])
    AC_DEFINE(HAVE_RESOLVER,1,[])
    LIBRESOLV="-lresolv"
    INCLRESOLV='-I$(TOPDIR)/libresolv'
    LIBRESOLVA="libresolv.a"
    AC_MSG_RESULT([Using bundled (bind 4.9.4-REL) libresolv])
fi

use_resolvopt=0
AC_ARG_WITH(resolvlib,   [  --with-resolvlib="-L ... -R .. -lxxx"  Use explicitely given
               resolver library with its linkage options.],
        use_resolvopt=1)
if test "$use_resolvopt" = 1; then
    AC_DEFINE(HAVE_GETHOSTBYNAME,1,[])
    AC_DEFINE(HAVE_RESOLVER,1,[])
    LIBRESOLV="$withval"
    INCLRESOLV=''
    LIBRESOLVA=""
    AC_MSG_RESULT([Using explicitely given resolvlib: '$withval'])
fi

#
# Test to see, if we have cd and ad fields in "struct HEADER"
#
AC_CACHE_CHECK(for cd and ad in HEADER struct (BIND 8),
               zm_cv_struct_HEADER_cd_ac,
               [AC_TRY_COMPILE(
[#include <sys/types.h>
#include <sys/socket.h>
#include <netinet/in.h>
#include <arpa/nameser.h>],
[struct HEADER a; a.ad = a.cd = 0;],
               zm_cv_struct_HEADER_cd_ac=yes,
               zm_cv_struct_HEADER_cd_ac=no)])
if test "$zm_cv_struct_HEADER_cd_ac" = yes; then
    AC_DEFINE(HAVE_HEADER_CD_AD,1,[The resolver library header has BIND 8 CD and AC bitfields defined.])
fi

#
#  We check for various libraries
#  - SysVr4 style of "-lsocket" at first (unless in libc)
#    The hallmark is  connect()  routine (we presume)
#
AC_SUBST(LIBSOCKET)dnl
ac_cv_libsocket_both=1
AC_CHECK_FUNC(connect, ac_cv_libsocket_both=0)
AC_CHECK_FUNC(gethostbyname, ac_cv_libsocket_both=0)
if test "$ac_cv_libsocket_both" = 1 ; then
  # Check cache
  if test "$ac_cv_func_socket_lxnet" = yes ; then
    AC_MSG_RESULT([need -lxnet library (cached)])
    LIBSOCKET="-lnsl -lsocket -lxnet"
  else
  if test "$ac_cv_func_socket_lsocket" = yes ; then
    AC_MSG_RESULT([need -lsocket library (cached)])
    LIBSOCKET="-lsocket"
    if test "$ac_cv_func_gethostbyname_lnsl" = yes ; then
        LIBSOCKET="-lnsl -lsocket"
    fi
  else
    # Well, will this work ?  SysVR4, but not Sun Solaris ?
    AC_CHECK_LIB(xnet, connect, [LIBSOCKET="-lnsl -lsocket -lxnet"
                                 ac_cv_func_socket_lsocket=no
                                 ac_cv_func_socket_lxnet=yes],[
      AC_CHECK_LIB(socket, connect, [LIBSOCKET="-lsocket"
                                     ac_cv_func_socket_lsocket=yes],
                                     ac_cv_func_socket_lsocket=no)
      if test "$ac_cv_func_socket_lsocket" = yes ; then
        t_oldLibs="$LIBS"
        LIBS="$LIBS -lsocket $LIBRESOLV"
        AC_TRY_LINK([],[gethostbyname();], ,[
          LIBS="$LIBS -lnsl" # Add this Solaris library..
          AC_TRY_LINK([],[gethostbyname();],[
                        LIBSOCKET="-lsocket -lnsl"
                        ac_cv_func_gethostbyname_lnsl=yes
                ], [
                   AC_MSG_ERROR([Weird, '$LIBS' not enough to find  gethostnyname() ?!])
                ])
          ])
        LIBS="$t_oldLibs"
      fi
    ])
  fi
  fi
fi

if test "x$LIBRESOLV" = "x"; then
  # Ok, No  -lresolv,  is this enough for the  _res  to appear ?
  t_oldLibs="$LIBS"
  LIBS="$LIBS $LIBSOCKET"
  ac_cv_var__res_options=no
  # This following is for IRIX6.4, and I sincerely hope it
  # will not fail on other systems...  It did! It did!
  # Many systems don't have idemponent headers, they need specific
  # includes before latter ones, or the latter ones won't be successful...
  AC_TRY_LINK([#include <sys/types.h>
#include <sys/socket.h>
#include <netinet/in.h>
#include <arpa/nameser.h>
#include <resolv.h>],
              [_res.options = RES_INIT;],
                ac_cv_var__res_options=yes);
  if test "$ac_cv_var__res_options" != "yes"; then
    AC_MSG_RESULT([Can't do without  -lresolv  to link resolver's  _res.options])
    LIBRESOLV="-lresolv"
  fi
  LIBS="$t_oldLibs"
fi

# See about the routines that possibly exist at the libraries..
LIBS="$t_oldLibs $LIBSOCKET"
AC_CHECK_FUNCS(socket socketpair)
LIBS="$t_oldLibs"

if test "$ac_cv_func_socket" = no -a "$LIBSOCKET" != ""; then
  LIBS="$LIBS $LIBSOCKET"
  AC_TRY_LINK([],[socket();], ac_cv_func_socket=yes)
  if test $ac_cv_func_socket = yes; then
    AC_DEFINE(HAVE_SOCKET)
    AC_MSG_RESULT([Has  socket()  when using  $LIBSOCKET])
  fi
  LIBS="$t_oldLibs"
fi
if test "$ac_cv_func_socketpair" = no -a "$LIBSOCKET" != ""; then
  LIBS="$LIBS $LIBSOCKET"
  AC_TRY_LINK([],[socketpair();], ac_cv_func_socketpair=yes)
  if test $ac_cv_func_socketpair = yes; then
    AC_DEFINE(HAVE_SOCKETPAIR)
    AC_MSG_RESULT([Has  socketpair()  when using  $LIBSOCKET])
  fi
  LIBS="$t_oldLibs"
fi

ac_with_ipv6_replacement_libc=0
AC_ARG_WITH(ipv6-replacement-libc, [  --with-ipv6-replacement-libc If system has broken  getaddrinfo() and friends],
        ac_with_ipv6_replacement_libc=1)

LIBS="$LIBSOCKET $LIBS"
AC_CHECK_FUNCS(inet_ntop inet_pton getaddrinfo getnameinfo gai_strerror)
LIBS="$t_oldLibs"

if test "$ac_with_ipv6_replacement_libc" = 1 ; then
  AC_LIBOBJ([inet_ntop])
  AC_LIBOBJ([inet_pton])
  AC_LIBOBJ([getaddrinfo])
  AC_LIBOBJ([getnameinfo])
  AC_LIBOBJ([gai_strerror])
  AC_DEFINE(HAVE_GETNAMEINFO)
  AC_DEFINE(HAVE_GETADDRINFO)
  AC_DEFINE(HAVE__GETADDRINFO_,1,[Using our own special replacement library for IPv6 support])
  AC_DEFINE(HAVE_INET_NTOP,1,[Have  inet_ntop()  function.])
  AC_DEFINE(HAVE_INET_PTON,1,[Have  inet_pton()  function.])
else

  t_oldLibs="$LIBS"
  LIBS="$LIBS $LIBSOCKET"

  #  Following stuff may exist in our LIBC, or in separate -linet6
 # AC_CHECK_FUNCS(inet_ntop inet_pton getaddrinfo getnameinfo gai_strerror)
  #  If not found in LIBC, try to use  -linet6,  if it fails too,
  #  THEN call the AC_REPLACE_FUNCS()
  if test "$ac_cv_func_gai_strerror" = no ; then
    LIBS="$LIBS -linet6"
    AC_TRY_LINK([],[gai_strerror();], ac_cv_func_gai_strerror=yes)
    LIBS="$t_oldLibs"
    if test "$ac_cv_func_gai_strerror" = yes; then
      LIBSOCKET="$LIBSOCKET -linet6"
      AC_MSG_RESULT([Has IPv6 API  gai_strerror()  when using  $LIBSOCKET])
    else
      AC_LIBOBJ([inet_ntop])
      AC_LIBOBJ([inet_pton])
      AC_LIBOBJ([getaddrinfo])
      AC_LIBOBJ([getnameinfo])
      AC_LIBOBJ([gai_strerror])
    fi
  fi

  LIBS="$t_oldLibs"

fi

AC_SUBST(RFC822TABS)
AC_ARG_WITH(rfc822-tabs,   [  --without-rfc822-tabs    Turn off the TABs from the rewritten headers ],
        [if test "$withval" = no; then
           use_rfc822_tabs=0
         else
           use_rfc822_tabs=1
         fi], [use_rfc822_tabs=1])
RFC822TABS="$use_rfc822_tabs"
AC_MSG_RESULT([RFC-822 TABs setting: $use_rfc822_tabs])

AC_SUBST(LIBWRAP)
AC_SUBST(INCLWRAP)
LIBWRAP=""
INCLWRAP=""
use_tcpwrappers=0
AC_ARG_WITH(tcp-wrappers,   [  --with-tcp-wrappers[=DIRPATH] Where the TCP-WRAPPERS can be found],
        [if test "$withval" = yes; then
           use_tcpwrappers=2
         else
           use_tcpwrappers=1
         fi])

t_oldLibs="$LIBS"
t_oldCpp="$CPPFLAGS"

if test "$use_tcpwrappers" != 0 ; then
    if test "$use_tcpwrappers" = 2 ; then

        AC_CHECK_HEADERS(tcpd.h)
        if test "$ac_cv_header_tcpd_h" = yes; then
            LIBWRAP="-lwrap"
            INCLWRAP=""
            wraploc="sysdefault"
        else
            if test -f "/local/include/tcpd.h"; then
                LIBWRAP="-L/local/lib -lwrap"
                INCLWRAP="-I/local/include"
                wraploc="-L/local/lib -I/local/include"
            elif test -f "/usr/local/include/tcpd.h"; then
                LIBWRAP="-L/usr/local/lib -lwrap"
                INCLWRAP="-I/usr/local/include"
                wraploc="-L/usr/local/lib -I/usr/local/include"
            elif test -f "/opt/include/tcpd.h"; then
                LIBWRAP="-L/opt/lib -lwrap"
                INCLWRAP="-I/opt/include"
                wraploc="-L/opt/lib -I/opt/include"
            elif test -f "/opt/local/include/tcpd.h"; then
                LIBWRAP="-L/opt/local/lib -lwrap"
                INCLWRAP="-I/opt/local/include"
                wraploc="-L/opt/local/lib -I/opt/local/include"
            else
                LIBWRAP=""
                INCLWRAP=""
                wraploc="nowhere?"
            fi
        fi
        LIBS="$LIBS $LIBSOCKET $LIBWRAP"
        CPPFLAGS="$CPPFLAGS $INCLWRAP"
        AC_CACHE_VAL(ac_cv_lib_tcpwrap,
                     [AC_TRY_LINK([#include <stdio.h>
#include <sys/types.h>
#include <sys/socket.h>
#include <netinet/in.h>
#include <tcpd.h>
struct request_info request;
int deny_severity, allow_severity;],[hosts_access(&request);],
                        ac_cv_lib_tcpwrap=yes,ac_cv_lib_tcpwrap=no)
        ])
        if test "$ac_cv_lib_tcpwrap" = yes; then
            AC_MSG_RESULT([Tcp-wrapper available at $wraploc: -lwrap !]);
        else
            LIBS="$t_oldLibs $LIBSOCKET -lnsl $LIBWRAP"
            CPPFLAGS="$CPPFLAGS $INCLWRAP"
            AC_CACHE_VAL(ac_cv_lib_tcpwrap_nsl,
                         [AC_TRY_LINK([#include <stdio.h>
#include <sys/types.h>
#include <sys/socket.h>
#include <netinet/in.h>
#include <tcpd.h>
struct request_info request;
int deny_severity, allow_severity;],[hosts_access(&request);],
                        ac_cv_lib_tcpwrap_nsl=yes,ac_cv_lib_tcpwrap_nsl=no)
            ])

            if test "$ac_cv_lib_tcpwrap_nsl" = yes; then
                AC_MSG_RESULT([Tcp-wrapper available at $wraploc: -lwrap !]);
                AC_MSG_RESULT([  NEEDED TO ADD  -lnsl  TO THE LIBSOCKET!]);
                LIBSOCKET="$LIBSOCKET -lnsl"            
            else
                AC_MSG_RESULT([No tcp-wrapper available at system default locations ?])
                LIBWRAP=""
                INCLWRAP=""
            fi
        fi
    else
      LIBWRAP="-L$withval -lwrap"
      INCLWRAP="-I$withval"
      unset ac_cv_lib_tcpwrap
      AC_DEFINE(HAVE_TCPD_H,1,[Have found TCP-Wrapper  tcpd.h  header file.])
      AC_MSG_RESULT([Using tcp-wrappers at directory: $withval]);
    fi
fi

if test -n "$LIBWRAP"; then
  AC_DEFINE(USE_TCPWRAPPER,1,[Want to use TCP-Wrapper code])
fi

CPPFLAGS="$t_oldCpp"
LIBS="$t_oldLibs"


AC_SUBST(PRIVATEMBOX)
PRIVATEMBOX=""
AC_ARG_WITH(privatembox,   [  --with-privatembox       Use 'private/' in a part of mailbox compilations],
        PRIVATEMBOX="private/")

AC_ARG_WITH(mboxquotacheck,[  --with-mboxquotacheck    Use 'CHECK_MB_SIZE' define in mailbox program.
                           Linking is presumed to use  --with-generic-lib=DIR],
        AC_DEFINE(CHECK_MB_SIZE,1,[Wants to do mboxquotacheck code]))

AC_SUBST(PRIVATEAUTH)
PRIVATEAUTH=""
AC_ARG_WITH(privateauth,   [  --with-privateauth       Use 'private/' in a part of smtpserver compilations],
        PRIVATEAUTH="private/")

AC_SUBST(LIBWHOSON)
AC_SUBST(INCLWHOSON)
use_whoson=0
AC_ARG_WITH(whoson,   [  --with-whoson[[=DIRPATH]]  Where the WHOSON libs can be found],
        [if test "$withval" = yes; then
                use_whoson=2
         else
                use_whoson=1
         fi])

t_oldLibs="$LIBS"
t_oldCpp="$CPPFLAGS"

if test "$use_whoson" != 0 ; then
  if test "$use_whoson" = 2 ; then

#    if test "$ac_cv_lib_whoson" = yes; then
#       LIBWHOSON="-lwhoson"
#       INCLWHOSON=""
#       AC_MSG_RESULT([Whoson libs available at system default: -lwhoson !]);
#    else
#-------------
#       AC_TRY_LINK([#include <whoson.h>],[wso_version();],
#                        ac_cv_lib_whoson=yes,ac_cv_lib_whoson=no)
#       LIBWHOSON=""
#       INCLWHOSON=""
#       if test "$ac_cv_lib_whoson" = yes; then
#           AC_MSG_RESULT([Whoson libs available at $whosonloc: -lwhoson !]);
#       else
#           AC_MSG_RESULT([No whoson libs available system at default location ?])
#       fi
#       : # "nop"       
#-------------
        AC_CHECK_HEADERS(whoson.h)
        if test "$ac_cv_header_whoson_h" = yes; then
            LIBWHOSON="-lwhoson"
            INCLWHOSON=""
            whosonloc="sysdefault"

            LIBS="$LIBS $LIBSOCKET $LIBWHOSON"
            CPPFLAGS="$CPPFLAGS $INCLWHOSON"
            AC_TRY_LINK([#include <whoson.h>
                        int deny_severity, allow_severity;],[wso_version();],
                        ac_cv_lib_whoson=yes,ac_cv_lib_whoson=no)
dnl AC_MSG_RESULT([ ... link -lwhoson yields: $ac_cv_lib_whoson])
            if test "$ac_cv_lib_whoson" = no; then
                LIBS="$t_oldLibs"
                LIBS="$LIBS $LIBSOCKET -L/usr/local/lib $LIBWHOSON"
                AC_TRY_LINK([#include <whoson.h>],[wso_version();],
                        ac_cv_lib_whoson=yes,ac_cv_lib_whoson=no)
dnl AC_MSG_RESULT([ ... link -L/usr/local/lib -lwhoson yields: $ac_cv_lib_whoson])
                if test  "$ac_cv_lib_whoson" = yes; then
                    whosonloc="-L/usr/local/lib"
                    LIBWHOSON="-L/usr/local/lib $LIBWHOSON"
                fi
            fi
            if test "$ac_cv_lib_whoson" = no; then
                LIBS="$t_oldLibs"
                LIBS="$LIBS $LIBSOCKET -L/local/lib $LIBWHOSON"
                AC_TRY_LINK([#include <whoson.h>],[wso_version();],
                        ac_cv_lib_whoson=yes,ac_cv_lib_whoson=no)
dnl AC_MSG_RESULT([ ... link -L/local/lib -lwhoson yields: $ac_cv_lib_whoson])
                if test  "$ac_cv_lib_whoson" = yes; then
                    whosonloc="-L/local/lib"
                    LIBWHOSON="-L/local/lib $LIBWHOSON"
                fi
            fi
            if test "$ac_cv_lib_whoson" = no; then
                LIBS="$t_oldLibs"
                LIBS="$LIBS $LIBSOCKET -L/opt/lib $LIBWHOSON"
                AC_TRY_LINK([#include <whoson.h>],[wso_version();],
                        ac_cv_lib_whoson=yes,ac_cv_lib_whoson=no)
dnl AC_MSG_RESULT([ ... link -L/opt/lib -lwhoson yields: $ac_cv_lib_whoson])
                if test  "$ac_cv_lib_whoson" = yes; then
                    whosonloc="-L/opt/lib"
                    LIBWHOSON="-L/opt/lib $LIBWHOSON"
                fi
            fi
            if test "$ac_cv_lib_whoson" = no; then
                LIBS="$t_oldLibs"
                LIBS="$LIBS $LIBSOCKET -L/opt/local/lib $LIBWHOSON"
                AC_TRY_LINK([#include <whoson.h>],[wso_version();],
                        ac_cv_lib_whoson=yes,ac_cv_lib_whoson=no)
                if test  "$ac_cv_lib_whoson" = yes; then
                    whosonloc="-L/opt/local/lib"
                    LIBWHOSON="-L/opt/local/lib $LIBWHOSON"
                fi
            fi
            if test "$ac_cv_lib_whoson" = no; then
                unset ac_cv_lib_whoson
            fi

            CPPFLAGS="$t_oldCpp"
            LIBS="$t_oldLibs"

        else
            AC_CHECK_HEADERS(/local/include/whoson.h /usr/local/include/whoson.h \
                             /opt/include/whoson.h /opt/local/include/whoson.h)
            if test -n "$ac_cv_header__local_include_whoson_h"; then
                LIBWHOSON="-L/local/lib -lwhoson"
                INCLWHOSON="-I/local/include"
                whosonloc="-L/local/lib -I/local/include"
            elif test -n "$ac_cv_header__usr_local_include_whoson_h"; then
                LIBWHOSON="-L/usr/local/lib -lwhoson"
                INCLWHOSON="-I/usr/local/include"
                whosonloc="-L/usr/local/lib -I/usr/local/include"
            elif test -n "$ac_cv_header__opt_include_whoson_h"; then
                LIBWHOSON="-L/opt/lib -lwhoson"
                INCLWHOSON="-I/opt/include"
                whosonloc="-L/opt/lib -I/opt/include"
            elif test -n "$ac_cv_header__opt_local_include_whoson_h"; then
                LIBWHOSON="-L/opt/local/lib -lwhoson"
                INCLWHOSON="-I/opt/local/include"
                whosonloc="-L/opt/local/lib -I/opt/local/include"
            else
                LIBWHOSON=""
                INCLWHOSON=""
                whosonloc="nowhere?"
            fi
        fi
        LIBS="$LIBS $LIBSOCKET $LIBWHOSON"
        CPPFLAGS="$CPPFLAGS $INCLWHOSON"
        AC_CACHE_VAL(ac_cv_lib_whoson,
          [AC_TRY_LINK([#include <whoson.h>],[wso_version();],
                        ac_cv_lib_whoson=yes,ac_cv_lib_whoson=no)
          ])
        if test "$ac_cv_lib_whoson" = yes; then
            AC_MSG_RESULT([Whoson libs  available at $whosonloc: -lwhoson !]);
            AC_DEFINE(HAVE_WHOSON_H,1,[Whoson libs available at $whosonloc: -lwhoson!])
        else
            AC_MSG_RESULT([No whoson libs available at system default locations ?])
            LIBWHOSON=""
            INCLWHOSON=""
        fi
  #  fi
  else
    if test -f "$withval"/lib/libwhoson.a ; then
        LIBWHOSON="-L$withval/lib -lwhoson"
        AC_MSG_RESULT([Using whoson libs at directory: $withval/lib]);
    else
        LIBWHOSON="-L$withval -lwhoson"
        AC_MSG_RESULT([Using whoson libs at directory: $withval]);
    fi
    if test -f "$withval"/include/whoson.h ; then
        INCLWHOSON="-I$withval/include"
        AC_MSG_RESULT([Using whoson includes at directory: $withval]);
    else
        INCLWHOSON="-I$withval"
        AC_MSG_RESULT([Using whoson includes at directory: $withval]);
    fi
    unset ac_cv_lib_whoson
    AC_DEFINE(HAVE_WHOSON_H,1,[Using whoson includes at directory: $withval])
  fi
fi

CPPFLAGS="$t_oldCpp"
LIBS="$t_oldLibs"

AC_SUBST(LIBSPF)
AC_SUBST(INCLSPF)
use_spf=0
AC_ARG_WITH(spf,   [  --with-spf[[=DIRPATH]]     Where the SPF libs can be found.
                           Needs spf_alt from http://www.midwestcs.com/spf/libspf-alt/
                           or  spf2   from  http://www.libspf2.org/],
        [if test "$withval" = yes; then
                use_spf=2
         else
                use_spf=1
         fi])

t_oldLibs="$LIBS"
t_oldCpp="$CPPFLAGS"

if test "$use_spf" != 0 ; then
  if test "$use_spf" = 2 ; then

	AC_CHECK_HEADERS(spf2/spf.h spf_alt/spf.h)

	SPFvers=0

	if test "$ac_cv_header_spf2_spf_h" = yes; then
	    LIBSPF="-lspf2"
	    INCLSPF=""
	    spfloc="sysdefault"
	    SPFvers=2

	    LIBS="$LIBS $LIBSOCKET $LIBSPF"
	    CPPFLAGS="$CPPFLAGS $INCLSPF"
	    AC_TRY_LINK([#include <sys/types.h>
			#include <spf2/spf.h>
			int major, minor, patch;],
			[SPF_get_lib_version(&major,&minor,&patch);],
			ac_cv_lib_spf2=yes,ac_cv_lib_spf2=no)
dnl AC_MSG_RESULT([ ... link -lspf2 yields: $ac_cv_lib_spf2])
	    if test "$ac_cv_lib_spf2" = no; then
		LIBS="$t_oldLibs"
		LIBS="$LIBS $LIBSOCKET -L/usr/local/lib $LIBSPF"
		AC_TRY_LINK([#include <sys/types.h>
				#include <spf2/spf.h>
				int major, minor,patch;],
				[SPF_get_lib_version(&major,&minor,&patch);],
			ac_cv_lib_spf2=yes,ac_cv_lib_spf2=no)
dnl AC_MSG_RESULT([ ... link -L/usr/local/lib -lspf2 yields: $ac_cv_lib_spf2])
		if test	 "$ac_cv_lib_spf2" = yes; then
		    spfloc="-L/usr/local/lib"
		    LIBSPF="-L/usr/local/lib $LIBSPF"
		fi
	    fi
	    if test "$ac_cv_lib_spf2" = no; then
		LIBS="$t_oldLibs"
		LIBS="$LIBS $LIBSOCKET -L/local/lib $LIBSPF"
		AC_TRY_LINK([#include <sys/types.h>
				#include <spf2/spf.h>
				int major, minor,patch;],
				[SPF_get_lib_version(&major,&minor,&patch);],
			ac_cv_lib_spf2=yes,ac_cv_lib_spf2=no)
dnl AC_MSG_RESULT([ ... link -L/local/lib -lspf2 yields: $ac_cv_lib_spf2])
		if test	 "$ac_cv_lib_spf2" = yes; then
		    spfloc="-L/local/lib"
		    LIBSPF="-L/local/lib $LIBSPF"
		fi
	    fi
	    if test "$ac_cv_lib_spf2" = no; then
		LIBS="$t_oldLibs"
		LIBS="$LIBS $LIBSOCKET -L/opt/lib $LIBSPF"
		AC_TRY_LINK([#include <sys/types.h>
				#include <spf2/spf.h>
				int major, minor,patch;],
				[SPF_get_lib_version(&major,&minor,&patch);],
			ac_cv_lib_spf2=yes,ac_cv_lib_spf2=no)
dnl AC_MSG_RESULT([ ... link -L/opt/lib -lspf yields: $ac_cv_lib_spf2])
		if test	 "$ac_cv_lib_spf2" = yes; then
		    spfloc="-L/opt/lib"
		    LIBSPF="-L/opt/lib $LIBSPF"
		fi
	    fi
	    if test "$ac_cv_lib_spf2" = no; then
		LIBS="$t_oldLibs"
		LIBS="$LIBS $LIBSOCKET -L/opt/local/lib $LIBSPF"
		AC_TRY_LINK([#include <sys/types.h>
				#include <spf2/spf.h>
				int major, minor;],
				[SPF_get_lib_version(&major,&minor);],
			ac_cv_lib_spf2=yes,ac_cv_lib_spf2=no)
		if test	 "$ac_cv_lib_spf2" = yes; then
		    spfloc="-L/opt/local/lib"
		    LIBSPF="-L/opt/local/lib $LIBSPF"
		fi
	    fi
	    if test "$ac_cv_lib_spf2" = no; then
		unset ac_cv_lib_spf2
	    fi

	    CPPFLAGS="$t_oldCpp"
	    LIBS="$t_oldLibs"

	else
	    AC_CHECK_HEADERS(/local/include/spf2/spf.h /usr/local/include/spf2/spf.h \
			     /opt/include/spf2/spf.h /opt/local/include/spf2/spf.h)
	    SPFvers=2
	    if test -n "$ac_cv_header__local_include_spf2_spf_h"; then
		LIBSPF="-L/local/lib -lspf2"
		INCLSPF="-I/local/include"
		spfloc="-L/local/lib -I/local/include"
	    elif test -n "$ac_cv_header__usr_local_include_spf2_spf_h"; then
		LIBSPF="-L/usr/local/lib -lspf2"
		INCLSPF="-I/usr/local/include"
		spfloc="-L/usr/local/lib -I/usr/local/include"
	    elif test -n "$ac_cv_header__opt_include_spf2_spf_h"; then
		LIBSPF="-L/opt/lib -lspf2"
		INCLSPF="-I/opt/include"
		spfloc="-L/opt/lib -I/opt/include"
	    elif test -n "$ac_cv_header__opt_local_include_spf2_spf_h"; then
		LIBSPF="-L/opt/local/lib -lspf2"
		INCLSPF="-I/opt/local/include"
		spfloc="-L/opt/local/lib -I/opt/local/include"
	    else
		LIBSPF=""
		INCLSPF=""
		spfloc="nowhere?"
		SPFvers=0
	    fi
	fi

	# How about the old   <spf_alt/spf.h>  file & lib ?
	if test -z "$LIBSPF" -a "$ac_cv_header_spf_alt_spf_h" = yes; then
	    LIBSPF="-lspf_alt"
	    INCLSPF=""
	    spfloc="sysdefault"
	    SPFvers=1

	    LIBS="$LIBS $LIBSOCKET $LIBSPF"
	    CPPFLAGS="$CPPFLAGS $INCLSPF"
	    AC_TRY_LINK([#include <sys/types.h>
			#include <spf_alt/spf.h>
			int major, minor;],
			[SPF_get_lib_version(&major,&minor);],
			ac_cv_lib_spf=yes,ac_cv_lib_spf=no)
dnl AC_MSG_RESULT([ ... link -lspf yields: $ac_cv_lib_spf])
	    if test "$ac_cv_lib_spf" = no; then
		LIBS="$t_oldLibs"
		LIBS="$LIBS $LIBSOCKET -L/usr/local/lib $LIBSPF"
		AC_TRY_LINK([#include <sys/types.h>
				#include <spf_alt/spf.h>
				int major, minor;],
				[SPF_get_lib_version(&major,&minor);],
			ac_cv_lib_spf=yes,ac_cv_lib_spf=no)
dnl AC_MSG_RESULT([ ... link -L/usr/local/lib -lspf yields: $ac_cv_lib_spf])
		if test	 "$ac_cv_lib_spf" = yes; then
		    spfloc="-L/usr/local/lib"
		    LIBSPF="-L/usr/local/lib $LIBSPF"
		fi
	    fi
	    if test "$ac_cv_lib_spf" = no; then
		LIBS="$t_oldLibs"
		LIBS="$LIBS $LIBSOCKET -L/local/lib $LIBSPF"
		AC_TRY_LINK([#include <sys/types.h>
				#include <spf_alt/spf.h>
				int major, minor;],
				[SPF_get_lib_version(&major,&minor);],
			ac_cv_lib_spf=yes,ac_cv_lib_spf=no)
dnl AC_MSG_RESULT([ ... link -L/local/lib -lspf yields: $ac_cv_lib_spf])
		if test	 "$ac_cv_lib_spf" = yes; then
		    spfloc="-L/local/lib"
		    LIBSPF="-L/local/lib $LIBSPF"
		fi
	    fi
	    if test "$ac_cv_lib_spf" = no; then
		LIBS="$t_oldLibs"
		LIBS="$LIBS $LIBSOCKET -L/opt/lib $LIBSPF"
		AC_TRY_LINK([#include <sys/types.h>
				#include <spf_alt/spf.h>
				int major, minor;],
				[SPF_get_lib_version(&major,&minor);],
			ac_cv_lib_spf=yes,ac_cv_lib_spf=no)
dnl AC_MSG_RESULT([ ... link -L/opt/lib -lspf yields: $ac_cv_lib_spf])
		if test	 "$ac_cv_lib_spf" = yes; then
		    spfloc="-L/opt/lib"
		    LIBSPF="-L/opt/lib $LIBSPF"
		fi
	    fi
	    if test "$ac_cv_lib_spf" = no; then
		LIBS="$t_oldLibs"
		LIBS="$LIBS $LIBSOCKET -L/opt/local/lib $LIBSPF"
		AC_TRY_LINK([#include <sys/types.h>
				#include <spf_alt/spf.h>
				int major, minor;],
				[SPF_get_lib_version(&major,&minor);],
			ac_cv_lib_spf=yes,ac_cv_lib_spf=no)
		if test	 "$ac_cv_lib_spf" = yes; then
		    spfloc="-L/opt/local/lib"
		    LIBSPF="-L/opt/local/lib $LIBSPF"
		fi
	    fi
	    if test "$ac_cv_lib_spf" = no; then
		unset ac_cv_lib_spf
	    fi

	    CPPFLAGS="$t_oldCpp"
	    LIBS="$t_oldLibs"

	elif test -z "$LIBSPF" ; then
	    AC_CHECK_HEADERS(/local/include/spf_alt/spf.h /usr/local/include/spf_alt/spf.h \
			     /opt/include/spf_alt/spf.h /opt/local/include/spf_alt/spf.h)
	    SPFvers=1
	    if test -n "$ac_cv_header__local_include_spf_alt_spf_h"; then
		LIBSPF="-L/local/lib -lspf_alt"
		INCLSPF="-I/local/include"
		spfloc="-L/local/lib -I/local/include"
	    elif test -n "$ac_cv_header__usr_local_include_spf_alt_spf_h"; then
		LIBSPF="-L/usr/local/lib -lspf_alt"
		INCLSPF="-I/usr/local/include"
		spfloc="-L/usr/local/lib -I/usr/local/include"
	    elif test -n "$ac_cv_header__opt_include_spf_alt_spf_h"; then
		LIBSPF="-L/opt/lib -lspf_alt"
		INCLSPF="-I/opt/include"
		spfloc="-L/opt/lib -I/opt/include"
	    elif test -n "$ac_cv_header__opt_local_include_spf_alt_spf_h"; then
		LIBSPF="-L/opt/local/lib -lspf_alt"
		INCLSPF="-I/opt/local/include"
		spfloc="-L/opt/local/lib -I/opt/local/include"
	    else
		LIBSPF=""
		INCLSPF=""
		spfloc="nowhere?"
		SPFvers=0
	    fi
	fi

	if test -n "$LIBSPF" ; then
	    if test "$SPFvers" = 2 ; then
		LIBS="$LIBS $LIBSOCKET $LIBSPF"
		CPPFLAGS="$CPPFLAGS $INCLSPF"
		AC_CACHE_VAL(ac_cv_lib_spf,
		    [AC_TRY_LINK([#include <sys/types.h>
			#include <spf2/spf.h>
			int major, minor, patch;],
			[SPF_get_lib_version(&major,&minor,&patch);],
			ac_cv_lib_spf2=yes,ac_cv_lib_spf2=no)
		])
		if test "$ac_cv_lib_spf2" = yes; then
		    AC_MSG_RESULT([SPF2 libs  available at $spfloc: -lspf2 !]);
		    AC_DEFINE(HAVE_SPF_H,1,[SPF2 libs  available at $spfloc: -lspf2 !])
		else
		    AC_MSG_RESULT([No spf2 libs available at system default locations ?])
		    LIBSPF=""
		    INCLSPF=""
		fi
	    else # SPF_ALT, I presume..
		LIBS="$LIBS $LIBSOCKET $LIBSPF"
		CPPFLAGS="$CPPFLAGS $INCLSPF"
		AC_CACHE_VAL(ac_cv_lib_spf,
		    [AC_TRY_LINK([#include <sys/types.h>
			#include <spf_alt/spf.h>
			int major, minor;],
			[SPF_get_lib_version(&major,&minor);],
			ac_cv_lib_spf=yes,ac_cv_lib_spf=no)
		])
		if test "$ac_cv_lib_spf" = yes; then
		    AC_MSG_RESULT([SPF libs  available at $spfloc: -lspf_alt !]);
		    AC_DEFINE(HAVE_SPF_H,1,[SPF libs  available at $spfloc: -lspf_alt !])
		else
		    AC_MSG_RESULT([No spf libs available at system default locations ?])
		    LIBSPF=""
		    INCLSPF=""
		fi
	    fi
	fi
  #  fi
  else
    if test -f "$withval"/lib/libspf2.a ; then
	LIBSPF="-L$withval/lib -lspf2"
	AC_MSG_RESULT([Using spf libs at directory: $withval/lib]);
    elif test -f "$withval"/lib/libspf_alt.a ; then
	LIBSPF="-L$withval/lib -lspf_alt"
	AC_MSG_RESULT([Using spf libs at directory: $withval/lib]);
    else
	LIBSPF="-L$withval -lspf_alt"
	AC_MSG_RESULT([Using spf libs at directory: $withval]);
    fi
    if test -f "$withval"/include/spf2/spf.h ; then
	INCLSPF="-I$withval/include"
	AC_MSG_RESULT([Using spf2 includes at directory: $withval]);
    elif test -f "$withval"/include/spf_alt/spf.h ; then
	INCLSPF="-I$withval/include"
	AC_MSG_RESULT([Using spf includes at directory: $withval]);
    else
	INCLSPF="-I$withval"
	AC_MSG_RESULT([Using spf includes at directory: $withval]);
    fi
    unset ac_cv_lib_spf
    AC_DEFINE(HAVE_SPF_H,1,[Using spf includes at directory: $withval])
  fi
fi

CPPFLAGS="$t_oldCpp"
LIBS="$t_oldLibs"


dnl #
dnl #  At some systems the load-average can be gotten with these routines..
dnl #
dnl AC_SUBST(LIBLOADAVER)dnl
dnl AC_CHECK_HEADERS(kvm.h)
dnl #if test "$ac_cv_header_kvm_h" = yes; then
dnl #  AC_DEFINE(SVR4_kvm)
dnl #  LIBLOADAVER="-lkvm"
dnl #  AC_MSG_RESULT([Presuming the need of -lkvm for load-average library])
dnl #fi
dnl 
dnl AC_CHECK_HEADERS(elf.h, [
dnl elf_LIBS="$LIBS"
dnl have_nlist=0
dnl AC_TRY_LINK([
dnl #ifdef HAVE_NLIST_H
dnl #include <nlist.h>
dnl #endif
dnl ],
dnl         [nlist((char*)0,(char*)0);],
dnl         have_nlist=1);
dnl if test "$have_nlist" = 1 ; then
dnl     AC_DEFINE(SVR4_elf)
dnl     AC_MSG_RESULT([Have  nlist()  without  -lelf])
dnl else
dnl     LIBS="$LIBS -lelf"
dnl     AC_TRY_LINK([
dnl #ifdef HAVE_NLIST_H
dnl #include <nlist.h>
dnl #endif
dnl ],
dnl             [nlist((char*)0,(char*)0);],
dnl             have_nlist=1);
dnl     if test "$have_nlist" = 1 ; then
dnl     AC_DEFINE(SVR4_elf)
dnl     LIBLOADAVER="$LIBLOADAVER -lelf"
dnl     AC_MSG_RESULT([Seems to need  -lelf  to link nlist()])
dnl     else
dnl     AC_MSG_RESULT([Don't know how to extract system load-average -- but don't really need it])
dnl     fi
dnl fi
dnl LIBS="$elf_LIBS"
dnl ])
dnl 

AC_FUNC_STRFTIME
AC_FUNC_SPRINTF
AC_FUNC_VPRINTF
AC_CHECK_FUNCS(vsprintf vsnprintf snprintf)
AC_FUNC_ALLOCA
AC_FUNC_GETPGRP
AC_FUNC_MMAP
dnl AC_FUNC_UTIME_NULL

AC_SUBST(TA_USE_MMAP)
TA_USE_MMAP="0"
AC_ARG_WITH(ta-mmap,   [  --with-ta-mmap           TA's to use MMAP for reading the message bodies],
        use_ta_mmap=1, use_ta_mmap=0)
if test "$use_ta_mmap" = "1"; then
    TA_USE_MMAP="1"
fi

AC_SUBST(GETPWLIB)
AC_ARG_WITH(getpwnam-library, [  --with-getpwnam-library=\"-L.. -l..\"
                            Linking options for non-std getpwnam() libraries],
        use_getpwnam_lib=1, use_getpwnam_lib=0)
if test "$use_getpwnam_lib" = 1; then
  GETPWLIB="$withval"
fi

AC_SUBST(OPENSSLPREFIX)
AC_SUBST(OPENSSLINCL)
AC_SUBST(OPENSSLLIB)

AC_ARG_WITH(openssl-prefix, [  --with-openssl-prefix=/dir/path (defines both include and lib)],
        OPENSSLPREFIX="$withval")
AC_ARG_WITH(openssl-include, [  --with-openssl-include=/dir/incl/path],
        OPENSSLINCL="-I$withval")
AC_ARG_WITH(openssl-lib, [  --with-openssl-lib=/dir/lib/path],
        [if test -f "$withval/libssl.so" ; then
          OPENSSLLIB="$withval/libssl.so $withval/libcrypto.so"
        else
          OPENSSLLIB="$withval/libssl.a $withval/libcrypto.a"
        fi
#       if test "$withval" != "/usr" -a "$withval" != "/usr/lib"; then
#         # Operating system dependent runtime path definition :-/
#         OPENSSLLIB="-R$withval $OPENSSLLIB"
#       fi
])
if test -n "$OPENSSLPREFIX" -a -z "$OPENSSLINCL" ; then
  if test -f "$OPENSSLPREFIX/include/openssl/ssl.h" ; then
    OPENSSLINCL="-I$OPENSSLPREFIX/include/"
  else
    AC_MSG_RESULT([!!! You defined  --with-openssl-prefix=$OPENSSLPREFIX,  BUT])
    AC_MSG_RESULT([!!! there does not exist file  $OPENSSLPREFIX/include/openssl/ssl.h !])
  fi
fi
if test -n "$OPENSSLPREFIX" -a -z "$OPENSSLLIB" ; then
  if test -n "$OPENSSLPREFIX" -a -f "$OPENSSLPREFIX/lib/libssl.so" ; then
    OPENSSLLIB="$OPENSSLPREFIX/lib/libssl.so $OPENSSLPREFIX/lib/libcrypto.so"
#   if test "$withval" != "/usr" -a "$withval" != "/usr/lib"; then
#       # Operating system dependent runtime path definition :-/
#       OPENSSLLIB="-R$withval $OPENSSLLIB"
#   fi
  elif test -n "$OPENSSLPREFIX" -a -f "$OPENSSLPREFIX/lib/libssl.a" ; then
    OPENSSLLIB="$OPENSSLPREFIX/lib/libssl.a $OPENSSLPREFIX/lib/libcrypto.a"
  else
    AC_MSG_RESULT([!!! You defined  --with-openssl-prefix=$OPENSSLPREFIX,  BUT])
    AC_MSG_RESULT([!!! there does not exist file  $OPENSSLPREFIX/lib/libssl.a !])
  fi
fi
if test -n "$OPENSSLINCL" -a -n "$OPENSSLLIB" ; then
  AC_DEFINE(HAVE_OPENSSL,1,[System has OpenSSL of some version, and want to use it.])
fi

AC_ARG_WITH(openssl, [  --with-openssl           Search for, and use OpenSSL, if it can be found],
[
 if test -z "$OPENSSLINCL" ; then
   # No Explicite setup, lets do some auto-tests
   if test -n "$PKGCONFIG" ; then # RedHat 8.0 with OpenSSL 0.9.7!
     OPENSSLINCL="`$PKGCONFIG --cflags-only-I openssl`"
     OPENSSLLIB="`$PKGCONFIG --libs openssl`"
   fi
   if test -n "$OPENSSLINCL" -o -n "$OPENSSLLIB" ; then
     WHEREOPENSSL="version unknown  via  pkg-config data"
   fi
 fi
 if test -z "$OPENSSLINCL" ; then
  # No Explicite setup, lets do some more auto-tests
  if test -f /usr/local/ssl/include/openssl/ssl.h ; then
    # Gee, OpenSSL 0.9.3a at default prefix!
    OPENSSLPREFIX="/usr/local/ssl"
    OPENSSLINCL="-I$OPENSSLPREFIX/include"
    if test -f "$OPENSSLPREFIX/lib/libssl.so" ; then
      OPENSSLLIB="$OPENSSLPREFIX/lib/libssl.so $OPENSSLPREFIX/lib/libcrypto.so"
    else
      OPENSSLLIB="$OPENSSLPREFIX/lib/libssl.a $OPENSSLPREFIX/lib/libcrypto.a"
    fi
    WHEREOPENSSL="version 0.9.3a (or newer) at default location"
  fi
  if test -f /usr/include/openssl/ssl.h ; then
    # Gee, OpenSSL 0.9.3a at  "--prefix=/usr" !!!
    OPENSSLPREFIX="/usr"
    OPENSSLINCL=""
    if test -f "$OPENSSLPREFIX/lib/libssl.so" ; then
      OPENSSLLIB="$OPENSSLPREFIX/lib/libssl.so $OPENSSLPREFIX/lib/libcrypto.so"
    else
      OPENSSLLIB="$OPENSSLPREFIX/lib/libssl.a $OPENSSLPREFIX/lib/libcrypto.a"
    fi
    WHEREOPENSSL="version 0.9.3a (or newer) at system root"
  fi
fi
if test -n "$OPENSSLINCL" -o -n "$OPENSSLLIB" ; then
  AC_MSG_RESULT([Found OpenSSL  $WHEREOPENSSL])
  AC_MSG_RESULT([   OPENSSLINCL=${OPENSSLINCL}])
  AC_MSG_RESULT([   OPENSSLLIB =${OPENSSLLIB}])
  AC_DEFINE(HAVE_OPENSSL,1,[System has OpenSSL of some version, and want to use it.])
fi

])


AC_MSG_CHECKING(whether Distcache is required)
ap_ssltk_dc="no"
tmp_nomessage=""
tmp_forced="no"
AC_ARG_ENABLE(distcache,
  [  --enable-distcache=yes/no,  Select distcache support],
  ap_ssltk_dc="$enableval"
  tmp_nomessage=""
  tmp_forced="yes"
  if test "x$ap_ssltk_dc" = "x"; then
    ap_ssltk_dc="yes"
    dnl our "error"s become "tests revealed that..."
    tmp_forced="no"
  fi
  if test "$ap_ssltk_dc" != "yes" -a "$ap_ssltk_dc" != "no"; then
    tmp_nomessage="--enable-distcache had illegal syntax - disabling"
    ap_ssltk_dc="no"
  fi)
if test "$tmp_forced" = "no"; then
    AC_MSG_RESULT($ap_ssltk_dc (default))
else
    AC_MSG_RESULT($ap_ssltk_dc (specified))
fi
if test "$tmp_forced" = "yes" -a "x$ap_ssltk_dc" = "xno" -a "x$tmp_nomessage" != "x"; then
    AC_MSG_ERROR(distcache support failed: $tmp_nomessage)
fi
if test "$ap_ssltk_dc" = "yes"; then
    AC_CHECK_HEADER(
      [distcache/dc_client.h],
      [],
      [tmp_nomessage="can't include distcache headers"
      ap_ssltk_dc="no"])
    if test "$tmp_forced" = "yes" -a "x$ap_ssltk_dc" = "xno"; then
      AC_MSG_ERROR(distcache support failed: $tmp_nomessage)
    fi
fi
if test "$ap_ssltk_dc" = "yes"; then
    AC_MSG_CHECKING(for Distcache version)
    AC_TRY_COMPILE(
[#include <distcache/dc_client.h>],
[#if DISTCACHE_CLIENT_API != 0x0001
#error "distcache API version is unrecognised"
#endif],
[],
[tmp_nomessage="distcache has an unsupported API version"
ap_ssltk_dc="no"])
    AC_MSG_RESULT($ap_ssltk_dc)
    if test "$tmp_forced" = "yes" -a "x$ap_ssltk_dc" = "xno"; then
      AC_MSG_ERROR(distcache support failed: $tmp_nomessage)
    fi
fi
if test "$ap_ssltk_dc" = "yes"; then
    AC_MSG_CHECKING(for Distcache libraries)
    save_libs=$LIBS
    LIBS="$LIBS -ldistcache -lnal"
    AC_TRY_LINK(
      [#include <distcache/dc_client.h>],
      [DC_CTX *foo = DC_CTX_new((const char *)0,0);],
      [],
      [tmp_no_message="failed to link with distcache libraries"
      ap_ssltk_dc="no"])
    LIBS=$save_libs
    AC_MSG_RESULT($ap_ssltk_dc)
    if test "$tmp_forced" = "yes" -a "x$ap_ssltk_dc" = "xno"; then
      AC_MSG_ERROR(distcache support failed: $tmp_nomessage; need  --generic-include and/or --generic-lib ?)
    fi
fi

if test "$ap_ssltk_dc" = "yes"; then
    AC_DEFINE(HAVE_DISTCACHE,1,[Have distributed (SSL session) cache])
    OPENSSLLIB="$OPENSSLLIB -ldistcache -lnal"
fi


AC_SUBST(SASL2PREFIX)
AC_SUBST(SASL2INCL)
AC_SUBST(SASL2LIB)

AC_ARG_WITH(sasl2-prefix, [  --with-sasl2-prefix=/dir/path (defines both include and lib)],
        SASL2PREFIX="$withval")
AC_ARG_WITH(sasl2-include, [  --with-sasl2-include=/dir/incl/path],
        SASL2INCL="-I$withval")
AC_ARG_WITH(sasl2-lib, [  --with-sasl2-lib=/dir/lib/path],
        [if test -f "$withval/libsasl2.so" ; then
          SASL2LIB="$withval/libsasl2.so"
        else
          SASL2LIB="$withval/libsasl2.a"
        fi
#       if test "$withval" != "/usr" -a "$withval" != "/usr/lib"; then
#         # Operating system dependent runtime path definition :-/
#         SASL2LIB="-R$withval $SASL2LIB"
#       fi
])
if test -n "$SASL2PREFIX" -a -z "$SASL2INCL" ; then
  if test -f "$SASL2PREFIX/include/sasl/sasl.h" ; then
    SASL2INCL="-I$SASL2PREFIX/include/"
    AC_DEFINE(HAVE_SASL_SASL_H, 1, [Have <sasl/sasl.h> header])
EOF
  else
    AC_MSG_RESULT([!!! You defined  --with-sasl2-prefix=$SASL2PREFIX,  BUT])
    AC_MSG_RESULT([!!! there does not exist file  $SASL2PREFIX/include/sasl/sasl.h !])
  fi
fi
if test -n "$SASL2PREFIX" -a -z "$SASL2LIB" ; then
  if test -n "$SASL2PREFIX" -a -f "$SASL2PREFIX/lib/libsasl2.so" ; then
    SASL2LIB="$SASL2PREFIX/lib/libsasl2.so"
#   if test "$withval" != "/usr" -a "$withval" != "/usr/lib"; then
#       # Operating system dependent runtime path definition :-/
#       SASL2LIB="-R$withval $SASL2LIB"
#   fi
  elif test -n "$SASL2PREFIX" -a -f "$SASL2PREFIX/lib/libsasl2.a" ; then
    SASL2LIB="$SASL2PREFIX/lib/libsasl2.a"
  else
    AC_MSG_RESULT([!!! You defined  --with-sasl2-prefix=$SASL2PREFIX,  BUT])
    AC_MSG_RESULT([!!! there does not exist file  $SASL2PREFIX/lib/libsasl2.a !])
  fi
fi
if test -n "$SASL2INCL" -a -n "$SASL2LIB" ; then
  AC_DEFINE(HAVE_SASL2,1,[System has Sasl2 of some version, and want to use it.])
fi

AC_ARG_WITH(sasl2, [  --with-sasl2             Search for, and use Sasl2, if it can be found],
[if test -z "$SASL2INCL" ; then
  # No Explicite setup, lets do some auto-tests
  SaslH=/usr/local/include/sasl/sasl.h
  if test -r $SaslH ; then
    AC_DEFINE(HAVE_SASL_SASL_H, 1, [Have <sasl/sasl.h> header])
    SaslMajor="`awk '/SASL_VERSION_MAJOR/{print $NF}' < $SaslH`"
    if test "$SaslMajor" != "2"; then
      # HUH! Not SASL2 !
      AC_MSG_RESULT([There is  $SaslH  file, but its SASL_VERSION_MAJOR is not 2!])
    else
      # Gee, Sasl2 2.1.x at default prefix!
      AC_DEFINE(HAVE_SASL2,1,[System has Sasl2 of some version, and want to use it.])
      SASL2PREFIX="/usr/local"
      SASL2INCL="-I$SASL2PREFIX/include"
      if test -f "$SASL2PREFIX/lib/libsasl2.so" ; then
        SASL2LIB="$SASL2PREFIX/lib/libsasl2.so"
      else
        SASL2LIB="$SASL2PREFIX/lib/libsasl2.a"
      fi
      AC_MSG_RESULT([You have Sasl2 version 2.x (or newer) at default location])
    fi
  fi
  SaslH=/usr/include/sasl/sasl.h
  if test -r $SaslH ; then
    AC_DEFINE(HAVE_SASL_SASL_H, 1, [Have <sasl/sasl.h> header])
    SaslMajor="`awk '/SASL_VERSION_MAJOR/{print $NF}' < $SaslH`"
    if test "$SaslMajor" != "2"; then
      # HUH! Not SASL2 !
      AC_MSG_RESULT([There is  $SaslH  file, but its SASL_VERSION_MAJOR is not 2!])
    else
      # Gee, Sasl2 2.1.x at default prefix!
      AC_DEFINE(HAVE_SASL2,1,[System has Sasl2 of some version, and want to use it.])
      SASL2PREFIX="/usr"
      SASL2INCL=""
      if test -f "$SASL2PREFIX/lib/libsasl2.so" ; then
        SASL2LIB="$SASL2PREFIX/lib/libsasl2.so"
      else
        SASL2LIB="$SASL2PREFIX/lib/libsasl2.a"
      fi
      AC_MSG_RESULT([You have Sasl2 version 2.x (or newer) at default location])
    fi
  fi
fi])


AC_ARG_ENABLE(translation,[  --enable-translation=CHS Enable charset translation of incoming text messages.
                           Assumes --generic-library=\"... -lmcs ...\" and
                           proper --generic-include.
                           (See smtpserver/README.translation)],
[
       AC_DEFINE_UNQUOTED(USE_TRANSLATION,"$enableval",[Do use incoming phase character set translator library]) 
])

AC_CHECK_FUNCS(crypt)

if test "$ac_cv_func_crypt" != yes ; then
    # Now why ???  Must have "-lcrypt" like Linuxes ???
    t_oldLibs="$LIBS"
    LIBS="$LIBS -lcrypt"
    AC_TRY_LINK([], [char *s1, *s2, *s3; s3 = crypt(s1,s2);],
                ac_cv_lib_crypt_lib=yes,ac_cv_lib_crypt_lib=no)
    if test "$ac_cv_lib_crypt_lib" = yes; then
        # Success with this flag..
        GETPWLIB="$GETPWLIB -lcrypt"
        AC_MSG_RESULT([crypt() was found by using -lcrypt  library!])
    fi
    LIBS="$t_oldLibs"
fi



# Determine how to get the list of mounted filesystems.

AC_FUNC_GETMNTENT
AC_FUNC_GETMNTENT_MORE

# Test how to find out the filesystem space usage:
AC_FUNC_STATVFS

AC_CHECK_FUNCS(ftruncate, , [ftruncate_missing=yes])

if test "$ftruncate_missing" = yes; then
  AC_MSG_CHECKING([fcntl emulation of ftruncate])
  AC_CACHE_VAL(fu_cv_sys_ftruncate_emulation,
  [AC_TRY_LINK([
#include <sys/types.h>
#include <fcntl.h>], [
#if !defined(F_CHSIZE) && !defined(F_FREESP)
chsize();
#endif
],
    fu_cv_sys_ftruncate_emulation=yes,
    fu_cv_sys_ftruncate_emulation=no)])
  AC_MSG_RESULT($fu_cv_sys_ftruncate_emulation)
  if test $fu_cv_sys_ftruncate_emulation = yes; then
    AC_LIBOBJ([ftruncate])
  fi
fi

# If we don't yet have getgroups, see if it's in -lbsd.
# This is reported to be necessary on an ITOS 3000WS running SEIUX 3.1.
AC_CHECK_FUNC(getgroups, , AC_CHECK_LIB(bsd, getgroups))

AC_CHECK_HEADERS(sys/ipc.h sys/msg.h)
AC_CHECK_FUNCS(msgsnd msgrcv msgctl)

# Check for libypsec.a on Dolphin M88K machines.
AC_CHECK_LIB(ypsec, main)

# m88k running dgux 5.4 needs this
AC_CHECK_LIB(ldgc, main)

AC_CHECKING(for AFS)
test -d /afs && AC_DEFINE(AFS,1,[Has /afs  directory, possibly AFS filesystem])

if test "$ac_cv_c_const" = no ; then
  CFLAGS="$CFLAGS -Dconst=''"
fi

AC_PATH_PROG(PROCMAIL, procmail, procmail)dnl
AC_PATH_PROG(MD5SUM, md5sum, $MAILBIN/md5sum)dnl

for x in sfio sfio/src sfio/src/lib sfio/src/lib/sfio sfio/include sfio/lib
do
  if test ! -d $x ; then mkdir $x; fi
done

CPPFLAGS="$OrigCPPFLAGS"

AC_CONFIG_HEADER(config.h)
AC_CONFIG_FILES([
	Makefile
        router/Makefile                 router/libdb/Makefile           
        scheduler/Makefile              smtpserver/Makefile             
        transports/Makefile             transports/smtp/Makefile        
        transports/mailbox/Makefile     transports/hold/Makefile        
        transports/libta/Makefile       transports/sm/Makefile          
        transports/errormail/Makefile   transports/fuzzyalias/Makefile  
        transports/expirer/Makefile     transports/expirer/manual-expirer 
	transports/reroute/Makefile	transports/reroute/manual-rerouter 
        compat/Makefile                 compat/rmail/Makefile           
        compat/sendmail/Makefile                                        
        sfio/Makefile                   sfio/src/lib/sfio/makefile      
        sfio/src/lib/sfio/Stdio_b/Makefile                              
        sfio/src/lib/sfio/Stdio_s/Makefile                              
        sfio/src/lib/sfio/Sfio_f/Makefile                               
        sfio/src/lib/sfio/Sfio_dc/Makefile                              
        lib/Makefile                    libc/Makefile                   
        libident/Makefile               libs/Makefile                   
        libsh/Makefile                  libmalloc/Makefile              
        libmalloc/splay/Makefile        libresolv/Makefile              
        ssl/Makefile                                                    
        doc/Makefile                    doc/design/Makefile             
        include/mail.h                  
        utils/policy-builder.sh         utils/Makefile                  
        utils/zmailer.init.sh           utils/autoanswer.pl             
        utils/vacation/Makefile         
        utils/vacation/vacation.sh      utils/makedb/Makefile           
        utils/rotate-logs.sh            utils/smtpserver-log-parser.pl  
        utils/mxverify/Makefile         
	utils/smtp-contentfilter	
        packaging/Makefile              packaging/solaris/Makefile      
        SiteConfig
	po/Makefile.in			intl/Makefile
],[])dnl
AC_CONFIG_FILES([
        proto/Makefile                  proto/zmailer.sh                
        proto/newaliases                proto/newfqdnaliases            
        proto/newdb                     proto/newdbprocessor            
        proto/scheduler.conf            proto/scheduler.auth            
        proto/mailrm.sh                 proto/db/Makefile               
        proto/cf/TELE-FI.cf             proto/smtpserver.conf           
        proto/cf/SMTP+UUCP.cf           proto/cf/UTdefault.cf           
        proto/cf/SMTP.cf                proto/smtp-tls.conf             
        proto/db/aliases                proto/sm.conf                   
        proto/post-install.sh
],[])dnl
dnl man-files
AC_CONFIG_FILES([
	man/Makefile		man/aliases.5		man/authuser.3
	man/errormail.8		man/expirer.8		man/hold.8
	man/mailbox.8		man/mailq.1		man/mailrm.1
	man/makedb.8		man/manual-expirer.8	man/zmsh.1
	man/manual-rerouter.8	man/mboxpath.1		man/zmailer.3
	man/mprobe.8		man/newaliases.1	man/newdb.8
	man/reroute.8		man/rmail.1		man/router.8
	man/scheduler.8		man/sendmail.8		man/sm.8
	man/smtp.8		man/smtpserver.8	man/ssl.1
	man/vacation.1		man/zdbases.conf.5	man/zmailer.1
],[])dnl
AC_CONFIG_FILES([
	utils/perl/Makefile		
],[
#### Special conditional copying:
if test ! -d utils/perl/mailq ; then
   mkdir utils/perl/mailq
   cp -pr $srcdir/utils/perl/mailq/* utils/perl/mailq/
fi
])dnl
AC_CONFIG_FILES([
        bin/mkdep                       bin/mklibdep  ],
[chmod 755 bin/*
 echo > stamp-h])dnl
AC_OUTPUT
AC_MSG_RESULT([Remember to check  SiteConfig  for possible option changes])
